<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Chat + Mock Test (v8.1 - Delete/AutoName Fixed)</title> <!-- рокродро┐рокрпНрокрпБ рокрпБродрпБрокрпНрокро┐роХрпНроХрокрпНрокроЯрпНроЯродрпБ -->

    <!-- MathJax Configuration -->
    <script> window.MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],displayMath:[['$$','$$'],['\\[','\\]']]},svg:{fontCache:'global'},options:{skipHtmlTags:['script','noscript','style','textarea','pre','code']}}; </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <style>
        /* --- Styles (Delete рокрпКродрпНродро╛ройрпБроХрпНроХро╛рой рооро╛ро▒рпНро▒роЩрпНроХро│рпН) --- */
        :root { /* ... Theme Variables ... */
             --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; --sidebar-width: 260px; --message-font-size-base: 1rem;
             /* LIGHT */ --sidebar-bg: #f7f7f7; --main-bg: #ffffff; --input-bg: #ffffff; --border-color: #e0e0e0; --text-primary: #2c2c2c; --text-secondary: #5f5f5f; --text-placeholder: #999999; --accent-color: #d97a7a; --user-message-bg: #cce0ff; --user-message-text: #1c1c1c; --ai-message-bg: #f0f0f0; --ai-message-text: #2c2c2c; --button-bg: #f0f0f0; --button-hover-bg: #e0e0e0; --active-item-bg: #e0e0e0; --code-bg: #e8e8e8; --scrollbar-thumb: #ccc; --scrollbar-thumb-hover: #bbb; --app-outer-bg: #e8e8e8; --send-button-bg: var(--accent-color); --send-button-hover-bg: #c76b6b; --send-button-text: #ffffff; --error-bg: #ffebee; --error-text: #c62828; --error-border: #ef9a9a; --message-font-size: var(--message-font-size-base); --delete-button-color: #aaa; --delete-button-hover-color: #dc3545;
        }
        body.dark-theme { /* DARK */ --sidebar-bg: #2a2a2e; --main-bg: #1e1e1e; --input-bg: #2a2a2e; --border-color: #404040; --text-primary: #e0e0e0; --text-secondary: #a0a0a0; --text-placeholder: #777777; --accent-color: #e58b8b; --user-message-bg: #3a4a6b; --user-message-text: #e8e8e8; --ai-message-bg: #333333; --ai-message-text: #e0e0e0; --button-bg: #404040; --button-hover-bg: #505050; --active-item-bg: #454545; --code-bg: #2c2c2e; --scrollbar-thumb: #555; --scrollbar-thumb-hover: #666; --app-outer-bg: #121212; --send-button-bg: var(--accent-color); --send-button-hover-bg: #f09f9f; --send-button-text: #1e1e1e; --error-bg: #5c2b2b; --error-text: #ffcdd2; --error-border: #8c4343; --delete-button-color: #666; --delete-button-hover-color: #f09f9f; }
        body { font-family: var(--font-family); margin: 0; padding: 0; background-color: var(--app-outer-bg); color: var(--text-primary); font-size: 15px; transition: background-color 0.3s ease, color 0.3s ease; }

        /* --- Layout & Structure (рооро╛ро▒рпНро▒рооро┐ро▓рпНро▓рпИ) --- */
        .app-container { display: flex; height: 100vh; width: 100vw; overflow: hidden; } .app-container.hidden { display: none; }
        .sidebar { width: var(--sidebar-width); background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 15px 0; box-sizing: border-box; flex-shrink: 0; transition: background-color 0.3s ease, border-color 0.3s ease; }
        .main-container { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; overflow: hidden; position: relative; }
        .main-content, .review-view { display: none; flex-direction: column; background-color: var(--main-bg); height: 100%; width: 100%; overflow: hidden; transition: background-color 0.3s ease; }
        .main-content.active, .review-view.active { display: flex; }
        .chat-area { flex-grow: 1; overflow-y: auto; padding: 30px 10% 20px; display: flex; flex-direction: column; max-width: 800px; margin: 0 auto; width: 80%; }
        .input-container { padding: 20px 10%; border-top: 1px solid var(--border-color); background-color: var(--input-bg); max-width: 800px; margin: 0 auto; width: 80%; transition: background-color 0.3s ease, border-color 0.3s ease; display: none; /* Initially hidden until login */ }

        /* --- Sidebar Elements --- */
         .sidebar-header { padding: 10px 20px; font-size: 1.1em; font-weight: 600; color: var(--text-primary); }
         .start-chat-button { display: flex; align-items: center; gap: 8px; background-color: var(--main-bg); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 8px; padding: 10px 15px; margin: 10px 15px; font-size: 0.95em; font-weight: 500; cursor: pointer; text-align: left; transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease; }
         .start-chat-button:hover { background-color: var(--button-hover-bg); } .start-chat-button svg { fill: currentColor; width: 16px; height: 16px; }
         .start-chat-button:disabled { opacity: 0.6; cursor: not-allowed; }
         .sidebar-section-title { padding: 15px 20px 5px; font-size: 0.85em; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
         .chat-list { flex-grow: 1; overflow-y: auto; padding: 0 15px; margin-bottom: 10px; }
         .chat-list::-webkit-scrollbar { width: 6px; } .chat-list::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 3px;} .chat-list::-webkit-scrollbar-thumb:hover { background: var(--scrollbar-thumb-hover); }
         .chat-list-item {
             padding: 8px 30px 8px 10px; /* Delete рокрпКродрпНродро╛ройрпБроХрпНроХро╛роХ ро╡ро▓родрпБрокрпБро▒ padding роЕродро┐роХроорпН */
             margin-bottom: 4px; border-radius: 6px; font-size: 0.9em;
             cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
             color: var(--text-secondary); transition: background-color 0.2s ease, color 0.2s ease;
             position: relative; /* Delete рокрпКродрпНродро╛ройро┐ройрпН absolute positioning-роХрпНроХрпБ родрпЗро╡рпИ */
         }
         .chat-list-item:hover { background-color: var(--button-hover-bg); color: var(--text-primary); }
         .chat-list-item.active { background-color: var(--active-item-bg); color: var(--text-primary); font-weight: 500; }
         .delete-chat-button { /* NEW - Delete рокрпКродрпНродро╛ройрпН ро╕рпНроЯрпИро▓рпН */
             position: absolute;
             right: 6px;
             top: 50%;
             transform: translateY(-50%);
             width: 18px;
             height: 18px;
             background: none;
             border: none;
             color: var(--delete-button-color);
             cursor: pointer;
             font-size: 1.3em; /* роЕро│ро╡рпБ рооро╛ро▒рпНро▒ро▓ро╛роорпН */
             line-height: 1;
             padding: 0;
             display: none; /* Default роЖроХ рооро▒рпИроирпНродро┐ро░рпБроХрпНроХрпБроорпН */
             opacity: 0.7;
             transition: color 0.2s ease, opacity 0.2s ease;
         }
         .chat-list-item:hover .delete-chat-button {
             display: block; /* Hover роЪрпЖропрпНропрпБроорпНрокрпЛродрпБ родрпЖро░ро┐ропрпБроорпН */
         }
         .delete-chat-button:hover {
             color: var(--delete-button-hover-color);
             opacity: 1;
         }
         .sidebar-footer { border-top: 1px solid var(--border-color); padding: 10px 15px; transition: border-color 0.3s ease;}
         .sidebar-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
         .text-size-controls span, .theme-toggle span { font-size: 0.85em; color: var(--text-secondary); }
         .text-size-buttons button, .theme-toggle button { background: var(--button-bg); border: 1px solid var(--border-color); color: var(--text-secondary); border-radius: 4px; padding: 2px 8px; margin-left: 5px; cursor: pointer; font-size: 1.1em; line-height: 1; transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease; }
         .text-size-buttons button:hover, .theme-toggle button:hover { background-color: var(--button-hover-bg); color: var(--text-primary); }
         .text-size-buttons button:disabled, .theme-toggle button:disabled { opacity: 0.6; cursor: not-allowed; }
         .account-info { display: flex; align-items: center; gap: 10px; font-size: 0.9em; margin-top: 10px; }
         .account-avatar { width: 30px; height: 30px; border-radius: 50%; background-color: #6c757d; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; }
         .account-details { overflow: hidden; }
         .account-email { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-primary); }
         .account-plan { font-size: 0.85em; color: var(--text-secondary); }
         #auth-controls { margin-top: 15px; text-align: center; }
         #auth-controls button { background-color: var(--button-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; padding: 8px 15px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s ease; }
         #auth-controls button:hover { background-color: var(--button-hover-bg); }
         #logout-btn { display: none; }


        /* --- Chat Area Elements (рооро╛ро▒рпНро▒рооро┐ро▓рпНро▓рпИ) --- */
        .greeting { font-size: 1.8em; font-weight: 600; margin-bottom: 40px; color: var(--text-primary); } .greeting .asterisk { color: var(--accent-color); font-size: 1.2em; margin-right: 5px; display: inline-block; vertical-align: middle; }
        .message { padding: 12px 18px; border-radius: 18px; max-width: 80%; word-wrap: break-word; line-height: 1.6; margin-bottom: 15px; font-size: var(--message-font-size); transition: background-color 0.3s ease, color 0.3s ease; }
        .user-message { background-color: var(--user-message-bg); color: var(--user-message-text); align-self: flex-end; border-bottom-right-radius: 5px; }
        .ai-message { background-color: var(--ai-message-bg); color: var(--ai-message-text); align-self: flex-start; border-bottom-left-radius: 5px; }
        .ai-message strong { font-weight: 600; } .ai-message em { font-style: italic; }
        .ai-message pre { background-color: var(--code-bg); color: var(--text-primary); padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 0.9em; transition: background-color 0.3s ease, color 0.3s ease;}
        .ai-message code { font-family: monospace; background-color: var(--code-bg); color: var(--text-primary); padding: 2px 4px; border-radius: 3px; transition: background-color 0.3s ease, color 0.3s ease;}
        .ai-message pre code { background-color: transparent; padding: 0; }
        .ai-message.thinking { background-color: transparent; color: var(--text-secondary); font-style: italic; }
        .error-message { background-color: var(--error-bg); color: var(--error-text); border: 1px solid var(--error-border); align-self: flex-start; transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;}
        .info-message { text-align: center; color: var(--text-secondary); padding: 50px 20px; font-style: italic; }
        .message mjx-container { color: inherit !important; font-size: inherit !important; }

        /* --- Input Area Elements (рооро╛ро▒рпНро▒рооро┐ро▓рпНро▓рпИ) --- */
        .suggestions { display: none; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .suggestion-chip { background-color: var(--button-bg); border: 1px solid var(--border-color); color: var(--text-secondary); border-radius: 16px; padding: 8px 15px; font-size: 0.9em; cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease; }
        .suggestion-chip:hover { background-color: var(--button-hover-bg); color: var(--text-primary); }
        .input-box { display: flex; align-items: flex-end; background-color: var(--main-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 5px 5px 5px 15px; position: relative; transition: background-color 0.3s ease, border-color 0.3s ease; }
        .input-box:focus-within { border-color: var(--accent-color); }
        #user-input { flex-grow: 1; border: none; outline: none; padding: 10px 5px; font-size: 1rem; background-color: transparent; resize: none; min-height: 48px; max-height: 250px; line-height: 1.5; color: var(--text-primary); font-family: var(--font-family); }
        #user-input::placeholder { color: var(--text-placeholder); }
        .mcq-mode-control { display: flex; align-items: center; margin-left: 10px; padding-bottom: 8px; flex-shrink: 0; }
        .mcq-mode-control input[type="checkbox"] { margin-right: 5px; accent-color: var(--accent-color); cursor: pointer;}
        .mcq-mode-control label { font-size: 0.85em; color: var(--text-secondary); cursor: pointer; user-select: none;}
        #send-button { background-color: var(--send-button-bg); color: var(--send-button-text); border: none; border-radius: 8px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-left: 10px; transition: background-color 0.2s ease; padding: 0; flex-shrink: 0; }
        #send-button:hover:not(:disabled) { background-color: var(--send-button-hover-bg); }
        #send-button:disabled { background-color: #cccccc; cursor: not-allowed; opacity: 0.6; }
        #send-button svg { width: 20px; height: 20px; fill: currentColor; }
        .thinking::after { content: ' .'; animation: dots 1s steps(3, end) infinite; display: inline-block; }
        @keyframes dots { 0%, 20% { content: ' .'; } 40% { content: ' ..'; } 60%, 100% { content: ' ...'; } }
         .start-test-button { background-color: var(--accent-color); color: var(--send-button-text); border: none; border-radius: 6px; padding: 8px 15px; margin-top: 10px; cursor: pointer; font-weight: 500; display: inline-block; transition: background-color 0.2s ease; }
         .start-test-button:hover { background-color: var(--send-button-hover-bg); }

        /* --- Mock Test View Styles (рооро╛ро▒рпНро▒рооро┐ро▓рпНро▓рпИ) --- */
        .mock-test-view { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--main-bg); z-index: 100; flex-direction: column; padding: 20px; box-sizing: border-box; transition: background-color 0.3s ease; }
        .mock-test-view.active { display: flex; }
        .test-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .test-header h2 { margin: 0; font-size: 1.3em; color: var(--text-primary); }
        .test-info span { margin-left: 15px; font-size: 0.95em; color: var(--text-secondary); }
        .test-content { flex-grow: 1; overflow-y: auto; padding: 10px 20px; }
        .test-question-container { margin-bottom: 25px; }
        .test-question-number { font-weight: bold; margin-bottom: 8px; color: var(--text-secondary); }
        .test-question { font-size: 1.1em; line-height: 1.5; margin-bottom: 15px; color: var(--text-primary); }
        .test-options label { display: block; margin-bottom: 12px; background-color: var(--button-bg); padding: 12px 15px; border-radius: 6px; border: 1px solid var(--border-color); cursor: pointer; transition: background-color 0.2s ease, border-color 0.2s ease; color: var(--text-primary); }
        .test-options label:hover { background-color: var(--button-hover-bg); }
        .test-options input[type="radio"] { margin-right: 10px; accent-color: var(--accent-color); cursor: pointer;}
        .test-navigation { display: flex; justify-content: space-between; padding-top: 15px; border-top: 1px solid var(--border-color); margin-top: auto; flex-shrink: 0; }
        .test-navigation button { background-color: var(--button-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; padding: 10px 20px; cursor: pointer; font-size: 0.95em; transition: background-color 0.2s ease; }
        .test-navigation button:hover:not(:disabled) { background-color: var(--button-hover-bg); }
        .test-navigation button#submit-test-btn { background-color: var(--accent-color); color: var(--send-button-text); border-color: var(--accent-color); }
        .test-navigation button#submit-test-btn:hover:not(:disabled) { background-color: var(--send-button-hover-bg); }
        .test-navigation button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* --- Review View Styles (рооро╛ро▒рпНро▒рооро┐ро▓рпНро▓рпИ) --- */
        .review-view { padding: 20px; box-sizing: border-box; background-color: var(--main-bg); }
        .review-header { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .review-header h2 { margin: 0 0 10px 0; font-size: 1.3em; color: var(--text-primary); }
        .review-summary span { margin-right: 20px; font-size: 1em; color: var(--text-primary); }
        .review-summary .score-correct { color: #28a745; font-weight: bold;} .review-summary .score-incorrect { color: #dc3545; font-weight: bold;} .review-summary .score-skipped { color: #fd7e14; font-weight: bold;}
        .review-filters { margin-bottom: 15px; }
        .review-filters button { background-color: var(--button-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; padding: 5px 12px; margin-right: 8px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s ease, border-color 0.2s ease; }
        .review-filters button:hover { background-color: var(--button-hover-bg); }
        .review-filters button.active-filter { background-color: var(--accent-color); color: var(--send-button-text); border-color: var(--accent-color);}
        .review-content { flex-grow: 1; overflow-y: auto; padding-right: 10px; }
        .review-item { margin-bottom: 15px; padding: 15px; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--button-bg); transition: background-color 0.3s ease, border-color 0.3s ease; }
        .review-item.hidden-by-filter { display: none; }
        .review-item-qnum { font-weight: bold; margin-bottom: 8px; color: var(--text-secondary); }
        .review-item-question { margin-bottom: 10px; line-height: 1.5; color: var(--text-primary); }
        .review-item-details span { display: block; margin-bottom: 5px; font-size: 0.95em; color: var(--text-primary); }
        .review-item-details .correct-answer { color: #28a745; font-weight: bold; }
        .review-item-details .user-answer-correct { color: #28a745; } .review-item-details .user-answer-incorrect { color: #dc3545; text-decoration: line-through; } .review-item-details .user-answer-skipped { color: #fd7e14; font-style: italic; }
        .review-footer { text-align: center; padding-top: 20px; border-top: 1px solid var(--border-color); margin-top: auto; flex-shrink: 0; display: flex; justify-content: center; gap: 15px; }
        #exit-review-btn, #save-review-btn { background-color: var(--accent-color); color: var(--send-button-text); border: none; border-radius: 6px; padding: 10px 25px; cursor: pointer; font-size: 1em; transition: background-color 0.2s ease; }
        #exit-review-btn:hover, #save-review-btn:hover:not(:disabled) { background-color: var(--send-button-hover-bg); }
        #save-review-btn { background-color: var(--button-bg); color: var(--text-primary); border: 1px solid var(--border-color); }
        #save-review-btn:hover:not(:disabled) { background-color: var(--button-hover-bg); }
        #save-review-btn:disabled { opacity: 0.6; cursor: not-allowed; background-color: #cccccc; border-color: #aaaaaa; }

    </style>
</head>
<body>

    <!-- App Container (Sidebar + Chat/Review) -->
    <div class="app-container" id="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">Gemini Chat</div>
            <button class="start-chat-button" id="start-chat" disabled>
                 <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg>
                 рокрпБродро┐роп роЙро░рпИропро╛роЯро▓рпН
            </button>
            <div class="sidebar-section-title">роЙро░рпИропро╛роЯро▓рпНроХро│рпН</div>
            <div class="chat-list" id="chat-list">
                 <div style="padding:10px;color:var(--text-secondary);font-size:0.9em;">роЙро░рпИропро╛роЯро▓рпНроХро│рпИрокрпН рокро╛ро░рпНроХрпНроХ роЙро│рпНроирпБро┤рпИропро╡рпБроорпН.</div>
            </div>
            <div class="sidebar-footer">
                <div class="sidebar-controls">
                     <div class="text-size-controls">
                         <span>роОро┤рпБродрпНродрпБ роЕро│ро╡рпБ</span>
                         <div class="text-size-buttons">
                             <button id="decrease-text-size" title="роОро┤рпБродрпНродрпБ роЕро│ро╡рпИроХрпН роХрпБро▒рпИроХрпНроХро╡рпБроорпН" disabled>-</button>
                             <button id="increase-text-size" title="роОро┤рпБродрпНродрпБ роЕро│ро╡рпИ роЕродро┐роХро░ро┐роХрпНроХро╡рпБроорпН" disabled>+</button>
                         </div>
                     </div>
                     <div class="theme-toggle">
                         <button id="theme-toggle-button" title="Toggle Theme" disabled>тШАя╕П</button>
                     </div>
                </div>
                 <div id="auth-controls">
                     <button id="login-google-btn">Google роорпВро▓роорпН роЙро│рпНроирпБро┤рпИроХ</button>
                     <button id="logout-btn" style="display: none;">ро╡рпЖро│ро┐ропрпЗро▒рпБ</button>
                 </div>
                 <div class="account-info">
                     <div class="account-avatar" id="account-avatar">?</div>
                     <div class="account-details">
                         <div class="account-email" id="account-email">роЙро│рпНроирпБро┤рпИропро╡ро┐ро▓рпНро▓рпИ</div>
                         <div class="account-plan" id="account-plan"></div>
                     </div>
                 </div>
            </div>
        </div>

        <!-- Main Area Container (Chat / Review) -->
        <div class="main-container">
            <!-- Chat View -->
            <div class="main-content active" id="main-content-chat">
                 <div class="chat-area" id="chat-area">
                     <!-- Greeting роЕро▓рпНро▓родрпБ Login Prompt роЗроЩрпНроХрпБ JS роорпВро▓роорпН роХро╛рогрпНрокро┐роХрпНроХрокрпНрокроЯрпБроорпН -->
                 </div>
                 <div class="input-container" id="input-container">
                     <div class="suggestions" id="suggestions">
                          <button class="suggestion-chip" data-prompt="5 questions about US History">5 Qs US History (Check MCQ)</button>
                          <button class="suggestion-chip" data-prompt="What is recursion?">Recursion?</button>
                          <button class="suggestion-chip" data-prompt="Explain $\lim_{x\to 0} \frac{\sin x}{x} = 1$">Limit sin(x)/x ?</button>
                     </div>
                    <div class="input-box">
                        <textarea id="user-input" placeholder="роХрпЗро│рпНро╡ро┐ропрпИ роЙро│рпНро│ро┐роЯро╡рпБроорпН ('MCQs?' роОройрпНрокродрпИ родрпЗро░рпНро╡рпБроЪрпЖропрпНродро╛ро▓рпН родрпЗро░рпНро╡рпБ роЙро░рпБро╡ро╛роХрпНроХрокрпНрокроЯрпБроорпН)" rows="1"></textarea>
                        <div class="mcq-mode-control"> <input type="checkbox" id="mcq-mode-checkbox" title="роЙроЩрпНроХро│рпН роХрпЗро│рпНро╡ро┐ роЕроЯро┐рокрпНрокроЯрпИропро┐ро▓рпН MCQ роХро│рпИ роЙро░рпБро╡ро╛роХрпНроХ роЗродрпИродрпН родрпЗро░рпНро╡рпБроЪрпЖропрпНроХ"> <label for="mcq-mode-checkbox">MCQs?</label> </div>
                        <button id="send-button" title="роЕройрпБрокрпНрокрпБ" disabled>
                            <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
                        </button>
                    </div>
                </div>
            </div>
            <!-- Review View -->
             <div class="review-view" id="review-view">
                 <div class="review-header">
                     <h2>родрпЗро░рпНро╡рпБ рооро▒рпБрокро╛ро░рпНро╡рпИ</h2>
                     <div class="review-summary" id="review-summary"></div>
                     <div class="review-filters" id="review-filters">
                         <button data-filter="all" class="active-filter">роЕройрпИродрпНродрпБроорпН</button>
                         <button data-filter="incorrect">родро╡ро▒ро╛ройро╡рпИ</button>
                         <button data-filter="skipped">родро╡ро┐ро░рпНроХрпНроХрокрпНрокроЯрпНроЯро╡рпИ</button>
                     </div>
                 </div>
                 <div class="review-content" id="review-content"></div>
                 <div class="review-footer">
                     <button id="save-review-btn">рооро▒рпБрокро╛ро░рпНро╡рпИропрпИ роЪрпЗрооро┐</button>
                     <button id="exit-review-btn">Chat-роХрпНроХрпБ родро┐ро░рпБроорпНрокрпБроХ</button>
                 </div>
             </div>
        </div>
    </div>

    <!-- Mock Test View (Fullscreen Overlay) -->
    <div class="mock-test-view" id="mock-test-view">
        <div class="test-header"> <h2 id="test-title">рооро╛родро┐ро░ро┐родрпН родрпЗро░рпНро╡рпБ</h2> <div class="test-info"> <span id="question-counter">роХрпЗро│рпНро╡ро┐: 1 / N</span> <span id="test-timer">роирпЗро░роорпН: 00:00</span> </div> </div>
        <div class="test-content"> <div class="test-question-container"> <div class="test-question-number" id="test-question-number"></div> <div class="test-question" id="test-question"></div> <div class="test-options" id="test-options"></div> </div> </div>
        <div class="test-navigation"> <button id="prev-question-btn" disabled>роорпБроирпНродрпИропродрпБ</button> <button id="next-question-btn">роЕроЯрпБродрпНродродрпБ</button> <button id="submit-test-btn">родрпЗро░рпНро╡рпИроЪрпН роЪрооро░рпНрокрпНрокро┐</button> </div>
    </div>


    <script>
        // --- Firebase Config ---
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        // !!! рокро╛родрпБроХро╛рокрпНрокрпБ роОроЪрпНроЪро░ро┐роХрпНроХрпИ / SECURITY WARNING !!!
        // роЗроирпНрод firebaseConfig ро╡ро┐ро╡ро░роЩрпНроХро│рпН рокро╛родрпБроХро╛рокрпНрокро▒рпНро▒родрпБ. роЪрпЛродро┐родрпНрод рокро┐ро▒роХрпБ,
        // Firebase Console-ро▓рпН роЗроирпНрод API Key-роР роХроЯрпНроЯрпБрокрпНрокроЯрпБродрпНродро┐ро╡ро┐роЯрпНроЯрпБ, рокрпБродро┐роп key-роР рокропройрпНрокроЯрпБродрпНродро╡рпБроорпН.
        // This firebaseConfig is insecure. Restrict/delete the API key in Firebase Console after testing.
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        const firebaseConfig = {
          apiKey: "AIzaSyDgw604fe5jnNu4kTOv1cQ-3n7PL8gcN58", // <- рокроХро┐ро░рокрпНрокроЯрпНроЯ, рокро╛родрпБроХро╛рокрпНрокро▒рпНро▒ Key / SHARED, INSECURE KEY
          authDomain: "krish-c5db8.firebaseapp.com",
          projectId: "krish-c5db8",
          storageBucket: "krish-c5db8.appspot.com",
          messagingSenderId: "217175257890",
          appId: "1:217175257890:web:209f0f290eabab6b1fab7b",
          measurementId: "G-97SHYGL2J4"
        };

        // --- Initialize Firebase ---
        firebase.initializeApp(firebaseConfig);
        const fbAuth = firebase.auth(); // Firebase Authentication
        const db = firebase.firestore(); // Firebase Firestore

        // --- DOM Elements ---
        const appContainer = document.getElementById('app-container');
        const chatArea = document.getElementById('chat-area');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const suggestionsContainer = document.getElementById('suggestions');
        const startChatButton = document.getElementById('start-chat');
        const chatListContainer = document.getElementById('chat-list');
        const accountEmail = document.getElementById('account-email');
        const accountAvatar = document.getElementById('account-avatar');
        const accountPlan = document.getElementById('account-plan');
        const decreaseTextBtn = document.getElementById('decrease-text-size');
        const increaseTextBtn = document.getElementById('increase-text-size');
        const themeToggleButton = document.getElementById('theme-toggle-button');
        const mainContainer = document.querySelector('.main-container');
        const chatView = document.getElementById('main-content-chat');
        const testView = document.getElementById('mock-test-view');
        const reviewView = document.getElementById('review-view');
        const inputContainer = document.getElementById('input-container');
        const mcqModeCheckbox = document.getElementById('mcq-mode-checkbox');
        const loginBtn = document.getElementById('login-google-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const testTitle = document.getElementById('test-title');
        const questionCounter = document.getElementById('question-counter');
        const testTimer = document.getElementById('test-timer');
        const testQuestionNumber = document.getElementById('test-question-number');
        const testQuestion = document.getElementById('test-question');
        const testOptionsContainer = document.getElementById('test-options');
        const prevQuestionBtn = document.getElementById('prev-question-btn');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const submitTestBtn = document.getElementById('submit-test-btn');
        const reviewSummary = document.getElementById('review-summary');
        const reviewContent = document.getElementById('review-content');
        const exitReviewBtn = document.getElementById('exit-review-btn');
        const reviewFilters = document.getElementById('review-filters');
        const saveReviewBtn = document.getElementById('save-review-btn');

        // --- Config & Constants ---
        const MODEL_NAME="gemini-1.5-flash-latest";
        const API_URL_BASE=`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=`;
        const STORAGE_KEY_API_KEY='geminiApiKey';
        const NEW_CHAT_TITLE="(рокрпБродро┐роп роЙро░рпИропро╛роЯро▓рпН)"; // родрооро┐ро┤ро┐ро▓рпН рооро╛ро▒рпНро▒рокрпНрокроЯрпНроЯродрпБ
        const TEXT_SIZE_STEP=0.1;
        const MIN_TEXT_SIZE_MULTIPLIER=0.7;
        const MAX_TEXT_SIZE_MULTIPLIER=1.5;
        const LIGHT_THEME_ICON='тШАя╕П';
        const DARK_THEME_ICON='ЁЯМЩ';
        const DELETE_ICON = '├Ч'; // Delete рокрпКродрпНродро╛ройрпБроХрпНроХро╛рой роРроХро╛ройрпН

        // --- State Variables ---
        let API_KEY='';
        let currentUser = null;
        let activeChatId = null;
        let currentChatHistory=[];
        let currentTextSizeMultiplier=1.0;
        let currentTheme='light';
        let isTestMode=false;
        let isReviewMode=false;
        let currentTestMCQs=[];
        let currentQuestionIndex=0;
        let userAnswers=[];
        let testStartTime=null;
        let testTimerInterval=null;
        let generatedMCQData=null;
        let reviewResultsCache = null;
        let activeChatListener = null;
        let chatListListener = null;
        let isDeletingChat = false; // Delete роЪрпЖропрпНропрпБроорпНрокрпЛродрпБ UI родро╛ро╡рпБро╡родрпИродрпН родроЯрпБроХрпНроХ

        // --- Initialization ---
        initializeApp();

        // --- Event Listeners ---
        sendButton.addEventListener('click', handleSendMessage);
        userInput.addEventListener('input', autoGrowTextarea);
        userInput.addEventListener('keydown', handleInputKeydown);
        suggestionsContainer.addEventListener('click', handleSuggestionClick);
        startChatButton.addEventListener('click', createNewChat);
        chatListContainer.addEventListener('click', handleChatListClick); // Delete роХрпИропро╛ро│рпБродро▓рпН роЪрпЗро░рпНроХрпНроХрокрпНрокроЯрпНроЯродрпБ
        decreaseTextBtn.addEventListener('click', () => adjustTextSize(-TEXT_SIZE_STEP));
        increaseTextBtn.addEventListener('click', () => adjustTextSize(TEXT_SIZE_STEP));
        themeToggleButton.addEventListener('click', toggleTheme);
        prevQuestionBtn.addEventListener('click', () => handleTestNavigation('prev'));
        nextQuestionBtn.addEventListener('click', () => handleTestNavigation('next'));
        submitTestBtn.addEventListener('click', submitTest);
        exitReviewBtn.addEventListener('click', exitReview);
        chatArea.addEventListener('click', handleChatAreaClick);
        reviewFilters.addEventListener('click', handleReviewFilterClick);
        saveReviewBtn.addEventListener('click', saveTestReviewToCloud);
        loginBtn.addEventListener('click', signInWithGoogle);
        logoutBtn.addEventListener('click', signOut);


        // --- Initialization Functions ---
        async function initializeApp() {
            loadGeminiApiKey();
            fbAuth.onAuthStateChanged(handleAuthStateChange); // Auth рооро╛ро▒рпНро▒роЩрпНроХро│рпИроХрпН роХро╡ройро┐родрпНродро▓рпН
            switchView('chat');
            userInput.focus();
        }

        function loadGeminiApiKey() {
             console.warn("рокро╛родрпБроХро╛рокрпНрокрпБ роОроЪрпНроЪро░ро┐роХрпНроХрпИ: Gemini API Key localStorage-ро▓рпН роЪрпЗрооро┐роХрпНроХрокрпНрокроЯрпБроХро┐ро▒родрпБ. роЗродрпБ рокро╛родрпБроХро╛рокрпНрокро▒рпНро▒родрпБ. Cloud Function-роХрпНроХрпБ рооро╛ро▒рпНро▒ро╡рпБроорпН.");
             // console.warn("SECURITY WARNING: Gemini API Key is stored in localStorage. This is insecure. Migrate to Cloud Function.");
            const k=localStorage.getItem(STORAGE_KEY_API_KEY);
            if(k){ API_KEY=k; }
            else { API_KEY=prompt("--- рокро╛родрпБроХро╛рокрпНрокро▒рпНро▒ роЯрпЖроорпЛ ---\nроЙроЩрпНроХро│рпН Gemini API Key-роР роЙро│рпНро│ро┐роЯро╡рпБроорпН (роЗродрпБ local storage-роЗро▓рпН роЪрпЗрооро┐роХрпНроХрокрпНрокроЯрпБроорпН - рокро╛родрпБроХро╛рокрпНрокро┐ро▒рпНроХрпБ Cloud Function родрпЗро╡рпИ):");
                 if(API_KEY){ localStorage.setItem(STORAGE_KEY_API_KEY, API_KEY); }
                 else { displayError("Gemini API Key родрпЗро╡рпИ. роорпАрогрпНроЯрпБроорпН роПро▒рпНро▒ро╡рпБроорпН."); setLoadingState(true, "API Key роЗро▓рпНро▓рпИ"); }
            }
             setLoadingState(false);
        }

        // --- Authentication Functions ---

        async function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                setLoadingState(true, "роЙро│рпНроирпБро┤рпИроХро┐ро▒родрпБ...");
                await fbAuth.signInWithPopup(provider);
            } catch (error) {
                console.error("Google роЙро│рпНроирпБро┤рпИро╡рпБ рокро┐ро┤рпИ:", error);
                displayError(`роЙро│рпНроирпБро┤рпИро╡рпБ родрпЛро▓рпНро╡ро┐: ${error.message}`);
                setLoadingState(false);
            }
        }

        async function signOut() {
            try {
                setLoadingState(true, "ро╡рпЖро│ро┐ропрпЗро▒рпБроХро┐ро▒родрпБ...");
                await fbAuth.signOut();
            } catch (error) {
                console.error("ро╡рпЖро│ро┐ропрпЗро▒рпБро╡родро┐ро▓рпН рокро┐ро┤рпИ:", error);
                displayError(`ро╡рпЖро│ро┐ропрпЗро▒рпБродро▓рпН родрпЛро▓рпНро╡ро┐: ${error.message}`);
                setLoadingState(false);
            }
        }

        function handleAuthStateChange(user) {
            // роорпБроирпНродрпИроп Firestore listeners-роХро│рпИ роирпАроХрпНроХрпБродро▓рпН
            if (activeChatListener) { activeChatListener(); activeChatListener = null; }
            if (chatListListener) { chatListListener(); chatListListener = null; }

            chatArea.innerHTML = '';
            chatListContainer.innerHTML = '';
            activeChatId = null;
            currentChatHistory = [];

            if (user) { // рокропройро░рпН роЙро│рпНроирпБро┤рпИроирпНродрпБро│рпНро│ро╛ро░рпН
                currentUser = user;
                console.log("рокропройро░рпН роЙро│рпНроирпБро┤рпИроирпНродрпБро│рпНро│ро╛ро░рпН:", currentUser.uid, currentUser.displayName || currentUser.email);
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'inline-block';
                accountEmail.textContent = currentUser.email || currentUser.displayName || `рокропройро░рпН`;
                accountAvatar.textContent = (currentUser.displayName || currentUser.email || 'U')[0].toUpperCase();
                accountPlan.textContent = "Firebase рокропройро░рпН";
                startChatButton.disabled = false;
                decreaseTextBtn.disabled = false;
                increaseTextBtn.disabled = false;
                themeToggleButton.disabled = false;
                sendButton.disabled = false;
                userInput.disabled = false;
                userInput.placeholder = "роХрпЗро│рпНро╡ро┐ропрпИ роЙро│рпНро│ро┐роЯро╡рпБроорпН...";
                inputContainer.style.display = 'block';
                suggestionsContainer.style.display = 'flex';

                loadUserSettings(currentUser.uid);
                loadAndListenForChats(currentUser.uid); // рокропройро░рпН chat-роХро│рпИроХрпН роХро╡ройро┐родрпНродро▓рпН

            } else { // рокропройро░рпН ро╡рпЖро│ро┐ропрпЗро▒ро┐ро╡ро┐роЯрпНроЯро╛ро░рпН
                currentUser = null;
                console.log("рокропройро░рпН ро╡рпЖро│ро┐ропрпЗро▒ро┐ро╡ро┐роЯрпНроЯро╛ро░рпН");
                loginBtn.style.display = 'inline-block';
                logoutBtn.style.display = 'none';
                accountEmail.textContent = "роЙро│рпНроирпБро┤рпИропро╡ро┐ро▓рпНро▓рпИ";
                accountAvatar.textContent = '?';
                accountPlan.textContent = "";
                startChatButton.disabled = true;
                decreaseTextBtn.disabled = true;
                increaseTextBtn.disabled = true;
                themeToggleButton.disabled = true;
                sendButton.disabled = true;
                userInput.disabled = true;
                userInput.placeholder = "родропро╡рпБроЪрпЖропрпНродрпБ роЙро│рпНроирпБро┤рпИропро╡рпБроорпН";
                inputContainer.style.display = 'none';
                suggestionsContainer.style.display = 'none';

                renderGreetingOrLoginPrompt();
                chatListContainer.innerHTML = '<div style="padding:10px;color:var(--text-secondary);font-size:0.9em;">роЙро░рпИропро╛роЯро▓рпНроХро│рпИрокрпН рокро╛ро░рпНроХрпНроХ роЙро│рпНроирпБро┤рпИропро╡рпБроорпН.</div>';

                currentTheme = 'light'; applyTheme();
                currentTextSizeMultiplier = 1.0; applyTextSize();
            }
            setLoadingState(false); // роЗро▒рпБродро┐ роиро┐ро▓рпИропрпИ роЙро▒рпБродро┐роЪрпЖропрпНродро▓рпН
        }


        function renderGreetingOrLoginPrompt() {
            chatArea.innerHTML = '';
            const g = document.createElement('div');
            g.classList.add('greeting');
            if (currentUser) {
                 g.innerHTML = `<span class="asterisk">*</span>ро╡рогроХрпНроХроорпН, ${currentUser.displayName || 'рокропройро░рпН'}!`;
                 chatArea.appendChild(g);
                 if (!activeChatId) {
                    displayMessage("роТро░рпБ роЙро░рпИропро╛роЯро▓рпИродрпН родрпЗро░рпНроирпНродрпЖроЯрпБроХрпНроХро╡рпБроорпН роЕро▓рпНро▓родрпБ рокрпБродро┐ропродро╛роХродрпН родрпКроЯроЩрпНроХро╡рпБроорпН.", 'ai');
                 }
            } else {
                g.innerHTML = `<span class="asterisk">*</span>ро╡ро░рпБроХ!`;
                chatArea.appendChild(g);
                displayMessage("роЙро░рпИропро╛роЯро▓рпИродрпН родрпКроЯроЩрпНроХ роЕро▓рпНро▓родрпБ роЙроЩрпНроХро│рпН ро╡ро░ро▓ро╛ро▒рпНро▒рпИроХрпН роХро╛рог sidebar-роЗро▓рпН роЙро│рпНро│ Google рокрпКродрпНродро╛ройрпИрокрпН рокропройрпНрокроЯрпБродрпНродро┐ роЙро│рпНроирпБро┤рпИропро╡рпБроорпН.", 'ai');
            }
            scrollToBottom(true);
        }


        // --- Settings (Theme/Text Size) Functions (рооро╛ро▒рпНро▒рооро┐ро▓рпНро▓рпИ) ---
        async function loadUserSettings(userId) { /* ... */
            const userDocRef = db.collection('users').doc(userId);
            try {
                const docSnap = await userDocRef.get();
                if (docSnap.exists) {
                    const settings = docSnap.data();
                    currentTheme = settings.theme || 'light';
                    currentTextSizeMultiplier = settings.textSizeMultiplier || 1.0;
                } else {
                    currentTheme = 'light';
                    currentTextSizeMultiplier = 1.0;
                    await saveUserSettings();
                }
            } catch (error) {
                console.error("рокропройро░рпН роЕроорпИрокрпНрокрпБроХро│рпИ роПро▒рпНро▒рпБро╡родро┐ро▓рпН рокро┐ро┤рпИ:", error);
                currentTheme = 'light'; currentTextSizeMultiplier = 1.0;
            }
            applyTheme(); applyTextSize();
         }
        async function saveUserSettings() { /* ... */
            if (!currentUser) return;
            const userDocRef = db.collection('users').doc(currentUser.uid);
            const settings = { theme: currentTheme, textSizeMultiplier: currentTextSizeMultiplier };
            try { await userDocRef.set(settings, { merge: true }); }
            catch (error) { console.error("рокропройро░рпН роЕроорпИрокрпНрокрпБроХро│рпИроЪрпН роЪрпЗрооро┐рокрпНрокродро┐ро▓рпН рокро┐ро┤рпИ:", error); }
         }
        function applyTheme() { /* ... */
            if(currentTheme==='dark'){ document.body.classList.add('dark-theme'); themeToggleButton.textContent=LIGHT_THEME_ICON; themeToggleButton.title="Light Mode"; }
            else { document.body.classList.remove('dark-theme'); themeToggleButton.textContent=DARK_THEME_ICON; themeToggleButton.title="Dark Mode"; }
         }
        function toggleTheme() { if (!currentUser) return; currentTheme = (currentTheme === 'light') ? 'dark' : 'light'; applyTheme(); saveUserSettings(); }
        function applyTextSize() { /* ... */
            const newSize = `calc(var(--message-font-size-base) * ${currentTextSizeMultiplier})`;
            document.documentElement.style.setProperty('--message-font-size', newSize);
         }
        function adjustTextSize(change) { /* ... */
            if (!currentUser) return;
            let newMultiplier = Math.max(MIN_TEXT_SIZE_MULTIPLIER, Math.min(MAX_TEXT_SIZE_MULTIPLIER, currentTextSizeMultiplier + change));
            newMultiplier = Math.round(newMultiplier * 10) / 10;
            if (newMultiplier !== currentTextSizeMultiplier) { currentTextSizeMultiplier = newMultiplier; applyTextSize(); saveUserSettings(); }
         }

        // --- Chat Storage & Loading (Firestore) ---

        // рокропройро░рпН chat-роХро│ро┐ройрпН рокроЯрпНроЯро┐ропро▓рпИроХрпН роХро╡ройро┐родрпНродрпБ sidebar-роРрокрпН рокрпБродрпБрокрпНрокро┐родрпНродро▓рпН
        function loadAndListenForChats(userId) {
            if (chatListListener) { chatListListener(); chatListListener = null; }

            const chatsRef = db.collection('chats')
                               .where('userId', '==', userId)
                               .orderBy('lastUpdated', 'desc'); // роЪроорпАрокродрпНродро┐ропродрпБ роорпБродро▓ро┐ро▓рпН

            console.log(`${userId} рокропройро░рпБроХрпНроХро╛рой chat-роХро│рпИроХрпН роХро╡ройро┐роХрпНроХро┐ро▒родрпБ`);
            chatListListener = chatsRef.onSnapshot(snapshot => {
                 if (isDeletingChat) {
                      console.log("Delete роЪрпЖропрпНропрпБроорпНрокрпЛродрпБ chat list update родро╡ро┐ро░рпНроХрпНроХрокрпНрокроЯрпНроЯродрпБ.");
                      return; // Delete роироЯроХрпНроХрпБроорпНрокрпЛродрпБ snapshot-роР process роЪрпЖропрпНроп ро╡рпЗрогрпНроЯро╛роорпН
                 }
                const chats = [];
                snapshot.forEach(doc => { chats.push({ id: doc.id, ...doc.data() }); });
                console.log("Chat list snapshot роХро┐роЯрпИродрпНродродрпБ:", chats);
                renderSidebarChatList(chats); // Sidebar-роР delete рокрпКродрпНродро╛ройрпНроХро│рпБроЯройрпН роХро╛роЯрпНроЯрпБ

                let chatToLoad = null;
                if (activeChatId && chats.some(c => c.id === activeChatId)) {
                     chatToLoad = activeChatId; // родро▒рпНрокрпЛродрпИроп chat роЗро░рпБроирпНродро╛ро▓рпН роЕродрпИропрпЗ ро╡рпИродрпНродро┐ро░рпБ
                } else if (chats.length > 0) {
                     // роЗро▓рпНро▓рпИропрпЖройро┐ро▓рпН, роЕро▓рпНро▓родрпБ active chat роирпАроХрпНроХрокрпНрокроЯрпНроЯро┐ро░рпБроирпНродро╛ро▓рпН, рокрпБродро┐ропродрпИ load роЪрпЖропрпН
                    chatToLoad = chats[0].id;
                    console.log("Active chat роЗро▓рпНро▓рпИ/роирпАроХрпНроХрокрпНрокроЯрпНроЯродрпБ, рокрпБродро┐ропродрпБ родрпЗро░рпНроирпНродрпЖроЯрпБроХрпНроХрокрпНрокроЯрпНроЯродрпБ:", chatToLoad);
                } else {
                    // роОроирпНрод chat-роорпН роЗро▓рпНро▓рпИ
                    console.log("рокропройро░рпБроХрпНроХрпБ chat-роХро│рпН роЗро▓рпНро▓рпИ.");
                    activeChatId = null;
                    if (activeChatListener) { activeChatListener(); activeChatListener = null; }
                    renderGreetingOrLoginPrompt(); // роХро╛ро▓ро┐ропро╛рой роиро┐ро▓рпИроХрпНроХрпБ prompt роХро╛роЯрпНроЯрпБ
                }

                if (chatToLoad && chatToLoad !== activeChatId) {
                     console.log("Chat рооро╛ро▒рпБроХро┐ро▒родрпБ:", chatToLoad);
                     switchChat(chatToLoad); // Chat-роР рооро╛ро▒рпНро▒ро┐ load роЪрпЖропрпН
                } else if (activeChatId) {
                     highlightActiveChatInSidebar(); // рооро╛ро▒ро╡ро┐ро▓рпНро▓рпИ роОройрпНро▒ро╛ро▓рпН highlight роороЯрпНроЯрпБроорпН роЪрпЖропрпН
                }

            }, error => {
                console.error("Chat list-роРроХрпН роХро╡ройро┐рокрпНрокродро┐ро▓рпН рокро┐ро┤рпИ:", error);
                displayError("Chat рокроЯрпНроЯро┐ропро▓рпИ роПро▒рпНро▒ роорпБроЯро┐ропро╡ро┐ро▓рпНро▓рпИ.");
                chatListContainer.innerHTML = '<div style="padding:10px;color:var(--text-secondary);font-size:0.9em;">Chat-роХро│рпИ роПро▒рпНро▒рпБро╡родро┐ро▓рпН рокро┐ро┤рпИ.</div>';
            });
        }

        // Sidebar-роЗро▓рпН chat рокроЯрпНроЯро┐ропро▓рпИ delete рокрпКродрпНродро╛ройрпНроХро│рпБроЯройрпН роХро╛роЯрпНроЯрпБродро▓рпН
        function renderSidebarChatList(chats) {
            chatListContainer.innerHTML = '';
            if (!currentUser) { /* ... роЙро│рпНроирпБро┤рпИропро╡ро┐ро▓рпНро▓рпИ роОройрпНро▒ро╛ро▓рпН ... */ return; }
            if (chats.length === 0) {
                const i = document.createElement('div'); i.textContent = "роЗройрпНройрпБроорпН роЙро░рпИропро╛роЯро▓рпНроХро│рпН роЗро▓рпНро▓рпИ."; /* ... */ chatListContainer.appendChild(i);
            } else {
                chats.forEach(c => {
                    const i = document.createElement('div'); i.classList.add('chat-list-item');
                    let title = c.title || '(рокрпЖропро░ро┐роЯрокрпНрокроЯро╛родродрпБ)';
                    if (typeof title !== 'string') title = '(родро╡ро▒ро╛рой родро▓рпИрокрпНрокрпБ)';
                    i.textContent = title; i.dataset.id = c.id; i.title = title;

                    // --- Delete рокрпКродрпНродро╛ройрпИроЪрпН роЪрпЗро░рпНродрпНродро▓рпН ---
                    const deleteBtn = document.createElement('button');
                    deleteBtn.classList.add('delete-chat-button');
                    deleteBtn.innerHTML = DELETE_ICON; // '├Ч'
                    deleteBtn.title = "роЙро░рпИропро╛роЯро▓рпИ роирпАроХрпНроХрпБ";
                    deleteBtn.dataset.id = c.id; // рокрпКродрпНродро╛ройро┐ро▓рпБроорпН ID-роР роЪрпЗрооро┐
                    i.appendChild(deleteBtn);
                    // --- Delete рокрпКродрпНродро╛ройрпН роорпБроЯро┐ро╡рпБ ---

                    chatListContainer.appendChild(i);
                });
            }
             highlightActiveChatInSidebar();
        }

        function highlightActiveChatInSidebar() { /* ... */
             const items = chatListContainer.querySelectorAll('.chat-list-item');
             items.forEach(item => { item.classList.toggle('active', item.dataset.id === activeChatId); });
         }

        // рокрпБродро┐роп chat-роР Firestore-роЗро▓рпН роЙро░рпБро╡ро╛роХрпНроХрпБродро▓рпН
        async function createNewChat() {
            if (!currentUser) { displayError("рокрпБродро┐роп роЙро░рпИропро╛роЯро▓рпИ роЙро░рпБро╡ро╛роХрпНроХ роЙро│рпНроирпБро┤рпИропро╡рпБроорпН."); return; }
            setLoadingState(true, "роЙро░рпИропро╛роЯро▓рпИ роЙро░рпБро╡ро╛роХрпНроХрпБроХро┐ро▒родрпБ...");
            const newChatRef = db.collection('chats').doc();
            const timestamp = firebase.firestore.FieldValue.serverTimestamp();
            try {
                await newChatRef.set({
                    userId: currentUser.uid,
                    title: NEW_CHAT_TITLE, // Default рокрпЖропро░рпБроЯройрпН родрпКроЯроЩрпНроХрпБ
                    createdAt: timestamp,
                    lastUpdated: timestamp
                });
                console.log("рокрпБродро┐роп chat document роЙро░рпБро╡ро╛роХрпНроХрокрпНрокроЯрпНроЯродрпБ:", newChatRef.id);
                // Listener роЗродрпИ роОроЯрпБродрпНродрпБроХрпНроХрпКро│рпНро│рпБроорпН
            } catch (error) {
                console.error("рокрпБродро┐роп chat роЙро░рпБро╡ро╛роХрпНроХрпБро╡родро┐ро▓рпН рокро┐ро┤рпИ:", error); displayError("Chat-роР роЙро░рпБро╡ро╛роХрпНроХ роорпБроЯро┐ропро╡ро┐ро▓рпНро▓рпИ.");
            } finally {
                setLoadingState(false); userInput.focus();
            }
        }

        // Chat list click-роРроХрпН роХрпИропро╛ро│рпБродро▓рпН (Delete роЕро▓рпНро▓родрпБ Switch)
        function handleChatListClick(event) {
             const target = event.target;

             // Delete рокрпКродрпНродро╛ройрпН click роЪрпЖропрпНропрокрпНрокроЯрпНроЯродро╛ роОрой роЪро░ро┐рокро╛ро░рпН
             if (target.classList.contains('delete-chat-button')) {
                 event.stopPropagation(); // Chat рооро╛ро▒рпБро╡родрпИродрпН родроЯрпБ
                 const chatId = target.dataset.id;
                 const chatItem = target.closest('.chat-list-item');
                 const chatTitle = chatItem?.title || 'роЗроирпНрод роЙро░рпИропро╛роЯро▓рпН'; // родро▓рпИрокрпНрокрпИрокрпН рокрпЖро▒ роорпБропро▒рпНроЪро┐
                 if (chatId) {
                      confirmAndDeleteChat(chatId, chatTitle); // роЙро▒рпБродро┐рокрпНрокроЯрпБродрпНродро▓рпН роХрпЗроЯрпНроЯрпБ роирпАроХрпНроХрпБ
                 }
                 return;
             }

             // роЗро▓рпНро▓рпИропрпЖройро┐ро▓рпН, chat рооро╛ро▒рпБродро▓рпИроХрпН роХрпИропро╛ро│рпН
            const item = target.closest('.chat-list-item');
            const clickedId = item?.dataset?.id;
            if (clickedId && clickedId !== activeChatId) {
                console.log("Chat list item click роЪрпЖропрпНропрокрпНрокроЯрпНроЯродрпБ:", clickedId);
                switchChat(clickedId);
            }
        }

        // Delete роЪрпЖропрпНро╡родро▒рпНроХро╛рой роЙро▒рпБродро┐рокрпНрокроЯрпБродрпНродро▓рпН
        function confirmAndDeleteChat(chatId, chatTitle) {
            if (!currentUser || !chatId) return;
            if (confirm(`"${chatTitle}" рооро▒рпНро▒рпБроорпН роЕродройрпН роЕройрпИродрпНродрпБ роЪрпЖропрпНродро┐роХро│рпИропрпБроорпН роиро┐ро░роирпНродро░рооро╛роХ роирпАроХрпНроХ ро╡ро┐ро░рпБроорпНрокрпБроХро┐ро▒рпАро░рпНроХро│ро╛?`)) {
                deleteChatFromFirestore(chatId);
            }
        }

        // Firestore-роЗро▓рпН роЗро░рпБроирпНродрпБ chat рооро▒рпНро▒рпБроорпН роЕродройрпН роЪрпЖропрпНродро┐роХро│рпИ роирпАроХрпНроХрпБродро▓рпН
        async function deleteChatFromFirestore(chatId) {
            if (!currentUser || !chatId) return;

            console.log(`Chat-роР роирпАроХрпНроХ роорпБропро▒рпНроЪро┐: ${chatId}`);
            // !!! роорпБроХрпНроХро┐ропроорпН: Firestore Security Rules роЕройрпБроородро┐ родрпЗро╡рпИ !!!
            // роЙроЩрпНроХро│рпН firestore.rules роХрпЛрокрпНрокро┐ро▓рпН, роЙро│рпНроирпБро┤рпИроирпНрод рокропройро░рпН родройродрпБ chat-роХро│рпИ роирпАроХрпНроХ роЕройрпБроородро┐ роЙро│рпНро│родро╛ роОрой роЪро░ро┐рокро╛ро░рпНроХрпНроХро╡рпБроорпН.
            // роО.роХро╛: allow delete: if request.auth.uid == resource.data.userId;
            // роЪрпЖропрпНродро┐роХро│рпИ роирпАроХрпНроХро╡рпБроорпН роЕройрпБроородро┐ родрпЗро╡рпИрокрпНрокроЯро▓ро╛роорпН:
            // match /chats/{chatId}/messages/{messageId} { allow delete: if get(/databases/$(database)/documents/chats/$(chatId)).data.userId == request.auth.uid; }

            isDeletingChat = true; // родро▒рпНроХро╛ро▓ро┐роХрооро╛роХ listener update-роХро│рпИ роиро┐ро▒рпБродрпНрод
            setLoadingState(true, "роЙро░рпИропро╛роЯро▓рпИ роирпАроХрпНроХрпБроХро┐ро▒родрпБ...");

            const chatDocRef = db.collection('chats').doc(chatId);
            const messagesRef = chatDocRef.collection('messages');

            try {
                // 1. Subcollection-роЗро▓рпН роЙро│рпНро│ роЕройрпИродрпНродрпБ роЪрпЖропрпНродро┐роХро│рпИропрпБроорпН роирпАроХрпНроХрпБ (batch рокропройрпНрокроЯрпБродрпНродро┐)
                const messagesSnapshot = await messagesRef.get();
                if (!messagesSnapshot.empty) {
                    const batch = db.batch();
                    messagesSnapshot.docs.forEach(doc => { batch.delete(doc.ref); });
                    await batch.commit();
                    console.log(`${messagesSnapshot.size} роЪрпЖропрпНродро┐роХро│рпН роирпАроХрпНроХрокрпНрокроЯрпНроЯрой (chat ${chatId})`);
                } else {
                    console.log(`роирпАроХрпНроХ роЪрпЖропрпНродро┐роХро│рпН роЗро▓рпНро▓рпИ (chat ${chatId})`);
                }

                // 2. Chat document-роР роирпАроХрпНроХрпБ
                await chatDocRef.delete();
                console.log(`Chat document ро╡рпЖро▒рпНро▒ро┐роХро░рооро╛роХ роирпАроХрпНроХрокрпНрокроЯрпНроЯродрпБ: ${chatId}`);

                // 3. Active chat роирпАроХрпНроХрокрпНрокроЯрпНроЯро┐ро░рпБроирпНродро╛ро▓рпН UI-роР роХрпИропро╛ро│рпБродро▓рпН
                if (activeChatId === chatId) {
                    console.log("Active chat роирпАроХрпНроХрокрпНрокроЯрпНроЯродрпБ. View роорпАроЯрпНроЯроорпИроХрпНроХрокрпНрокроЯрпБроХро┐ро▒родрпБ.");
                    activeChatId = null; currentChatHistory = [];
                    if (activeChatListener) { activeChatListener(); activeChatListener = null; }
                    chatArea.innerHTML = ''; // роЙроЯройроЯро┐ропро╛роХ chat area-ро╡рпИ роХро╛ро▓ро┐ роЪрпЖропрпН
                    renderGreetingOrLoginPrompt(); // Default prompt роХро╛роЯрпНроЯрпБ
                }
                // Listener (isDeletingChat = false роЖройродрпБроорпН) роЕроЯрпБродрпНрод chat-роРродрпН родрпЗро░рпНроирпНродрпЖроЯрпБроХрпНроХрпБроорпН (роЗро░рпБроирпНродро╛ро▓рпН).

            } catch (error) {
                console.error(`Chat ${chatId} роирпАроХрпНроХрпБро╡родро┐ро▓рпН рокро┐ро┤рпИ:`, error);
                // рокрпЖро░рпБроорпНрокро╛ро▓рпБроорпН роЗродрпБ Security Rules рокро┐ро┤рпИропро╛роХ роЗро░рпБроХрпНроХро▓ро╛роорпН
                displayError("роЙро░рпИропро╛роЯро▓рпИ роирпАроХрпНроХ роорпБроЯро┐ропро╡ро┐ро▓рпНро▓рпИ. Security Rules роЕро▓рпНро▓родрпБ рокро┐рогрпИроп роЗрогрпИрокрпНрокрпИроЪрпН роЪро░ро┐рокро╛ро░рпНроХрпНроХро╡рпБроорпН.");
            } finally {
                isDeletingChat = false; // роХрпКроЯро┐ропрпИ роирпАроХрпНроХрпБ
                setLoadingState(false); // Loading роиро┐ро▓рпИропрпИ роирпАроХрпНроХрпБ
            }
        }

        // ро╡рпЗро▒рпБ chat-роХрпНроХрпБ рооро╛ро▒рпБродро▓рпН
        function switchChat(chatId) {
             if (!currentUser || !chatId || chatId === activeChatId) return;
            console.log("Chat рооро╛ро▒рпБроХро┐ро▒родрпБ:", chatId);
            activeChatId = chatId;
            highlightActiveChatInSidebar();
            loadAndListenForActiveChat(chatId); // рокрпБродро┐роп chat роЪрпЖропрпНродро┐роХро│рпИ load роЪрпЖропрпН
            userInput.focus();
            userInput.value = ''; autoGrowTextarea(); mcqModeCheckbox.checked = false;
        }

        // Active chat-роЗройрпН роЪрпЖропрпНродро┐роХро│рпИ Firestore-роЗро▓рпН роЗро░рпБроирпНродрпБ роХро╡ройро┐родрпНродро▓рпН
        function loadAndListenForActiveChat(chatId) {
            if (!currentUser || !chatId) { /* ... */ return; }
            if (activeChatListener) { activeChatListener(); activeChatListener = null; }
            highlightActiveChatInSidebar();

            const messagesRef = db.collection('chats').doc(chatId).collection('messages').orderBy('timestamp', 'asc');
            chatArea.innerHTML = '';
            const loadingMsg = displayMessage("роЙро░рпИропро╛роЯро▓рпИ роПро▒рпНро▒рпБроХро┐ро▒родрпБ...", 'ai', ['thinking']); // родрооро┐ро┤ро┐ро▓рпН

            console.log(`Chat ${chatId} роЪрпЖропрпНродро┐роХро│рпИроХрпН роХро╡ройро┐роХрпНроХро┐ро▒родрпБ`);
            activeChatListener = messagesRef.onSnapshot(snapshot => {
                console.log(`Chat ${chatId} роЪрпЖропрпНродро┐роХро│рпН snapshot роХро┐роЯрпИродрпНродродрпБ:`, snapshot.size, "роЪрпЖропрпНродро┐роХро│рпН");
                removeMessageElement(loadingMsg);
                chatArea.innerHTML = ''; currentChatHistory = []; // ро╡ро░ро▓ро╛ро▒рпНро▒рпИ роорпАроЯрпНроЯроорпИ

                if (snapshot.empty) {
                    console.log("роЙро░рпИропро╛роЯро▓рпН роХро╛ро▓ро┐ропро╛роХ роЙро│рпНро│родрпБ.");
                    renderGreetingOrLoginPrompt();
                } else {
                    snapshot.forEach(doc => {
                        const msgData = doc.data();
                        const text = msgData.text || "";
                        const role = msgData.role || "model";
                        currentChatHistory.push({ // API context-роХрпНроХрпБ
                             role: role === 'user' ? 'user' : 'model',
                             parts: [{ text: text }]
                         });
                        displayMessage(text, role, [], null, msgData); // Render роЪрпЖропрпН
                    });
                }
                scrollToBottom(true); // роХрпАро┤рпЗ scroll роЪрпЖропрпН

            }, error => {
                console.error(`Chat ${chatId} роЪрпЖропрпНродро┐роХро│рпИроХрпН роХро╡ройро┐рокрпНрокродро┐ро▓рпН рокро┐ро┤рпИ:`, error);
                displayError("роЗроирпНрод роЙро░рпИропро╛роЯро▓ро┐ройрпН роЪрпЖропрпНродро┐роХро│рпИ роПро▒рпНро▒ роорпБроЯро┐ропро╡ро┐ро▓рпНро▓рпИ.");
                removeMessageElement(loadingMsg); chatArea.innerHTML = ''; currentChatHistory = [];
            });
        }

        // --- Message Sending (Gemini API & Firestore Save) ---
        async function handleSendMessage() {
            const txt = userInput.value.trim();
            if (!API_KEY) { displayError("Gemini API Key роЕроорпИроХрпНроХрокрпНрокроЯро╡ро┐ро▓рпНро▓рпИ."); return; }
            if (!currentUser) { displayError("родропро╡рпБроЪрпЖропрпНродрпБ роЙро│рпНроирпБро┤рпИропро╡рпБроорпН."); return; }
            if (!activeChatId) { displayError("родропро╡рпБроЪрпЖропрпНродрпБ роТро░рпБ роЙро░рпИропро╛роЯро▓рпИродрпН родрпЗро░рпНроирпНродрпЖроЯрпБроХрпНроХро╡рпБроорпН роЕро▓рпНро▓родрпБ роЙро░рпБро╡ро╛роХрпНроХро╡рпБроорпН."); return; }
            if (!txt || sendButton.disabled) return;

            const isMCQRequest = mcqModeCheckbox.checked;
            setLoadingState(true, "роЕройрпБрокрпНрокрпБроХро┐ро▒родрпБ...");
            const userMessageText = txt;

            userInput.value = ''; autoGrowTextarea(); if (isMCQRequest) mcqModeCheckbox.checked = false;

            const timestamp = firebase.firestore.FieldValue.serverTimestamp();
            const messagesColRef = db.collection('chats').doc(activeChatId).collection('messages');
            const chatDocRef = db.collection('chats').doc(activeChatId);

            // --- роЗродрпБ роорпБродро▓рпН роЪрпЖропрпНродро┐ропро╛ роОрой Firestore-роР роЪро░ро┐рокро╛ро░рпН (роЪрпЗрооро┐роХрпНроХрпБроорпН роорпБройрпН) ---
            let isFirstUserMessageInNewChat = false;
            try {
                 const chatSnap = await chatDocRef.get();
                 if (chatSnap.exists && chatSnap.data().title === NEW_CHAT_TITLE) {
                      const messagesSnap = await messagesColRef.limit(1).get();
                      if (messagesSnap.empty) { isFirstUserMessageInNewChat = true; }
                 }
            } catch(err) { console.error("роорпБродро▓рпН роЪрпЖропрпНродро┐ропрпИроЪрпН роЪро░ро┐рокро╛ро░рпНрокрпНрокродро┐ро▓рпН рокро┐ро┤рпИ:", err); }
            // --- роЪро░ро┐рокро╛ро░рпНрокрпНрокрпБ роорпБроЯро┐ро╡рпБ ---

            // 1. рокропройро░рпН роЪрпЖропрпНродро┐ропрпИ Firestore-роЗро▓рпН роЪрпЗрооро┐
             const userMsgData = { role: "user", text: userMessageText, timestamp: timestamp };
             try {
                 await messagesColRef.add(userMsgData);
                 await chatDocRef.update({ lastUpdated: timestamp });
                 console.log("рокропройро░рпН роЪрпЖропрпНродро┐ Firestore-роЗро▓рпН роЪрпЗрооро┐роХрпНроХрокрпНрокроЯрпНроЯродрпБ.");

                 // --- Automatic Title Update Logic (роЗроЩрпНроХрпБ роироХро░рпНродрпНродрокрпНрокроЯрпНроЯродрпБ) ---
                 if (isFirstUserMessageInNewChat) {
                     console.log("роорпБродро▓рпН рокропройро░рпН роЪрпЖропрпНродро┐, родро▓рпИрокрпНрокрпБ роЙро░рпБро╡ро╛роХрпНроХ роорпБропро▒рпНроЪро┐.");
                     const generatedTitle = generateChatTitle(userMessageText);
                     if (generatedTitle !== NEW_CHAT_TITLE) {
                         await updateActiveChatTitle(generatedTitle);
                         console.log("Chat родро▓рпИрокрпНрокрпБ родро╛ройро╛роХрокрпН рокрпБродрпБрокрпНрокро┐роХрпНроХрокрпНрокроЯрпНроЯродрпБ:", generatedTitle);
                     }
                 }
                 // --- Title Update роорпБроЯро┐ро╡рпБ ---

             } catch(error) {
                 console.error("рокропройро░рпН роЪрпЖропрпНродро┐ропрпИроЪрпН роЪрпЗрооро┐рокрпНрокродро┐ро▓рпН/родро▓рпИрокрпНрокрпИрокрпН рокрпБродрпБрокрпНрокро┐рокрпНрокродро┐ро▓рпН рокро┐ро┤рпИ:", error);
                 displayError("роЪрпЖропрпНродро┐ропрпИ роЕройрпБрокрпНрок роорпБроЯро┐ропро╡ро┐ро▓рпНро▓рпИ. роорпАрогрпНроЯрпБроорпН роорпБропро▒рпНроЪро┐роХрпНроХро╡рпБроорпН.");
                 setLoadingState(false); return;
             }

            // 2. API роЕро┤рпИрокрпНрокрпБроХрпНроХрпБродрпН родропро╛ро░ро╛роХрпБ
            const thinking = displayMessage("роЪро┐роирпНродро┐роХрпНроХро┐ро▒родрпБ...", 'ai', ['thinking']); // родрооро┐ро┤ро┐ро▓рпН
            const requestHistory = [ ...currentChatHistory, { role: "user", parts: [{ text: userMessageText }] } ];
            let modifiedPrompt = userMessageText;
             if (isMCQRequest) { /* ... MCQ prompt рооро╛ро▒рпНро▒роорпН ... */
                 modifiedPrompt = `${userMessageText}\n\nPlease provide the response strictly in JSON format containing an array of objects... Example: \`\`\`json\n[{"question":"Capital of France?","options":["A) Berlin","B) Paris","C) Rome","D) Madrid"],"answer":"B"}]\n\`\`\` Do not include any text before or after the JSON array.`;
                 requestHistory[requestHistory.length - 1] = { role: "user", parts: [{ text: modifiedPrompt }] };
             }

            // 3. Gemini API-роР роЕро┤рпИ
             console.warn("рокро╛родрпБроХро╛рокрпНрокрпБ роОроЪрпНроЪро░ро┐роХрпНроХрпИ: Client-side key роЙроЯройрпН Gemini API роЕро┤рпИроХрпНроХрокрпНрокроЯрпБроХро┐ро▒родрпБ.");
            try {
                const response = await fetch(API_URL_BASE + API_KEY, { /* ... fetch options ... */
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify({
                         contents: requestHistory,
                         safetySettings: [
                             {category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_MEDIUM_AND_ABOVE"},
                             {category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_MEDIUM_AND_ABOVE"},
                             {category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_MEDIUM_AND_ABOVE"},
                             {category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_MEDIUM_AND_ABOVE"}
                         ]
                     }),
                });
                removeMessageElement(thinking);
                let aiMsgData = { role: "model", text: "Error: API-ропро┐ро▓ро┐ро░рпБроирпНродрпБ рокродро┐ро▓рпН роЗро▓рпНро▓рпИ.", timestamp: firebase.firestore.FieldValue.serverTimestamp() };

                if (!response.ok) { /* ... API рокро┐ро┤рпИ роХрпИропро╛ро│рпБродро▓рпН ... */
                    let err = { message: `API рокро┐ро┤рпИ (${response.status})` };
                    try { err = (await response.json()).error || err; } catch {}
                    console.error("API рокро┐ро┤рпИ:", err);
                    aiMsgData.text = `рокро┐ро┤рпИ: ${err.message || "родрпЖро░ро┐ропро╛род API рокро┐ро┤рпИ"}`;
                    displayError(aiMsgData.text);
                    if(response.status===400 && err.message?.toLowerCase().includes('api key not valid')){
                         localStorage.removeItem(STORAGE_KEY_API_KEY); API_KEY='';
                         displayError("родро╡ро▒ро╛рой Gemini API Key роирпАроХрпНроХрокрпНрокроЯрпНроЯродрпБ. рокрпБродро┐роп key-роР роЙро│рпНро│ро┐роЯ reload роЪрпЖропрпНропро╡рпБроорпН.");
                     }
                } else { /* ... ро╡рпЖро▒рпНро▒ро┐ / MCQ роХрпИропро╛ро│рпБродро▓рпН ... */
                     const data = await response.json(); let aiTxt = "рооройрпНройро┐роХрпНроХро╡рпБроорпН, ро╡рпЖро▒рпНро▒рпБрокрпН рокродро┐ро▓рпН роХро┐роЯрпИродрпНродродрпБ."; let blocked = false;
                     if (data.promptFeedback?.blockReason) { aiTxt = `родроЯрпБроХрпНроХрокрпНрокроЯрпНроЯродрпБ: ${data.promptFeedback.blockReason}`; blocked = true; aiMsgData.text = aiTxt; displayMessage(aiTxt,'ai',['error-message']); }
                     else if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
                         aiTxt = data.candidates[0].content.parts[0].text; aiMsgData.text = aiTxt; let processedForMCQ = false;
                         if (isMCQRequest && !blocked) { /* ... MCQ parsing logic ... */
                              try {
                                  const jsonMatch = aiTxt.match(/```json\s*([\s\S]*?)\s*```/);
                                  const jsonString = jsonMatch ? jsonMatch[1].trim() : aiTxt.trim();
                                  if (jsonString.startsWith('[') && jsonString.endsWith(']')) {
                                      const mcqs = JSON.parse(jsonString);
                                      if (Array.isArray(mcqs) && mcqs.length > 0 && mcqs.every(q => q.question && Array.isArray(q.options) && q.answer)) {
                                          const summaryText = `${mcqs.length} MCQроХро│рпН роЙро░рпБро╡ро╛роХрпНроХрокрпНрокроЯрпНроЯрой. родрпЗро░рпНро╡рпИродрпН родрпКроЯроЩрпНроХ роХрпАро┤рпЗ роХро┐ро│ро┐роХрпН роЪрпЖропрпНропро╡рпБроорпН.`; aiMsgData.text = summaryText; aiMsgData.mcqData = mcqs; console.log("MCQроХро│рпН ро╡рпЖро▒рпНро▒ро┐роХро░рооро╛роХрокрпН рокро┐ро░ро┐роХрпНроХрокрпНрокроЯрпНроЯрпБ Firestore-роЗро▓рпН роЪрпЗрооро┐роХрпНроХрокрпНрокроЯрпБроХро┐ройрпНро▒рой:", mcqs); processedForMCQ = true;
                                      } else { console.warn("MCQ JSON роЪро░ро┐рокро╛ро░рпНрокрпНрокрпБ родрпЛро▓рпНро╡ро┐."); }
                                  } else { console.warn("MCQ-роХрпНроХро╛рой AI рокродро┐ро▓рпН JSON array рокрпЛро▓рпН роЗро▓рпНро▓рпИ."); }
                              } catch (parseError) { console.error("MCQ JSON-роРрокрпН рокро┐ро░ро┐рокрпНрокродро┐ро▓рпН родрпЛро▓рпНро╡ро┐:", parseError); }
                          }
                          if (!processedForMCQ) { console.log("роЪро╛родро╛ро░рог AI рокродро┐ро▓рпИроЪрпН роЪрпЗрооро┐роХрпНроХро┐ро▒родрпБ."); }
                     } else { console.warn("роОродро┐ро░рпНрокро╛ро░ро╛род API рокродро┐ро▓рпН ро╡роЯро┐ро╡роорпН:", data); aiMsgData.text = "рокро┐ро┤рпИ: рокродро┐ро▓ро┐ро▓ро┐ро░рпБроирпНродрпБ роЪро░ро┐ропро╛рой роЙро░рпИропрпИрокрпН рокро┐ро░ро┐роХрпНроХ роорпБроЯро┐ропро╡ро┐ро▓рпНро▓рпИ."; displayError(aiMsgData.text); }
                }
                 // 4. AI рокродро┐ро▓рпИ/рокро┐ро┤рпИропрпИ Firestore-роЗро▓рпН роЪрпЗрооро┐
                 try {
                     await messagesColRef.add(aiMsgData);
                     await chatDocRef.update({ lastUpdated: firebase.firestore.FieldValue.serverTimestamp() });
                     console.log("AI рокродро┐ро▓рпН/рокро┐ро┤рпИ Firestore-роЗро▓рпН роЪрпЗрооро┐роХрпНроХрокрпНрокроЯрпНроЯродрпБ.");
                 } catch (saveError) {
                     console.error("AI рокродро┐ро▓рпИ Firestore-роЗро▓рпН роЪрпЗрооро┐рокрпНрокродро┐ро▓рпН рокро┐ро┤рпИ:", saveError); displayError("рокродро┐ро▓рпИроЪрпН роЪрпЗрооро┐рокрпНрокродро┐ро▓рпН рокро┐ро┤рпИ. роЕродрпБ родрпЛройрпНро▒ро╛рооро▓рпН рокрпЛроХро▓ро╛роорпН.");
                 }

            } catch (error) { /* ... Network/рокро┐ро▒ рокро┐ро┤рпИроХро│рпН ... */
                console.error("Fetch/Processing рокро┐ро┤рпИ:", error); removeMessageElement(thinking);
                const errorText = `рокро┐ро┤рпИ: ${error.message || "роХрпЛро░ро┐роХрпНроХрпИропро┐ройрпН рокрпЛродрпБ рокро┐рогрпИропрокрпН рокро┐ро┤рпИ."}`; displayError(errorText);
                try { await messagesColRef.add({ role: "model", text: errorText, timestamp: firebase.firestore.FieldValue.serverTimestamp() }); await chatDocRef.update({ lastUpdated: firebase.firestore.FieldValue.serverTimestamp() }); }
                catch (saveError) { /* рокро┐ро┤рпИроЪрпН роЪрпЖропрпНродро┐ропрпИроЪрпН роЪрпЗрооро┐рокрпНрокродро┐ро▓рпН рокро┐ро┤рпИропрпИрокрпН рокрпБро▒роХрпНроХрогро┐ */ }
            } finally {
                setLoadingState(false);
                if (!isTestMode && !isReviewMode) userInput.focus();
            }
        }

        // роорпБродро▓рпН рокропройро░рпН роЪрпЖропрпНродро┐ропро┐ро▓ро┐ро░рпБроирпНродрпБ chat родро▓рпИрокрпНрокрпИ роЙро░рпБро╡ро╛роХрпНроХрпБродро▓рпН
        function generateChatTitle(firstUserMessageText) {
            if (firstUserMessageText) {
                const text = firstUserMessageText;
                const title = text.split(/\s+/).slice(0, 5).join(' ').replace(/[.,!?;:]$/, ''); // роорпБродро▓рпН 5 ро╡ро╛ро░рпНродрпНродрпИроХро│рпН
                return title.length > 35 ? title.substring(0, 32) + '...' : title; // роирпАро│родрпНродрпИроХрпН роХроЯрпНроЯрпБрокрпНрокроЯрпБродрпНродрпБ
            }
            return NEW_CHAT_TITLE;
        }

        // Firestore-роЗро▓рпН chat родро▓рпИрокрпНрокрпИрокрпН рокрпБродрпБрокрпНрокро┐родрпНродро▓рпН
         async function updateActiveChatTitle(newTitle) {
             if (!currentUser || !activeChatId || !newTitle || newTitle === NEW_CHAT_TITLE) { return; }
             const chatDocRef = db.collection('chats').doc(activeChatId);
             try {
                 await chatDocRef.update({ title: newTitle });
                 console.log(`Chat ${activeChatId} родро▓рпИрокрпНрокрпБ рокрпБродрпБрокрпНрокро┐роХрпНроХрокрпНрокроЯрпНроЯродрпБ: ${newTitle}`);
                 // Listener sidebar-роРрокрпН рокрпБродрпБрокрпНрокро┐роХрпНроХрпБроорпН
             } catch (error) {
                 console.error("Chat родро▓рпИрокрпНрокрпИ Firestore-роЗро▓рпН рокрпБродрпБрокрпНрокро┐рокрпНрокродро┐ро▓рпН рокро┐ро┤рпИ:", error);
             }
         }

        // --- UI & Message Display Functions ---
        function autoGrowTextarea() { userInput.style.height='auto'; userInput.style.height=(userInput.scrollHeight)+'px'; }
        function handleInputKeydown(event) { if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();handleSendMessage();} }
        function handleSuggestionClick(event) { if(event.target.classList.contains('suggestion-chip')){userInput.value=event.target.dataset.prompt||'';autoGrowTextarea();userInput.focus();} }
        function displayError(text) { displayMessage(`рокро┐ро┤рпИ: ${text}`, 'ai', ['error-message']); }
        function scrollToBottom(immediate = false) { chatArea.scrollTo({top:chatArea.scrollHeight,behavior:immediate?'auto':'smooth'}); }
        function removeMessageElement(element) { if(element?.parentNode===chatArea)chatArea.removeChild(element); }

        // Loading роиро┐ро▓рпИропрпИроХрпН роХроЯрпНроЯрпБрокрпНрокроЯрпБродрпНродрпБродро▓рпН
        function setLoadingState(isLoading, message = "роЙро░рпБро╡ро╛роХрпНроХрпБроХро┐ро▒родрпБ...") {
            const isDisabled = isLoading || !currentUser || (!activeChatId && !isDeletingChat); // Active chat роЗро▓рпНро▓рпИ роОройрпНро▒ро╛ро▓рпЛ роЕро▓рпНро▓родрпБ роирпАроХрпНроХрпБроорпНрокрпЛродрпБ родро╡ро┐ро░ disable роЪрпЖропрпН
            const inputDisabled = isLoading || !currentUser; // Input loading роЕро▓рпНро▓родрпБ logged out роОройрпНро▒ро╛ро▓рпН роороЯрпНроЯрпБроорпН disable

            userInput.disabled = inputDisabled;
            sendButton.disabled = isDisabled;
            mcqModeCheckbox.disabled = isDisabled;

            if (isLoading) { userInput.placeholder = message; }
            else if (!currentUser) { userInput.placeholder = "родропро╡рпБроЪрпЖропрпНродрпБ роЙро│рпНроирпБро┤рпИропро╡рпБроорпН"; }
            else if (!activeChatId && !isDeletingChat) { userInput.placeholder = "роТро░рпБ роЙро░рпИропро╛роЯро▓рпИродрпН родрпЗро░рпНроирпНродрпЖроЯрпБроХрпНроХро╡рпБроорпН роЕро▓рпНро▓родрпБ роЙро░рпБро╡ро╛роХрпНроХро╡рпБроорпН"; }
            else if (!activeChatId && isDeletingChat) { userInput.placeholder = "роПро▒рпНро▒рпБроХро┐ро▒родрпБ..."; } // роХроЯрпИроЪро┐ chat роирпАроХрпНроХрпБроорпНрокрпЛродрпБ
            else { userInput.placeholder = "роХрпЗро│рпНро╡ро┐ропрпИ роЙро│рпНро│ро┐роЯро╡рпБроорпН..."; }

            startChatButton.disabled = isLoading || !currentUser;
        }

        // Views (Chat, Test, Review) рооро╛ро▒рпНро▒рпБродро▓рпН
        function switchView(viewName) { /* ... (рооро╛ро▒рпНро▒рооро┐ро▓рпНро▓рпИ) ... */
            console.log("View рооро╛ро▒рпБроХро┐ро▒родрпБ:", viewName);
            chatView.classList.remove('active'); reviewView.classList.remove('active'); testView.classList.remove('active');
            appContainer.classList.remove('hidden');
            if(viewName==='test'){ appContainer.classList.add('hidden'); testView.classList.add('active'); isTestMode=true; isReviewMode=false; }
            else if(viewName==='review'){ reviewView.classList.add('active'); isTestMode=false; isReviewMode=true; }
            else { chatView.classList.add('active'); isTestMode=false; isReviewMode=false; }
            if (viewName !== 'test' && testTimerInterval) { clearInterval(testTimerInterval); testTimerInterval = null; }
        }

        // роЪрпЖропрпНродро┐ропрпИроХрпН роХро╛роЯрпНроЯрпБродро▓рпН (MCQ offer роХрпИропро╛ро│рпБродро▓рпБроЯройрпН)
        function displayMessage(text, sender, cssClasses = [], appendHtml = null, messageData = null) { /* ... (рооро╛ро▒рпНро▒рооро┐ро▓рпНро▓рпИ) ... */
            const element = document.createElement('div');
            element.classList.add('message', `${sender}-message`, ...cssClasses);
             let formattedText = text.replace(/</g, "<").replace(/>/g, ">").replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/```([\s\S]*?)```/g, (match, code) => `<pre><code>${code.replace(/</g, "<").replace(/>/g, ">")}</code></pre>`).replace(/`([^`]+)`/g, (match, code) => `<code>${code.replace(/</g, "<").replace(/>/g, ">")}</code>`).replace(/\n/g, '<br>');
            element.innerHTML = formattedText;
            if (messageData?.role === 'model' && Array.isArray(messageData.mcqData)) { console.log("MCQ offer роХро╛роЯрпНроЯрокрпНрокроЯрпБроХро┐ро▒родрпБ:", messageData.mcqData.length, "роХрпЗро│рпНро╡ро┐роХро│рпН"); displayMCQOffer(messageData.mcqData, element); }
            else if (appendHtml) { const tempDiv = document.createElement('div'); tempDiv.innerHTML = appendHtml; while (tempDiv.firstChild) { element.appendChild(tempDiv.firstChild); } }
            chatArea.appendChild(element);
            try { if (typeof MathJax !== "undefined" && MathJax.typesetPromise) { MathJax.typesetPromise([element]).catch(err => console.error('MathJax typeset error:', err)); } }
            catch (e) { console.error("MathJax роЕро┤рпИрокрпНрокрпБ родрпЛро▓рпНро╡ро┐:", e); }
            return element;
        }

        // --- MCQ/Test/Review Functions (рооро╛ро▒рпНро▒рооро┐ро▓рпНро▓рпИ) ---
        function handleChatAreaClick(event) { /* ... */ if (event.target.classList.contains('start-test-button')) { const mcqs = generatedMCQData; if (mcqs) { startMockTest(mcqs); generatedMCQData = null; } else { displayError("родрпЗро░рпНро╡рпИродрпН родрпКроЯроЩрпНроХ роорпБроЯро┐ропро╡ро┐ро▓рпНро▓рпИ. MCQ родро░ро╡рпБ роЗро▓рпНро▓рпИ."); } } }
        function displayMCQOffer(mcqs, aiMessageElement) { /* ... */ generatedMCQData = mcqs; const buttonHtml = `<button class="start-test-button">рооро╛родро┐ро░ро┐родрпН родрпЗро░рпНро╡рпИродрпН родрпКроЯроЩрпНроХрпБ (${mcqs.length} роХрпЗро│рпНро╡ро┐роХро│рпН)</button>`; const tempDiv = document.createElement('div'); tempDiv.style.marginTop = '10px'; tempDiv.innerHTML = buttonHtml; aiMessageElement.appendChild(tempDiv); scrollToBottom(); }
        function startMockTest(mcqs) { /* ... */ if (!currentUser) { displayError("родрпЗро░рпНро╡рпИродрпН родрпКроЯроЩрпНроХ роЙро│рпНроирпБро┤рпИропро╡рпБроорпН."); return; } if (!mcqs || mcqs.length === 0) { displayError("роЗроирпНродродрпН родрпЗро░рпНро╡рпБроХрпНроХрпБ роХрпЗро│рпНро╡ро┐роХро│рпН роЗро▓рпНро▓рпИ."); return; } currentTestMCQs = mcqs; currentQuestionIndex = 0; userAnswers = new Array(mcqs.length).fill(null); reviewResultsCache = null; switchView('test'); displayTestQuestion(0); startTestTimer(); testTitle.textContent = `рооро╛родро┐ро░ро┐родрпН родрпЗро░рпНро╡рпБ (${mcqs.length} роХрпЗро│рпНро╡ро┐роХро│рпН)`; }
        function displayTestQuestion(index) { /* ... */ if (index < 0 || index >= currentTestMCQs.length) return; currentQuestionIndex = index; const q = currentTestMCQs[index]; testQuestionNumber.textContent = `роХрпЗро│рпНро╡ро┐ ${index + 1}`; testQuestion.innerHTML = q.question; testOptionsContainer.innerHTML = ''; const options = Array.isArray(q.options) ? q.options : []; options.forEach((opt, i) => { const label = document.createElement('label'); const input = document.createElement('input'); input.type = 'radio'; input.name = `q_${index}`; input.value = i; input.checked = (userAnswers[index] === i); input.onchange = () => handleOptionSelect(i); label.appendChild(input); label.appendChild(document.createTextNode(` ${opt || '(роХро╛ро▓ро┐ Option)'}`)); testOptionsContainer.appendChild(label); }); try { if (typeof MathJax !== "undefined" && MathJax.typesetPromise) { MathJax.typesetPromise([testQuestion, testOptionsContainer]).catch(err => console.error('MathJax typeset error:', err)); } } catch(e){ console.error("MathJax call failed:", e); } prevQuestionBtn.disabled = (index === 0); nextQuestionBtn.disabled = (index === currentTestMCQs.length - 1); questionCounter.textContent = `роХрпЗро│рпНро╡ро┐: ${index + 1} / ${currentTestMCQs.length}`; }
        function handleOptionSelect(optionIndex) { /* ... */ if (currentQuestionIndex >= 0 && currentQuestionIndex < userAnswers.length) { userAnswers[currentQuestionIndex] = optionIndex; } }
        function handleTestNavigation(direction) { /* ... */ let newIndex = currentQuestionIndex; if (direction === 'prev' && currentQuestionIndex > 0) newIndex--; else if (direction === 'next' && currentQuestionIndex < currentTestMCQs.length - 1) newIndex++; if (newIndex !== currentQuestionIndex) displayTestQuestion(newIndex); }
        function startTestTimer() { /* ... */ if (testTimerInterval) clearInterval(testTimerInterval); testStartTime = Date.now(); testTimerInterval = setInterval(() => { const elapsedSeconds = Math.floor((Date.now() - testStartTime) / 1000); const minutes = Math.floor(elapsedSeconds / 60).toString().padStart(2, '0'); const seconds = (elapsedSeconds % 60).toString().padStart(2, '0'); testTimer.textContent = `роирпЗро░роорпН: ${minutes}:${seconds}`; }, 1000); }
        function submitTest() { /* ... */ if (!confirm("родрпЗро░рпНро╡рпИроЪрпН роЪрооро░рпНрокрпНрокро┐роХрпНроХ ро╡ро┐ро░рпБроорпНрокрпБроХро┐ро▒рпАро░рпНроХро│ро╛?")) return; if (testTimerInterval) clearInterval(testTimerInterval); const endTime = Date.now(); const timeTakenMs = endTime - testStartTime; switchView('review'); displayReview(timeTakenMs); }
        function displayReview(timeTakenMs) { /* ... */ reviewContent.innerHTML = ''; saveReviewBtn.disabled = false; saveReviewBtn.textContent = "рооро▒рпБрокро╛ро░рпНро╡рпИропрпИ роЪрпЗрооро┐"; if (!currentTestMCQs || currentTestMCQs.length === 0) { reviewSummary.innerHTML = "<span>рооро▒рпБрокро╛ро░рпНро╡рпИ роЪрпЖропрпНроп родрпЗро░рпНро╡рпБродрпН родро░ро╡рпБ роЗро▓рпНро▓рпИ.</span>"; return; } let correctCount = 0, incorrectCount = 0, skippedCount = 0; reviewResultsCache = { questions: [], summary: {}, testDate: new Date().toISOString(), timeTakenMs: timeTakenMs }; currentTestMCQs.forEach((q, index) => { const userAnswerIndex = userAnswers[index]; let userAnswerText = "родро╡ро┐ро░рпНроХрпНроХрокрпНрокроЯрпНроЯродрпБ"; let status = "skipped"; let itemStatusClass = "status-skipped"; let answerDetailClass = "user-answer-skipped"; const correctAnswerLetter = q.answer?.trim().toUpperCase(); const correctAnswerIndex = correctAnswerLetter ? correctAnswerLetter.charCodeAt(0) - 'A'.charCodeAt(0) : -1; const options = Array.isArray(q.options) ? q.options : []; const correctAnswerText = (correctAnswerIndex >= 0 && correctAnswerIndex < options.length) ? options[correctAnswerIndex] : "N/A"; if (userAnswerIndex !== null && userAnswerIndex >= 0 && userAnswerIndex < options.length) { userAnswerText = options[userAnswerIndex]; if (userAnswerIndex === correctAnswerIndex) { status = "correct"; itemStatusClass = "status-correct"; answerDetailClass = "user-answer-correct"; correctCount++; } else { status = "incorrect"; itemStatusClass = "status-incorrect"; answerDetailClass = "user-answer-incorrect"; incorrectCount++; } } else if (userAnswerIndex !== null) { userAnswerText = "родро╡ро▒ро╛рой родрпЗро░рпНро╡рпБ"; status = "incorrect"; itemStatusClass = "status-incorrect"; answerDetailClass = "user-answer-incorrect"; incorrectCount++; } else { skippedCount++; } reviewResultsCache.questions.push({ question: q.question, options: options, correctAnswer: correctAnswerText, userAnswer: userAnswerText, status: status }); const item = document.createElement('div'); item.classList.add('review-item', itemStatusClass); item.dataset.status = status; let detailsHtml = `<span class="${answerDetailClass}">роЙроЩрпНроХро│рпН рокродро┐ро▓рпН: ${userAnswerText}</span>`; if (status !== 'correct') { detailsHtml += `<br><span class="correct-answer">роЪро░ро┐ропро╛рой рокродро┐ро▓рпН: ${correctAnswerText}</span>`; } item.innerHTML = `<div class="review-item-qnum">роХрпЗро│рпНро╡ро┐ ${index + 1}</div><div class="review-item-question">${q.question}</div><div class="review-item-details">${detailsHtml}</div>`; reviewContent.appendChild(item); }); const totalQuestions = currentTestMCQs.length; const score = `${correctCount}/${totalQuestions}`; const timeSeconds = Math.round(timeTakenMs / 1000); const minutes = Math.floor(timeSeconds / 60); const seconds = timeSeconds % 60; const timeString = `${minutes}роиро┐ ${seconds}ро╡ро┐`; reviewSummary.innerHTML = `<span>роородро┐рокрпНрокрпЖрогрпН: ${score}</span> <span class="score-correct">роЪро░ро┐: ${correctCount}</span> <span class="score-incorrect">родро╡ро▒рпБ: ${incorrectCount}</span> <span class="score-skipped">родро╡ро┐ро░рпНродрпНродро╡рпИ: ${skippedCount}</span> <span>роорпКродрпНрод роирпЗро░роорпН: ${timeString}</span>`; reviewResultsCache.summary = { score, correct: correctCount, incorrect: incorrectCount, skipped: skippedCount, timeString }; try { if (typeof MathJax !== "undefined" && MathJax.typesetPromise) { MathJax.typesetPromise([reviewContent]).catch(err => console.error('MathJax typeset error:', err)); } } catch (e) { console.error("MathJax call failed:", e); } filterReviewItems('all'); }
        function handleReviewFilterClick(event) { /* ... */ const button = event.target.closest('button[data-filter]'); if (button) filterReviewItems(button.dataset.filter); }
        function filterReviewItems(filter) { /* ... */ reviewFilters.querySelectorAll('button').forEach(btn => { btn.classList.toggle('active-filter', btn.dataset.filter === filter); }); reviewContent.querySelectorAll('.review-item').forEach(item => { const show = (filter === 'all') || item.classList.contains(`status-${filter}`); item.classList.toggle('hidden-by-filter', !show); }); }
        function exitReview() { switchView('chat'); reviewResultsCache = null; }
        async function saveTestReviewToCloud() { /* ... */ if (!currentUser) { alert("рооро▒рпБрокро╛ро░рпНро╡рпИропрпИроЪрпН роЪрпЗрооро┐роХрпНроХ роЙро│рпНроирпБро┤рпИропро╡рпБроорпН."); return; } if (!reviewResultsCache) { alert("роЪрпЗрооро┐роХрпНроХ рооро▒рпБрокро╛ро░рпНро╡рпИродрпН родро░ро╡рпБ роЗро▓рпНро▓рпИ."); return; } const reviewDataToSave = { ...reviewResultsCache, userId: currentUser.uid, savedAt: firebase.firestore.FieldValue.serverTimestamp() }; saveReviewBtn.disabled = true; saveReviewBtn.textContent = "роЪрпЗрооро┐роХрпНроХро┐ро▒родрпБ..."; try { const newReviewRef = await db.collection('testReviews').add(reviewDataToSave); console.log("рооро▒рпБрокро╛ро░рпНро╡рпИ Firestore-роЗро▓рпН роЪрпЗрооро┐роХрпНроХрокрпНрокроЯрпНроЯродрпБ:", newReviewRef.id); alert("родрпЗро░рпНро╡рпБ рооро▒рпБрокро╛ро░рпНро╡рпИ ро╡рпЖро▒рпНро▒ро┐роХро░рооро╛роХроЪрпН роЪрпЗрооро┐роХрпНроХрокрпНрокроЯрпНроЯродрпБ!"); saveReviewBtn.textContent = "роЪрпЗрооро┐роХрпНроХрокрпНрокроЯрпНроЯродрпБ"; } catch (error) { console.error("рооро▒рпБрокро╛ро░рпНро╡рпИропрпИ Firestore-роЗро▓рпН роЪрпЗрооро┐рокрпНрокродро┐ро▓рпН рокро┐ро┤рпИ:", error); alert("рооро▒рпБрокро╛ро░рпНро╡рпИропрпИроЪрпН роЪрпЗрооро┐роХрпНроХ роорпБроЯро┐ропро╡ро┐ро▓рпНро▓рпИ. роорпАрогрпНроЯрпБроорпН роорпБропро▒рпНроЪро┐роХрпНроХро╡рпБроорпН."); saveReviewBtn.disabled = false; saveReviewBtn.textContent = "рооро▒рпБрокро╛ро░рпНро╡рпИропрпИ роЪрпЗрооро┐"; } }

    </script>

</body>
</html>
