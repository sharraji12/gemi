<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Chat + Mock Test (v8 - Reviews & Delete)</title>

    <!-- MathJax Configuration -->
    <script> window.MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],displayMath:[['$$','$$'],['\\[','\\]']]},svg:{fontCache:'global'},options:{skipHtmlTags:['script','noscript','style','textarea','pre','code']}}; </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <style>
        /* --- Styles --- */
        :root { /* ... Theme Variables (Unchanged) ... */
             --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; --sidebar-width: 260px; --message-font-size-base: 1rem;
             /* LIGHT */ --sidebar-bg: #f7f7f7; --main-bg: #ffffff; --input-bg: #ffffff; --border-color: #e0e0e0; --text-primary: #2c2c2c; --text-secondary: #5f5f5f; --text-placeholder: #999999; --accent-color: #d97a7a; --user-message-bg: #cce0ff; --user-message-text: #1c1c1c; --ai-message-bg: #f0f0f0; --ai-message-text: #2c2c2c; --button-bg: #f0f0f0; --button-hover-bg: #e0e0e0; --active-item-bg: #e0e0e0; --code-bg: #e8e8e8; --scrollbar-thumb: #ccc; --scrollbar-thumb-hover: #bbb; --app-outer-bg: #e8e8e8; --send-button-bg: var(--accent-color); --send-button-hover-bg: #c76b6b; --send-button-text: #ffffff; --error-bg: #ffebee; --error-text: #c62828; --error-border: #ef9a9a; --message-font-size: var(--message-font-size-base);
        }
        body.dark-theme { /* DARK (Unchanged) */ --sidebar-bg: #2a2a2e; --main-bg: #1e1e1e; --input-bg: #2a2a2e; --border-color: #404040; --text-primary: #e0e0e0; --text-secondary: #a0a0a0; --text-placeholder: #777777; --accent-color: #e58b8b; --user-message-bg: #3a4a6b; --user-message-text: #e8e8e8; --ai-message-bg: #333333; --ai-message-text: #e0e0e0; --button-bg: #404040; --button-hover-bg: #505050; --active-item-bg: #454545; --code-bg: #2c2c2e; --scrollbar-thumb: #555; --scrollbar-thumb-hover: #666; --app-outer-bg: #121212; --send-button-bg: var(--accent-color); --send-button-hover-bg: #f09f9f; --send-button-text: #1e1e1e; --error-bg: #5c2b2b; --error-text: #ffcdd2; --error-border: #8c4343; }
        body { font-family: var(--font-family); margin: 0; padding: 0; background-color: var(--app-outer-bg); color: var(--text-primary); font-size: 15px; transition: background-color 0.3s ease, color 0.3s ease; }

        /* --- Layout & Structure (Added All Reviews View) --- */
        .app-container { display: flex; height: 100vh; width: 100vw; overflow: hidden; } .app-container.hidden { display: none; }
        .sidebar { width: var(--sidebar-width); background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 15px 0; box-sizing: border-box; flex-shrink: 0; transition: background-color 0.3s ease, border-color 0.3s ease; }
        .main-container { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; overflow: hidden; position: relative; }
        .main-content, .review-view, .all-reviews-view { /* Added all-reviews-view */
            display: none; flex-direction: column; background-color: var(--main-bg); height: 100%; width: 100%; overflow: hidden; transition: background-color 0.3s ease;
        }
        .main-content.active, .review-view.active, .all-reviews-view.active { display: flex; }
        .chat-area { flex-grow: 1; overflow-y: auto; padding: 30px 10% 20px; display: flex; flex-direction: column; max-width: 800px; margin: 0 auto; width: 80%; }
        .input-container { padding: 20px 10%; border-top: 1px solid var(--border-color); background-color: var(--input-bg); max-width: 800px; margin: 0 auto; width: 80%; transition: background-color 0.3s ease, border-color 0.3s ease; display: none; /* Initially hidden until login */ }

        /* --- Sidebar Elements (Added Delete Button, Reviews Link) --- */
         .sidebar-header { padding: 10px 20px; font-size: 1.1em; font-weight: 600; color: var(--text-primary); }
         .start-chat-button { display: flex; align-items: center; gap: 8px; background-color: var(--main-bg); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 8px; padding: 10px 15px; margin: 10px 15px; font-size: 0.95em; font-weight: 500; cursor: pointer; text-align: left; transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease; }
         .start-chat-button:hover { background-color: var(--button-hover-bg); } .start-chat-button svg { fill: currentColor; width: 16px; height: 16px; }
         .start-chat-button:disabled { opacity: 0.6; cursor: not-allowed; } /* Disabled style for logged out */
         .sidebar-section-title { padding: 15px 20px 5px; font-size: 0.85em; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
         .chat-list { flex-grow: 1; overflow-y: auto; padding: 0 15px; margin-bottom: 10px; }
         .chat-list::-webkit-scrollbar { width: 6px; } .chat-list::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 3px;} .chat-list::-webkit-scrollbar-thumb:hover { background: var(--scrollbar-thumb-hover); }
         .chat-list-item { display: flex; align-items: center; justify-content: space-between; /* For delete btn */ padding: 8px 10px; margin-bottom: 4px; border-radius: 6px; font-size: 0.9em; cursor: pointer; /* white-space: nowrap; */ /* overflow: hidden; */ /* text-overflow: ellipsis; */ color: var(--text-secondary); transition: background-color 0.2s ease, color 0.2s ease; position: relative; }
         .chat-list-item:hover { background-color: var(--button-hover-bg); color: var(--text-primary); }
         .chat-list-item.active { background-color: var(--active-item-bg); color: var(--text-primary); font-weight: 500; }
         .chat-title { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 5px; /* Space before delete btn */ }
         .delete-chat-btn { background: none; border: none; color: var(--text-secondary); font-size: 1.1em; line-height: 1; padding: 0 4px; cursor: pointer; display: none; /* Hidden by default */ flex-shrink: 0; }
         .chat-list-item:hover .delete-chat-btn { display: inline-block; } /* Show on hover */
         .delete-chat-btn:hover { color: #dc3545; } /* Red on hover */
         .sidebar-footer { border-top: 1px solid var(--border-color); padding: 10px 15px; transition: border-color 0.3s ease;}
         .sidebar-section-link { /* Style for View All Reviews link */
              display: block; text-align: center; padding: 8px 15px; margin: 5px 15px 10px; background-color: var(--button-bg); border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9em; color: var(--text-primary); cursor: pointer; transition: background-color 0.2s ease;
         }
         .sidebar-section-link:hover { background-color: var(--button-hover-bg); }
         .sidebar-section-link:disabled { opacity: 0.6; cursor: not-allowed; } /* For logged out state */
         .sidebar-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
         .text-size-controls span, .theme-toggle span { font-size: 0.85em; color: var(--text-secondary); }
         .text-size-buttons button, .theme-toggle button { background: var(--button-bg); border: 1px solid var(--border-color); color: var(--text-secondary); border-radius: 4px; padding: 2px 8px; margin-left: 5px; cursor: pointer; font-size: 1.1em; line-height: 1; transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease; }
         .text-size-buttons button:hover, .theme-toggle button:hover { background-color: var(--button-hover-bg); color: var(--text-primary); }
         .text-size-buttons button:disabled, .theme-toggle button:disabled { opacity: 0.6; cursor: not-allowed; } /* Disabled style for logged out */
         .account-info { display: flex; align-items: center; gap: 10px; font-size: 0.9em; margin-top: 10px; /* Added margin */ }
         .account-avatar { width: 30px; height: 30px; border-radius: 50%; background-color: #6c757d; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; }
         .account-details { overflow: hidden; }
         .account-email { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-primary); }
         .account-plan { font-size: 0.85em; color: var(--text-secondary); }
         #auth-controls { margin-top: 15px; text-align: center; } /* Auth buttons container */
         #auth-controls button { background-color: var(--button-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; padding: 8px 15px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s ease; }
         #auth-controls button:hover { background-color: var(--button-hover-bg); }
         #logout-btn { display: none; /* Initially hidden */ }


        /* --- Chat Area Elements (Unchanged) --- */
        .greeting { font-size: 1.8em; font-weight: 600; margin-bottom: 40px; color: var(--text-primary); } .greeting .asterisk { color: var(--accent-color); font-size: 1.2em; margin-right: 5px; display: inline-block; vertical-align: middle; }
        .message { padding: 12px 18px; border-radius: 18px; max-width: 80%; word-wrap: break-word; line-height: 1.6; margin-bottom: 15px; font-size: var(--message-font-size); transition: background-color 0.3s ease, color 0.3s ease; }
        .user-message { background-color: var(--user-message-bg); color: var(--user-message-text); align-self: flex-end; border-bottom-right-radius: 5px; }
        .ai-message { background-color: var(--ai-message-bg); color: var(--ai-message-text); align-self: flex-start; border-bottom-left-radius: 5px; }
        .ai-message strong { font-weight: 600; } .ai-message em { font-style: italic; }
        .ai-message pre { background-color: var(--code-bg); color: var(--text-primary); padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 0.9em; transition: background-color 0.3s ease, color 0.3s ease;}
        .ai-message code { font-family: monospace; background-color: var(--code-bg); color: var(--text-primary); padding: 2px 4px; border-radius: 3px; transition: background-color 0.3s ease, color 0.3s ease;}
        .ai-message pre code { background-color: transparent; padding: 0; }
        .ai-message.thinking { background-color: transparent; color: var(--text-secondary); font-style: italic; }
        .error-message { background-color: var(--error-bg); color: var(--error-text); border: 1px solid var(--error-border); align-self: flex-start; transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;}
        .info-message { text-align: center; color: var(--text-secondary); padding: 50px 20px; font-style: italic; }
        .message mjx-container { color: inherit !important; font-size: inherit !important; }

        /* --- Input Area Elements (Unchanged) --- */
        .suggestions { display: none; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; } /* Initially hidden */
        .suggestion-chip { background-color: var(--button-bg); border: 1px solid var(--border-color); color: var(--text-secondary); border-radius: 16px; padding: 8px 15px; font-size: 0.9em; cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease; }
        .suggestion-chip:hover { background-color: var(--button-hover-bg); color: var(--text-primary); }
        .input-box { display: flex; align-items: flex-end; background-color: var(--main-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 5px 5px 5px 15px; position: relative; transition: background-color 0.3s ease, border-color 0.3s ease; }
        .input-box:focus-within { border-color: var(--accent-color); }
        #user-input { flex-grow: 1; border: none; outline: none; padding: 10px 5px; font-size: 1rem; background-color: transparent; resize: none; min-height: 48px; max-height: 250px; line-height: 1.5; color: var(--text-primary); font-family: var(--font-family); }
        #user-input::placeholder { color: var(--text-placeholder); }
        .mcq-mode-control { display: flex; align-items: center; margin-left: 10px; padding-bottom: 8px; flex-shrink: 0; }
        .mcq-mode-control input[type="checkbox"] { margin-right: 5px; accent-color: var(--accent-color); cursor: pointer;}
        .mcq-mode-control label { font-size: 0.85em; color: var(--text-secondary); cursor: pointer; user-select: none;}
        #send-button { background-color: var(--send-button-bg); color: var(--send-button-text); border: none; border-radius: 8px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-left: 10px; transition: background-color 0.2s ease; padding: 0; flex-shrink: 0; }
        #send-button:hover:not(:disabled) { background-color: var(--send-button-hover-bg); }
        #send-button:disabled { background-color: #cccccc; cursor: not-allowed; opacity: 0.6; }
        #send-button svg { width: 20px; height: 20px; fill: currentColor; }
        .thinking::after { content: ' .'; animation: dots 1s steps(3, end) infinite; display: inline-block; }
        @keyframes dots { 0%, 20% { content: ' .'; } 40% { content: ' ..'; } 60%, 100% { content: ' ...'; } }
         .start-test-button { background-color: var(--accent-color); color: var(--send-button-text); border: none; border-radius: 6px; padding: 8px 15px; margin-top: 10px; cursor: pointer; font-weight: 500; display: inline-block; transition: background-color 0.2s ease; }
         .start-test-button:hover { background-color: var(--send-button-hover-bg); }

        /* --- Mock Test View Styles (Unchanged) --- */
        .mock-test-view { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--main-bg); z-index: 100; flex-direction: column; padding: 20px; box-sizing: border-box; transition: background-color 0.3s ease; }
        .mock-test-view.active { display: flex; }
        .test-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .test-header h2 { margin: 0; font-size: 1.3em; color: var(--text-primary); }
        .test-info span { margin-left: 15px; font-size: 0.95em; color: var(--text-secondary); }
        .test-content { flex-grow: 1; overflow-y: auto; padding: 10px 20px; }
        .test-question-container { margin-bottom: 25px; }
        .test-question-number { font-weight: bold; margin-bottom: 8px; color: var(--text-secondary); }
        .test-question { font-size: 1.1em; line-height: 1.5; margin-bottom: 15px; color: var(--text-primary); }
        .test-options label { display: block; margin-bottom: 12px; background-color: var(--button-bg); padding: 12px 15px; border-radius: 6px; border: 1px solid var(--border-color); cursor: pointer; transition: background-color 0.2s ease, border-color 0.2s ease; color: var(--text-primary); }
        .test-options label:hover { background-color: var(--button-hover-bg); }
        .test-options input[type="radio"] { margin-right: 10px; accent-color: var(--accent-color); cursor: pointer;}
        .test-navigation { display: flex; justify-content: space-between; padding-top: 15px; border-top: 1px solid var(--border-color); margin-top: auto; flex-shrink: 0; }
        .test-navigation button { background-color: var(--button-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; padding: 10px 20px; cursor: pointer; font-size: 0.95em; transition: background-color 0.2s ease; }
        .test-navigation button:hover:not(:disabled) { background-color: var(--button-hover-bg); }
        .test-navigation button#submit-test-btn { background-color: var(--accent-color); color: var(--send-button-text); border-color: var(--accent-color); }
        .test-navigation button#submit-test-btn:hover:not(:disabled) { background-color: var(--send-button-hover-bg); }
        .test-navigation button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* --- Review View Styles (Unchanged) --- */
        .review-view { padding: 20px; box-sizing: border-box; background-color: var(--main-bg); }
        .review-header { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .review-header h2 { margin: 0 0 10px 0; font-size: 1.3em; color: var(--text-primary); }
        .review-summary span { margin-right: 20px; font-size: 1em; color: var(--text-primary); }
        .review-summary .score-correct { color: #28a745; font-weight: bold;} .review-summary .score-incorrect { color: #dc3545; font-weight: bold;} .review-summary .score-skipped { color: #fd7e14; font-weight: bold;}
        .review-filters { margin-bottom: 15px; }
        .review-filters button { background-color: var(--button-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; padding: 5px 12px; margin-right: 8px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s ease, border-color 0.2s ease; }
        .review-filters button:hover { background-color: var(--button-hover-bg); }
        .review-filters button.active-filter { background-color: var(--accent-color); color: var(--send-button-text); border-color: var(--accent-color);}
        .review-content { flex-grow: 1; overflow-y: auto; padding-right: 10px; }
        .review-item { margin-bottom: 15px; padding: 15px; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--button-bg); transition: background-color 0.3s ease, border-color 0.3s ease; }
        .review-item.hidden-by-filter { display: none; }
        .review-item-qnum { font-weight: bold; margin-bottom: 8px; color: var(--text-secondary); }
        .review-item-question { margin-bottom: 10px; line-height: 1.5; color: var(--text-primary); }
        .review-item-details span { display: block; margin-bottom: 5px; font-size: 0.95em; color: var(--text-primary); }
        .review-item-details .correct-answer { color: #28a745; font-weight: bold; }
        .review-item-details .user-answer-correct { color: #28a745; } .review-item-details .user-answer-incorrect { color: #dc3545; text-decoration: line-through; } .review-item-details .user-answer-skipped { color: #fd7e14; font-style: italic; }
        .review-footer { text-align: center; padding-top: 20px; border-top: 1px solid var(--border-color); margin-top: auto; flex-shrink: 0; display: flex; justify-content: center; gap: 15px; /* Space between buttons */ }
        #exit-review-btn, #save-review-btn { /* Style both buttons */
            background-color: var(--accent-color); color: var(--send-button-text); border: none;
            border-radius: 6px; padding: 10px 25px; cursor: pointer; font-size: 1em;
            transition: background-color 0.2s ease;
        }
        #exit-review-btn:hover, #save-review-btn:hover:not(:disabled) { background-color: var(--send-button-hover-bg); }
        #save-review-btn { /* Secondary button style (optional) */
            background-color: var(--button-bg); color: var(--text-primary); border: 1px solid var(--border-color);
        }
        #save-review-btn:hover:not(:disabled) { background-color: var(--button-hover-bg); }
        #save-review-btn:disabled { opacity: 0.6; cursor: not-allowed; background-color: #cccccc; border-color: #aaaaaa; } /* Disabled style */

        /* --- All Test Reviews View Styles --- */
        .all-reviews-view { padding: 20px; box-sizing: border-box; }
        .all-reviews-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .all-reviews-header h2 { margin: 0; font-size: 1.3em; color: var(--text-primary); }
        .all-reviews-header .search-container { display: flex; align-items: center; gap: 5px; }
        .all-reviews-header .search-container label { font-size: 0.9em; color: var(--text-secondary); }
        .all-reviews-header input[type="search"] { padding: 6px 10px; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--input-bg); color: var(--text-primary); font-size: 0.95em; }
        .all-reviews-header input[type="search"]:focus { border-color: var(--accent-color); outline: none; }
        .all-reviews-header #back-to-chat-from-reviews-btn { /* Style for back button */
            background-color: var(--button-bg); color: var(--text-primary); border: 1px solid var(--border-color);
            border-radius: 6px; padding: 6px 15px; cursor: pointer; font-size: 0.9em;
            transition: background-color 0.2s ease;
        }
        .all-reviews-header #back-to-chat-from-reviews-btn:hover { background-color: var(--button-hover-bg); }
        .all-reviews-list { flex-grow: 1; overflow-y: auto; padding: 10px 5px 10px 0; } /* Add padding-right */
        .all-reviews-list-item { margin-bottom: 15px; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--main-bg); transition: background-color 0.3s ease, border-color 0.3s ease; }
        .all-reviews-list-item.hidden-by-search { display: none; } /* For search filtering */
        .review-item-header { margin-bottom: 10px; display: flex; justify-content: space-between; align-items: baseline; flex-wrap: wrap; gap: 10px; }
        .review-item-header .review-date { font-size: 0.85em; color: var(--text-secondary); }
        .review-item-header .review-summary-short span { margin-left: 15px; font-size: 0.95em; color: var(--text-primary); }
        .review-item-details-preview { font-size: 0.9em; color: var(--text-secondary); margin-bottom: 12px; max-height: 60px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; } /* Preview first question */
        .review-item-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .review-item-actions button {
            background-color: var(--button-bg); color: var(--text-primary); border: 1px solid var(--border-color);
            border-radius: 5px; padding: 5px 12px; cursor: pointer; font-size: 0.85em;
            transition: background-color 0.2s ease;
        }
        .review-item-actions button:hover { background-color: var(--button-hover-bg); }
        .review-item-actions button.reattempt-full { /* Optional distinct style */
             /* border-color: var(--accent-color); */
        }


    </style>
</head>
<body>

    <!-- App Container (Sidebar + Main Views) -->
    <div class="app-container" id="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">Gemini Chat</div>
            <button class="start-chat-button" id="start-chat" disabled>
                 <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg>
                 Start new chat
            </button>
            <div class="sidebar-section-title">Chats</div>
            <div class="chat-list" id="chat-list">
                 <div style="padding:10px;color:var(--text-secondary);font-size:0.9em;">Please log in to see chats.</div>
            </div>
            <!-- Link to All Reviews -->
            <div class="sidebar-section-title">Reviews</div>
            <button class="sidebar-section-link" id="view-all-reviews-btn" disabled>View Saved Tests</button>
            <!-- Footer -->
            <div class="sidebar-footer">
                <div class="sidebar-controls">
                     <div class="text-size-controls">
                         <span>Text Size</span>
                         <div class="text-size-buttons">
                             <button id="decrease-text-size" title="Decrease text size" disabled>-</button>
                             <button id="increase-text-size" title="Increase text size" disabled>+</button>
                         </div>
                     </div>
                     <div class="theme-toggle">
                         <button id="theme-toggle-button" title="Toggle Theme" disabled>☀️</button>
                     </div>
                </div>
                 <div id="auth-controls">
                     <button id="login-google-btn">Login with Google</button>
                     <button id="logout-btn" style="display: none;">Logout</button>
                 </div>
                 <div class="account-info">
                     <div class="account-avatar" id="account-avatar">?</div>
                     <div class="account-details">
                         <div class="account-email" id="account-email">Not logged in</div>
                         <div class="account-plan" id="account-plan"></div>
                     </div>
                 </div>
            </div>
        </div>

        <!-- Main Area Container (Chat / Single Review / All Reviews) -->
        <div class="main-container">
            <!-- Chat View -->
            <div class="main-content active" id="main-content-chat">
                 <div class="chat-area" id="chat-area">
                     <!-- Greeting or Login Prompt -->
                 </div>
                 <div class="input-container" id="input-container">
                     <div class="suggestions" id="suggestions">
                          <button class="suggestion-chip" data-prompt="5 questions about US History">5 Qs US History (Check MCQ)</button>
                          <button class="suggestion-chip" data-prompt="What is recursion?">Recursion?</button>
                          <button class="suggestion-chip" data-prompt="Explain $\lim_{x\to 0} \frac{\sin x}{x} = 1$">Limit sin(x)/x ?</button>
                     </div>
                    <div class="input-box">
                        <textarea id="user-input" placeholder="Enter prompt..." rows="1"></textarea>
                        <div class="mcq-mode-control"> <input type="checkbox" id="mcq-mode-checkbox" title="Check to generate MCQs based on your prompt"> <label for="mcq-mode-checkbox">MCQs?</label> </div>
                        <button id="send-button" title="Send message" disabled>
                            <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
                        </button>
                    </div>
                </div>
            </div>
            <!-- Single Test Review View -->
             <div class="review-view" id="review-view">
                 <div class="review-header">
                     <h2>Test Review</h2>
                     <div class="review-summary" id="review-summary"></div>
                     <div class="review-filters" id="review-filters">
                         <button data-filter="all" class="active-filter">All</button>
                         <button data-filter="incorrect">Incorrect</button>
                         <button data-filter="skipped">Skipped</button>
                     </div>
                 </div>
                 <div class="review-content" id="review-content"></div>
                 <div class="review-footer">
                     <button id="save-review-btn">Save Review</button>
                     <button id="exit-review-btn">Back to Chat</button>
                 </div>
             </div>
             <!-- All Test Reviews View -->
              <div class="all-reviews-view" id="all-reviews-view">
                  <div class="all-reviews-header">
                       <h2>All Saved Test Reviews</h2>
                       <div class="search-container">
                           <label for="review-search">Search:</label>
                           <input type="search" id="review-search" placeholder="Search questions...">
                       </div>
                       <button id="back-to-chat-from-reviews-btn">Back to Chat</button>
                  </div>
                  <div class="all-reviews-list" id="all-reviews-list">
                      <!-- Review items will be loaded here -->
                       <div class="info-message">Loading saved reviews...</div>
                  </div>
              </div>
        </div>
    </div>

    <!-- Mock Test View (Fullscreen Overlay - Unchanged) -->
    <div class="mock-test-view" id="mock-test-view">
        <div class="test-header"> <h2 id="test-title">Mock Test</h2> <div class="test-info"> <span id="question-counter">Q: 1 / N</span> <span id="test-timer">Time: 00:00</span> </div> </div>
        <div class="test-content"> <div class="test-question-container"> <div class="test-question-number" id="test-question-number"></div> <div class="test-question" id="test-question"></div> <div class="test-options" id="test-options"></div> </div> </div>
        <div class="test-navigation"> <button id="prev-question-btn" disabled>Previous</button> <button id="next-question-btn">Next</button> <button id="submit-test-btn">Submit Test</button> </div>
    </div>


    <script>
        // --- Firebase Config (SHARED, INSECURE KEY - REPLACE) ---
        const firebaseConfig = {
          apiKey: "AIzaSyDgw604fe5jnNu4kTOv1cQ-3n7PL8gcN58", // <- REPLACE THIS KEY
          authDomain: "krish-c5db8.firebaseapp.com",
          projectId: "krish-c5db8",
          storageBucket: "krish-c5db8.appspot.com",
          messagingSenderId: "217175257890",
          appId: "1:217175257890:web:209f0f290eabab6b1fab7b",
          measurementId: "G-97SHYGL2J4"
        };

        // --- Initialize Firebase ---
        firebase.initializeApp(firebaseConfig);
        const fbAuth = firebase.auth();
        const db = firebase.firestore();

        // --- DOM Elements ---
        const appContainer = document.getElementById('app-container');
        const chatArea = document.getElementById('chat-area');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const suggestionsContainer = document.getElementById('suggestions');
        const startChatButton = document.getElementById('start-chat');
        const chatListContainer = document.getElementById('chat-list');
        const accountEmail = document.getElementById('account-email');
        const accountAvatar = document.getElementById('account-avatar');
        const accountPlan = document.getElementById('account-plan');
        const decreaseTextBtn = document.getElementById('decrease-text-size');
        const increaseTextBtn = document.getElementById('increase-text-size');
        const themeToggleButton = document.getElementById('theme-toggle-button');
        const mainContainer = document.querySelector('.main-container');
        const chatView = document.getElementById('main-content-chat');
        const testView = document.getElementById('mock-test-view');
        const reviewView = document.getElementById('review-view');
        const allReviewsView = document.getElementById('all-reviews-view'); // New View
        const allReviewsListContainer = document.getElementById('all-reviews-list'); // New List
        const reviewSearchInput = document.getElementById('review-search'); // New Search Input
        const viewAllReviewsBtn = document.getElementById('view-all-reviews-btn'); // New Sidebar Btn
        const backToChatFromReviewsBtn = document.getElementById('back-to-chat-from-reviews-btn'); // New Back Btn
        const inputContainer = document.getElementById('input-container');
        const mcqModeCheckbox = document.getElementById('mcq-mode-checkbox');
        const loginBtn = document.getElementById('login-google-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const testTitle = document.getElementById('test-title');
        const questionCounter = document.getElementById('question-counter');
        const testTimer = document.getElementById('test-timer');
        const testQuestionNumber = document.getElementById('test-question-number');
        const testQuestion = document.getElementById('test-question');
        const testOptionsContainer = document.getElementById('test-options');
        const prevQuestionBtn = document.getElementById('prev-question-btn');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const submitTestBtn = document.getElementById('submit-test-btn');
        const reviewSummary = document.getElementById('review-summary');
        const reviewContent = document.getElementById('review-content');
        const exitReviewBtn = document.getElementById('exit-review-btn');
        const reviewFilters = document.getElementById('review-filters');
        const saveReviewBtn = document.getElementById('save-review-btn');

        // --- Config & Constants ---
        const MODEL_NAME="gemini-1.5-flash-latest";
        const API_URL_BASE=`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=`;
        const STORAGE_KEY_API_KEY='geminiApiKey';
        const NEW_CHAT_TITLE="(New Chat)";
        const TEXT_SIZE_STEP=0.1;
        const MIN_TEXT_SIZE_MULTIPLIER=0.7;
        const MAX_TEXT_SIZE_MULTIPLIER=1.5;
        const LIGHT_THEME_ICON='☀️';
        const DARK_THEME_ICON='🌙';
        const DELETE_ICON_HTML = '✕'; // Multiplication sign '×' as delete icon

        // --- State Variables ---
        let API_KEY='';
        let currentUser = null;
        let activeChatId = null;
        let currentChatHistory=[]; // Only stores {role, parts} for API call format
        let currentTextSizeMultiplier=1.0;
        let currentTheme='light';
        let isTestMode=false;
        let isReviewMode=false;
        let isAllReviewsMode = false; // New state for All Reviews view
        let currentTestMCQs=[];
        let currentQuestionIndex=0;
        let userAnswers=[];
        let testStartTime=null;
        let testTimerInterval=null;
        let generatedMCQData=null;
        let reviewResultsCache = null;
        let allReviewsCache = []; // Cache for fetched reviews in All Reviews view
        let activeChatListener = null;
        let chatListListener = null;
        let allReviewsListener = null; // Listener for all reviews collection

        // --- Initialization ---
        initializeApp();

        // --- Event Listeners ---
        sendButton.addEventListener('click', handleSendMessage);
        userInput.addEventListener('input', autoGrowTextarea);
        userInput.addEventListener('keydown', handleInputKeydown);
        suggestionsContainer.addEventListener('click', handleSuggestionClick);
        startChatButton.addEventListener('click', createNewChat);
        chatListContainer.addEventListener('click', handleChatListClick); // Handles selection AND deletion
        decreaseTextBtn.addEventListener('click', () => adjustTextSize(-TEXT_SIZE_STEP));
        increaseTextBtn.addEventListener('click', () => adjustTextSize(TEXT_SIZE_STEP));
        themeToggleButton.addEventListener('click', toggleTheme);
        prevQuestionBtn.addEventListener('click', () => handleTestNavigation('prev'));
        nextQuestionBtn.addEventListener('click', () => handleTestNavigation('next'));
        submitTestBtn.addEventListener('click', submitTest);
        exitReviewBtn.addEventListener('click', exitReview); // Exits SINGLE review
        chatArea.addEventListener('click', handleChatAreaClick);
        reviewFilters.addEventListener('click', handleReviewFilterClick);
        saveReviewBtn.addEventListener('click', saveTestReviewToCloud);
        loginBtn.addEventListener('click', signInWithGoogle);
        logoutBtn.addEventListener('click', signOut);
        viewAllReviewsBtn.addEventListener('click', showAllReviewsView); // New: Go to All Reviews
        backToChatFromReviewsBtn.addEventListener('click', () => switchView('chat')); // New: Back from All Reviews
        reviewSearchInput.addEventListener('input', handleAllReviewsSearch); // New: Search listener
        allReviewsListContainer.addEventListener('click', handleReattemptClick); // New: Reattempt listener

        // --- Initialization Functions ---
        async function initializeApp() {
            loadGeminiApiKey();
            fbAuth.onAuthStateChanged(handleAuthStateChange);
            switchView('chat');
            userInput.focus();
        }

        function loadGeminiApiKey() {
             console.warn("SECURITY WARNING: Gemini API Key is stored in localStorage. This is insecure. Migrate to Cloud Function.");
            const k=localStorage.getItem(STORAGE_KEY_API_KEY);
            if(k){ API_KEY=k; }
            else { API_KEY=prompt("--- INSECURE DEMO ---\nEnter Gemini API Key (stored locally - requires Cloud Function for security):");
                 if(API_KEY){ localStorage.setItem(STORAGE_KEY_API_KEY, API_KEY); }
                 else { displayError("Gemini API Key required. Reload to enter."); setLoadingState(true, "API Key Missing"); }
            }
        }

        // --- Authentication Functions ---
        async function signInWithGoogle() { /* ... (Unchanged) ... */
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                setLoadingState(true, "Logging in...");
                await fbAuth.signInWithPopup(provider);
            } catch (error) {
                console.error("Google Sign-In Error:", error);
                displayError(`Login failed: ${error.message}`);
                setLoadingState(false); // Ensure loading stops on error
            }
        }

        async function signOut() { /* ... (Unchanged) ... */
            try {
                setLoadingState(true, "Logging out...");
                await fbAuth.signOut();
            } catch (error) {
                console.error("Sign Out Error:", error);
                displayError(`Logout failed: ${error.message}`);
                setLoadingState(false); // Ensure loading stops on error
            }
        }

        function handleAuthStateChange(user) {
            // Detach ALL previous Firestore listeners
            if (activeChatListener) { activeChatListener(); activeChatListener = null; }
            if (chatListListener) { chatListListener(); chatListListener = null; }
            if (allReviewsListener) { allReviewsListener(); allReviewsListener = null; } // Detach reviews listener

            // Clear main UI areas and state
            chatArea.innerHTML = '';
            chatListContainer.innerHTML = '';
            allReviewsListContainer.innerHTML = ''; // Clear all reviews list
            activeChatId = null;
            currentChatHistory = [];
            allReviewsCache = []; // Clear reviews cache
            reviewSearchInput.value = ''; // Clear search

            if (user) {
                // --- User is logged IN ---
                currentUser = user;
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'inline-block';
                accountEmail.textContent = currentUser.email || currentUser.displayName || `User`;
                accountAvatar.textContent = (currentUser.displayName || currentUser.email || 'U')[0].toUpperCase();
                accountPlan.textContent = "Firebase User";
                startChatButton.disabled = false;
                decreaseTextBtn.disabled = false;
                increaseTextBtn.disabled = false;
                themeToggleButton.disabled = false;
                viewAllReviewsBtn.disabled = false; // Enable reviews button

                sendButton.disabled = false; // Enable based on chat selection later in setLoadingState
                userInput.disabled = false;  // Enable based on chat selection later in setLoadingState
                userInput.placeholder = "Select or create a chat"; // Initial placeholder
                inputContainer.style.display = 'block';
                suggestionsContainer.style.display = 'flex';

                loadUserSettings(currentUser.uid);
                loadAndListenForChats(currentUser.uid); // This might load the first chat and trigger message loading

                // Listen for saved reviews in the background
                listenForAllReviews(currentUser.uid);

                // Initially switch to chat view after login
                switchView('chat');

            } else {
                // --- User is logged OUT ---
                currentUser = null;
                loginBtn.style.display = 'inline-block';
                logoutBtn.style.display = 'none';
                accountEmail.textContent = "Not logged in";
                accountAvatar.textContent = '?';
                accountPlan.textContent = "";
                startChatButton.disabled = true;
                decreaseTextBtn.disabled = true;
                increaseTextBtn.disabled = true;
                themeToggleButton.disabled = true;
                viewAllReviewsBtn.disabled = true; // Disable reviews button

                sendButton.disabled = true;
                userInput.disabled = true;
                userInput.placeholder = "Please log in";
                inputContainer.style.display = 'none';
                suggestionsContainer.style.display = 'none';

                renderGreetingOrLoginPrompt(); // Show login prompt in chat area
                chatListContainer.innerHTML = '<div style="padding:10px;color:var(--text-secondary);font-size:0.9em;">Please log in to see chats.</div>';
                allReviewsListContainer.innerHTML = '<div class="info-message">Please log in to see saved reviews.</div>';

                currentTheme = 'light'; applyTheme();
                currentTextSizeMultiplier = 1.0; applyTextSize();

                // Ensure back in chat view on logout
                switchView('chat');
            }
            // Update loading state AFTER main setup
            setLoadingState(false);
        }

        // Helper to show greeting or login message
        function renderGreetingOrLoginPrompt() { /* ... (Unchanged) ... */
            chatArea.innerHTML = '';
            const g = document.createElement('div');
            g.classList.add('greeting');
            if (currentUser) {
                 g.innerHTML = `<span class="asterisk">*</span>Good day, ${currentUser.displayName || 'User'}!`;
                 chatArea.appendChild(g);
                 if (!activeChatId) { // Only show if no chat is active
                    displayMessage("Select a chat from the sidebar or start a new one.", 'ai', ['info-message']);
                 }
            } else {
                g.innerHTML = `<span class="asterisk">*</span>Welcome!`;
                chatArea.appendChild(g);
                displayMessage("Please log in using Google (button in the sidebar) to start chatting or view your history.", 'ai', ['info-message']);
            }
            scrollToBottom(true);
        }


        // --- Settings (Theme/Text Size) --- (Unchanged)
        async function loadUserSettings(userId) { /* ... */ }
        async function saveUserSettings() { /* ... */ }
        function applyTheme() { /* ... */ }
        function toggleTheme() { /* ... */ }
        function applyTextSize() { /* ... */ }
        function adjustTextSize(change) { /* ... */ }

        // --- Chat Storage & Loading (Firestore - Modified for Delete) ---

        function loadAndListenForChats(userId) {
            if (chatListListener) { chatListListener(); chatListListener = null; }

            const chatsRef = db.collection('chats')
                               .where('userId', '==', userId)
                               .orderBy('lastUpdated', 'desc');

            console.log(`Listening for chats for user ${userId}`);
            chatListListener = chatsRef.onSnapshot(snapshot => {
                const chats = [];
                snapshot.forEach(doc => {
                    chats.push({ id: doc.id, ...doc.data() });
                });
                console.log("Received chat list snapshot:", chats);
                renderSidebarChatList(chats); // Render sidebar with new data

                let chatToLoadId = null;
                let activeChatStillExists = chats.some(c => c.id === activeChatId);

                if (activeChatStillExists) {
                    chatToLoadId = activeChatId; // Keep current chat active
                     // Ensure highlight is correct even if no ID change occurred
                    highlightActiveChatInSidebar();
                } else if (chats.length > 0) {
                    // Active chat was deleted or never set, load the newest one
                    chatToLoadId = chats[0].id;
                } else {
                    // No chats exist for the user
                    chatToLoadId = null;
                }

                // Switch chat content only if the target ID has changed or become null
                if (chatToLoadId !== activeChatId) {
                     if (chatToLoadId) {
                         console.log("Switching active chat content to:", chatToLoadId);
                         switchChat(chatToLoadId); // This handles listeners and UI update
                     } else {
                         // No chats left, clear the chat area and stop message listener
                         console.log("No chats available for user.");
                         activeChatId = null;
                         currentChatHistory = [];
                         if (activeChatListener) { activeChatListener(); activeChatListener = null; }
                         renderGreetingOrLoginPrompt();
                         highlightActiveChatInSidebar(); // Clear highlight
                         setLoadingState(false); // Ensure input is disabled if no chat selected
                     }
                } else if (!activeChatStillExists && chats.length === 0) {
                    // Special case: The *only* chat was deleted
                    activeChatId = null;
                    currentChatHistory = [];
                    if (activeChatListener) { activeChatListener(); activeChatListener = null; }
                    renderGreetingOrLoginPrompt();
                    highlightActiveChatInSidebar(); // Clear highlight
                    setLoadingState(false);
                }

            }, error => {
                console.error("Error listening for chats:", error);
                displayError("Could not load chat list.");
                chatListContainer.innerHTML = '<div style="padding:10px;color:var(--text-secondary);font-size:0.9em;">Error loading chats.</div>';
            });
        }

        // Modified to include delete button
        function renderSidebarChatList(chats) {
            chatListContainer.innerHTML = '';
            if (!currentUser) { /* ... login prompt ... */ return; }
            if (chats.length === 0) {
                 const i = document.createElement('div');
                 i.textContent = "No chats yet.";
                 i.style.cssText = "padding:10px;color:var(--text-secondary);font-size:0.9em;";
                 chatListContainer.appendChild(i);
            } else {
                chats.forEach(c => {
                    const item = document.createElement('div');
                    item.classList.add('chat-list-item');
                    item.dataset.id = c.id;

                    const titleSpan = document.createElement('span');
                    titleSpan.classList.add('chat-title');
                    titleSpan.textContent = c.title || '(Untitled)';
                    titleSpan.title = c.title || '(Untitled)'; // Tooltip for long titles

                    const deleteBtn = document.createElement('button');
                    deleteBtn.classList.add('delete-chat-btn');
                    deleteBtn.innerHTML = DELETE_ICON_HTML;
                    deleteBtn.title = "Delete chat";
                    deleteBtn.dataset.id = c.id; // Add id to button for easier handling

                    item.appendChild(titleSpan);
                    item.appendChild(deleteBtn);
                    chatListContainer.appendChild(item);
                });
            }
            highlightActiveChatInSidebar();
        }

        function highlightActiveChatInSidebar() { /* ... (Unchanged) ... */
             const items = chatListContainer.querySelectorAll('.chat-list-item');
             items.forEach(item => {
                 item.classList.toggle('active', item.dataset.id === activeChatId);
             });
         }

        async function createNewChat() { /* ... (Unchanged, listener handles the rest) ... */
            if (!currentUser) { displayError("Please log in to create a new chat."); return; }
            setLoadingState(true, "Creating chat...");
            const newChatRef = db.collection('chats').doc();
            const timestamp = firebase.firestore.FieldValue.serverTimestamp();
            try {
                await newChatRef.set({
                    userId: currentUser.uid,
                    title: NEW_CHAT_TITLE,
                    createdAt: timestamp,
                    lastUpdated: timestamp
                });
                console.log("New chat document created:", newChatRef.id);
                // Listener (loadAndListenForChats) will pick it up and make it active
            } catch (error) {
                console.error("Error creating new chat:", error);
                displayError("Failed to create chat.");
            } finally {
                setLoadingState(false);
                userInput.focus();
            }
        }

        // Modified to handle delete button clicks
        function handleChatListClick(event) {
            const deleteButton = event.target.closest('.delete-chat-btn');
            const chatItem = event.target.closest('.chat-list-item');

            if (deleteButton) {
                const chatIdToDelete = deleteButton.dataset.id;
                const chatTitle = chatItem?.querySelector('.chat-title')?.textContent || 'this chat';
                if (chatIdToDelete && confirm(`Are you sure you want to permanently delete "${chatTitle}" and all its messages?`)) {
                    deleteChat(chatIdToDelete);
                }
            } else if (chatItem) {
                const clickedId = chatItem.dataset.id;
                if (clickedId && clickedId !== activeChatId) {
                    console.log("Chat list item selected:", clickedId);
                    switchChat(clickedId);
                }
            }
        }

        // New function to delete chat and its subcollection
        async function deleteChat(chatId) {
            if (!currentUser || !chatId) return;
            console.log(`Attempting to delete chat: ${chatId}`);
            setLoadingState(true, `Deleting chat...`);

            const chatDocRef = db.collection('chats').doc(chatId);
            const messagesColRef = chatDocRef.collection('messages');

            try {
                // 1. Delete messages subcollection (important!)
                await deleteSubcollection(messagesColRef);
                console.log(`Messages subcollection deleted for chat ${chatId}`);

                // 2. Delete the chat document itself
                await chatDocRef.delete();
                console.log(`Chat document ${chatId} deleted`);

                // 3. UI update is handled by the chat list listener reacting to the deletion.
                //    It will automatically select the next newest chat or show the empty state.

                // Optional: Clear related data if needed (e.g., test reviews linked to this chat - not implemented)

            } catch (error) {
                console.error(`Error deleting chat ${chatId}:`, error);
                displayError(`Failed to delete chat: ${error.message}`);
            } finally {
                setLoadingState(false);
            }
        }

        // Helper to delete all documents in a subcollection
        async function deleteSubcollection(collectionRef, batchSize = 100) {
            const query = collectionRef.orderBy('__name__').limit(batchSize);

            return new Promise((resolve, reject) => {
                deleteQueryBatch(query, resolve, reject);
            });
        }

        async function deleteQueryBatch(query, resolve, reject) {
            try {
                const snapshot = await query.get();

                // When there are no documents left, we are done
                if (snapshot.size === 0) {
                    resolve();
                    return;
                }

                // Delete documents in a batch
                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();

                // Recurse on the next process tick, to avoid exploding the stack.
                process.nextTick(() => {
                    deleteQueryBatch(query, resolve, reject);
                });

            } catch(error) {
                 console.error("Error deleting batch in subcollection:", error);
                 reject(error);
            }
        }
        // Workaround if process.nextTick isn't available in browser directly
        async function deleteQueryBatch(query, resolve, reject) {
             try {
                 const snapshot = await query.get();
                 if (snapshot.size === 0) {
                     resolve();
                     return;
                 }
                 const batch = db.batch();
                 snapshot.docs.forEach(doc => batch.delete(doc.ref));
                 await batch.commit();
                 // Use setTimeout for recursion in browser
                 setTimeout(() => deleteQueryBatch(query, resolve, reject), 0);
             } catch (error) {
                 console.error("Error deleting batch in subcollection:", error);
                 reject(error);
             }
         }


        function switchChat(chatId) {
             if (!currentUser || !chatId) return; // || chatId === activeChatId removed, listener handles no-op

             console.log("Switching to chat:", chatId);
             if (activeChatId !== chatId) { // Only proceed if ID is actually changing
                activeChatId = chatId;
                highlightActiveChatInSidebar();
                loadAndListenForActiveChat(chatId); // Load messages for the new chat
             }
             userInput.focus();
             setLoadingState(false); // Ensure input is enabled after switching
        }

        // --- Message Loading (Firestore) --- (Unchanged)
        function loadAndListenForActiveChat(chatId) {
            if (!currentUser || !chatId) { /* ... */ return; }
            if (activeChatListener) { activeChatListener(); activeChatListener = null; }

            highlightActiveChatInSidebar();
            const messagesRef = db.collection('chats').doc(chatId).collection('messages').orderBy('timestamp', 'asc');
            chatArea.innerHTML = ''; // Clear before loading
            const loadingMsg = displayMessage("Loading chat...", 'ai', ['thinking']);
            currentChatHistory = []; // Clear history before loading new chat

            console.log(`Listening for messages in chat ${chatId}`);
            activeChatListener = messagesRef.onSnapshot(snapshot => {
                console.log(`Received messages snapshot for chat ${chatId}:`, snapshot.size, "messages");
                removeMessageElement(loadingMsg);
                chatArea.innerHTML = ''; // Clear again before rendering batch
                currentChatHistory = []; // Reset and rebuild history

                if (snapshot.empty) {
                     renderGreetingOrLoginPrompt(); // Show greeting if chat is empty
                } else {
                    snapshot.forEach(doc => {
                        const msgData = doc.data();
                        const text = msgData.text || "";
                        const role = msgData.role || "model";
                         // Add to API history format
                         currentChatHistory.push({
                             role: (role === "model" ? "model" : "user"), // Ensure correct roles for API
                             parts: [{ text: text }]
                         });
                        displayMessage(text, role, [], null, msgData); // Display visually
                    });
                }
                scrollToBottom(true);
                setLoadingState(false); // Ensure input enabled after loading messages

            }, error => {
                console.error(`Error listening for messages in chat ${chatId}:`, error);
                displayError("Could not load messages for this chat.");
                removeMessageElement(loadingMsg);
                chatArea.innerHTML = '';
                currentChatHistory = [];
                setLoadingState(false); // Ensure interactable on error
            });
        }

        // --- Message Sending (Gemini API & Firestore Save - Title Update Refined) ---

        async function handleSendMessage() {
            const txt = userInput.value.trim();
            if (!API_KEY || !currentUser || !activeChatId || !txt || sendButton.disabled) return;

            const isMCQRequest = mcqModeCheckbox.checked;
            setLoadingState(true, "Sending...");
            const userMessageText = txt;

            userInput.value = '';
            autoGrowTextarea();
            if (isMCQRequest) mcqModeCheckbox.checked = false;

            const timestamp = firebase.firestore.FieldValue.serverTimestamp();
            const messagesColRef = db.collection('chats').doc(activeChatId).collection('messages');
            const chatDocRef = db.collection('chats').doc(activeChatId);

            // 1. Save user message
             const userMsgData = { role: "user", text: userMessageText, timestamp: timestamp };
             let userMsgRef;
             try {
                 userMsgRef = await messagesColRef.add(userMsgData); // Get ref if needed later
                 await chatDocRef.update({ lastUpdated: timestamp });
                 console.log("User message saved.");
             } catch(error) { /* ... error handling ... */ setLoadingState(false); return; }

             // --- Title Generation Trigger (User Message) ---
             // Check if title needs update *after* user message is saved, using chat history length *before* listener adds it
             const historyBeforeUserMsg = [...currentChatHistory]; // Snapshot before listener updates
             const isFirstUserMessage = historyBeforeUserMsg.filter(m => m.role === 'user').length === 0;
             if (isFirstUserMessage) {
                 try {
                     const chatDocSnap = await chatDocRef.get();
                     if (chatDocSnap.exists() && chatDocSnap.data().title === NEW_CHAT_TITLE) {
                         const generatedTitle = generateChatTitleFromText(userMessageText); // Use simple generation
                         if (generatedTitle !== NEW_CHAT_TITLE) {
                             await updateActiveChatTitle(generatedTitle);
                         }
                     }
                 } catch (titleError) { console.error("Error checking/updating title after user msg:", titleError); }
             }
             // --- End Title Generation ---

            // 3. Prepare for API call
            const thinking = displayMessage("Thinking", 'ai', ['thinking']);
            const requestHistory = [
                 ...currentChatHistory, // History built by listener (might not include this latest user msg yet)
                 { role: "user", parts: [{ text: userMessageText }] } // Add it explicitly for the API call
                ];

            let modifiedPrompt = userMessageText;
            if (isMCQRequest) { /* ... JSON prompt modification (Unchanged) ... */
                 modifiedPrompt = `${userMessageText}\n\nPlease provide the response strictly in JSON format...`;
                 requestHistory[requestHistory.length - 1] = { role: "user", parts: [{ text: modifiedPrompt }] };
             }

            // 4. Call Gemini API
            console.warn("Calling Gemini API using client-side key. Replace with Cloud Function.");
            try {
                const response = await fetch(API_URL_BASE + API_KEY, { /* ... (fetch options unchanged) ... */ });
                removeMessageElement(thinking);

                let aiMsgData = { role: "model", text: "", timestamp: firebase.firestore.FieldValue.serverTimestamp() };
                let aiResponseText = "";
                let isBlocked = false;

                if (!response.ok) { /* ... (Error handling unchanged) ... */
                    let err = { message: `API error (${response.status})` };
                    try { err = (await response.json()).error || err; } catch { /* Ignore */ }
                    aiMsgData.text = `Error: ${err.message || "Unknown API error"}`;
                    displayError(aiMsgData.text); // Show error in chat
                    if(response.status===400 && err.message?.toLowerCase().includes('api key not valid')){ /* ... clear key ... */ }
                } else {
                    const data = await response.json();
                    if (data.promptFeedback?.blockReason) { /* ... (Block handling unchanged) ... */
                        aiResponseText = `Blocked: ${data.promptFeedback.blockReason}`;
                        aiMsgData.text = aiResponseText;
                        isBlocked = true;
                        displayMessage(aiResponseText,'ai',['error-message']); // Show block in chat
                    } else if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
                        aiResponseText = data.candidates[0].content.parts[0].text;
                        aiMsgData.text = aiResponseText; // Base text for saving

                        if (isMCQRequest && !isBlocked) { /* ... (MCQ Parsing unchanged) ... */
                             try { /* ... */
                                 const mcqs = JSON.parse(jsonString);
                                 if (/* validation */) {
                                     const summaryText = `Generated ${mcqs.length} MCQs...`;
                                     aiMsgData.text = summaryText; // Save summary
                                     aiMsgData.mcqData = mcqs; // Save full MCQ data
                                     processedForMCQ = true;
                                 } /* ... */
                             } catch (parseError) { /* ... */ }
                        }
                        // If not processed as MCQ, aiMsgData.text holds the normal response.
                    } else { /* ... (Handle unexpected format) ... */
                         aiMsgData.text = "Error: Could not extract valid text from response.";
                         displayError(aiMsgData.text);
                    }
                }

                 // 5. Save AI response/error to Firestore
                 let aiMsgRef;
                 try {
                     aiMsgRef = await messagesColRef.add(aiMsgData);
                     await chatDocRef.update({ lastUpdated: firebase.firestore.FieldValue.serverTimestamp() });
                     console.log("AI response/error saved.");
                 } catch (saveError) { /* ... error handling ... */ }

                 // --- Title Generation Trigger (AI Response) ---
                 // If it was the *first* AI message AND title is still default, generate title
                 const historyAfterUserMsg = [...requestHistory]; // History including user msg sent to API
                 const isFirstAiMessage = historyAfterUserMsg.filter(m => m.role === 'model').length === 0;
                 if (isFirstAiMessage && !isBlocked && aiResponseText) {
                     try {
                         const chatDocSnap = await chatDocRef.get();
                         if (chatDocSnap.exists() && chatDocSnap.data().title === NEW_CHAT_TITLE) {
                             // Generate title based on User + AI response
                             const titleText = userMessageText + "\n" + aiResponseText;
                             const generatedTitle = generateChatTitleFromText(titleText);
                             if (generatedTitle !== NEW_CHAT_TITLE) {
                                 await updateActiveChatTitle(generatedTitle);
                             }
                         }
                     } catch (titleError) { console.error("Error checking/updating title after AI msg:", titleError); }
                 }
                 // --- End Title Generation ---


            } catch (error) { /* ... (Network/Script error handling unchanged) ... */
                 removeMessageElement(thinking);
                 const errorText = `Error: ${error.message || "Network error"}`;
                 displayError(errorText);
                 try { /* ... save error to Firestore ... */ } catch (saveError) { /* ... */ }
            } finally {
                setLoadingState(false);
                if (!isTestMode && !isReviewMode && !isAllReviewsMode) userInput.focus();
            }
        }

        // Refined simple title generation from text
        function generateChatTitleFromText(text) {
             if (!text) return NEW_CHAT_TITLE;
             // Remove potential markdown, newlines, trim, take first few words
             const cleanText = text.replace(/[*`#\n\r]/g, ' ').replace(/\s+/g, ' ').trim();
             const title = cleanText.split(' ').slice(0, 5).join(' ');
             // Limit length
             const maxLength = 40;
             return title.length > maxLength ? title.substring(0, maxLength - 3) + '...' : (title || NEW_CHAT_TITLE);
        }

         async function updateActiveChatTitle(newTitle) { /* ... (Unchanged) ... */
             if (!currentUser || !activeChatId || !newTitle || newTitle === NEW_CHAT_TITLE) return;
             const chatDocRef = db.collection('chats').doc(activeChatId);
             try {
                 await chatDocRef.update({ title: newTitle });
                 console.log(`Chat ${activeChatId} title updated to: ${newTitle}`);
                 // Listener updates sidebar
             } catch (error) { console.error("Error updating chat title:", error); }
         }


        // --- UI & Message Display ---
        function autoGrowTextarea() { /* ... (Unchanged) ... */ }
        function handleInputKeydown(event) { /* ... (Unchanged) ... */ }
        function handleSuggestionClick(event) { /* ... (Unchanged) ... */ }
        function displayError(text) { displayMessage(`Error: ${text}`, 'ai', ['error-message']); }
        function scrollToBottom(immediate = false) { chatArea.scrollTo({top:chatArea.scrollHeight,behavior:immediate?'auto':'smooth'}); }
        function removeMessageElement(element) { /* ... (Unchanged) ... */ }

        // Modified setLoadingState
        function setLoadingState(isLoading, message = "Generating...") {
            // Disable if loading OR if logged out
            const baseDisabled = isLoading || !currentUser;
            // Input/Send also disabled if no active chat selected
            const inputDisabled = baseDisabled || !activeChatId;

            userInput.disabled = inputDisabled;
            sendButton.disabled = inputDisabled;
            mcqModeCheckbox.disabled = inputDisabled;
            startChatButton.disabled = baseDisabled; // Can always start new chat if logged in & not loading
            viewAllReviewsBtn.disabled = baseDisabled; // Can view reviews if logged in & not loading

            // Update placeholder
            if (isLoading) {
                userInput.placeholder = message;
            } else if (!currentUser) {
                userInput.placeholder = "Please log in";
            } else if (!activeChatId) {
                userInput.placeholder = "Select or create a chat";
            } else {
                userInput.placeholder = "Enter prompt (Check 'MCQs?' to generate test)";
            }

             // Disable sidebar controls etc. if loading
             decreaseTextBtn.disabled = baseDisabled;
             increaseTextBtn.disabled = baseDisabled;
             themeToggleButton.disabled = baseDisabled;
             logoutBtn.disabled = isLoading; // Prevent logout during operation? Maybe not necessary.
        }

        // Modified switchView
        function switchView(viewName) {
            console.log("Switching view to:", viewName);
            chatView.classList.remove('active');
            reviewView.classList.remove('active');
            testView.classList.remove('active');
            allReviewsView.classList.remove('active'); // Deactivate all reviews view
            appContainer.classList.remove('hidden');

            isTestMode = false;
            isReviewMode = false;
            isAllReviewsMode = false; // Reset all view flags

            if(viewName==='test'){
                appContainer.classList.add('hidden'); // Overlay
                testView.classList.add('active');
                isTestMode=true;
            } else if(viewName==='review'){
                reviewView.classList.add('active');
                isReviewMode=true;
            } else if (viewName === 'allReviews') { // New case
                allReviewsView.classList.add('active');
                isAllReviewsMode = true;
                // Optional: Trigger fetch/render if not already listening
                if (!allReviewsListener && currentUser) {
                    listenForAllReviews(currentUser.uid); // Start listening if not already
                }
            } else { // Default to chat view
                chatView.classList.add('active');
                // Focus input only if coming back to chat view and logged in
                 if (currentUser && activeChatId) userInput.focus();
            }

            // Stop test timer if switching away from test view
            if (viewName !== 'test' && testTimerInterval) {
                clearInterval(testTimerInterval);
                testTimerInterval = null;
            }
        }

        // Modified displayMessage to handle MCQ button better
        function displayMessage(text, sender, cssClasses = [], appendHtml = null, messageData = null) {
            const element = document.createElement('div');
            element.classList.add('message', `${sender}-message`, ...cssClasses);

            let formattedText = text /* ... (formatting unchanged) ... */
                .replace(/</g, "<").replace(/>/g, ">")
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/```([\s\S]*?)```/g, (match, code) => `<pre><code>${code.replace(/</g, "<").replace(/>/g, ">")}</code></pre>`)
                .replace(/`([^`]+)`/g, (match, code) => `<code>${code.replace(/</g, "<").replace(/>/g, ">")}</code>`)
                .replace(/\n/g, '<br>');

            element.innerHTML = formattedText;

            // Handle MCQ offer (uses messageData from Firestore)
            if (messageData?.role === 'model' && messageData.mcqData && Array.isArray(messageData.mcqData)) {
                 console.log("Rendering MCQ offer button for message with MCQs:", messageData.mcqData.length);
                 const buttonContainer = document.createElement('div');
                 buttonContainer.style.marginTop = '10px';
                 const button = document.createElement('button');
                 button.classList.add('start-test-button');
                 button.textContent = `Start Mock Test (${messageData.mcqData.length} Questions)`;
                 // Store data needed to start test directly on the button for simplicity
                 button.dataset.mcqData = JSON.stringify(messageData.mcqData);
                 buttonContainer.appendChild(button);
                 element.appendChild(buttonContainer);
            } else if (appendHtml) { /* ... (appendHtml logic unchanged) ... */ }

            chatArea.appendChild(element);

            try { /* ... (MathJax typesetting unchanged) ... */
                 if (typeof MathJax !== "undefined" && MathJax.typesetPromise) {
                    MathJax.typesetPromise([element]).catch(err => console.error('MathJax typeset error:', err));
                 }
            } catch (e) { console.error("MathJax call failed:", e); }

            // scroll handled by listener
            return element;
        }


        // --- MCQ/Test Specific Functions ---

        // Modified to get data from button dataset
        function handleChatAreaClick(event) {
            if (event.target.classList.contains('start-test-button') && event.target.dataset.mcqData) {
                try {
                    const mcqs = JSON.parse(event.target.dataset.mcqData);
                    if (mcqs && Array.isArray(mcqs)) {
                        startMockTest(mcqs);
                    } else {
                        console.error("Invalid MCQ data on button.");
                        displayError("Could not start test: Invalid data.");
                    }
                } catch (e) {
                    console.error("Failed to parse MCQ data from button:", e);
                    displayError("Could not start test: Corrupted data.");
                }
            }
        }

        // Removed displayMCQOffer - button is now created directly in displayMessage

        function startMockTest(mcqs) { /* ... (Unchanged, but ensure testStartTime is reset) ... */
             if (!currentUser) { displayError("Please log in to start a test."); return; }
             if (!mcqs || mcqs.length === 0) { displayError("No questions available for this test."); return; }
             console.log("Starting mock test with", mcqs.length, "questions.");

             currentTestMCQs = mcqs; // Store the questions being used for this test run
             currentQuestionIndex = 0;
             userAnswers = new Array(mcqs.length).fill(null);
             reviewResultsCache = null; // Clear any previous review cache
             testStartTime = null; // Reset start time, will be set when timer starts

             switchView('test');
             displayTestQuestion(0);
             startTestTimer(); // Start timer which sets testStartTime
             testTitle.textContent = `Mock Test (${mcqs.length} Qs)`;
        }

        function displayTestQuestion(index) { /* ... (Unchanged) ... */ }
        function handleOptionSelect(optionIndex) { /* ... (Unchanged) ... */ }
        function handleTestNavigation(direction) { /* ... (Unchanged) ... */ }

        // Reset testStartTime when timer starts
        function startTestTimer() {
            if (testTimerInterval) clearInterval(testTimerInterval);
            testStartTime = Date.now(); // <<< SET START TIME HERE
            testTimer.textContent = `Time: 00:00`; // Reset display
            testTimerInterval = setInterval(() => {
                if (!testStartTime) return; // Guard against race conditions
                const elapsedSeconds = Math.floor((Date.now() - testStartTime) / 1000);
                const minutes = Math.floor(elapsedSeconds / 60).toString().padStart(2, '0');
                const seconds = (elapsedSeconds % 60).toString().padStart(2, '0');
                testTimer.textContent = `Time: ${minutes}:${seconds}`;
            }, 1000);
        }

        function submitTest() { /* ... (Unchanged) ... */ }

        // --- Single Test Review Functions --- (Unchanged)
        function displayReview(timeTakenMs) { /* ... (Builds reviewResultsCache) ... */ }
        function handleReviewFilterClick(event) { /* ... */ }
        function filterReviewItems(filter) { /* ... */ }
        function exitReview() { switchView('chat'); reviewResultsCache = null; }
        async function saveTestReviewToCloud() { /* ... (Uses reviewResultsCache) ... */ }


        // --- All Test Reviews Functions (NEW) ---

        // Navigate to the All Reviews view
        function showAllReviewsView() {
            if (!currentUser) { displayError("Please log in to view saved reviews."); return; }
            switchView('allReviews');
            // Data loading is handled by the listener or triggered in switchView if needed
        }

        // Listen for changes in the user's saved reviews
        function listenForAllReviews(userId) {
            if (allReviewsListener) { allReviewsListener(); allReviewsListener = null; } // Detach previous listener

            const reviewsRef = db.collection('testReviews')
                                 .where('userId', '==', userId)
                                 .orderBy('savedAt', 'desc'); // Newest first

            console.log(`Listening for saved reviews for user ${userId}`);
            allReviewsListContainer.innerHTML = '<div class="info-message">Loading saved reviews...</div>'; // Loading indicator

            allReviewsListener = reviewsRef.onSnapshot(snapshot => {
                allReviewsCache = []; // Clear cache before repopulating
                snapshot.forEach(doc => {
                    allReviewsCache.push({ id: doc.id, ...doc.data() });
                });
                console.log("Received all reviews snapshot:", allReviewsCache.length, "reviews");
                renderAllReviewsList(allReviewsCache); // Render the list
                handleAllReviewsSearch(); // Apply current search filter after rendering

            }, error => {
                console.error("Error listening for all reviews:", error);
                displayError("Could not load saved reviews.");
                allReviewsListContainer.innerHTML = '<div class="info-message error-message">Error loading reviews.</div>';
            });
        }

        // Render the list of all saved reviews
        function renderAllReviewsList(reviews) {
            allReviewsListContainer.innerHTML = ''; // Clear previous content
            if (reviews.length === 0) {
                allReviewsListContainer.innerHTML = '<div class="info-message">No test reviews saved yet.</div>';
                return;
            }

            reviews.forEach(review => {
                const item = document.createElement('div');
                item.classList.add('all-reviews-list-item');
                item.dataset.reviewId = review.id; // Store ID for actions

                 // Safely access data, provide defaults
                 const savedDate = review.savedAt?.toDate ? review.savedAt.toDate().toLocaleString() : (review.testDate ? new Date(review.testDate).toLocaleString() : 'Unknown Date');
                 const summary = review.summary || {};
                 const score = summary.score || 'N/A';
                 const correct = summary.correct ?? '?';
                 const incorrect = summary.incorrect ?? '?';
                 const skipped = summary.skipped ?? '?';
                 const time = summary.timeString || 'N/A';
                 const firstQuestion = review.questions?.[0]?.question || 'No question preview available.';

                item.innerHTML = `
                    <div class="review-item-header">
                        <span class="review-date">Saved: ${savedDate}</span>
                        <div class="review-summary-short">
                             <span>Score: ${score}</span>
                             <span class="score-correct">C: ${correct}</span>
                             <span class="score-incorrect">I: ${incorrect}</span>
                             <span class="score-skipped">S: ${skipped}</span>
                             <span>Time: ${time}</span>
                        </div>
                    </div>
                    <div class="review-item-details-preview">${firstQuestion.replace(/<br>/g, ' ')}</div>
                    <div class="review-item-actions">
                        <button class="reattempt-btn reattempt-full" data-review-id="${review.id}" data-reattempt-type="full">Reattempt Full</button>
                        <button class="reattempt-btn reattempt-mistakes" data-review-id="${review.id}" data-reattempt-type="mistakes">Reattempt Mistakes</button>
                        <button class="reattempt-btn reattempt-skipped" data-review-id="${review.id}" data-reattempt-type="skipped">Reattempt Skipped</button>
                        <!-- Maybe add a 'View Details' button later -->
                    </div>
                `;
                allReviewsListContainer.appendChild(item);
            });
            // Apply MathJax if needed (if question preview uses it - less likely)
             try { if (typeof MathJax !== "undefined" && MathJax.typesetPromise) { MathJax.typesetPromise(allReviewsListContainer.querySelectorAll('.review-item-details-preview')).catch(err => console.error('MathJax typeset error:', err)); } } catch (e) { console.error("MathJax call failed:", e); }

        }

        // Handle search input changes
        function handleAllReviewsSearch() {
            const searchTerm = reviewSearchInput.value.toLowerCase().trim();
            const items = allReviewsListContainer.querySelectorAll('.all-reviews-list-item');
            let visibleCount = 0;

            items.forEach(item => {
                const reviewId = item.dataset.reviewId;
                const reviewData = allReviewsCache.find(r => r.id === reviewId);
                let isMatch = true; // Show by default if search is empty

                if (searchTerm && reviewData?.questions) {
                    // Check if any question text matches the search term
                    isMatch = reviewData.questions.some(q =>
                        q.question?.toLowerCase().includes(searchTerm)
                    );
                }

                item.classList.toggle('hidden-by-search', !isMatch);
                if (isMatch) visibleCount++;
            });

            // Optional: Show message if no results found
            const noResultsMsg = allReviewsListContainer.querySelector('.no-search-results');
            if (searchTerm && visibleCount === 0 && !noResultsMsg) {
                const msgDiv = document.createElement('div');
                msgDiv.classList.add('info-message', 'no-search-results');
                msgDiv.textContent = 'No reviews match your search.';
                allReviewsListContainer.appendChild(msgDiv);
            } else if (noResultsMsg && (visibleCount > 0 || !searchTerm)) {
                noResultsMsg.remove();
            }
        }

        // Handle clicks on reattempt buttons
        function handleReattemptClick(event) {
            const button = event.target.closest('.reattempt-btn');
            if (button && button.dataset.reviewId && button.dataset.reattemptType) {
                const reviewId = button.dataset.reviewId;
                const reattemptType = button.dataset.reattemptType;
                const reviewData = allReviewsCache.find(r => r.id === reviewId);

                if (reviewData) {
                    startReattempt(reviewData, reattemptType);
                } else {
                    console.error(`Review data not found in cache for ID: ${reviewId}`);
                    displayError("Could not start reattempt: Review data missing.");
                }
            }
        }

        // Prepare and start a reattempt test
        function startReattempt(reviewData, reattemptType) {
            if (!reviewData || !reviewData.questions || reviewData.questions.length === 0) {
                 displayError("Cannot reattempt: No question data found in this review.");
                 return;
            }

            let questionsToReattempt = [];
            const originalQuestions = reviewData.questions;

            if (reattemptType === 'full') {
                questionsToReattempt = originalQuestions;
            } else if (reattemptType === 'mistakes') {
                questionsToReattempt = originalQuestions.filter(q => q.status === 'incorrect');
            } else if (reattemptType === 'skipped') {
                questionsToReattempt = originalQuestions.filter(q => q.status === 'skipped');
            }

            if (questionsToReattempt.length === 0) {
                 alert(`There are no ${reattemptType} questions to reattempt in this review.`);
                 return;
            }

            // Convert saved review questions back to the MCQ format expected by startMockTest
            const mcqsForTest = questionsToReattempt.map(q => {
                 if (!q.question || !Array.isArray(q.options) || !q.correctAnswer) {
                     console.warn("Skipping invalid question data during reattempt setup:", q);
                     return null; // Skip invalid question structure
                 }

                 // Find the correct answer letter/index based on the saved text
                 let correctAnswerLetter = "A"; // Default, should be overridden
                 const correctIndex = q.options.findIndex(opt => opt === q.correctAnswer);

                 if (correctIndex !== -1) {
                     correctAnswerLetter = String.fromCharCode('A'.charCodeAt(0) + correctIndex);
                 } else {
                     console.warn(`Could not find correct answer text "${q.correctAnswer}" in options for question: ${q.question.substring(0, 50)}...`);
                     // Decide how to handle: skip question, use default 'A', or mark somehow?
                     // For now, let's default to 'A' but log the warning.
                     correctAnswerLetter = "A";
                 }

                 return {
                     question: q.question,
                     options: q.options,
                     answer: correctAnswerLetter // The LETTER (A, B, C, D)
                 };
            }).filter(mcq => mcq !== null); // Remove any skipped invalid questions

            if (mcqsForTest.length === 0) {
                displayError("Could not prepare any valid questions for reattempt.");
                return;
            }

            console.log(`Starting reattempt (${reattemptType}) with ${mcqsForTest.length} questions.`);
            startMockTest(mcqsForTest); // Start the test with the filtered/reconstructed MCQs
        }


    </script>

</body>
</html>
