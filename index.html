<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ‡Æ§‡Æ≤‡Øà‡Æ™‡Øç‡Æ™‡ØÅ ‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ -->
    <title>Gemini Chat + Tests (v9 - Test List & Lang)</title>

    <!-- MathJax Configuration -->
    <script> window.MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],displayMath:[['$$','$$'],['\\[','\\]']]},svg:{fontCache:'global'},options:{skipHtmlTags:['script','noscript','style','textarea','pre','code']}}; </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <style>
        /* --- Styles (Test List View ‡ÆÆ‡Æ±‡Øç‡Æ±‡ØÅ‡ÆÆ‡Øç Language Toggle-‡Æï‡Øç‡Æï‡Ææ‡Æ© ‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡Æô‡Øç‡Æï‡Æ≥‡Øç) --- */
        :root {
             /* ... (‡ÆÆ‡ØÅ‡Æ®‡Øç‡Æ§‡Øà‡ÆØ theme variables ‡ÆÖ‡Æ™‡Øç‡Æ™‡Æü‡Æø‡ÆØ‡Øá) ... */
             --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; --sidebar-width: 260px; --message-font-size-base: 1rem;
             /* LIGHT */ --sidebar-bg: #f7f7f7; --main-bg: #ffffff; --input-bg: #ffffff; --border-color: #e0e0e0; --text-primary: #2c2c2c; --text-secondary: #5f5f5f; --text-placeholder: #999999; --accent-color: #d97a7a; --user-message-bg: #cce0ff; --user-message-text: #1c1c1c; --ai-message-bg: #f0f0f0; --ai-message-text: #2c2c2c; --button-bg: #f0f0f0; --button-hover-bg: #e0e0e0; --active-item-bg: #e0e0e0; --code-bg: #e8e8e8; --scrollbar-thumb: #ccc; --scrollbar-thumb-hover: #bbb; --app-outer-bg: #e8e8e8; --send-button-bg: var(--accent-color); --send-button-hover-bg: #c76b6b; --send-button-text: #ffffff; --error-bg: #ffebee; --error-text: #c62828; --error-border: #ef9a9a; --message-font-size: var(--message-font-size-base); --delete-button-color: #aaa; --delete-button-hover-color: #dc3545;
        }
        body.dark-theme {
            /* DARK */ --sidebar-bg: #2a2a2e; --main-bg: #1e1e1e; --input-bg: #2a2a2e; --border-color: #404040; --text-primary: #e0e0e0; --text-secondary: #a0a0a0; --text-placeholder: #777777; --accent-color: #e58b8b; --user-message-bg: #3a4a6b; --user-message-text: #e8e8e8; --ai-message-bg: #333333; --ai-message-text: #e0e0e0; --button-bg: #404040; --button-hover-bg: #505050; --active-item-bg: #454545; --code-bg: #2c2c2e; --scrollbar-thumb: #555; --scrollbar-thumb-hover: #666; --app-outer-bg: #121212; --send-button-bg: var(--accent-color); --send-button-hover-bg: #f09f9f; --send-button-text: #1e1e1e; --error-bg: #5c2b2b; --error-text: #ffcdd2; --error-border: #8c4343; --delete-button-color: #666; --delete-button-hover-color: #f09f9f;
        }
        body { font-family: var(--font-family); margin: 0; padding: 0; background-color: var(--app-outer-bg); color: var(--text-primary); font-size: 15px; transition: background-color 0.3s ease, color 0.3s ease; }

        /* --- Layout & Structure --- */
        .app-container { display: flex; height: 100vh; width: 100vw; overflow: hidden; } .app-container.hidden { display: none; }
        .sidebar { width: var(--sidebar-width); background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 15px 0; box-sizing: border-box; flex-shrink: 0; transition: background-color 0.3s ease, border-color 0.3s ease; }
        .main-container { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; overflow: hidden; position: relative; }
        /* Views */
        .main-content, .review-view, .test-list-view { /* test-list-view ‡Æö‡Øá‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ */
            display: none; flex-direction: column; background-color: var(--main-bg);
            height: 100%; width: 100%; overflow: hidden; transition: background-color 0.3s ease;
        }
        .main-content.active, .review-view.active, .test-list-view.active { /* test-list-view ‡Æö‡Øá‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ */
            display: flex;
        }
        .chat-area { flex-grow: 1; overflow-y: auto; padding: 30px 10% 20px; display: flex; flex-direction: column; max-width: 800px; margin: 0 auto; width: 80%; }
        .input-container { padding: 20px 10%; border-top: 1px solid var(--border-color); background-color: var(--input-bg); max-width: 800px; margin: 0 auto; width: 80%; transition: background-color 0.3s ease, border-color 0.3s ease; display: none; }

        /* --- Sidebar Elements --- */
         .sidebar-header { padding: 10px 20px; font-size: 1.1em; font-weight: 600; color: var(--text-primary); }
         .sidebar-button { /* ‡Æ™‡Øä‡Æ§‡ØÅ‡Æµ‡Ææ‡Æ© ‡Æ∏‡Øç‡Æü‡Øà‡Æ≤‡Øç */
             display: flex; align-items: center; gap: 8px; background-color: var(--main-bg); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 8px; padding: 10px 15px; margin: 5px 15px; font-size: 0.95em; font-weight: 500; cursor: pointer; text-align: left; transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
         }
         .sidebar-button:hover { background-color: var(--button-hover-bg); }
         .sidebar-button svg { fill: currentColor; width: 16px; height: 16px; }
         .sidebar-button:disabled { opacity: 0.6; cursor: not-allowed; }
         .sidebar-section-title { padding: 15px 20px 5px; font-size: 0.85em; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
         .chat-list { max-height: calc(100vh - 450px); /* ‡Æâ‡ÆØ‡Æ∞‡ÆÆ‡Øç ‡Æö‡Æ∞‡Æø‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ */ overflow-y: auto; padding: 0 15px; margin-bottom: 10px; }
         .chat-list::-webkit-scrollbar { width: 6px; } .chat-list::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 3px;} .chat-list::-webkit-scrollbar-thumb:hover { background: var(--scrollbar-thumb-hover); }
         .chat-list-item { padding: 8px 30px 8px 10px; margin-bottom: 4px; border-radius: 6px; font-size: 0.9em; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-secondary); transition: background-color 0.2s ease, color 0.2s ease; position: relative; }
         .chat-list-item:hover { background-color: var(--button-hover-bg); color: var(--text-primary); }
         .chat-list-item.active { background-color: var(--active-item-bg); color: var(--text-primary); font-weight: 500; }
         .delete-chat-button { position: absolute; right: 6px; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; background: none; border: none; color: var(--delete-button-color); cursor: pointer; font-size: 1.3em; line-height: 1; padding: 0; display: none; opacity: 0.7; transition: color 0.2s ease, opacity 0.2s ease; }
         .chat-list-item:hover .delete-chat-button { display: block; }
         .delete-chat-button:hover { color: var(--delete-button-hover-color); opacity: 1; }
         .sidebar-footer { border-top: 1px solid var(--border-color); padding: 10px 15px; margin-top: auto; /* Footer-‡Æê ‡Æï‡ØÄ‡Æ¥‡Øá ‡Æ§‡Æ≥‡Øç‡Æ≥ */ transition: border-color 0.3s ease;}
         .sidebar-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px; /* Wrap controls */ }
         .control-group span { font-size: 0.85em; color: var(--text-secondary); margin-right: 5px; }
         .control-group button { background: var(--button-bg); border: 1px solid var(--border-color); color: var(--text-secondary); border-radius: 4px; padding: 2px 8px; margin-left: 5px; cursor: pointer; font-size: 1.1em; line-height: 1; transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease; }
         .control-group button:hover { background-color: var(--button-hover-bg); color: var(--text-primary); }
         .control-group button:disabled { opacity: 0.6; cursor: not-allowed; }
         #language-toggle-button { font-size: 0.9em; padding: 3px 10px; font-weight: bold; } /* ‡ÆÆ‡Øä‡Æ¥‡Æø ‡Æ™‡Øä‡Æ§‡Øç‡Æ§‡Ææ‡Æ©‡Øç ‡Æ∏‡Øç‡Æü‡Øà‡Æ≤‡Øç */
         .account-info { display: flex; align-items: center; gap: 10px; font-size: 0.9em; margin-top: 10px; }
         .account-avatar { width: 30px; height: 30px; border-radius: 50%; background-color: #6c757d; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; }
         .account-details { overflow: hidden; }
         .account-email { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-primary); }
         .account-plan { font-size: 0.85em; color: var(--text-secondary); }
         #auth-controls { margin-top: 15px; text-align: center; }
         #auth-controls button { background-color: var(--button-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; padding: 8px 15px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s ease; }
         #auth-controls button:hover { background-color: var(--button-hover-bg); }
         #logout-btn { display: none; }

        /* --- Chat Area Elements --- */
        .greeting { font-size: 1.8em; font-weight: 600; margin-bottom: 40px; color: var(--text-primary); } .greeting .asterisk { color: var(--accent-color); font-size: 1.2em; margin-right: 5px; display: inline-block; vertical-align: middle; }
        .message { padding: 12px 18px; border-radius: 18px; max-width: 80%; word-wrap: break-word; line-height: 1.6; margin-bottom: 15px; font-size: var(--message-font-size); transition: background-color 0.3s ease, color 0.3s ease; }
        /* ... (‡ÆÆ‡Æ±‡Øç‡Æ± message styles ‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡ÆÆ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà) ... */
        .user-message { background-color: var(--user-message-bg); color: var(--user-message-text); align-self: flex-end; border-bottom-right-radius: 5px; }
        .ai-message { background-color: var(--ai-message-bg); color: var(--ai-message-text); align-self: flex-start; border-bottom-left-radius: 5px; }
        .ai-message strong { font-weight: 600; } .ai-message em { font-style: italic; }
        .ai-message pre { background-color: var(--code-bg); color: var(--text-primary); padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 0.9em; transition: background-color 0.3s ease, color 0.3s ease;}
        .ai-message code { font-family: monospace; background-color: var(--code-bg); color: var(--text-primary); padding: 2px 4px; border-radius: 3px; transition: background-color 0.3s ease, color 0.3s ease;}
        .ai-message pre code { background-color: transparent; padding: 0; }
        .ai-message.thinking { background-color: transparent; color: var(--text-secondary); font-style: italic; }
        .error-message { background-color: var(--error-bg); color: var(--error-text); border: 1px solid var(--error-border); align-self: flex-start; transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;}
        .info-message { text-align: center; color: var(--text-secondary); padding: 50px 20px; font-style: italic; }
        .message mjx-container { color: inherit !important; font-size: inherit !important; }

        /* --- Input Area Elements --- */
        .suggestions { display: none; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .suggestion-chip { background-color: var(--button-bg); border: 1px solid var(--border-color); color: var(--text-secondary); border-radius: 16px; padding: 8px 15px; font-size: 0.9em; cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease; }
        .suggestion-chip:hover { background-color: var(--button-hover-bg); color: var(--text-primary); }
        .input-box { display: flex; align-items: flex-end; background-color: var(--main-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 5px 5px 5px 15px; position: relative; transition: background-color 0.3s ease, border-color 0.3s ease; }
        .input-box:focus-within { border-color: var(--accent-color); }
        #user-input { flex-grow: 1; border: none; outline: none; padding: 10px 5px; font-size: 1rem; background-color: transparent; resize: none; min-height: 48px; max-height: 250px; line-height: 1.5; color: var(--text-primary); font-family: var(--font-family); }
        #user-input::placeholder { color: var(--text-placeholder); }
        .mcq-mode-control { display: flex; align-items: center; margin-left: 10px; padding-bottom: 8px; flex-shrink: 0; }
        .mcq-mode-control input[type="checkbox"] { margin-right: 5px; accent-color: var(--accent-color); cursor: pointer;}
        .mcq-mode-control label { font-size: 0.85em; color: var(--text-secondary); cursor: pointer; user-select: none;}
        #send-button { background-color: var(--send-button-bg); color: var(--send-button-text); border: none; border-radius: 8px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-left: 10px; transition: background-color 0.2s ease; padding: 0; flex-shrink: 0; }
        #send-button:hover:not(:disabled) { background-color: var(--send-button-hover-bg); }
        #send-button:disabled { background-color: #cccccc; cursor: not-allowed; opacity: 0.6; }
        #send-button svg { width: 20px; height: 20px; fill: currentColor; }
        .thinking::after { content: ' .'; animation: dots 1s steps(3, end) infinite; display: inline-block; }
        @keyframes dots { 0%, 20% { content: ' .'; } 40% { content: ' ..'; } 60%, 100% { content: ' ...'; } }
         .start-test-button { background-color: var(--accent-color); color: var(--send-button-text); border: none; border-radius: 6px; padding: 8px 15px; margin-top: 10px; cursor: pointer; font-weight: 500; display: inline-block; transition: background-color 0.2s ease; }
         .start-test-button:hover { background-color: var(--send-button-hover-bg); }

        /* --- Mock Test View Styles --- */
        /* ... (‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡ÆÆ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà) ... */
        .mock-test-view { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--main-bg); z-index: 100; flex-direction: column; padding: 20px; box-sizing: border-box; transition: background-color 0.3s ease; }
        .mock-test-view.active { display: flex; }
        .test-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .test-header h2 { margin: 0; font-size: 1.3em; color: var(--text-primary); }
        .test-info span { margin-left: 15px; font-size: 0.95em; color: var(--text-secondary); }
        .test-content { flex-grow: 1; overflow-y: auto; padding: 10px 20px; }
        .test-question-container { margin-bottom: 25px; }
        .test-question-number { font-weight: bold; margin-bottom: 8px; color: var(--text-secondary); }
        .test-question { font-size: 1.1em; line-height: 1.5; margin-bottom: 15px; color: var(--text-primary); }
        .test-options label { display: block; margin-bottom: 12px; background-color: var(--button-bg); padding: 12px 15px; border-radius: 6px; border: 1px solid var(--border-color); cursor: pointer; transition: background-color 0.2s ease, border-color 0.2s ease; color: var(--text-primary); }
        .test-options label:hover { background-color: var(--button-hover-bg); }
        .test-options input[type="radio"] { margin-right: 10px; accent-color: var(--accent-color); cursor: pointer;}
        .test-navigation { display: flex; justify-content: space-between; padding-top: 15px; border-top: 1px solid var(--border-color); margin-top: auto; flex-shrink: 0; }
        .test-navigation button { background-color: var(--button-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; padding: 10px 20px; cursor: pointer; font-size: 0.95em; transition: background-color 0.2s ease; }
        .test-navigation button:hover:not(:disabled) { background-color: var(--button-hover-bg); }
        .test-navigation button#submit-test-btn { background-color: var(--accent-color); color: var(--send-button-text); border-color: var(--accent-color); }
        .test-navigation button#submit-test-btn:hover:not(:disabled) { background-color: var(--send-button-hover-bg); }
        .test-navigation button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* --- Review View Styles --- */
        /* ... (Save ‡Æ™‡Øä‡Æ§‡Øç‡Æ§‡Ææ‡Æ©‡Øç disable/enable ‡ÆÆ‡Æü‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡ÆÆ‡ØÅ‡Æï‡Øç‡Æï‡Æø‡ÆØ‡ÆÆ‡Øç) ... */
        .review-view { padding: 20px; box-sizing: border-box; background-color: var(--main-bg); flex-grow: 1; display: flex; flex-direction: column; } /* Flex grow */
        .review-header { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .review-header h2 { margin: 0 0 10px 0; font-size: 1.3em; color: var(--text-primary); }
        .review-summary span { margin-right: 20px; font-size: 1em; color: var(--text-primary); }
        .review-summary .score-correct { color: #28a745; font-weight: bold;} .review-summary .score-incorrect { color: #dc3545; font-weight: bold;} .review-summary .score-skipped { color: #fd7e14; font-weight: bold;}
        .review-filters { margin-bottom: 15px; flex-shrink: 0; }
        .review-filters button { background-color: var(--button-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; padding: 5px 12px; margin-right: 8px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s ease, border-color 0.2s ease; }
        .review-filters button:hover { background-color: var(--button-hover-bg); }
        .review-filters button.active-filter { background-color: var(--accent-color); color: var(--send-button-text); border-color: var(--accent-color);}
        .review-content { flex-grow: 1; overflow-y: auto; padding-right: 10px; } /* Scrollable content */
        .review-item { margin-bottom: 15px; padding: 15px; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--button-bg); transition: background-color 0.3s ease, border-color 0.3s ease; }
        .review-item.hidden-by-filter { display: none; }
        .review-item-qnum { font-weight: bold; margin-bottom: 8px; color: var(--text-secondary); }
        .review-item-question { margin-bottom: 10px; line-height: 1.5; color: var(--text-primary); }
        .review-item-details span { display: block; margin-bottom: 5px; font-size: 0.95em; color: var(--text-primary); }
        .review-item-details .correct-answer { color: #28a745; font-weight: bold; }
        .review-item-details .user-answer-correct { color: #28a745; } .review-item-details .user-answer-incorrect { color: #dc3545; text-decoration: line-through; } .review-item-details .user-answer-skipped { color: #fd7e14; font-style: italic; }
        .review-footer { text-align: center; padding-top: 20px; border-top: 1px solid var(--border-color); margin-top: auto; flex-shrink: 0; display: flex; justify-content: center; gap: 15px; }
        #exit-review-btn, #save-review-btn { background-color: var(--accent-color); color: var(--send-button-text); border: none; border-radius: 6px; padding: 10px 25px; cursor: pointer; font-size: 1em; transition: background-color 0.2s ease; }
        #exit-review-btn:hover, #save-review-btn:hover:not(:disabled) { background-color: var(--send-button-hover-bg); }
        #save-review-btn { background-color: var(--button-bg); color: var(--text-primary); border: 1px solid var(--border-color); }
        #save-review-btn:hover:not(:disabled) { background-color: var(--button-hover-bg); }
        #save-review-btn:disabled { opacity: 0.6; cursor: not-allowed; background-color: #cccccc; border-color: #aaaaaa; }

        /* --- Test List View Styles (‡Æ™‡ØÅ‡Æ§‡Æø‡Æ§‡ØÅ) --- */
        .test-list-view { padding: 20px; box-sizing: border-box; background-color: var(--main-bg); flex-grow: 1; display: flex; flex-direction: column; }
        .test-list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; flex-wrap: wrap; gap: 10px; }
        .test-list-header h2 { margin: 0; font-size: 1.3em; color: var(--text-primary); }
        #test-search-input { padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.95em; background-color: var(--input-bg); color: var(--text-primary); min-width: 250px; }
        .test-list-content { flex-grow: 1; overflow-y: auto; padding-right: 10px; }
        .test-list-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--button-bg); transition: background-color 0.3s ease, border-color 0.3s ease; flex-wrap: wrap; gap: 10px; }
        .test-list-item.hidden-by-search { display: none; }
        .test-list-info { font-size: 0.95em; color: var(--text-secondary); flex-grow: 1; }
        .test-list-info strong { color: var(--text-primary); }
        .test-list-actions button { background-color: var(--button-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; padding: 6px 12px; margin-left: 8px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s ease; }
        .test-list-actions button:hover { background-color: var(--button-hover-bg); }
        .test-list-actions .retake-btn { border-color: var(--accent-color); color: var(--accent-color); }
        .test-list-actions .retake-btn:hover { background-color: var(--accent-color); color: var(--send-button-text); }
        .test-list-footer { text-align: center; padding-top: 20px; border-top: 1px solid var(--border-color); margin-top: auto; flex-shrink: 0; }
        .test-list-footer button { background-color: var(--accent-color); color: var(--send-button-text); border: none; border-radius: 6px; padding: 10px 25px; cursor: pointer; font-size: 1em; transition: background-color 0.2s ease; }
        .test-list-footer button:hover { background-color: var(--send-button-hover-bg); }

    </style>
</head>
<body>

    <div class="app-container" id="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <!-- data-lang-key attributes ‡Æö‡Øá‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ© -->
            <div class="sidebar-header" data-lang-key="sidebarHeader">Gemini Chat</div>
            <button class="sidebar-button" id="start-chat" data-lang-key="startChatButtonText" disabled>
                 <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg>
                 <span data-lang-key="startChatButtonText">Start new chat</span>
            </button>
            <!-- "My Tests" ‡Æ™‡Øä‡Æ§‡Øç‡Æ§‡Ææ‡Æ©‡Øç ‡Æö‡Øá‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ -->
            <button class="sidebar-button" id="show-tests-btn" data-lang-key="myTestsButtonText" disabled>
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"></path></svg>
                <span data-lang-key="myTestsButtonText">My Tests</span>
            </button>
            <div class="sidebar-section-title" data-lang-key="chatsTitle">Chats</div>
            <div class="chat-list" id="chat-list">
                 <div style="padding:10px;color:var(--text-secondary);font-size:0.9em;" data-lang-key="loginToSeeChats">Please log in to see chats.</div>
            </div>
            <div class="sidebar-footer">
                <div class="sidebar-controls">
                     <div class="control-group text-size-controls">
                         <span data-lang-key="textSizeLabel">Text Size</span>
                         <button id="decrease-text-size" title="Decrease text size" data-lang-key="decreaseTextTitle" disabled>-</button>
                         <button id="increase-text-size" title="Increase text size" data-lang-key="increaseTextTitle" disabled>+</button>
                     </div>
                     <div class="control-group theme-toggle">
                         <span data-lang-key="themeLabel">Theme</span>
                         <button id="theme-toggle-button" title="Toggle Theme" data-lang-key="toggleThemeTitle" disabled>‚òÄÔ∏è</button>
                     </div>
                     <!-- ‡ÆÆ‡Øä‡Æ¥‡Æø ‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡ØÅ‡ÆÆ‡Øç ‡Æ™‡Øä‡Æ§‡Øç‡Æ§‡Ææ‡Æ©‡Øç -->
                     <div class="control-group language-toggle">
                         <span data-lang-key="languageLabel">Language</span>
                         <button id="language-toggle-button" title="Change Language" data-lang-key="toggleLanguageTitle" disabled>TA</button>
                     </div>
                </div>
                 <div id="auth-controls">
                     <button id="login-google-btn" data-lang-key="loginButtonText">Login with Google</button>
                     <button id="logout-btn" style="display: none;" data-lang-key="logoutButtonText">Logout</button>
                 </div>
                 <div class="account-info">
                     <div class="account-avatar" id="account-avatar">?</div>
                     <div class="account-details">
                         <div class="account-email" id="account-email" data-lang-key="notLoggedIn">Not logged in</div>
                         <div class="account-plan" id="account-plan"></div>
                     </div>
                 </div>
            </div>
        </div>

        <!-- Main Area Container -->
        <div class="main-container">
            <!-- Chat View -->
            <div class="main-content active" id="main-content-chat">
                 <div class="chat-area" id="chat-area"></div>
                 <div class="input-container" id="input-container">
                     <div class="suggestions" id="suggestions">
                          <button class="suggestion-chip" data-prompt="5 questions about US History">5 Qs US History (Check MCQ)</button>
                          <button class="suggestion-chip" data-prompt="What is recursion?">Recursion?</button>
                          <button class="suggestion-chip" data-prompt="Explain $\lim_{x\to 0} \frac{\sin x}{x} = 1$">Limit sin(x)/x ?</button>
                     </div>
                    <div class="input-box">
                        <textarea id="user-input" placeholder="Enter prompt..." rows="1" data-lang-key="promptPlaceholder"></textarea>
                        <div class="mcq-mode-control">
                            <input type="checkbox" id="mcq-mode-checkbox" title="Check to generate MCQs" data-lang-key="mcqCheckboxTitle">
                            <label for="mcq-mode-checkbox" data-lang-key="mcqLabel">MCQs?</label>
                         </div>
                        <button id="send-button" title="Send message" data-lang-key="sendButtonTitle" disabled>
                            <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Review View -->
             <div class="review-view" id="review-view">
                 <div class="review-header">
                     <h2 data-lang-key="reviewTitle">Test Review</h2>
                     <div class="review-summary" id="review-summary"></div>
                     <div class="review-filters" id="review-filters">
                         <button data-filter="all" class="active-filter" data-lang-key="filterAll">All</button>
                         <button data-filter="incorrect" data-lang-key="filterIncorrect">Incorrect</button>
                         <button data-filter="skipped" data-lang-key="filterSkipped">Skipped</button>
                     </div>
                 </div>
                 <div class="review-content" id="review-content"></div>
                 <div class="review-footer">
                     <button id="save-review-btn" data-lang-key="saveReviewButtonText">Save Review</button>
                     <button id="exit-review-btn" data-lang-key="backToChatButtonText">Back to Chat</button>
                 </div>
             </div>

            <!-- Test List View (‡Æ™‡ØÅ‡Æ§‡Æø‡Æ§‡ØÅ) -->
            <div class="test-list-view" id="test-list-view">
                <div class="test-list-header">
                    <h2 data-lang-key="myTestsTitle">My Saved Tests</h2>
                    <input type="text" id="test-search-input" placeholder="Search tests by date or summary..." data-lang-key="searchTestsPlaceholder">
                </div>
                <div class="test-list-content" id="test-list-content">
                    <!-- ‡Æö‡Øá‡ÆÆ‡Æø‡Æ§‡Øç‡Æ§ ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ‡Æï‡Æ≥‡Øç ‡Æá‡Æô‡Øç‡Æï‡ØÅ JS ‡ÆÆ‡ØÇ‡Æ≤‡ÆÆ‡Øç ‡Æö‡Øá‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡ØÅ‡ÆÆ‡Øç -->
                    <div class="info-message" data-lang-key="noSavedTests">No saved tests found.</div>
                </div>
                <div class="test-list-footer">
                    <button id="exit-test-list-btn" data-lang-key="backToChatButtonText">Back to Chat</button>
                </div>
            </div>

        </div> <!-- End Main Container -->
    </div> <!-- End App Container -->

    <!-- Mock Test View (Fullscreen Overlay) -->
    <div class="mock-test-view" id="mock-test-view">
        <div class="test-header">
            <h2 id="test-title" data-lang-key="mockTestTitle">Mock Test</h2>
            <div class="test-info">
                <span id="question-counter">Q: 1 / N</span>
                <span id="test-timer">Time: 00:00</span>
            </div>
         </div>
        <div class="test-content"> <div class="test-question-container"> <div class="test-question-number" id="test-question-number"></div> <div class="test-question" id="test-question"></div> <div class="test-options" id="test-options"></div> </div> </div>
        <div class="test-navigation">
            <button id="prev-question-btn" data-lang-key="prevButtonText" disabled>Previous</button>
            <button id="next-question-btn" data-lang-key="nextButtonText">Next</button>
            <button id="submit-test-btn" data-lang-key="submitTestButtonText">Submit Test</button>
         </div>
    </div>


    <script>
        // --- Firebase Config ---
        // ... (Firebase config ‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡ÆÆ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà) ...
        const firebaseConfig = {
          apiKey: "AIzaSyDgw604fe5jnNu4kTOv1cQ-3n7PL8gcN58",
          authDomain: "krish-c5db8.firebaseapp.com",
          projectId: "krish-c5db8",
          storageBucket: "krish-c5db8.appspot.com",
          messagingSenderId: "217175257890",
          appId: "1:217175257890:web:209f0f290eabab6b1fab7b",
          measurementId: "G-97SHYGL2J4"
        };
        firebase.initializeApp(firebaseConfig);
        const fbAuth = firebase.auth();
        const db = firebase.firestore();

        // --- DOM Elements (‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ‡Æµ‡Øà ‡Æö‡Øá‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ©) ---
        const appContainer = document.getElementById('app-container');
        const chatArea = document.getElementById('chat-area');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const suggestionsContainer = document.getElementById('suggestions');
        const startChatButton = document.getElementById('start-chat');
        const showTestsButton = document.getElementById('show-tests-btn'); // ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ ‡Æ™‡Øä‡Æ§‡Øç‡Æ§‡Ææ‡Æ©‡Øç
        const chatListContainer = document.getElementById('chat-list');
        const accountEmail = document.getElementById('account-email');
        const accountAvatar = document.getElementById('account-avatar');
        const accountPlan = document.getElementById('account-plan');
        const decreaseTextBtn = document.getElementById('decrease-text-size');
        const increaseTextBtn = document.getElementById('increase-text-size');
        const themeToggleButton = document.getElementById('theme-toggle-button');
        const languageToggleButton = document.getElementById('language-toggle-button'); // ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ ‡Æ™‡Øä‡Æ§‡Øç‡Æ§‡Ææ‡Æ©‡Øç
        const mainContainer = document.querySelector('.main-container');
        const chatView = document.getElementById('main-content-chat');
        const testView = document.getElementById('mock-test-view');
        const reviewView = document.getElementById('review-view');
        const testListView = document.getElementById('test-list-view'); // ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ view
        const inputContainer = document.getElementById('input-container');
        const mcqModeCheckbox = document.getElementById('mcq-mode-checkbox');
        const loginBtn = document.getElementById('login-google-btn');
        const logoutBtn = document.getElementById('logout-btn');
        // Test elements
        const testTitle = document.getElementById('test-title');
        const questionCounter = document.getElementById('question-counter');
        const testTimer = document.getElementById('test-timer');
        const testQuestionNumber = document.getElementById('test-question-number');
        const testQuestion = document.getElementById('test-question');
        const testOptionsContainer = document.getElementById('test-options');
        const prevQuestionBtn = document.getElementById('prev-question-btn');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const submitTestBtn = document.getElementById('submit-test-btn');
        // Review elements
        const reviewSummary = document.getElementById('review-summary');
        const reviewContent = document.getElementById('review-content');
        const exitReviewBtn = document.getElementById('exit-review-btn');
        const reviewFilters = document.getElementById('review-filters');
        const saveReviewBtn = document.getElementById('save-review-btn');
        // Test List elements (‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ‡Æµ‡Øà)
        const testListContent = document.getElementById('test-list-content');
        const testSearchInput = document.getElementById('test-search-input');
        const exitTestListBtn = document.getElementById('exit-test-list-btn');


        // --- Config & Constants ---
        // ... (‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡ÆÆ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà) ...
        const MODEL_NAME="gemini-1.5-flash-latest";
        const API_URL_BASE=`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=`;
        const STORAGE_KEY_API_KEY='geminiApiKey';
        const NEW_CHAT_TITLE_KEY='newChatTitle'; // ‡ÆÆ‡Øä‡Æ¥‡Æø‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Øç‡Æï‡Ææ‡Æï key ‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ
        const TEXT_SIZE_STEP=0.1; const MIN_TEXT_SIZE_MULTIPLIER=0.7; const MAX_TEXT_SIZE_MULTIPLIER=1.5;
        const LIGHT_THEME_ICON='‚òÄÔ∏è'; const DARK_THEME_ICON='üåô'; const DELETE_ICON = '√ó';

        // --- State Variables (‡ÆÆ‡Øä‡Æ¥‡Æø, test list listener ‡Æö‡Øá‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ) ---
        let API_KEY='';
        let currentUser = null;
        let activeChatId = null;
        let currentChatHistory=[];
        let currentTextSizeMultiplier=1.0;
        let currentTheme='light';
        let currentLanguage = 'en'; // Default ‡ÆÆ‡Øä‡Æ¥‡Æø 'en' (English)
        let isTestMode=false;
        let isReviewMode=false;
        let isTestListView = false; // Test list view-‡Æá‡Æ≤‡Øç ‡Æá‡Æ∞‡ØÅ‡Æï‡Øç‡Æï‡Æø‡Æ±‡Øã‡ÆÆ‡Ææ?
        let currentTestMCQs=[];
        let currentQuestionIndex=0;
        let userAnswers=[];
        let testStartTime=null;
        let testTimerInterval=null;
        let generatedMCQData=null;
        let reviewResultsCache = null;
        let activeChatListener = null;
        let chatListListener = null;
        let testListListener = null; // ‡Æö‡Øá‡ÆÆ‡Æø‡Æ§‡Øç‡Æ§ test-‡Æï‡Æ≥‡ØÅ‡Æï‡Øç‡Æï‡Ææ‡Æ© listener
        let isDeletingChat = false;

        // --- Translations Object (‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ‡Æ§‡ØÅ) ---
        const translations = {
            en: {
                sidebarHeader: "Gemini Chat", startChatButtonText: "Start new chat", myTestsButtonText: "My Tests",
                chatsTitle: "Chats", loginToSeeChats: "Please log in to see chats.", textSizeLabel: "Text Size",
                decreaseTextTitle: "Decrease text size", increaseTextTitle: "Increase text size", themeLabel: "Theme",
                toggleThemeTitle: "Toggle Theme", languageLabel: "Language", toggleLanguageTitle: "Change Language (‡ÆÆ‡Øä‡Æ¥‡Æø ‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±)",
                loginButtonText: "Login with Google", logoutButtonText: "Logout", notLoggedIn: "Not logged in",
                promptPlaceholder: "Enter prompt (Check 'MCQs?' to generate test)", mcqCheckboxTitle: "Check to generate MCQs based on your prompt",
                mcqLabel: "MCQs?", sendButtonTitle: "Send message", reviewTitle: "Test Review", filterAll: "All",
                filterIncorrect: "Incorrect", filterSkipped: "Skipped", saveReviewButtonText: "Save Review",
                backToChatButtonText: "Back to Chat", mockTestTitle: "Mock Test", prevButtonText: "Previous", nextButtonText: "Next",
                submitTestButtonText: "Submit Test", myTestsTitle: "My Saved Tests", searchTestsPlaceholder: "Search tests by date or summary...",
                noSavedTests: "No saved tests found.", loadingChats: "Loading chats...", loadingMessages: "Loading chat...",
                loadingTests: "Loading tests...", creatingChat: "Creating chat...", sendingMessage: "Sending...",
                thinking: "Thinking...", deletingChat: "Deleting chat...", savingReview: "Saving review...",
                retakeTestButtonText: "Retake Test", reviewAttemptButtonText: "Review Attempt", confirmDeleteChat: "Are you sure you want to permanently delete \"{chatTitle}\" and all its messages?",
                errorApi: "Gemini API Key required. Reload to enter.", errorLogin: "Login failed: {message}", errorLogout: "Logout failed: {message}",
                errorLoadSettings: "Error loading user settings", errorSaveSettings: "Error saving user settings",
                errorLoadChats: "Could not load chat list.", errorCreateChat: "Failed to create chat.", errorDeleteChat: "Failed to delete chat. Check permissions or connection.",
                errorLoadMessages: "Could not load messages for this chat.", errorSendMessage: "Failed to send message. Please try again.",
                errorApiGeneric: "API error ({status})", errorApiUnknown: "Unknown API error", errorApiResponse: "Could not extract valid text from response.",
                errorNetwork: "Network error during request.", errorSaveResponse: "Error saving response. It might not appear.",
                errorStartTestMCQ: "Could not start the test. MCQ data missing.", errorSaveReview: "Failed to save the review data to the cloud. Please try again.",
                errorLoadSavedTests: "Could not load saved tests.", errorRetakeTest: "Could not load questions for retake.",
                errorReviewSaved: "Could not load saved review data.", testSavedSuccess: "Test review saved successfully!",
                newChatTitle: "(New Chat)"
            },
            ta: {
                sidebarHeader: "‡Æú‡ØÜ‡ÆÆ‡Æø‡Æ©‡Æø Chat", startChatButtonText: "‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ ‡Æâ‡Æ∞‡Øà‡ÆØ‡Ææ‡Æü‡Æ≤‡Øç", myTestsButtonText: "‡Æé‡Æ©‡Æ§‡ØÅ ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ‡Æï‡Æ≥‡Øç",
                chatsTitle: "‡Æâ‡Æ∞‡Øà‡ÆØ‡Ææ‡Æü‡Æ≤‡Øç‡Æï‡Æ≥‡Øç", loginToSeeChats: "‡Æâ‡Æ∞‡Øà‡ÆØ‡Ææ‡Æü‡Æ≤‡Øç‡Æï‡Æ≥‡Øà‡Æ™‡Øç ‡Æ™‡Ææ‡Æ∞‡Øç‡Æï‡Øç‡Æï ‡Æâ‡Æ≥‡Øç‡Æ®‡ØÅ‡Æ¥‡Øà‡ÆØ‡Æµ‡ØÅ‡ÆÆ‡Øç.", textSizeLabel: "‡Æé‡Æ¥‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ ‡ÆÖ‡Æ≥‡Æµ‡ØÅ",
                decreaseTextTitle: "‡Æé‡Æ¥‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ ‡ÆÖ‡Æ≥‡Æµ‡Øà‡Æï‡Øç ‡Æï‡ØÅ‡Æ±‡Øà‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç", increaseTextTitle: "‡Æé‡Æ¥‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ ‡ÆÖ‡Æ≥‡Æµ‡Øà ‡ÆÖ‡Æ§‡Æø‡Æï‡Æ∞‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç", themeLabel: "‡Æ§‡ØÄ‡ÆÆ‡Øç",
                toggleThemeTitle: "‡Æ§‡ØÄ‡ÆÆ‡Øç ‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡ØÅ‡Æï", languageLabel: "‡ÆÆ‡Øä‡Æ¥‡Æø", toggleLanguageTitle: "Change Language (‡ÆÆ‡Øä‡Æ¥‡Æø ‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±)",
                loginButtonText: "Google ‡ÆÆ‡ØÇ‡Æ≤‡ÆÆ‡Øç ‡Æâ‡Æ≥‡Øç‡Æ®‡ØÅ‡Æ¥‡Øà‡Æï", logoutButtonText: "‡Æµ‡ØÜ‡Æ≥‡Æø‡ÆØ‡Øá‡Æ±‡ØÅ", notLoggedIn: "‡Æâ‡Æ≥‡Øç‡Æ®‡ØÅ‡Æ¥‡Øà‡ÆØ‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà",
                promptPlaceholder: "‡Æï‡Øá‡Æ≥‡Øç‡Æµ‡Æø‡ÆØ‡Øà ‡Æâ‡Æ≥‡Øç‡Æ≥‡Æø‡Æü‡Æµ‡ØÅ‡ÆÆ‡Øç ('MCQs?' ‡Æé‡Æ©‡Øç‡Æ™‡Æ§‡Øà ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡Ææ‡Æ≤‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ ‡Æâ‡Æ∞‡ØÅ‡Æµ‡Ææ‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡ØÅ‡ÆÆ‡Øç)", mcqCheckboxTitle: "‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æï‡Øá‡Æ≥‡Øç‡Æµ‡Æø ‡ÆÖ‡Æü‡Æø‡Æ™‡Øç‡Æ™‡Æü‡Øà‡ÆØ‡Æø‡Æ≤‡Øç MCQ ‡Æï‡Æ≥‡Øà ‡Æâ‡Æ∞‡ØÅ‡Æµ‡Ææ‡Æï‡Øç‡Æï ‡Æá‡Æ§‡Øà‡Æ§‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ‡Æö‡ØÜ‡ÆØ‡Øç‡Æï",
                mcqLabel: "MCQs?", sendButtonTitle: "‡ÆÖ‡Æ©‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ", reviewTitle: "‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ ‡ÆÆ‡Æ±‡ØÅ‡Æ™‡Ææ‡Æ∞‡Øç‡Æµ‡Øà", filterAll: "‡ÆÖ‡Æ©‡Øà‡Æ§‡Øç‡Æ§‡ØÅ‡ÆÆ‡Øç",
                filterIncorrect: "‡Æ§‡Æµ‡Æ±‡Ææ‡Æ©‡Æµ‡Øà", filterSkipped: "‡Æ§‡Æµ‡Æø‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æµ‡Øà", saveReviewButtonText: "‡ÆÆ‡Æ±‡ØÅ‡Æ™‡Ææ‡Æ∞‡Øç‡Æµ‡Øà‡ÆØ‡Øà ‡Æö‡Øá‡ÆÆ‡Æø",
                backToChatButtonText: "Chat-‡Æï‡Øç‡Æï‡ØÅ ‡Æ§‡Æø‡Æ∞‡ØÅ‡ÆÆ‡Øç‡Æ™‡ØÅ‡Æï", mockTestTitle: "‡ÆÆ‡Ææ‡Æ§‡Æø‡Æ∞‡Æø‡Æ§‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ", prevButtonText: "‡ÆÆ‡ØÅ‡Æ®‡Øç‡Æ§‡Øà‡ÆØ‡Æ§‡ØÅ", nextButtonText: "‡ÆÖ‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡Æ§‡ØÅ",
                submitTestButtonText: "‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡Øà‡Æö‡Øç ‡Æö‡ÆÆ‡Æ∞‡Øç‡Æ™‡Øç‡Æ™‡Æø", myTestsTitle: "‡Æé‡Æ©‡Æ§‡ØÅ ‡Æö‡Øá‡ÆÆ‡Æø‡Æ§‡Øç‡Æ§ ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ‡Æï‡Æ≥‡Øç", searchTestsPlaceholder: "‡Æ§‡Øá‡Æ§‡Æø ‡ÆÖ‡Æ≤‡Øç‡Æ≤‡Æ§‡ØÅ ‡Æö‡ØÅ‡Æ∞‡ØÅ‡Æï‡Øç‡Æï‡ÆÆ‡Øç ‡ÆÆ‡ØÇ‡Æ≤‡ÆÆ‡Øç ‡Æ§‡Øá‡Æü‡Æµ‡ØÅ‡ÆÆ‡Øç...",
                noSavedTests: "‡Æö‡Øá‡ÆÆ‡Æø‡Æ§‡Øç‡Æ§ ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ‡Æï‡Æ≥‡Øç ‡Æé‡Æ§‡ØÅ‡Æµ‡ØÅ‡ÆÆ‡Øç ‡Æá‡Æ≤‡Øç‡Æ≤‡Øà.", loadingChats: "‡Æâ‡Æ∞‡Øà‡ÆØ‡Ææ‡Æü‡Æ≤‡Øç‡Æï‡Æ≥‡Øà ‡Æè‡Æ±‡Øç‡Æ±‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ...", loadingMessages: "‡Æâ‡Æ∞‡Øà‡ÆØ‡Ææ‡Æü‡Æ≤‡Øà ‡Æè‡Æ±‡Øç‡Æ±‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ...",
                loadingTests: "‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ‡Æï‡Æ≥‡Øà ‡Æè‡Æ±‡Øç‡Æ±‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ...", creatingChat: "‡Æâ‡Æ∞‡Øà‡ÆØ‡Ææ‡Æü‡Æ≤‡Øà ‡Æâ‡Æ∞‡ØÅ‡Æµ‡Ææ‡Æï‡Øç‡Æï‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ...", sendingMessage: "‡ÆÖ‡Æ©‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ...",
                thinking: "‡Æö‡Æø‡Æ®‡Øç‡Æ§‡Æø‡Æï‡Øç‡Æï‡Æø‡Æ±‡Æ§‡ØÅ...", deletingChat: "‡Æâ‡Æ∞‡Øà‡ÆØ‡Ææ‡Æü‡Æ≤‡Øà ‡Æ®‡ØÄ‡Æï‡Øç‡Æï‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ...", savingReview: "‡ÆÆ‡Æ±‡ØÅ‡Æ™‡Ææ‡Æ∞‡Øç‡Æµ‡Øà‡ÆØ‡Øà ‡Æö‡Øá‡ÆÆ‡Æø‡Æï‡Øç‡Æï‡Æø‡Æ±‡Æ§‡ØÅ...",
                retakeTestButtonText: "‡ÆÆ‡ØÄ‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ", reviewAttemptButtonText: "‡ÆÆ‡ØÅ‡ÆØ‡Æ±‡Øç‡Æö‡Æø‡ÆØ‡Øà ‡ÆÆ‡Æ±‡ØÅ‡Æ™‡Ææ‡Æ∞‡Øç‡Æµ‡Øà", confirmDeleteChat: "\"{chatTitle}\" ‡ÆÆ‡Æ±‡Øç‡Æ±‡ØÅ‡ÆÆ‡Øç ‡ÆÖ‡Æ§‡Æ©‡Øç ‡ÆÖ‡Æ©‡Øà‡Æ§‡Øç‡Æ§‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡Æø‡Æï‡Æ≥‡Øà‡ÆØ‡ØÅ‡ÆÆ‡Øç ‡Æ®‡Æø‡Æ∞‡Æ®‡Øç‡Æ§‡Æ∞‡ÆÆ‡Ææ‡Æï ‡Æ®‡ØÄ‡Æï‡Øç‡Æï ‡Æµ‡Æø‡Æ∞‡ØÅ‡ÆÆ‡Øç‡Æ™‡ØÅ‡Æï‡Æø‡Æ±‡ØÄ‡Æ∞‡Øç‡Æï‡Æ≥‡Ææ?",
                errorApi: "Gemini API Key ‡Æ§‡Øá‡Æµ‡Øà. ‡ÆÆ‡ØÄ‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡Æè‡Æ±‡Øç‡Æ±‡Æµ‡ØÅ‡ÆÆ‡Øç.", errorLogin: "‡Æâ‡Æ≥‡Øç‡Æ®‡ØÅ‡Æ¥‡Øà‡Æµ‡ØÅ ‡Æ§‡Øã‡Æ≤‡Øç‡Æµ‡Æø: {message}", errorLogout: "‡Æµ‡ØÜ‡Æ≥‡Æø‡ÆØ‡Øá‡Æ±‡ØÅ‡Æ§‡Æ≤‡Øç ‡Æ§‡Øã‡Æ≤‡Øç‡Æµ‡Æø: {message}",
                errorLoadSettings: "‡Æ™‡ÆØ‡Æ©‡Æ∞‡Øç ‡ÆÖ‡ÆÆ‡Øà‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øà ‡Æè‡Æ±‡Øç‡Æ±‡ØÅ‡Æµ‡Æ§‡Æø‡Æ≤‡Øç ‡Æ™‡Æø‡Æ¥‡Øà", errorSaveSettings: "‡Æ™‡ÆØ‡Æ©‡Æ∞‡Øç ‡ÆÖ‡ÆÆ‡Øà‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øà‡Æö‡Øç ‡Æö‡Øá‡ÆÆ‡Æø‡Æ™‡Øç‡Æ™‡Æ§‡Æø‡Æ≤‡Øç ‡Æ™‡Æø‡Æ¥‡Øà",
                errorLoadChats: "Chat ‡Æ™‡Æü‡Øç‡Æü‡Æø‡ÆØ‡Æ≤‡Øà ‡Æè‡Æ±‡Øç‡Æ± ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà.", errorCreateChat: "Chat-‡Æê ‡Æâ‡Æ∞‡ØÅ‡Æµ‡Ææ‡Æï‡Øç‡Æï ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà.", errorDeleteChat: "‡Æâ‡Æ∞‡Øà‡ÆØ‡Ææ‡Æü‡Æ≤‡Øà ‡Æ®‡ØÄ‡Æï‡Øç‡Æï ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà. ‡ÆÖ‡Æ©‡ØÅ‡ÆÆ‡Æ§‡Æø‡Æï‡Æ≥‡Øç ‡ÆÖ‡Æ≤‡Øç‡Æ≤‡Æ§‡ØÅ ‡Æá‡Æ£‡Øà‡Æ™‡Øç‡Æ™‡Øà‡Æö‡Øç ‡Æö‡Æ∞‡Æø‡Æ™‡Ææ‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç.",
                errorLoadMessages: "‡Æá‡Æ®‡Øç‡Æ§ ‡Æâ‡Æ∞‡Øà‡ÆØ‡Ææ‡Æü‡Æ≤‡Æø‡Æ©‡Øç ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡Æø‡Æï‡Æ≥‡Øà ‡Æè‡Æ±‡Øç‡Æ± ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà.", errorSendMessage: "‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡Æø‡ÆØ‡Øà ‡ÆÖ‡Æ©‡ØÅ‡Æ™‡Øç‡Æ™ ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà. ‡ÆÆ‡ØÄ‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡ÆÆ‡ØÅ‡ÆØ‡Æ±‡Øç‡Æö‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç.",
                errorApiGeneric: "API ‡Æ™‡Æø‡Æ¥‡Øà ({status})", errorApiUnknown: "‡Æ§‡ØÜ‡Æ∞‡Æø‡ÆØ‡Ææ‡Æ§ API ‡Æ™‡Æø‡Æ¥‡Øà", errorApiResponse: "‡Æ™‡Æ§‡Æø‡Æ≤‡Æø‡Æ≤‡Æø‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æö‡Æ∞‡Æø‡ÆØ‡Ææ‡Æ© ‡Æâ‡Æ∞‡Øà‡ÆØ‡Øà‡Æ™‡Øç ‡Æ™‡Æø‡Æ∞‡Æø‡Æï‡Øç‡Æï ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà.",
                errorNetwork: "‡Æï‡Øã‡Æ∞‡Æø‡Æï‡Øç‡Æï‡Øà‡ÆØ‡Æø‡Æ©‡Øç ‡Æ™‡Øã‡Æ§‡ØÅ ‡Æ™‡Æø‡Æ£‡Øà‡ÆØ‡Æ™‡Øç ‡Æ™‡Æø‡Æ¥‡Øà.", errorSaveResponse: "‡Æ™‡Æ§‡Æø‡Æ≤‡Øà‡Æö‡Øç ‡Æö‡Øá‡ÆÆ‡Æø‡Æ™‡Øç‡Æ™‡Æ§‡Æø‡Æ≤‡Øç ‡Æ™‡Æø‡Æ¥‡Øà. ‡ÆÖ‡Æ§‡ØÅ ‡Æ§‡Øã‡Æ©‡Øç‡Æ±‡Ææ‡ÆÆ‡Æ≤‡Øç ‡Æ™‡Øã‡Æï‡Æ≤‡Ææ‡ÆÆ‡Øç.",
                errorStartTestMCQ: "‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡Øà‡Æ§‡Øç ‡Æ§‡Øä‡Æü‡Æô‡Øç‡Æï ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà. MCQ ‡Æ§‡Æ∞‡Æµ‡ØÅ ‡Æá‡Æ≤‡Øç‡Æ≤‡Øà.", errorSaveReview: "‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ ‡ÆÆ‡Æ±‡ØÅ‡Æ™‡Ææ‡Æ∞‡Øç‡Æµ‡Øà ‡Æ§‡Æ∞‡Æµ‡Øà cloud-‡Æá‡Æ≤‡Øç ‡Æö‡Øá‡ÆÆ‡Æø‡Æï‡Øç‡Æï ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà. ‡ÆÆ‡ØÄ‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡ÆÆ‡ØÅ‡ÆØ‡Æ±‡Øç‡Æö‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç.",
                errorLoadSavedTests: "‡Æö‡Øá‡ÆÆ‡Æø‡Æ§‡Øç‡Æ§ ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ‡Æï‡Æ≥‡Øà ‡Æè‡Æ±‡Øç‡Æ± ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà.", errorRetakeTest: "‡ÆÆ‡ØÄ‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ ‡Æï‡Øá‡Æ≥‡Øç‡Æµ‡Æø‡Æï‡Æ≥‡Øà ‡Æè‡Æ±‡Øç‡Æ± ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà.",
                errorReviewSaved: "‡Æö‡Øá‡ÆÆ‡Æø‡Æ§‡Øç‡Æ§ ‡ÆÆ‡Æ±‡ØÅ‡Æ™‡Ææ‡Æ∞‡Øç‡Æµ‡Øà‡Æ§‡Øç ‡Æ§‡Æ∞‡Æµ‡Øà ‡Æè‡Æ±‡Øç‡Æ± ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà.", testSavedSuccess: "‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ ‡ÆÆ‡Æ±‡ØÅ‡Æ™‡Ææ‡Æ∞‡Øç‡Æµ‡Øà ‡Æµ‡ØÜ‡Æ±‡Øç‡Æ±‡Æø‡Æï‡Æ∞‡ÆÆ‡Ææ‡Æï‡Æö‡Øç ‡Æö‡Øá‡ÆÆ‡Æø‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ!",
                newChatTitle: "(‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ ‡Æâ‡Æ∞‡Øà‡ÆØ‡Ææ‡Æü‡Æ≤‡Øç)"
            }
        };

        // --- Initialization ---
        initializeApp();

        // --- Event Listeners (‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ‡Æµ‡Øà ‡Æö‡Øá‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ©) ---
        sendButton.addEventListener('click', handleSendMessage);
        userInput.addEventListener('input', autoGrowTextarea);
        userInput.addEventListener('keydown', handleInputKeydown);
        suggestionsContainer.addEventListener('click', handleSuggestionClick);
        startChatButton.addEventListener('click', () => switchView('chat')); // Chat view‡Æï‡Øç‡Æï‡ØÅ ‡ÆÆ‡Ææ‡Æ±
        showTestsButton.addEventListener('click', () => switchView('test-list')); // Test list view‡Æï‡Øç‡Æï‡ØÅ ‡ÆÆ‡Ææ‡Æ±
        chatListContainer.addEventListener('click', handleChatListClick);
        decreaseTextBtn.addEventListener('click', () => adjustTextSize(-TEXT_SIZE_STEP));
        increaseTextBtn.addEventListener('click', () => adjustTextSize(TEXT_SIZE_STEP));
        themeToggleButton.addEventListener('click', toggleTheme);
        languageToggleButton.addEventListener('click', toggleLanguage); // ‡ÆÆ‡Øä‡Æ¥‡Æø ‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±
        // Test listeners
        prevQuestionBtn.addEventListener('click', () => handleTestNavigation('prev'));
        nextQuestionBtn.addEventListener('click', () => handleTestNavigation('next'));
        submitTestBtn.addEventListener('click', submitTest);
        // Review listeners
        exitReviewBtn.addEventListener('click', exitReview);
        chatArea.addEventListener('click', handleChatAreaClick);
        reviewFilters.addEventListener('click', handleReviewFilterClick);
        saveReviewBtn.addEventListener('click', saveTestReviewToCloud);
        // Test List listeners (‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ‡Æµ‡Øà)
        testSearchInput.addEventListener('input', handleTestSearch);
        testListContent.addEventListener('click', handleTestListClick); // Retake/Review ‡Æ™‡Øä‡Æ§‡Øç‡Æ§‡Ææ‡Æ©‡Øç‡Æï‡Æ≥‡ØÅ‡Æï‡Øç‡Æï‡Ææ‡Æï
        exitTestListBtn.addEventListener('click', () => switchView('chat')); // Chat‡Æï‡Øç‡Æï‡ØÅ ‡Æ§‡Æø‡Æ∞‡ØÅ‡ÆÆ‡Øç‡Æ™
        // Auth listeners
        loginBtn.addEventListener('click', signInWithGoogle);
        logoutBtn.addEventListener('click', signOut);


        // --- Initialization Functions ---
        async function initializeApp() {
            applyLanguage(); // Default ‡ÆÆ‡Øä‡Æ¥‡Æø‡ÆØ‡Øà‡Æ™‡Øç ‡Æ™‡ÆØ‡Æ©‡Øç‡Æ™‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ
            loadGeminiApiKey();
            fbAuth.onAuthStateChanged(handleAuthStateChange);
            switchView('chat'); // Chat view-‡Æá‡Æ≤‡Øç ‡Æ§‡Øä‡Æü‡Æô‡Øç‡Æï‡ØÅ
            userInput.focus();
        }

        function loadGeminiApiKey() { /* ... (‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡ÆÆ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà) ... */
            console.warn("‡Æ™‡Ææ‡Æ§‡ØÅ‡Æï‡Ææ‡Æ™‡Øç‡Æ™‡ØÅ ‡Æé‡Æö‡Øç‡Æö‡Æ∞‡Æø‡Æï‡Øç‡Æï‡Øà: Gemini API Key localStorage-‡Æ≤‡Øç...");
            const k=localStorage.getItem(STORAGE_KEY_API_KEY);
            if(k){ API_KEY=k; } else { API_KEY=prompt(getText('errorApi')); if(API_KEY){ localStorage.setItem(STORAGE_KEY_API_KEY, API_KEY); } else { displayError(getText('errorApi')); setLoadingState(true, "API Key Missing"); } }
            setLoadingState(false);
        }

        // --- Language Functions (‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ‡Æµ‡Øà) ---
        // ‡ÆÆ‡Øä‡Æ¥‡Æø‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç‡Æ™‡Øç‡Æ™‡Øà‡Æ™‡Øç ‡Æ™‡ØÜ‡Æ±‡ØÅ‡Æ§‡Æ≤‡Øç
        function getText(key, params = {}) {
            let text = translations[currentLanguage]?.[key] || translations['en']?.[key] || `[${key}]`;
            // Replace placeholders like {placeholder}
            for (const paramKey in params) {
                text = text.replace(`{${paramKey}}`, params[paramKey]);
            }
            return text;
        }

        // UI-‡Æá‡Æ≤‡Øç ‡ÆÆ‡Øä‡Æ¥‡Æø‡ÆØ‡Øà‡Æ™‡Øç ‡Æ™‡ÆØ‡Æ©‡Øç‡Æ™‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ‡Æ§‡Æ≤‡Øç
        function applyLanguage() {
            document.querySelectorAll('[data-lang-key]').forEach(element => {
                const key = element.dataset.langKey;
                const text = getText(key);
                if (element.tagName === 'TEXTAREA' || element.tagName === 'INPUT') {
                    if(element.type === 'text' || element.type === 'search' || element.tagName === 'TEXTAREA') {
                        element.placeholder = text;
                    } else if (element.title) { // Checkbox title ‡Æ™‡Øã‡Æ©‡Øç‡Æ±‡Æµ‡Æ±‡Øç‡Æ±‡ØÅ‡Æï‡Øç‡Æï‡ØÅ
                         element.title = text;
                    }
                } else if (element.title) { // Button title ‡Æ™‡Øã‡Æ©‡Øç‡Æ±‡Æµ‡Æ±‡Øç‡Æ±‡ØÅ‡Æï‡Øç‡Æï‡ØÅ
                     element.title = text;
                      // ‡Æö‡Æø‡Æ≤ ‡Æ™‡Øä‡Æ§‡Øç‡Æ§‡Ææ‡Æ©‡Øç‡Æï‡Æ≥‡ØÅ‡Æï‡Øç‡Æï‡ØÅ textContent-‡ÆÆ‡Øç ‡Æ§‡Øá‡Æµ‡Øà‡Æ™‡Øç‡Æ™‡Æü‡Æ≤‡Ææ‡ÆÆ‡Øç
                     if(element.id === 'language-toggle-button') {
                         element.textContent = currentLanguage === 'en' ? 'TA' : 'EN';
                     } else if (!element.querySelector('svg')) { // ‡Æâ‡Æ≥‡Øç‡Æ≥‡Øá svg ‡Æá‡Æ≤‡Øç‡Æ≤‡Øà‡ÆØ‡ØÜ‡Æ©‡Øç‡Æ±‡Ææ‡Æ≤‡Øç textContent ‡Æê ‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡ØÅ
                         element.textContent = text;
                     } else { // SVG ‡Æâ‡Æ≥‡Øç‡Æ≥ ‡Æ™‡Øä‡Æ§‡Øç‡Æ§‡Ææ‡Æ©‡Øç‡Æï‡Æ≥‡ØÅ‡Æï‡Øç‡Æï‡ØÅ (start chat, my tests)
                         const span = element.querySelector('span[data-lang-key]');
                         if(span) span.textContent = text;
                     }
                } else {
                     // ‡ÆÆ‡Æ±‡Øç‡Æ± ‡Æâ‡Æ±‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡ØÅ‡Æï‡Øç‡Æï‡ØÅ (header, label, etc.)
                    element.textContent = text;
                }
            });
             // Sidebar chat list placeholder
             const chatListPlaceholder = chatListContainer.querySelector('div[data-lang-key="loginToSeeChats"]');
             if(chatListPlaceholder) chatListPlaceholder.textContent = getText('loginToSeeChats');
             const noChatsPlaceholder = chatListContainer.querySelector('div[style*="padding:10px"]'); // ‡Æá‡Æ§‡ØÅ ‡Æá‡Æ©‡Øç‡Æ©‡ØÅ‡ÆÆ‡Øç ‡Æö‡Æø‡Æ±‡Æ™‡Øç‡Æ™‡Ææ‡Æï ‡Æá‡Æ∞‡ØÅ‡Æï‡Øç‡Æï‡Æ≤‡Ææ‡ÆÆ‡Øç
             if(noChatsPlaceholder && !currentUser) noChatsPlaceholder.textContent = getText('loginToSeeChats');
             // Update New Chat title constant in display if needed (optional)
             // Update user input placeholder explicitly if needed during state changes
             if(userInput && !currentUser) userInput.placeholder = getText('notLoggedIn');
             else if(userInput) userInput.placeholder = getText('promptPlaceholder');

             console.log(`Language applied: ${currentLanguage}`);
        }

        // ‡ÆÆ‡Øä‡Æ¥‡Æø‡ÆØ‡Øà ‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡ØÅ‡Æ§‡Æ≤‡Øç
        function toggleLanguage() {
            currentLanguage = (currentLanguage === 'en') ? 'ta' : 'en';
            applyLanguage();
            saveUserSettings(); // ‡Æ™‡ÆØ‡Æ©‡Æ∞‡Øç ‡ÆÖ‡ÆÆ‡Øà‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Æø‡Æ≤‡Øç ‡Æö‡Øá‡ÆÆ‡Æø
        }


        // --- Authentication Functions ---
        async function signInWithGoogle() { /* ... */ try { setLoadingState(true, "Logging in..."); await fbAuth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); } catch (error) { console.error("Google Sign-In Error:", error); displayError(getText('errorLogin', { message: error.message })); setLoadingState(false); } }
        async function signOut() { /* ... */ try { setLoadingState(true, "Logging out..."); await fbAuth.signOut(); } catch (error) { console.error("Sign Out Error:", error); displayError(getText('errorLogout', { message: error.message })); setLoadingState(false); } }

        // Auth ‡Æ®‡Æø‡Æ≤‡Øà ‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡Æô‡Øç‡Æï‡Æ≥‡Øà‡Æï‡Øç ‡Æï‡Øà‡ÆØ‡Ææ‡Æ≥‡ØÅ‡Æ§‡Æ≤‡Øç (Listeners-‡Æï‡Æ≥‡Øà detach/attach ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡Æ≤‡Øç)
        function handleAuthStateChange(user) {
            // ‡ÆÆ‡ØÅ‡Æ®‡Øç‡Æ§‡Øà‡ÆØ listeners-‡Æï‡Æ≥‡Øà ‡Æ®‡ØÄ‡Æï‡Øç‡Æï‡ØÅ
            if (activeChatListener) { activeChatListener(); activeChatListener = null; }
            if (chatListListener) { chatListListener(); chatListListener = null; }
            if (testListListener) { testListListener(); testListListener = null; } // Test listener ‡Æ®‡ØÄ‡Æï‡Øç‡Æï‡ØÅ

            chatArea.innerHTML = '';
            chatListContainer.innerHTML = '';
            testListContent.innerHTML = ''; // Test list‡Æê‡ÆØ‡ØÅ‡ÆÆ‡Øç ‡Æï‡Ææ‡Æ≤‡Æø ‡Æö‡ØÜ‡ÆØ‡Øç
            activeChatId = null;
            currentChatHistory = [];

            if (user) {
                currentUser = user;
                console.log("User logged in:", currentUser.uid);
                loginBtn.style.display = 'none'; logoutBtn.style.display = 'inline-block';
                accountEmail.textContent = currentUser.email || currentUser.displayName || `User`;
                accountAvatar.textContent = (currentUser.displayName || currentUser.email || 'U')[0].toUpperCase();
                accountPlan.textContent = "Firebase User";
                // ‡Æ™‡Øä‡Æ§‡Øç‡Æ§‡Ææ‡Æ©‡Øç‡Æï‡Æ≥‡Øà enable ‡Æö‡ØÜ‡ÆØ‡Øç
                startChatButton.disabled = false; showTestsButton.disabled = false; // My Tests ‡Æ™‡Øä‡Æ§‡Øç‡Æ§‡Ææ‡Æ©‡Øç
                decreaseTextBtn.disabled = false; increaseTextBtn.disabled = false;
                themeToggleButton.disabled = false; languageToggleButton.disabled = false; // ‡ÆÆ‡Øä‡Æ¥‡Æø ‡Æ™‡Øä‡Æ§‡Øç‡Æ§‡Ææ‡Æ©‡Øç
                sendButton.disabled = false; userInput.disabled = false;
                inputContainer.style.display = 'block'; suggestionsContainer.style.display = 'flex';

                loadUserSettings(currentUser.uid); // ‡ÆÆ‡Øä‡Æ¥‡Æø ‡Æâ‡Æü‡Øç‡Æ™‡Æü ‡ÆÖ‡ÆÆ‡Øà‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øà load ‡Æö‡ØÜ‡ÆØ‡Øç
                loadAndListenForChats(currentUser.uid);
                // loadAndListenForSavedTests(currentUser.uid); // Test list view‡Æï‡Øç‡Æï‡ØÅ ‡ÆÆ‡Ææ‡Æ±‡ØÅ‡ÆÆ‡Øç‡Æ™‡Øã‡Æ§‡ØÅ load ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡Æ≤‡Ææ‡ÆÆ‡Øç

            } else { // ‡Æ™‡ÆØ‡Æ©‡Æ∞‡Øç ‡Æµ‡ØÜ‡Æ≥‡Æø‡ÆØ‡Øá‡Æ±‡Æø‡Æµ‡Æø‡Æü‡Øç‡Æü‡Ææ‡Æ∞‡Øç
                currentUser = null;
                console.log("User logged out");
                loginBtn.style.display = 'inline-block'; logoutBtn.style.display = 'none';
                accountEmail.textContent = getText('notLoggedIn');
                accountAvatar.textContent = '?'; accountPlan.textContent = "";
                // ‡Æ™‡Øä‡Æ§‡Øç‡Æ§‡Ææ‡Æ©‡Øç‡Æï‡Æ≥‡Øà disable ‡Æö‡ØÜ‡ÆØ‡Øç
                startChatButton.disabled = true; showTestsButton.disabled = true; // My Tests ‡Æ™‡Øä‡Æ§‡Øç‡Æ§‡Ææ‡Æ©‡Øç
                decreaseTextBtn.disabled = true; increaseTextBtn.disabled = true;
                themeToggleButton.disabled = true; languageToggleButton.disabled = true; // ‡ÆÆ‡Øä‡Æ¥‡Æø ‡Æ™‡Øä‡Æ§‡Øç‡Æ§‡Ææ‡Æ©‡Øç
                sendButton.disabled = true; userInput.disabled = true;
                inputContainer.style.display = 'none'; suggestionsContainer.style.display = 'none';

                renderGreetingOrLoginPrompt();
                chatListContainer.innerHTML = `<div style="padding:10px;color:var(--text-secondary);font-size:0.9em;" data-lang-key="loginToSeeChats">${getText('loginToSeeChats')}</div>`;
                testListContent.innerHTML = `<div class="info-message" data-lang-key="loginToSeeChats">${getText('loginToSeeChats')}</div>`; // Test list‡Æï‡Øç‡Æï‡ØÅ‡ÆÆ‡Øç ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡Æø

                // Default ‡ÆÖ‡ÆÆ‡Øà‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øà‡Æ™‡Øç ‡Æ™‡ÆØ‡Æ©‡Øç‡Æ™‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ
                currentTheme = 'light'; currentLanguage = 'en'; currentTextSizeMultiplier = 1.0;
                applyTheme(); applyLanguage(); applyTextSize();
            }
            setLoadingState(false);
        }

        // --- Settings (‡ÆÆ‡Øä‡Æ¥‡Æø ‡Æö‡Øá‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ) ---
        async function loadUserSettings(userId) {
            const userDocRef = db.collection('users').doc(userId);
            try {
                const docSnap = await userDocRef.get();
                if (docSnap.exists) {
                    const settings = docSnap.data();
                    currentTheme = settings.theme || 'light';
                    currentTextSizeMultiplier = settings.textSizeMultiplier || 1.0;
                    currentLanguage = settings.language || 'en'; // ‡ÆÆ‡Øä‡Æ¥‡Æø‡ÆØ‡Øà load ‡Æö‡ØÜ‡ÆØ‡Øç
                    console.log("Loaded user settings:", settings);
                } else {
                    console.log("No user settings found, using defaults and saving.");
                    currentTheme = 'light'; currentTextSizeMultiplier = 1.0; currentLanguage = 'en';
                    await saveUserSettings(); // Defaults-‡Æê ‡Æö‡Øá‡ÆÆ‡Æø
                }
            } catch (error) {
                console.error(getText('errorLoadSettings'), error);
                currentTheme = 'light'; currentTextSizeMultiplier = 1.0; currentLanguage = 'en'; // ‡Æ™‡Æø‡Æ¥‡Øà‡ÆØ‡Æø‡Æ©‡Øç‡Æ™‡Øã‡Æ§‡ØÅ Defaults
            }
            // ‡ÆÖ‡ÆÆ‡Øà‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øà‡Æ™‡Øç ‡Æ™‡ÆØ‡Æ©‡Øç‡Æ™‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ
            applyTheme();
            applyTextSize();
            applyLanguage(); // ‡ÆÆ‡Øä‡Æ¥‡Æø‡ÆØ‡Øà‡Æ™‡Øç ‡Æ™‡ÆØ‡Æ©‡Øç‡Æ™‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ
        }

        async function saveUserSettings() {
            if (!currentUser) return;
            const userDocRef = db.collection('users').doc(currentUser.uid);
            const settings = {
                theme: currentTheme,
                textSizeMultiplier: currentTextSizeMultiplier,
                language: currentLanguage // ‡ÆÆ‡Øä‡Æ¥‡Æø‡ÆØ‡Øà‡Æö‡Øç ‡Æö‡Øá‡ÆÆ‡Æø
            };
            try {
                await userDocRef.set(settings, { merge: true });
                console.log("User settings saved:", settings);
            } catch (error) {
                console.error(getText('errorSaveSettings'), error);
            }
        }

        // --- Chat Storage & Loading ---
        // ... (loadAndListenForChats, renderSidebarChatList, highlightActiveChatInSidebar, createNewChat, handleChatListClick, confirmAndDeleteChat, deleteChatFromFirestore, switchChat, loadAndListenForActiveChat - ‡Æ™‡ØÜ‡Æ∞‡ØÅ‡ÆÆ‡Øç‡Æ™‡Ææ‡Æ≤‡ØÅ‡ÆÆ‡Øç ‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡ÆÆ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà, getText() ‡Æ™‡ÆØ‡Æ©‡Øç‡Æ™‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡Æ™‡Øç‡Æ™‡Æü‡Æ≤‡Ææ‡ÆÆ‡Øç) ...
         function loadAndListenForChats(userId) { /* ... */ if (chatListListener) { chatListListener(); chatListListener = null; } const chatsRef = db.collection('chats').where('userId', '==', userId).orderBy('lastUpdated', 'desc'); chatListListener = chatsRef.onSnapshot(snapshot => { if (isDeletingChat) return; const chats = []; snapshot.forEach(doc => { chats.push({ id: doc.id, ...doc.data() }); }); renderSidebarChatList(chats); let chatToLoad = null; if (activeChatId && chats.some(c => c.id === activeChatId)) { chatToLoad = activeChatId; } else if (chats.length > 0) { chatToLoad = chats[0].id; } else { activeChatId = null; if (activeChatListener) { activeChatListener(); activeChatListener = null; } if (!isTestListView) renderGreetingOrLoginPrompt(); } if (chatToLoad && chatToLoad !== activeChatId) { switchChat(chatToLoad); } else if (activeChatId) { highlightActiveChatInSidebar(); } }, error => { console.error("Error listening for chats:", error); displayError(getText('errorLoadChats')); chatListContainer.innerHTML = `<div style="padding:10px;color:var(--text-secondary);font-size:0.9em;">${getText('errorLoadChats')}</div>`; }); }
         function renderSidebarChatList(chats) { chatListContainer.innerHTML = ''; if (!currentUser) { chatListContainer.innerHTML = `<div ...>${getText('loginToSeeChats')}</div>`; return; } if (chats.length === 0) { const i = document.createElement('div'); i.textContent = getText('noSavedTests'); i.style.cssText = "..."; chatListContainer.appendChild(i); } else { chats.forEach(c => { const i = document.createElement('div'); i.classList.add('chat-list-item'); let title = c.title || getText(NEW_CHAT_TITLE_KEY); if (title === '(New Chat)') title = getText(NEW_CHAT_TITLE_KEY); // Ensure translation i.textContent = title; i.dataset.id = c.id; i.title = title; const deleteBtn = document.createElement('button'); deleteBtn.classList.add('delete-chat-button'); deleteBtn.innerHTML = DELETE_ICON; deleteBtn.title = getText('deleteChatButtonTitle', { title: title }); deleteBtn.dataset.id = c.id; i.appendChild(deleteBtn); chatListContainer.appendChild(i); }); } highlightActiveChatInSidebar(); }
         function highlightActiveChatInSidebar() { /* ... */ const items = chatListContainer.querySelectorAll('.chat-list-item'); items.forEach(item => { item.classList.toggle('active', item.dataset.id === activeChatId); }); }
         async function createNewChat() { /* ... */ if (!currentUser) { displayError(getText('loginToCreateChat')); return; } setLoadingState(true, getText('creatingChat')); const newChatRef = db.collection('chats').doc(); const timestamp = firebase.firestore.FieldValue.serverTimestamp(); try { await newChatRef.set({ userId: currentUser.uid, title: getText(NEW_CHAT_TITLE_KEY), createdAt: timestamp, lastUpdated: timestamp }); console.log("New chat document created:", newChatRef.id); } catch (error) { console.error("Error creating new chat:", error); displayError(getText('errorCreateChat')); } finally { setLoadingState(false); userInput.focus(); } }
         function handleChatListClick(event) { const target = event.target; if (target.classList.contains('delete-chat-button')) { event.stopPropagation(); const chatId = target.dataset.id; const chatTitle = target.closest('.chat-list-item')?.title || 'this chat'; if (chatId) { confirmAndDeleteChat(chatId, chatTitle); } return; } const item = target.closest('.chat-list-item'); const clickedId = item?.dataset?.id; if (clickedId && clickedId !== activeChatId) { switchChat(clickedId); } }
         function confirmAndDeleteChat(chatId, chatTitle) { if (!currentUser || !chatId) return; if (confirm(getText('confirmDeleteChat', { chatTitle: chatTitle }))) { deleteChatFromFirestore(chatId); } }
         async function deleteChatFromFirestore(chatId) { /* ... */ if (!currentUser || !chatId) return; isDeletingChat = true; setLoadingState(true, getText('deletingChat')); const chatDocRef = db.collection('chats').doc(chatId); const messagesRef = chatDocRef.collection('messages'); try { const messagesSnapshot = await messagesRef.get(); if (!messagesSnapshot.empty) { const batch = db.batch(); messagesSnapshot.docs.forEach(doc => { batch.delete(doc.ref); }); await batch.commit(); } await chatDocRef.delete(); if (activeChatId === chatId) { activeChatId = null; currentChatHistory = []; if (activeChatListener) { activeChatListener(); activeChatListener = null; } chatArea.innerHTML = ''; if (!isTestListView) renderGreetingOrLoginPrompt(); } } catch (error) { console.error(`Error deleting chat ${chatId}:`, error); displayError(getText('errorDeleteChat')); } finally { isDeletingChat = false; setLoadingState(false); } }
         function switchChat(chatId) { if (!currentUser || !chatId || chatId === activeChatId) return; activeChatId = chatId; highlightActiveChatInSidebar(); loadAndListenForActiveChat(chatId); userInput.focus(); userInput.value = ''; autoGrowTextarea(); mcqModeCheckbox.checked = false; if(isTestListView) switchView('chat'); // Test list‡Æ≤‡Æø‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æµ‡Æ®‡Øç‡Æ§‡Ææ‡Æ≤‡Øç chat view‡Æï‡Øç‡Æï‡ØÅ ‡ÆÆ‡Ææ‡Æ±‡ØÅ }
         function loadAndListenForActiveChat(chatId) { /* ... */ if (!currentUser || !chatId) { /*...*/ return; } if (activeChatListener) { activeChatListener(); activeChatListener = null; } highlightActiveChatInSidebar(); const messagesRef = db.collection('chats').doc(chatId).collection('messages').orderBy('timestamp', 'asc'); chatArea.innerHTML = ''; const loadingMsg = displayMessage(getText('loadingMessages'), 'ai', ['thinking']); activeChatListener = messagesRef.onSnapshot(snapshot => { removeMessageElement(loadingMsg); chatArea.innerHTML = ''; currentChatHistory = []; if (snapshot.empty) { if (!isTestListView) renderGreetingOrLoginPrompt(); } else { snapshot.forEach(doc => { const msgData = doc.data(); const text = msgData.text || ""; const role = msgData.role || "model"; currentChatHistory.push({ role: role === 'user' ? 'user' : 'model', parts: [{ text: text }] }); displayMessage(text, role, [], null, msgData); }); } scrollToBottom(true); }, error => { console.error(`Error listening for messages in chat ${chatId}:`, error); displayError(getText('errorLoadMessages')); removeMessageElement(loadingMsg); chatArea.innerHTML = ''; currentChatHistory = []; }); }


        // --- Message Sending ---
        async function handleSendMessage() { /* ... (getText() for messages/errors) ... */
            const txt = userInput.value.trim();
            if (!API_KEY) { displayError(getText('errorApi')); return; }
            if (!currentUser) { displayError(getText('loginRequired')); return; }
            if (!activeChatId) { displayError(getText('selectOrCreateChat')); return; }
            if (!txt || sendButton.disabled) return;

            const isMCQRequest = mcqModeCheckbox.checked;
            setLoadingState(true, getText('sendingMessage'));
            const userMessageText = txt;
            userInput.value = ''; autoGrowTextarea(); if (isMCQRequest) mcqModeCheckbox.checked = false;

            const timestamp = firebase.firestore.FieldValue.serverTimestamp();
            const messagesColRef = db.collection('chats').doc(activeChatId).collection('messages');
            const chatDocRef = db.collection('chats').doc(activeChatId);

            let isFirstUserMessageInNewChat = false;
            try { const chatSnap = await chatDocRef.get(); if (chatSnap.exists && chatSnap.data().title === getText(NEW_CHAT_TITLE_KEY)) { const messagesSnap = await messagesColRef.limit(1).get(); if (messagesSnap.empty) { isFirstUserMessageInNewChat = true; } } } catch(err) { console.error("Error checking for first message:", err); }

             const userMsgData = { role: "user", text: userMessageText, timestamp: timestamp };
             try {
                 await messagesColRef.add(userMsgData); await chatDocRef.update({ lastUpdated: timestamp });
                 if (isFirstUserMessageInNewChat) { const generatedTitle = generateChatTitle(userMessageText); if (generatedTitle !== getText(NEW_CHAT_TITLE_KEY)) { await updateActiveChatTitle(generatedTitle); } }
             } catch(error) { console.error("Error saving user message or updating title:", error); displayError(getText('errorSendMessage')); setLoadingState(false); return; }

            const thinking = displayMessage(getText('thinking'), 'ai', ['thinking']);
            const requestHistory = [ ...currentChatHistory, { role: "user", parts: [{ text: userMessageText }] } ];
            let modifiedPrompt = userMessageText; if (isMCQRequest) { /* ... MCQ prompt ... */ modifiedPrompt = `${userMessageText}\n\nPlease provide the response strictly in JSON format...`; requestHistory[requestHistory.length - 1] = { role: "user", parts: [{ text: modifiedPrompt }] }; }

             console.warn("Calling Gemini API using client-side key...");
            try {
                const response = await fetch(API_URL_BASE + API_KEY, { /* ... fetch options ... */ method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: requestHistory, safetySettings: [ /*...*/ ] }), });
                removeMessageElement(thinking);
                let aiMsgData = { role: "model", text: "Error", timestamp: firebase.firestore.FieldValue.serverTimestamp() };
                if (!response.ok) { let err = { message: `API error (${response.status})` }; try { err = (await response.json()).error || err; } catch {} aiMsgData.text = getText('errorApiGeneric', {status: response.status}) + `: ${err.message || getText('errorApiUnknown')}`; displayError(aiMsgData.text); if(response.status===400 && err.message?.toLowerCase().includes('api key not valid')){ localStorage.removeItem(STORAGE_KEY_API_KEY); API_KEY=''; displayError(getText('errorApiKeyInvalid')); } }
                else { const data = await response.json(); let aiTxt = getText('emptyResponse'); let blocked = false; if (data.promptFeedback?.blockReason) { aiTxt = `Blocked: ${data.promptFeedback.blockReason}`; blocked = true; aiMsgData.text = aiTxt; displayMessage(aiTxt,'ai',['error-message']); } else if (data.candidates?.[0]?.content?.parts?.[0]?.text) { aiTxt = data.candidates[0].content.parts[0].text; aiMsgData.text = aiTxt; let processedForMCQ = false; if (isMCQRequest && !blocked) { try { /* ... MCQ parsing ... */ const jsonMatch = aiTxt.match(/```json\s*([\s\S]*?)\s*```/); const jsonString = jsonMatch ? jsonMatch[1].trim() : aiTxt.trim(); if (jsonString.startsWith('[') && jsonString.endsWith(']')) { const mcqs = JSON.parse(jsonString); if (Array.isArray(mcqs) && mcqs.length > 0 && mcqs.every(q => q.question && Array.isArray(q.options) && q.answer)) { const summaryText = `${mcqs.length} MCQs generated. Click below to start.`; aiMsgData.text = summaryText; aiMsgData.mcqData = mcqs; processedForMCQ = true; } } } catch (parseError) { console.error("Failed to parse MCQ JSON:", parseError); } } } else { aiMsgData.text = getText('errorApiResponse'); displayError(aiMsgData.text); } }
                 try { await messagesColRef.add(aiMsgData); await chatDocRef.update({ lastUpdated: firebase.firestore.FieldValue.serverTimestamp() }); } catch (saveError) { console.error("Error saving AI response:", saveError); displayError(getText('errorSaveResponse')); }
            } catch (error) { removeMessageElement(thinking); const errorText = getText('errorNetwork') + `: ${error.message || ""}`; displayError(errorText); try { await messagesColRef.add({ role: "model", text: errorText, timestamp: firebase.firestore.FieldValue.serverTimestamp() }); await chatDocRef.update({ lastUpdated: firebase.firestore.FieldValue.serverTimestamp() }); } catch {} }
            finally { setLoadingState(false); if (!isTestMode && !isReviewMode) userInput.focus(); }
         }

        function generateChatTitle(firstUserMessageText) { /* ... (‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡ÆÆ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà) ... */ if (firstUserMessageText) { const text = firstUserMessageText; const title = text.split(/\s+/).slice(0, 5).join(' ').replace(/[.,!?;:]$/, ''); return title.length > 35 ? title.substring(0, 32) + '...' : title; } return getText(NEW_CHAT_TITLE_KEY); }
        async function updateActiveChatTitle(newTitle) { /* ... (‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡ÆÆ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà) ... */ if (!currentUser || !activeChatId || !newTitle || newTitle === getText(NEW_CHAT_TITLE_KEY)) return; const chatDocRef = db.collection('chats').doc(activeChatId); try { await chatDocRef.update({ title: newTitle }); } catch (error) { console.error("Error updating chat title:", error); } }

        // --- UI & Message Display Functions ---
        function autoGrowTextarea() { /* ... */ userInput.style.height='auto'; userInput.style.height=(userInput.scrollHeight)+'px'; }
        function handleInputKeydown(event) { /* ... */ if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();handleSendMessage();} }
        function handleSuggestionClick(event) { /* ... */ if(event.target.classList.contains('suggestion-chip')){userInput.value=event.target.dataset.prompt||'';autoGrowTextarea();userInput.focus();} }
        function displayError(text) { /* ... */ displayMessage(`${getText('errorLabel', {})} ${text}`, 'ai', ['error-message']); } // Add error label translation?
        function scrollToBottom(immediate = false) { /* ... */ chatArea.scrollTo({top:chatArea.scrollHeight,behavior:immediate?'auto':'smooth'}); }
        function removeMessageElement(element) { /* ... */ if(element?.parentNode===chatArea)chatArea.removeChild(element); }
        function setLoadingState(isLoading, message = getText('thinking')) { /* ... (getText() for placeholder) ... */ const isDisabled = isLoading || !currentUser || (!activeChatId && !isTestListView && !isReviewMode && !isDeletingChat); const inputDisabled = isLoading || !currentUser; userInput.disabled = inputDisabled; sendButton.disabled = isDisabled; mcqModeCheckbox.disabled = isDisabled; if (isLoading) { userInput.placeholder = message; } else if (!currentUser) { userInput.placeholder = getText('notLoggedIn'); } else if (!activeChatId && !isTestListView && !isReviewMode) { userInput.placeholder = getText('selectOrCreateChat'); } else if (isTestListView || isReviewMode) { userInput.placeholder = ""; } else { userInput.placeholder = getText('promptPlaceholder'); } startChatButton.disabled = isLoading || !currentUser; showTestsButton.disabled = isLoading || !currentUser; }

        // View ‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡ØÅ‡Æ§‡Æ≤‡Øç (test-list ‡Æö‡Øá‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ)
        function switchView(viewName) {
            console.log("Switching view to:", viewName);
            chatView.classList.remove('active');
            reviewView.classList.remove('active');
            testView.classList.remove('active');
            testListView.classList.remove('active'); // test-list ‡Æê ‡Æ®‡ØÄ‡Æï‡Øç‡Æï‡ØÅ
            appContainer.classList.remove('hidden');
            isTestMode=false; isReviewMode=false; isTestListView = false; // Reset flags

            // Listener-‡Æï‡Æ≥‡Øà ‡Æ®‡Æø‡Æ∞‡Øç‡Æµ‡Æï‡Æø
            if (viewName !== 'chat' && activeChatListener) { activeChatListener(); activeChatListener = null; }
            if (viewName !== 'test-list' && testListListener) { testListListener(); testListListener = null; }

            if(viewName==='test'){
                appContainer.classList.add('hidden'); testView.classList.add('active'); isTestMode=true;
            } else if(viewName==='review'){
                reviewView.classList.add('active'); isReviewMode=true;
                // Review view‡Æï‡Øç‡Æï‡Ææ‡Æ© save ‡Æ™‡Øä‡Æ§‡Øç‡Æ§‡Ææ‡Æ©‡Øà‡Æï‡Øç ‡Æï‡Æü‡Øç‡Æü‡ØÅ‡Æ™‡Øç‡Æ™‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ (saved review ‡Æ™‡Ææ‡Æ∞‡Øç‡Æï‡Øç‡Æï‡ØÅ‡ÆÆ‡Øç‡Æ™‡Øã‡Æ§‡ØÅ disable ‡Æö‡ØÜ‡ÆØ‡Øç)
                // saveReviewBtn.disabled = ?? ; // ‡Æá‡Æ§‡Øà displaySavedReview-‡Æá‡Æ≤‡Øç ‡Æï‡Øà‡ÆØ‡Ææ‡Æ≥‡Æ≤‡Ææ‡ÆÆ‡Øç
            } else if(viewName === 'test-list') { // ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ view
                testListView.classList.add('active'); isTestListView = true;
                loadAndListenForSavedTests(currentUser?.uid); // ‡Æ™‡ÆØ‡Æ©‡Æ∞‡Øç ‡Æá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡Ææ‡Æ≤‡Øç load ‡Æö‡ØÜ‡ÆØ‡Øç
                testSearchInput.value = ''; // Search ‡Æê clear ‡Æö‡ØÜ‡ÆØ‡Øç
                handleTestSearch(); // Filter ‡Æê reset ‡Æö‡ØÜ‡ÆØ‡Øç
            } else { // Default to chat view
                chatView.classList.add('active');
                // Chat view‡Æï‡Øç‡Æï‡ØÅ ‡ÆÆ‡Ææ‡Æ±‡ØÅ‡ÆÆ‡Øç‡Æ™‡Øã‡Æ§‡ØÅ ‡Æ§‡Øá‡Æµ‡Øà‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Ææ‡Æ≤‡Øç chat‡Æê load ‡Æö‡ØÜ‡ÆØ‡Øç
                if(activeChatId && !activeChatListener) loadAndListenForActiveChat(activeChatId);
                else if (!activeChatId && currentUser) renderGreetingOrLoginPrompt();
            }

            if (viewName !== 'test' && testTimerInterval) { clearInterval(testTimerInterval); testTimerInterval = null; }
        }

        function displayMessage(text, sender, cssClasses = [], appendHtml = null, messageData = null) { /* ... (‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡ÆÆ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà) ... */
            const element = document.createElement('div'); element.classList.add('message', `${sender}-message`, ...cssClasses);
            let formattedText = text.replace(/</g, "<").replace(/>/g, ">").replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/```([\s\S]*?)```/g, (match, code) => `<pre><code>${code.replace(/</g, "<").replace(/>/g, ">")}</code></pre>`).replace(/`([^`]+)`/g, (match, code) => `<code>${code.replace(/</g, "<").replace(/>/g, ">")}</code>`).replace(/\n/g, '<br>');
            element.innerHTML = formattedText;
            if (messageData?.role === 'model' && Array.isArray(messageData.mcqData)) { displayMCQOffer(messageData.mcqData, element); }
            else if (appendHtml) { const tempDiv = document.createElement('div'); tempDiv.innerHTML = appendHtml; while (tempDiv.firstChild) { element.appendChild(tempDiv.firstChild); } }
            chatArea.appendChild(element);
            try { if (typeof MathJax !== "undefined" && MathJax.typesetPromise) { MathJax.typesetPromise([element]).catch(err => console.error('MathJax typeset error:', err)); } } catch (e) {}
            return element;
        }

        // --- MCQ/Test Functions ---
        function handleChatAreaClick(event) { /* ... */ if (event.target.classList.contains('start-test-button')) { const mcqs = generatedMCQData; if (mcqs) { startMockTest(mcqs); generatedMCQData = null; } else { displayError(getText('errorStartTestMCQ')); } } }
        function displayMCQOffer(mcqs, aiMessageElement) { /* ... */ generatedMCQData = mcqs; const buttonHtml = `<button class="start-test-button">${getText('startMockTestButtonText', {count: mcqs.length})}</button>`; const tempDiv = document.createElement('div'); tempDiv.style.marginTop = '10px'; tempDiv.innerHTML = buttonHtml; aiMessageElement.appendChild(tempDiv); scrollToBottom(); }
        function startMockTest(mcqs) { /* ... (mcqs format: [{question, options, answer}]) ... */ if (!currentUser) { displayError(getText('loginToStartTest')); return; } if (!mcqs || mcqs.length === 0) { displayError(getText('noQuestionsForTest')); return; } currentTestMCQs = mcqs; currentQuestionIndex = 0; userAnswers = new Array(mcqs.length).fill(null); reviewResultsCache = null; switchView('test'); displayTestQuestion(0); startTestTimer(); testTitle.textContent = `${getText('mockTestTitle')} (${mcqs.length} Qs)`; }
        function displayTestQuestion(index) { /* ... (‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡ÆÆ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà) ... */ if (index < 0 || index >= currentTestMCQs.length) return; currentQuestionIndex = index; const q = currentTestMCQs[index]; testQuestionNumber.textContent = `${getText('questionLabel')} ${index + 1}`; testQuestion.innerHTML = q.question; testOptionsContainer.innerHTML = ''; const options = Array.isArray(q.options) ? q.options : []; options.forEach((opt, i) => { const label = document.createElement('label'); const input = document.createElement('input'); input.type = 'radio'; input.name = `q_${index}`; input.value = i; input.checked = (userAnswers[index] === i); input.onchange = () => handleOptionSelect(i); label.appendChild(input); label.appendChild(document.createTextNode(` ${opt || getText('emptyOption')}`)); testOptionsContainer.appendChild(label); }); try { if (typeof MathJax !== "undefined" && MathJax.typesetPromise) { MathJax.typesetPromise([testQuestion, testOptionsContainer]).catch(err => {}); } } catch(e){} prevQuestionBtn.disabled = (index === 0); nextQuestionBtn.disabled = (index === currentTestMCQs.length - 1); questionCounter.textContent = `Q: ${index + 1} / ${currentTestMCQs.length}`; }
        function handleOptionSelect(optionIndex) { /* ... */ if (currentQuestionIndex >= 0 && currentQuestionIndex < userAnswers.length) { userAnswers[currentQuestionIndex] = optionIndex; } }
        function handleTestNavigation(direction) { /* ... */ let newIndex = currentQuestionIndex; if (direction === 'prev' && currentQuestionIndex > 0) newIndex--; else if (direction === 'next' && currentQuestionIndex < currentTestMCQs.length - 1) newIndex++; if (newIndex !== currentQuestionIndex) displayTestQuestion(newIndex); }
        function startTestTimer() { /* ... */ if (testTimerInterval) clearInterval(testTimerInterval); testStartTime = Date.now(); testTimerInterval = setInterval(() => { const elapsedSeconds = Math.floor((Date.now() - testStartTime) / 1000); const minutes = Math.floor(elapsedSeconds / 60).toString().padStart(2, '0'); const seconds = (elapsedSeconds % 60).toString().padStart(2, '0'); testTimer.textContent = `${getText('timeLabel')}: ${minutes}:${seconds}`; }, 1000); }
        function submitTest() { /* ... */ if (!confirm(getText('confirmSubmitTest'))) return; if (testTimerInterval) clearInterval(testTimerInterval); const endTime = Date.now(); const timeTakenMs = endTime - testStartTime; switchView('review'); displayReview(timeTakenMs); } // displayReview current attempt‡Æê‡Æï‡Øç ‡Æï‡Ææ‡Æü‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç

        // --- Review Functions (originalMCQs ‡Æö‡Øá‡ÆÆ‡Æø‡Æ™‡Øç‡Æ™‡ØÅ ‡Æö‡Øá‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ) ---
        // ‡Æ§‡Æ±‡Øç‡Æ™‡Øã‡Æ§‡Øà‡ÆØ ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ ‡ÆÆ‡ØÅ‡Æü‡Æø‡Æµ‡Øà‡Æï‡Øç ‡Æï‡Ææ‡Æü‡Øç‡Æü‡ØÅ‡Æ§‡Æ≤‡Øç
        function displayReview(timeTakenMs) {
             reviewContent.innerHTML = '';
             saveReviewBtn.disabled = false; // ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ ‡ÆÆ‡ØÅ‡Æü‡Æø‡Æµ‡Øà‡Æö‡Øç ‡Æö‡Øá‡ÆÆ‡Æø‡Æï‡Øç‡Æï‡Æ≤‡Ææ‡ÆÆ‡Øç
             saveReviewBtn.textContent = getText('saveReviewButtonText');

             if (!currentTestMCQs || currentTestMCQs.length === 0) { /* ... */ return; }

             let correctCount = 0, incorrectCount = 0, skippedCount = 0;
             reviewResultsCache = { // Firestore-‡Æá‡Æ≤‡Øç ‡Æö‡Øá‡ÆÆ‡Æø‡Æï‡Øç‡Æï‡Æ§‡Øç ‡Æ§‡ÆØ‡Ææ‡Æ∞‡Øç ‡Æö‡ØÜ‡ÆØ‡Øç
                 questions: [], // ‡Æ™‡ÆØ‡Æ©‡Æ∞‡Øç ‡Æ™‡Æ§‡Æø‡Æ≤‡Øç‡Æï‡Æ≥‡ØÅ‡Æü‡Æ©‡Øç ‡Æï‡ØÇ‡Æü‡Æø‡ÆØ ‡Æï‡Øá‡Æ≥‡Øç‡Æµ‡Æø‡Æï‡Æ≥‡Øç
                 summary: {},
                 testDate: new Date().toISOString(),
                 timeTakenMs: timeTakenMs,
                 originalMCQs: currentTestMCQs // <<< Retake ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ ‡ÆÖ‡Æö‡Æ≤‡Øç ‡Æï‡Øá‡Æ≥‡Øç‡Æµ‡Æø‡Æï‡Æ≥‡Øà‡Æö‡Øç ‡Æö‡Øá‡ÆÆ‡Æø
             };

             currentTestMCQs.forEach((q, index) => { // q = {question, options, answer (letter)}
                 const userAnswerIndex = userAnswers[index];
                 let userAnswerText = getText('skippedStatus');
                 let status = "skipped"; let itemStatusClass = "status-skipped"; let answerDetailClass = "user-answer-skipped";

                 // ‡Æö‡Æ∞‡Æø‡ÆØ‡Ææ‡Æ© ‡Æ™‡Æ§‡Æø‡Æ≤‡Øç ‡Æé‡Æ¥‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ ‡ÆÆ‡Æ±‡Øç‡Æ±‡ØÅ‡ÆÆ‡Øç index-‡Æê‡Æï‡Øç ‡Æï‡Æ£‡Øç‡Æü‡ØÅ‡Æ™‡Æø‡Æü‡Æø
                 const correctAnswerLetter = q.answer?.trim().toUpperCase();
                 const correctAnswerIndex = correctAnswerLetter ? correctAnswerLetter.charCodeAt(0) - 'A'.charCodeAt(0) : -1;
                 const options = Array.isArray(q.options) ? q.options : [];
                 const correctAnswerText = (correctAnswerIndex >= 0 && correctAnswerIndex < options.length) ? options[correctAnswerIndex] : "N/A";

                 if (userAnswerIndex !== null && userAnswerIndex >= 0 && userAnswerIndex < options.length) {
                     userAnswerText = options[userAnswerIndex];
                     if (userAnswerIndex === correctAnswerIndex) { status = "correct"; itemStatusClass = "status-correct"; answerDetailClass = "user-answer-correct"; correctCount++; }
                     else { status = "incorrect"; itemStatusClass = "status-incorrect"; answerDetailClass = "user-answer-incorrect"; incorrectCount++; }
                 } else if (userAnswerIndex !== null) { userAnswerText = getText('invalidSelection'); status = "incorrect"; itemStatusClass = "status-incorrect"; answerDetailClass = "user-answer-incorrect"; incorrectCount++; }
                 else { skippedCount++; }

                 // ‡Æö‡Øá‡ÆÆ‡Æø‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡ØÅ‡ÆÆ‡Øç ‡Æï‡Øá‡Æ≥‡Øç‡Æµ‡Æø‡Æ§‡Øç ‡Æ§‡Æ∞‡Æµ‡ØÅ (‡Æ™‡Æ§‡Æø‡Æ≤‡Øç ‡Æµ‡Æø‡Æµ‡Æ∞‡Æô‡Øç‡Æï‡Æ≥‡ØÅ‡Æü‡Æ©‡Øç)
                 reviewResultsCache.questions.push({
                     question: q.question, options: options,
                     correctAnswer: correctAnswerText, // ‡Æö‡Æ∞‡Æø‡ÆØ‡Ææ‡Æ© ‡Æ™‡Æ§‡Æø‡Æ≤‡Øç (text)
                     userAnswer: userAnswerText,       // ‡Æ™‡ÆØ‡Æ©‡Æ∞‡Øç ‡Æ™‡Æ§‡Æø‡Æ≤‡Øç (text)
                     status: status                    // ‡Æ®‡Æø‡Æ≤‡Øà (correct/incorrect/skipped)
                 });

                 // Review item‡Æê‡Æï‡Øç ‡Æï‡Ææ‡Æü‡Øç‡Æü‡ØÅ
                 const item = document.createElement('div'); item.classList.add('review-item', itemStatusClass); item.dataset.status = status;
                 let detailsHtml = `<span class="${answerDetailClass}">${getText('yourAnswerLabel')}: ${userAnswerText}</span>`;
                 if (status !== 'correct') { detailsHtml += `<br><span class="correct-answer">${getText('correctAnswerLabel')}: ${correctAnswerText}</span>`; }
                 item.innerHTML = `<div class="review-item-qnum">${getText('questionLabel')} ${index + 1}</div><div class="review-item-question">${q.question}</div><div class="review-item-details">${detailsHtml}</div>`;
                 reviewContent.appendChild(item);
             });

             // ‡Æö‡ØÅ‡Æ∞‡ØÅ‡Æï‡Øç‡Æï‡Æ§‡Øç‡Æ§‡Øà‡Æï‡Øç ‡Æï‡Ææ‡Æü‡Øç‡Æü‡ØÅ
             const totalQuestions = currentTestMCQs.length; const score = `${correctCount}/${totalQuestions}`; const timeSeconds = Math.round(timeTakenMs / 1000); const minutes = Math.floor(timeSeconds / 60); const seconds = timeSeconds % 60; const timeString = `${minutes}m ${seconds}s`;
             reviewSummary.innerHTML = `<span>${getText('scoreLabel')}: ${score}</span> <span class="score-correct">${getText('correctLabel')}: ${correctCount}</span> <span class="score-incorrect">${getText('incorrectLabel')}: ${incorrectCount}</span> <span class="score-skipped">${getText('skippedLabel')}: ${skippedCount}</span> <span>${getText('totalTimeLabel')}: ${timeString}</span>`;
             reviewResultsCache.summary = { score, correct: correctCount, incorrect: incorrectCount, skipped: skippedCount, timeString };

             try { if (typeof MathJax !== "undefined" && MathJax.typesetPromise) { MathJax.typesetPromise([reviewContent]).catch(err => {}); } } catch (e) {}
             filterReviewItems('all');
        }

        // ‡Æö‡Øá‡ÆÆ‡Æø‡Æ§‡Øç‡Æ§ ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ ‡ÆÆ‡ØÅ‡Æü‡Æø‡Æµ‡Øà‡Æï‡Øç ‡Æï‡Ææ‡Æü‡Øç‡Æü‡ØÅ‡Æ§‡Æ≤‡Øç (‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ ‡Æö‡ØÜ‡ÆØ‡Æ≤‡Øç‡Æ™‡Ææ‡Æü‡ØÅ)
        function displaySavedReview(reviewData) {
            reviewContent.innerHTML = '';
            saveReviewBtn.disabled = true; // ‡Æö‡Øá‡ÆÆ‡Æø‡Æ§‡Øç‡Æ§‡Æ§‡Øà ‡ÆÆ‡ØÄ‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡Æö‡Øá‡ÆÆ‡Æø‡Æï‡Øç‡Æï ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡Ææ‡Æ§‡ØÅ
            saveReviewBtn.textContent = getText('reviewSavedAlready'); // ‡ÆÖ‡Æ≤‡Øç‡Æ≤‡Æ§‡ØÅ ‡ÆÆ‡Æ±‡Øà‡Æï‡Øç‡Æï‡Æ≤‡Ææ‡ÆÆ‡Øç

            if (!reviewData || !Array.isArray(reviewData.questions) || reviewData.questions.length === 0) {
                reviewSummary.innerHTML = `<span>${getText('noReviewData')}</span>`; return;
            }

            // ‡Æö‡ØÅ‡Æ∞‡ØÅ‡Æï‡Øç‡Æï‡Æ§‡Øç‡Æ§‡Øà‡Æï‡Øç ‡Æï‡Ææ‡Æü‡Øç‡Æü‡ØÅ
            const summary = reviewData.summary || {};
            reviewSummary.innerHTML = `
                <span>${getText('scoreLabel')}: ${summary.score || 'N/A'}</span>
                <span class="score-correct">${getText('correctLabel')}: ${summary.correct ?? 'N/A'}</span>
                <span class="score-incorrect">${getText('incorrectLabel')}: ${summary.incorrect ?? 'N/A'}</span>
                <span class="score-skipped">${getText('skippedLabel')}: ${summary.skipped ?? 'N/A'}</span>
                <span>${getText('totalTimeLabel')}: ${summary.timeString || 'N/A'}</span>
                <span>(${getText('savedOnLabel')}: ${new Date(reviewData.testDate).toLocaleDateString()})</span>`;

            // ‡Æï‡Øá‡Æ≥‡Øç‡Æµ‡Æø‡Æï‡Æ≥‡Øà‡Æï‡Øç ‡Æï‡Ææ‡Æü‡Øç‡Æü‡ØÅ
            reviewData.questions.forEach((q, index) => {
                 let itemStatusClass = `status-${q.status || 'unknown'}`;
                 let answerDetailClass = `user-answer-${q.status || 'unknown'}`;
                 if (q.status === 'correct') answerDetailClass = 'user-answer-correct';
                 else if (q.status === 'incorrect') answerDetailClass = 'user-answer-incorrect';
                 else if (q.status === 'skipped') answerDetailClass = 'user-answer-skipped';

                 const item = document.createElement('div');
                 item.classList.add('review-item', itemStatusClass);
                 item.dataset.status = q.status;

                 let detailsHtml = `<span class="${answerDetailClass}">${getText('yourAnswerLabel')}: ${q.userAnswer}</span>`;
                 if (q.status !== 'correct') {
                     detailsHtml += `<br><span class="correct-answer">${getText('correctAnswerLabel')}: ${q.correctAnswer}</span>`;
                 }

                 // ‡Æµ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡Æô‡Øç‡Æï‡Æ≥‡Øà‡ÆØ‡ØÅ‡ÆÆ‡Øç ‡Æï‡Ææ‡Æü‡Øç‡Æü‡Æ≤‡Ææ‡ÆÆ‡Øç (‡Æµ‡Æø‡Æ∞‡ØÅ‡ÆÆ‡Øç‡Æ™‡Æø‡Æ©‡Ææ‡Æ≤‡Øç)
                 // let optionsHtml = '<div style="margin-top: 8px; font-size: 0.9em;">Options:<ul>';
                 // if(Array.isArray(q.options)) {
                 //    q.options.forEach(opt => optionsHtml += `<li>${opt}</li>`);
                 // }
                 // optionsHtml += '</ul></div>';
                 // detailsHtml += optionsHtml;


                 item.innerHTML = `
                     <div class="review-item-qnum">${getText('questionLabel')} ${index + 1}</div>
                     <div class="review-item-question">${q.question}</div>
                     <div class="review-item-details">${detailsHtml}</div>`;
                 reviewContent.appendChild(item);
            });

             try { if (typeof MathJax !== "undefined" && MathJax.typesetPromise) { MathJax.typesetPromise([reviewContent]).catch(err => {}); } } catch (e) {}
             filterReviewItems('all'); // Default filter
        }


        function handleReviewFilterClick(event) { /* ... */ const button = event.target.closest('button[data-filter]'); if (button) filterReviewItems(button.dataset.filter); }
        function filterReviewItems(filter) { /* ... */ reviewFilters.querySelectorAll('button').forEach(btn => { btn.classList.toggle('active-filter', btn.dataset.filter === filter); }); reviewContent.querySelectorAll('.review-item').forEach(item => { const show = (filter === 'all') || item.dataset.status === filter; item.classList.toggle('hidden-by-filter', !show); }); }
        function exitReview() { switchView(isTestListView ? 'test-list' : 'chat'); reviewResultsCache = null; } // ‡Æé‡Æ®‡Øç‡Æ§ view‡Æ≤‡Æø‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æµ‡Æ®‡Øç‡Æ§‡Øã‡ÆÆ‡Øã ‡ÆÖ‡Æ§‡Æ±‡Øç‡Æï‡ØÅ‡Æ§‡Øç ‡Æ§‡Æø‡Æ∞‡ØÅ‡ÆÆ‡Øç‡Æ™‡ØÅ

        // Cloud‡Æï‡Øç‡Æï‡ØÅ Review‡Æµ‡Øà ‡Æö‡Øá‡ÆÆ‡Æø (originalMCQs ‡Æâ‡Æü‡Æ©‡Øç)
        async function saveTestReviewToCloud() {
            if (!currentUser) { alert(getText('loginToSaveReview')); return; }
            if (!reviewResultsCache || !reviewResultsCache.originalMCQs) { // originalMCQs ‡Æâ‡Æ≥‡Øç‡Æ≥‡Æ§‡Ææ ‡Æé‡Æ©‡Æö‡Øç ‡Æö‡Æ∞‡Æø‡Æ™‡Ææ‡Æ∞‡Øç
                alert(getText('noReviewDataToSave')); return;
            }

            const reviewDataToSave = {
                ...reviewResultsCache, // summary, questions (with answers), timeTakenMs, testDate, originalMCQs
                userId: currentUser.uid,
                savedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            saveReviewBtn.disabled = true; saveReviewBtn.textContent = getText('savingReview');
            try {
                const newReviewRef = await db.collection('testReviews').add(reviewDataToSave);
                console.log("Review saved to Firestore with ID:", newReviewRef.id);
                alert(getText('testSavedSuccess'));
                saveReviewBtn.textContent = getText('reviewSavedAlready');
            } catch (error) {
                console.error("Error saving review to Firestore:", error); alert(getText('errorSaveReview'));
                saveReviewBtn.disabled = false; saveReviewBtn.textContent = getText('saveReviewButtonText');
            }
        }

        // --- Test List Functions (‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ‡Æµ‡Øà) ---

        // ‡Æö‡Øá‡ÆÆ‡Æø‡Æ§‡Øç‡Æ§ ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ‡Æï‡Æ≥‡Øà Firestore-‡Æá‡Æ≤‡Øç ‡Æá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æï‡Æµ‡Æ©‡Æø‡Æ§‡Øç‡Æ§‡Æ≤‡Øç
        function loadAndListenForSavedTests(userId) {
            if (!userId) {
                testListContent.innerHTML = `<div class="info-message">${getText('loginToSeeChats')}</div>`; // ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Æø‡Æ≤‡Øç Login ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡Æø
                return;
            }
            if (testListListener) { testListListener(); testListListener = null; } // ‡ÆÆ‡ØÅ‡Æ®‡Øç‡Æ§‡Øà‡ÆØ‡Æ§‡Øà ‡Æ®‡ØÄ‡Æï‡Øç‡Æï‡ØÅ

            const testsRef = db.collection('testReviews')
                               .where('userId', '==', userId)
                               .orderBy('savedAt', 'desc'); // ‡Æö‡ÆÆ‡ØÄ‡Æ™‡Æ§‡Øç‡Æ§‡Æø‡ÆØ‡Æ§‡ØÅ ‡ÆÆ‡ØÅ‡Æ§‡Æ≤‡Æø‡Æ≤‡Øç

            testListContent.innerHTML = `<div class="info-message">${getText('loadingTests')}</div>`; // Loading ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡Æø

            testListListener = testsRef.onSnapshot(snapshot => {
                const savedTests = [];
                snapshot.forEach(doc => {
                    savedTests.push({ id: doc.id, ...doc.data() });
                });
                renderSavedTestList(savedTests); // ‡Æ™‡Æü‡Øç‡Æü‡Æø‡ÆØ‡Æ≤‡Øà‡Æï‡Øç ‡Æï‡Ææ‡Æü‡Øç‡Æü‡ØÅ
            }, error => {
                console.error("Error listening for saved tests:", error);
                testListContent.innerHTML = `<div class="info-message error-message">${getText('errorLoadSavedTests')}</div>`;
            });
        }

        // ‡Æö‡Øá‡ÆÆ‡Æø‡Æ§‡Øç‡Æ§ ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ‡Æï‡Æ≥‡Æø‡Æ©‡Øç ‡Æ™‡Æü‡Øç‡Æü‡Æø‡ÆØ‡Æ≤‡Øà‡Æï‡Øç ‡Æï‡Ææ‡Æü‡Øç‡Æü‡ØÅ‡Æ§‡Æ≤‡Øç
        function renderSavedTestList(tests) {
            testListContent.innerHTML = ''; // ‡ÆÆ‡ØÅ‡Æ®‡Øç‡Æ§‡Øà‡ÆØ ‡Æ™‡Æü‡Øç‡Æü‡Æø‡ÆØ‡Æ≤‡Øà ‡Æ®‡ØÄ‡Æï‡Øç‡Æï‡ØÅ
            if (tests.length === 0) {
                testListContent.innerHTML = `<div class="info-message">${getText('noSavedTests')}</div>`;
                return;
            }

            tests.forEach(test => {
                const item = document.createElement('div');
                item.classList.add('test-list-item');
                item.dataset.reviewId = test.id; // ID ‡Æê ‡Æö‡Øá‡ÆÆ‡Æø

                const testDate = test.savedAt?.toDate ? test.savedAt.toDate() : (test.testDate ? new Date(test.testDate) : new Date());
                const formattedDate = testDate.toLocaleDateString();
                const summary = test.summary || {};
                const score = summary.score || 'N/A';
                const time = summary.timeString || 'N/A';
                const qCount = test.originalMCQs?.length || test.questions?.length || 0;

                // ‡Æ§‡Øá‡Æü‡Æ≤‡ØÅ‡Æï‡Øç‡Æï‡Ææ‡Æ© ‡Æ§‡Æ∞‡Æµ‡Øà‡Æö‡Øç ‡Æö‡Øá‡Æ∞‡Øç (lowercase)
                item.dataset.searchText = `${formattedDate} ${score} ${qCount} questions`.toLowerCase();


                item.innerHTML = `
                    <div class="test-list-info">
                        ${getText('savedOnLabel')}: <strong>${formattedDate}</strong> |
                        ${getText('scoreLabel')}: <strong>${score}</strong> (${qCount} Qs) |
                        ${getText('timeLabel')}: ${time}
                    </div>
                    <div class="test-list-actions">
                        <button class="retake-btn" data-action="retake" data-review-id="${test.id}">${getText('retakeTestButtonText')}</button>
                        <button class="review-btn" data-action="review" data-review-id="${test.id}">${getText('reviewAttemptButtonText')}</button>
                        <!-- Delete ‡Æ™‡Øä‡Æ§‡Øç‡Æ§‡Ææ‡Æ©‡Øç ‡Æö‡Øá‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æ≤‡Ææ‡ÆÆ‡Øç: <button data-action="delete" ...>Delete</button> -->
                    </div>
                `;
                testListContent.appendChild(item);
            });
             handleTestSearch(); // ‡Æ§‡Æ±‡Øç‡Æ™‡Øã‡Æ§‡Øà‡ÆØ search ‡Æâ‡Æü‡Æ©‡Øç filter ‡Æö‡ØÜ‡ÆØ‡Øç
        }

        // Test list-‡Æá‡Æ≤‡Øç ‡Æâ‡Æ≥‡Øç‡Æ≥ ‡Æ™‡Øä‡Æ§‡Øç‡Æ§‡Ææ‡Æ©‡Øç click-‡Æï‡Æ≥‡Øà‡Æï‡Øç ‡Æï‡Øà‡ÆØ‡Ææ‡Æ≥‡ØÅ‡Æ§‡Æ≤‡Øç
        function handleTestListClick(event) {
            const button = event.target.closest('button[data-action]');
            if (!button) return;

            const action = button.dataset.action;
            const reviewId = button.dataset.reviewId;

            if (action === 'retake') {
                handleRetakeTest(reviewId);
            } else if (action === 'review') {
                handleReviewSavedAttempt(reviewId);
            }
            // else if (action === 'delete') { /* Delete logic for saved reviews */ }
        }

        // ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡Øà ‡ÆÆ‡ØÄ‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡Æé‡Æ¥‡ØÅ‡Æ§‡ØÅ‡Æ§‡Æ≤‡Øç
        async function handleRetakeTest(reviewId) {
            if (!currentUser || !reviewId) return;
            console.log("Retaking test from review:", reviewId);
            setLoadingState(true, getText('loadingQuestions')); // ‡Æí‡Æ∞‡ØÅ loading ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡Æø ‡Æï‡Ææ‡Æü‡Øç‡Æü‡Æ≤‡Ææ‡ÆÆ‡Øç
            try {
                const reviewDocRef = db.collection('testReviews').doc(reviewId);
                const docSnap = await reviewDocRef.get();

                if (docSnap.exists()) {
                    const reviewData = docSnap.data();
                    // ‡ÆÖ‡Æö‡Æ≤‡Øç MCQ ‡Æï‡Æ≥‡Øà‡Æ™‡Øç ‡Æ™‡ØÜ‡Æ±‡ØÅ‡Æ§‡Æ≤‡Øç (‡Æá‡Æ§‡Æø‡Æ≤‡Øç answer letter ‡Æá‡Æ∞‡ØÅ‡Æï‡Øç‡Æï ‡Æµ‡Øá‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç)
                    const originalMCQs = reviewData.originalMCQs;
                    if (Array.isArray(originalMCQs) && originalMCQs.length > 0) {
                         // originalMCQs format: [{question, options, answer}]
                        startMockTest(originalMCQs); // ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡Øà‡Æ§‡Øç ‡Æ§‡Øä‡Æü‡Æô‡Øç‡Æï‡ØÅ
                    } else {
                        displayError(getText('noMCQDataForRetake'));
                    }
                } else {
                    displayError(getText('reviewNotFound'));
                }
            } catch (error) {
                console.error("Error fetching review for retake:", error);
                displayError(getText('errorRetakeTest'));
            } finally {
                setLoadingState(false);
            }
        }

        // ‡Æö‡Øá‡ÆÆ‡Æø‡Æ§‡Øç‡Æ§ ‡ÆÆ‡ØÅ‡ÆØ‡Æ±‡Øç‡Æö‡Æø‡ÆØ‡Øà ‡ÆÆ‡Æ±‡ØÅ‡Æ™‡Ææ‡Æ∞‡Øç‡Æµ‡Øà ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡Æ≤‡Øç
        async function handleReviewSavedAttempt(reviewId) {
            if (!currentUser || !reviewId) return;
            console.log("Reviewing saved attempt:", reviewId);
            setLoadingState(true, getText('loadingReview'));
            try {
                const reviewDocRef = db.collection('testReviews').doc(reviewId);
                const docSnap = await reviewDocRef.get();

                if (docSnap.exists()) {
                    const reviewData = docSnap.data();
                    switchView('review'); // Review view‡Æï‡Øç‡Æï‡ØÅ ‡ÆÆ‡Ææ‡Æ±‡ØÅ
                    displaySavedReview(reviewData); // ‡Æö‡Øá‡ÆÆ‡Æø‡Æ§‡Øç‡Æ§ ‡Æ§‡Æ∞‡Æµ‡Øà‡Æï‡Øç ‡Æï‡Ææ‡Æü‡Øç‡Æü‡ØÅ
                } else {
                    displayError(getText('reviewNotFound'));
                }
            } catch (error) {
                console.error("Error fetching saved review:", error);
                displayError(getText('errorReviewSaved'));
            } finally {
                setLoadingState(false);
            }
        }

        // Test list-‡Æá‡Æ≤‡Øç ‡Æ§‡Øá‡Æü‡ØÅ‡Æ§‡Æ≤‡Øç
        function handleTestSearch() {
            const searchTerm = testSearchInput.value.toLowerCase().trim();
            const items = testListContent.querySelectorAll('.test-list-item');

            items.forEach(item => {
                const itemText = item.dataset.searchText || '';
                const isVisible = itemText.includes(searchTerm);
                item.classList.toggle('hidden-by-search', !isVisible);
            });
        }

    </script>

</body>
</html>
