<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Chat + Mock Test (v9.4 - Audio Features)</title> <!-- Version Updated -->
    <script>
        // MathJax Config (same)
        window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']] }, svg: { fontCache: 'global' }, options: { skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'] } };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <!-- <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script> -->

    <style>
        /* --- Styles (v9.4 - Audio Styles Added) --- */
        :root { /* ... Theme Variables ... */
             --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; --sidebar-width: 260px; --message-font-size-base: 1rem;
            /* LIGHT */ --sidebar-bg: #f7f7f7; --main-bg: #ffffff; --input-bg: #ffffff; --border-color: #e0e0e0; --text-primary: #2c2c2c; --text-secondary: #5f5f5f; --text-placeholder: #999999; --accent-color: #d97a7a; --user-message-bg: #cce0ff; --user-message-text: #1c1c1c; --ai-message-bg: #f0f0f0; --ai-message-text: #2c2c2c; --button-bg: #f0f0f0; --button-hover-bg: #e0e0e0; --active-item-bg: #e0e0e0; --code-bg: #e8e8e8; --scrollbar-thumb: #ccc; --scrollbar-thumb-hover: #bbb; --app-outer-bg: #e8e8e8; --send-button-bg: var(--accent-color); --send-button-hover-bg: #c76b6b; --send-button-text: #ffffff; --error-bg: #ffebee; --error-text: #c62828; --error-border: #ef9a9a; --message-font-size: var(--message-font-size-base); --delete-button-color: #aaa; --delete-button-hover-color: #dc3545; --input-border-color: var(--border-color); --input-focus-border-color: var(--accent-color); --preview-bg: var(--button-bg); --preview-border: var(--border-color); --remove-btn-color: var(--text-secondary); --remove-btn-hover-color: var(--error-text); --record-btn-color: var(--text-secondary); --record-btn-active-color: #dc3545;
        }
        body.dark-theme { /* DARK */ --sidebar-bg: #2a2a2e; --main-bg: #1e1e1e; --input-bg: #2a2a2e; --border-color: #404040; --text-primary: #e0e0e0; --text-secondary: #a0a0a0; --text-placeholder: #777777; --accent-color: #e58b8b; --user-message-bg: #3a4a6b; --user-message-text: #e8e8e8; --ai-message-bg: #333333; --ai-message-text: #e0e0e0; --button-bg: #404040; --button-hover-bg: #505050; --active-item-bg: #454545; --code-bg: #2c2c2e; --scrollbar-thumb: #555; --scrollbar-thumb-hover: #666; --app-outer-bg: #121212; --send-button-bg: var(--accent-color); --send-button-hover-bg: #f09f9f; --send-button-text: #1e1e1e; --error-bg: #5c2b2b; --error-text: #ffcdd2; --error-border: #8c4343; --delete-button-color: #666; --delete-button-hover-color: #f09f9f; --input-border-color: var(--border-color); --input-focus-border-color: var(--accent-color); --preview-bg: var(--button-bg); --preview-border: var(--border-color); --remove-btn-color: var(--text-secondary); --remove-btn-hover-color: var(--error-text); --record-btn-color: var(--text-secondary); --record-btn-active-color: #f09f9f; }
        body { font-family: var(--font-family); margin: 0; padding: 0; background-color: var(--app-outer-bg); color: var(--text-primary); font-size: 15px; transition: background-color 0.3s ease, color 0.3s ease; }

        /* Layout & Structure (same) */
        .app-container { display: flex; height: 100vh; width: 100vw; overflow: hidden; } .app-container.hidden { display: none; }
        .sidebar { width: var(--sidebar-width); background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 15px 0; box-sizing: border-box; flex-shrink: 0; transition: background-color 0.3s ease, border-color 0.3s ease, width 0.3s ease; }
        .main-container { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; overflow: hidden; position: relative; }
        .main-content, .review-view { display: none; flex-direction: column; background-color: var(--main-bg); height: 100%; width: 100%; overflow: hidden; transition: background-color 0.3s ease; }
        .main-content.active, .review-view.active { display: flex; }
        .chat-area { flex-grow: 1; overflow-y: auto; padding: 30px 10% 20px; display: flex; flex-direction: column; max-width: 800px; margin: 0 auto; width: 80%; }
        .input-container { padding: 10px 10% 15px; border-top: 1px solid var(--border-color); background-color: var(--input-bg); max-width: 800px; margin: 0 auto; width: 80%; transition: background-color 0.3s ease, border-color 0.3s ease; display: none; }

        /* Sidebar Elements (same) */
         /* ... */
         .sidebar-header { padding: 10px 20px; font-size: 1.1em; font-weight: 600; color: var(--text-primary); }
         .sidebar-section { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; margin-top: 10px; }
         .sidebar-section-title { padding: 5px 20px; font-size: 0.85em; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; flex-shrink: 0; }
         #all-tests-section { border-bottom: 1px solid var(--border-color); margin-bottom: 10px; padding-bottom: 10px; flex-shrink: 0; display: flex; flex-direction: column; max-height: 40%; display: none; }
         #all-tests-section.visible { display: flex; }
         #test-search-input { width: calc(100% - 40px); padding: 8px 10px; margin: 5px 15px 10px 15px; border: 1px solid var(--input-border-color); background-color: var(--input-bg); color: var(--text-primary); border-radius: 6px; font-size: 0.9em; box-sizing: border-box; }
         #test-search-input:focus { outline: none; border-color: var(--input-focus-border-color); }
         #all-tests-list { overflow-y: auto; padding: 0 15px; flex-grow: 1; }
         #all-tests-list::-webkit-scrollbar { width: 6px; } #all-tests-list::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 3px;} #all-tests-list::-webkit-scrollbar-thumb:hover { background: var(--scrollbar-thumb-hover); }
         .test-list-item { padding: 8px 10px; margin-bottom: 5px; border-radius: 6px; background-color: var(--button-bg); cursor: default; transition: background-color 0.2s ease; display: flex; flex-direction: column; gap: 5px; border: 1px solid var(--border-color); }
         .test-list-item.hidden-by-search { display: none; }
         .test-list-item .no-search-results { padding:10px;color:var(--text-secondary);font-size:0.9em; }
         .test-item-info { font-size: 0.9em; color: var(--text-primary); position: relative; padding-right: 50px; }
         .test-item-title { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
         .test-item-details { font-size: 0.8em; color: var(--text-secondary); }
         .test-item-actions { display: flex; justify-content: flex-start; gap: 8px; }
         .test-item-actions button, .test-item-actions select { background-color: var(--main-bg); border: 1px solid var(--border-color); color: var(--text-secondary); border-radius: 4px; padding: 4px 8px; font-size: 0.8em; cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease; }
         .test-item-actions button:hover, .test-item-actions select:hover { background-color: var(--button-hover-bg); color: var(--text-primary); }
         .test-item-actions select:disabled { opacity: 0.6; cursor: not-allowed; }
        .test-item-controls { position: absolute; right: 5px; top: 0; display: flex; gap: 5px; }
        .test-item-controls button { background: none; border: none; color: var(--delete-button-color); cursor: pointer; font-size: 1.1em; padding: 0 3px; line-height: 1; opacity: 0.7; transition: color 0.2s ease, opacity 0.2s ease; }
        .test-item-controls button:hover { opacity: 1; color: var(--delete-button-hover-color); }
        .test-item-edit-mode { display: flex; align-items: center; }
        .test-item-edit-mode input[type="text"] { flex-grow: 1; padding: 2px 4px; margin-right: 5px; border: 1px solid var(--input-focus-border-color); background-color: var(--input-bg); color: var(--text-primary); border-radius: 3px; font-size: 0.95em; }
        .test-item-edit-mode button { font-size: 0.9em; padding: 2px 5px; background-color: var(--button-bg); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 3px; cursor: pointer; margin-left: 3px; }
        .test-item-edit-mode button:hover { background-color: var(--button-hover-bg); }
         .start-chat-button { display: flex; align-items: center; gap: 8px; background-color: var(--main-bg); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 8px; padding: 10px 15px; margin: 0 15px 10px 15px; font-size: 0.95em; font-weight: 500; cursor: pointer; text-align: left; transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease; flex-shrink: 0; }
         .start-chat-button:hover { background-color: var(--button-hover-bg); } .start-chat-button svg { fill: currentColor; width: 16px; height: 16px; }
         .start-chat-button:disabled { opacity: 0.6; cursor: not-allowed; }
         .chat-list { overflow-y: auto; padding: 0 15px; margin-bottom: 10px; flex-grow: 1; }
         .chat-list::-webkit-scrollbar { width: 6px; } .chat-list::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 3px;} .chat-list::-webkit-scrollbar-thumb:hover { background: var(--scrollbar-thumb-hover); }
         .chat-list-item { padding: 8px 30px 8px 10px; margin-bottom: 4px; border-radius: 6px; font-size: 0.9em; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-secondary); transition: background-color 0.2s ease, color 0.2s ease; position: relative; }
         .chat-list-item:hover { background-color: var(--button-hover-bg); color: var(--text-primary); }
         .chat-list-item.active { background-color: var(--active-item-bg); color: var(--text-primary); font-weight: 500; }
         .delete-chat-button { position: absolute; right: 6px; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; background: none; border: none; color: var(--delete-button-color); cursor: pointer; font-size: 1.3em; line-height: 1; padding: 0; display: none; opacity: 0.7; transition: color 0.2s ease, opacity 0.2s ease; }
         .chat-list-item:hover .delete-chat-button { display: block; }
         .delete-chat-button:hover { color: var(--delete-button-hover-color); opacity: 1; }
         .sidebar-footer { border-top: 1px solid var(--border-color); padding: 10px 15px; transition: border-color 0.3s ease; flex-shrink: 0; }
         .sidebar-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
         .text-size-controls span, .theme-toggle span { font-size: 0.85em; color: var(--text-secondary); }
         .text-size-buttons button, .theme-toggle button { background: var(--button-bg); border: 1px solid var(--border-color); color: var(--text-secondary); border-radius: 4px; padding: 2px 8px; margin-left: 5px; cursor: pointer; font-size: 1.1em; line-height: 1; transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease; }
         .text-size-buttons button:hover, .theme-toggle button:hover { background-color: var(--button-hover-bg); color: var(--text-primary); }
         .text-size-buttons button:disabled, .theme-toggle button:disabled { opacity: 0.6; cursor: not-allowed; }
         .account-info { display: flex; align-items: center; gap: 10px; font-size: 0.9em; margin-top: 10px; }
         .account-avatar { width: 30px; height: 30px; border-radius: 50%; background-color: #6c757d; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; }
         .account-details { overflow: hidden; }
         .account-email { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-primary); }
         .account-plan { font-size: 0.85em; color: var(--text-secondary); }
         #auth-controls { margin-top: 15px; text-align: center; }
         #auth-controls button { background-color: var(--button-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; padding: 8px 15px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s ease; }
         #auth-controls button:hover { background-color: var(--button-hover-bg); }
         #logout-btn { display: none; }

        /* Chat Area Elements */
        /* ... (greeting, message, user-message, ai-message styles same) ... */
        .greeting { font-size: 1.8em; font-weight: 600; margin-bottom: 40px; color: var(--text-primary); } .greeting .asterisk { color: var(--accent-color); font-size: 1.2em; margin-right: 5px; display: inline-block; vertical-align: middle; }
        .message { padding: 12px 18px; border-radius: 18px; max-width: 80%; word-wrap: break-word; line-height: 1.6; margin-bottom: 15px; font-size: var(--message-font-size); transition: background-color 0.3s ease, color 0.3s ease; }
        .user-message { background-color: var(--user-message-bg); color: var(--user-message-text); align-self: flex-end; border-bottom-right-radius: 5px; }
        .ai-message { background-color: var(--ai-message-bg); color: var(--ai-message-text); align-self: flex-start; border-bottom-left-radius: 5px; }
        .ai-message strong { font-weight: 600; } .ai-message em { font-style: italic; }
        .ai-message pre { background-color: var(--code-bg); color: var(--text-primary); padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 0.9em; transition: background-color 0.3s ease, color 0.3s ease; }
        .ai-message code { font-family: monospace; background-color: var(--code-bg); color: var(--text-primary); padding: 2px 4px; border-radius: 3px; transition: background-color 0.3s ease, color 0.3s ease;}
        .ai-message pre code { background-color: transparent; padding: 0; }
        .ai-message.thinking { background-color: transparent; color: var(--text-secondary); font-style: italic; }
        .error-message { background-color: var(--error-bg); color: var(--error-text); border: 1px solid var(--error-border); align-self: flex-start; transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;}
        .info-message { text-align: center; color: var(--text-secondary); padding: 50px 20px; font-style: italic; }
        .message mjx-container { color: inherit !important; font-size: inherit !important; }
        /* Embedded Media */
        .message img.chat-image, .message img.uploaded-image { max-width: 100%; height: auto; border-radius: 8px; margin-top: 8px; cursor: pointer; display: block; }
        .message img.uploaded-image { border: 1px solid var(--border-color); margin-bottom: 5px; }
        .message audio.chat-audio { width: 100%; max-width: 400px; /* Limit audio player width */ margin-top: 8px; display: block; }
        .message .youtube-embed-container { margin-top: 10px; }
        .message iframe.chat-video { max-width: 100%; aspect-ratio: 16 / 9; border: none; border-radius: 8px; }

        /* Input Area Elements */
        .suggestions { display: none; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; } /* Reduced margin */
        .suggestion-chip { background-color: var(--button-bg); border: 1px solid var(--border-color); color: var(--text-secondary); border-radius: 16px; padding: 8px 15px; font-size: 0.9em; cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease; }
        .suggestion-chip:hover { background-color: var(--button-hover-bg); color: var(--text-primary); }
        .input-box { display: flex; align-items: flex-end; background-color: var(--main-bg); border: 1px solid var(--input-border-color); border-radius: 12px; padding: 5px 5px 5px 10px; /* Reduced left padding */ position: relative; transition: background-color 0.3s ease, border-color 0.3s ease; }
        .input-box:focus-within { border-color: var(--input-focus-border-color); }
        /* Input Buttons (Upload/Record) */
        #file-upload-button, /* Renamed from image-upload-button */
        #record-audio-button {
            background: none; border: none; color: var(--record-btn-color); cursor: pointer; font-size: 1.4em; padding: 0 6px; /* Reduced padding */ margin-right: 3px; /* Reduced margin */ line-height: 1; align-self: center; transition: color 0.2s ease;
        }
        #file-upload-button:hover,
        #record-audio-button:hover { color: var(--text-primary); }
        #file-upload-button:disabled,
        #record-audio-button:disabled { opacity: 0.5; cursor: not-allowed; }
        #record-audio-button.recording { color: var(--record-btn-active-color); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        #user-input { flex-grow: 1; border: none; outline: none; padding: 10px 5px; font-size: 1rem; background-color: transparent; resize: none; min-height: 48px; max-height: 250px; line-height: 1.5; color: var(--text-primary); font-family: var(--font-family); }
        #user-input::placeholder { color: var(--text-placeholder); }
        .mcq-mode-control { display: flex; align-items: center; margin-left: 10px; padding-bottom: 8px; flex-shrink: 0; }
        .mcq-mode-control input[type="checkbox"] { margin-right: 5px; accent-color: var(--accent-color); cursor: pointer;}
        .mcq-mode-control label { font-size: 0.85em; color: var(--text-secondary); cursor: pointer; user-select: none;}
        #send-button { background-color: var(--send-button-bg); color: var(--send-button-text); border: none; border-radius: 8px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-left: 10px; transition: background-color 0.2s ease; padding: 0; flex-shrink: 0; }
        #send-button:hover:not(:disabled) { background-color: var(--send-button-hover-bg); }
        #send-button:disabled { background-color: #cccccc; cursor: not-allowed; opacity: 0.6; }
        #send-button svg { width: 20px; height: 20px; fill: currentColor; }
        /* File Previews */
        #image-preview-container, #audio-preview-container {
            margin-bottom: 8px; /* Space below preview */ padding: 8px; background-color: var(--preview-bg); border: 1px solid var(--preview-border); border-radius: 8px; display: flex; align-items: center; gap: 10px; display: none; /* Hidden by default */
        }
        #image-preview-container img { max-height: 50px; max-width: 80px; height: auto; width: auto; border-radius: 4px; object-fit: cover; }
        #image-preview-info, #audio-preview-info { font-size: 0.85em; color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex-grow: 1; }
        #audio-preview-container .audio-icon { font-size: 1.5em; margin-right: 5px; color: var(--text-secondary); } /* Simple icon for audio */
        #remove-image-button, #remove-audio-button { background: none; border: none; color: var(--remove-btn-color); cursor: pointer; font-size: 1.4em; line-height: 1; padding: 0 5px; transition: color 0.2s ease; margin-left: auto; /* Push remove button to the right */ }
        #remove-image-button:hover, #remove-audio-button:hover { color: var(--remove-btn-hover-color); }
        /* Recording Status */
        #recording-status { font-size: 0.8em; color: var(--record-btn-active-color); margin-left: 5px; }


        .thinking::after { content: ' .'; animation: dots 1s steps(3, end) infinite; display: inline-block; }
        @keyframes dots { 0%, 20% { content: ' .'; } 40% { content: ' ..'; } 60%, 100% { content: ' ...'; } }
         .start-test-button { background-color: var(--accent-color); color: var(--send-button-text); border: none; border-radius: 6px; padding: 8px 15px; margin-top: 10px; cursor: pointer; font-weight: 500; display: inline-block; transition: background-color 0.2s ease; }
         .start-test-button:hover { background-color: var(--send-button-hover-bg); }

        /* Mock Test & Review Styles (same) */
        /* ... */
        .mock-test-view { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--main-bg); z-index: 100; flex-direction: column; padding: 20px; box-sizing: border-box; transition: background-color 0.3s ease; }
        .mock-test-view.active { display: flex; }
        .test-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .test-header h2 { margin: 0; font-size: 1.3em; color: var(--text-primary); }
        .test-info { display: flex; align-items: center; }
        .test-info span { margin-left: 15px; font-size: 0.95em; color: var(--text-secondary); }
        #test-language-toggle, #review-language-toggle { margin-left: 15px; padding: 3px 8px; font-size: 0.8em; cursor: pointer; background-color: var(--button-bg); border: 1px solid var(--border-color); color: var(--text-secondary); border-radius: 4px; transition: background-color 0.2s ease, color 0.2s ease; }
        #test-language-toggle:hover, #review-language-toggle:hover { background-color: var(--button-hover-bg); color: var(--text-primary); }
        .test-content { flex-grow: 1; overflow-y: auto; padding: 10px 20px; }
        .test-question-container { margin-bottom: 25px; }
        .test-question-number { font-weight: bold; margin-bottom: 8px; color: var(--text-secondary); }
        .test-question { font-size: 1.1em; line-height: 1.5; margin-bottom: 15px; color: var(--text-primary); }
        .test-options label { display: block; margin-bottom: 12px; background-color: var(--button-bg); padding: 12px 15px; border-radius: 6px; border: 1px solid var(--border-color); cursor: pointer; transition: background-color 0.2s ease, border-color 0.2s ease; color: var(--text-primary); }
        .test-options label:hover { background-color: var(--button-hover-bg); }
        .test-options input[type="radio"] { margin-right: 10px; accent-color: var(--accent-color); cursor: pointer;}
        .test-navigation { display: flex; justify-content: space-between; padding-top: 15px; border-top: 1px solid var(--border-color); margin-top: auto; flex-shrink: 0; }
        .test-navigation button { background-color: var(--button-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; padding: 10px 20px; cursor: pointer; font-size: 0.95em; transition: background-color 0.2s ease; }
        .test-navigation button:hover:not(:disabled) { background-color: var(--button-hover-bg); }
        .test-navigation button#submit-test-btn { background-color: var(--accent-color); color: var(--send-button-text); border-color: var(--accent-color); }
        .test-navigation button#submit-test-btn:hover:not(:disabled) { background-color: var(--send-button-hover-bg); }
        .test-navigation button:disabled { opacity: 0.5; cursor: not-allowed; }
        .review-view { padding: 20px; box-sizing: border-box; background-color: var(--main-bg); }
        .review-header { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .review-header h2 { margin: 0 0 10px 0; font-size: 1.3em; color: var(--text-primary); }
        .review-summary { display: inline; }
        .review-summary span { margin-right: 20px; font-size: 1em; color: var(--text-primary); }
        .review-summary .score-correct { color: #28a745; font-weight: bold;} .review-summary .score-incorrect { color: #dc3545; font-weight: bold;} .review-summary .score-skipped { color: #fd7e14; font-weight: bold;}
        .review-filters { margin-top: 10px; margin-bottom: 15px; }
        .review-filters button { background-color: var(--button-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; padding: 5px 12px; margin-right: 8px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s ease, border-color 0.2s ease; }
        .review-filters button:hover { background-color: var(--button-hover-bg); }
        .review-filters button.active-filter { background-color: var(--accent-color); color: var(--send-button-text); border-color: var(--accent-color);}
        .review-content { flex-grow: 1; overflow-y: auto; padding-right: 10px; }
        .review-item { margin-bottom: 15px; padding: 15px; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--button-bg); transition: background-color 0.3s ease, border-color 0.3s ease; }
        .review-item.hidden-by-filter { display: none; }
        .review-item-qnum { font-weight: bold; margin-bottom: 8px; color: var(--text-secondary); }
        .review-item-question { margin-bottom: 10px; line-height: 1.5; color: var(--text-primary); }
        .review-item-details span { display: block; margin-bottom: 5px; font-size: 0.95em; color: var(--text-primary); }
        .review-item-details .correct-answer { color: #28a745; font-weight: bold; }
        .review-item-details .user-answer-correct { color: #28a745; } .review-item-details .user-answer-incorrect { color: #dc3545; text-decoration: line-through; } .review-item-details .user-answer-skipped { color: #fd7e14; font-style: italic; }
        .review-item-explanation { margin-top: 8px; font-size: 0.9em; color: var(--text-secondary); border-left: 3px solid var(--border-color); padding-left: 8px; line-height: 1.4; }
        .review-footer { text-align: center; padding-top: 20px; border-top: 1px solid var(--border-color); margin-top: auto; flex-shrink: 0; display: flex; justify-content: center; gap: 15px; }
        #exit-review-btn, #save-review-btn { background-color: var(--accent-color); color: var(--send-button-text); border: none; border-radius: 6px; padding: 10px 25px; cursor: pointer; font-size: 1em; transition: background-color 0.2s ease; display: none; }
        #exit-review-btn:hover, #save-review-btn:hover:not(:disabled) { background-color: var(--send-button-hover-bg); }
        #save-review-btn { background-color: var(--button-bg); color: var(--text-primary); border: 1px solid var(--border-color); }
        #save-review-btn:hover:not(:disabled) { background-color: var(--button-hover-bg); }
        #save-review-btn:disabled { opacity: 0.6; cursor: not-allowed; background-color: #cccccc; border-color: #aaaaaa; }


        /* Responsive Design */
        @media (max-width: 768px) {
            :root { --sidebar-width: 200px; }
            /* ... other mobile styles ... */
            #file-upload-button, #record-audio-button { font-size: 1.3em; padding: 0 5px; } /* Adjust button size */
            #image-preview-container, #audio-preview-container { padding: 6px; gap: 8px; }
            #image-preview-container img { max-height: 40px; }
            #image-preview-info, #audio-preview-info { font-size: 0.8em; }
            #remove-image-button, #remove-audio-button { font-size: 1.3em; }
            .input-box { padding: 5px 5px 5px 8px; } /* Adjust padding */
            /* ... other mobile styles ... */
        }

    </style>
</head>
<body>

    <div class="app-container" id="app-container">
        <div class="sidebar">
             <!-- Sidebar content -->
             <div class="sidebar-header">Gemini Chat</div>
             <div id="all-tests-section"> <div class="sidebar-section-title">All Tests</div> <input type="search" id="test-search-input" placeholder="Search tests..." disabled> <div class="all-tests-list" id="all-tests-list"> <div>Login to see saved tests.</div> </div> </div>
             <div class="sidebar-section"> <button class="start-chat-button" id="start-chat" disabled> <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg> Start new chat </button> <div class="sidebar-section-title">Chats</div> <div class="chat-list" id="chat-list"> <div>Please log in to see chats.</div> </div> </div>
             <div class="sidebar-footer"> <div class="sidebar-controls"> <div class="text-size-controls"> <span>Text Size</span> <div class="text-size-buttons"> <button id="decrease-text-size" title="Decrease text size" disabled>-</button> <button id="increase-text-size" title="Increase text size" disabled>+</button> </div> </div> <div class="theme-toggle"> <button id="theme-toggle-button" title="Toggle Theme" disabled>☀️</button> </div> </div> <div id="auth-controls"> <button id="login-google-btn">Login with Google</button> <button id="logout-btn" style="display: none;">Logout</button> </div> <div class="account-info"> <div class="account-avatar" id="account-avatar">?</div> <div class="account-details"> <div class="account-email" id="account-email">Not logged in</div> <div class="account-plan" id="account-plan"></div> </div> </div> </div>
        </div>

        <div class="main-container">
            <div class="main-content active" id="main-content-chat">
                 <div class="chat-area" id="chat-area">
                     <!-- Messages -->
                 </div>
                 <div class="input-container" id="input-container">
                     <div class="suggestions" id="suggestions">
                          <button class="suggestion-chip" data-prompt="Summarize this audio">Summarize audio</button>
                          <button class="suggestion-chip" data-prompt="Describe this image">Describe image</button>
                          <button class="suggestion-chip" data-prompt="Explain $\lim_{x\to 0} \frac{\sin x}{x} = 1$">Limit sin(x)/x ?</button>
                     </div>
                    <!-- Previews -->
                    <div id="image-preview-container">
                        <img id="preview-image" src="#" alt="Image preview" />
                        <span id="image-preview-info"></span>
                        <button id="remove-image-button" title="Remove image">&times;</button>
                    </div>
                     <div id="audio-preview-container">
                         <span class="audio-icon">🎵</span> <!-- Simple icon -->
                         <span id="audio-preview-info"></span>
                         <span id="recording-status"></span> <!-- For "Recording..." text -->
                         <button id="remove-audio-button" title="Remove audio">&times;</button>
                     </div>
                    <!-- Input Box -->
                    <div class="input-box">
                         <!-- Hidden file input for both image and audio -->
                         <input type="file" id="file-upload-input" accept="image/*,audio/*" style="display: none;">
                         <!-- Upload button (triggers file input) -->
                         <button id="file-upload-button" title="Upload image or audio file" disabled>📎</button>
                         <!-- Record button -->
                         <button id="record-audio-button" title="Record audio" disabled>🎙️</button>
                         <textarea id="user-input" placeholder="Enter prompt, paste URL, click 📎 or 🎙️" rows="1"></textarea>
                         <div class="mcq-mode-control"> <input type="checkbox" id="mcq-mode-checkbox" title="Generate MCQs"> <label for="mcq-mode-checkbox">MCQs?</label> </div>
                         <button id="send-button" title="Send message" disabled> <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
                        </button>
                    </div>
                 </div>
            </div>
            <!-- Review View -->
            <div class="review-view" id="review-view"> <div class="review-header"> <h2 id="review-title">Test Review</h2> <div> <div class="review-summary" id="review-summary"></div> <button id="review-language-toggle">தமிழ்</button> </div> <div class="review-filters" id="review-filters" style="display: none;"> <button data-filter="all" class="active-filter">All</button> <button data-filter="incorrect">Incorrect</button> <button data-filter="skipped">Skipped</button> </div> </div> <div class="review-content" id="review-content"></div> <div class="review-footer"> <button id="save-review-btn">Save Review</button> <button id="exit-review-btn">Back</button> </div> </div>
        </div>
    </div>
    <!-- Mock Test View -->
    <div class="mock-test-view" id="mock-test-view"> <div class="test-header"> <h2 id="test-title">Mock Test</h2> <div class="test-info"> <span id="question-counter">Q: 1 / N</span> <span id="test-timer">Time: 00:00</span> <button id="test-language-toggle">தமிழ்</button> </div> </div> <div class="test-content"> <div class="test-question-container"> <div class="test-question-number" id="test-question-number"></div> <div class="test-question" id="test-question"></div> <div class="test-options" id="test-options"></div> </div> </div> <div class="test-navigation"> <button id="prev-question-btn" disabled>Previous</button> <button id="next-question-btn">Next</button> <button id="submit-test-btn">Submit Test</button> </div> </div>


    <script>
        // --- Firebase Config ---
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        // !!! பாதுகாப்பு எச்சரிக்கை / SECURITY WARNING !!!
        // Replace with YOUR Firebase config and consider security measures.
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        const firebaseConfig = {
          apiKey: "AIzaSyDgw604fe5jnNu4kTOv1cQ-3n7PL8gcN58", // <- REPLACE WITH YOUR KEY
          authDomain: "krish-c5db8.firebaseapp.com",
          projectId: "krish-c5db8",
          storageBucket: "krish-c5db8.appspot.com",
          messagingSenderId: "217175257890",
          appId: "1:217175257890:web:209f0f290eabab6b1fab7b",
          measurementId: "G-97SHYGL2J4"
        };

        // --- Initialize Firebase ---
        firebase.initializeApp(firebaseConfig);
        const fbAuth = firebase.auth();
        const db = firebase.firestore();
        // const storage = firebase.storage();

        // --- DOM Elements ---
        const fileUploadButton = document.getElementById('file-upload-button'); // Renamed
        const fileUploadInput = document.getElementById('file-upload-input'); // Renamed
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const previewImage = document.getElementById('preview-image');
        const imagePreviewInfo = document.getElementById('image-preview-info');
        const removeImageButton = document.getElementById('remove-image-button');
        const recordAudioButton = document.getElementById('record-audio-button');
        const audioPreviewContainer = document.getElementById('audio-preview-container');
        const audioPreviewInfo = document.getElementById('audio-preview-info');
        const removeAudioButton = document.getElementById('remove-audio-button');
        const recordingStatus = document.getElementById('recording-status');
        // Other elements (same as before)
        const appContainer = document.getElementById('app-container');
        const chatArea = document.getElementById('chat-area');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const suggestionsContainer = document.getElementById('suggestions');
        const startChatButton = document.getElementById('start-chat');
        const chatListContainer = document.getElementById('chat-list');
        const allTestsSection = document.getElementById('all-tests-section');
        const testSearchInput = document.getElementById('test-search-input');
        const allTestsListContainer = document.getElementById('all-tests-list');
        const accountEmail = document.getElementById('account-email');
        const accountAvatar = document.getElementById('account-avatar');
        const accountPlan = document.getElementById('account-plan');
        const decreaseTextBtn = document.getElementById('decrease-text-size');
        const increaseTextBtn = document.getElementById('increase-text-size');
        const themeToggleButton = document.getElementById('theme-toggle-button');
        const mainContainer = document.querySelector('.main-container');
        const chatView = document.getElementById('main-content-chat');
        const testView = document.getElementById('mock-test-view');
        const reviewView = document.getElementById('review-view');
        const inputContainer = document.getElementById('input-container');
        const mcqModeCheckbox = document.getElementById('mcq-mode-checkbox');
        const loginBtn = document.getElementById('login-google-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const testTitle = document.getElementById('test-title');
        const questionCounter = document.getElementById('question-counter');
        const testTimer = document.getElementById('test-timer');
        const testQuestionNumber = document.getElementById('test-question-number');
        const testQuestion = document.getElementById('test-question');
        const testOptionsContainer = document.getElementById('test-options');
        const prevQuestionBtn = document.getElementById('prev-question-btn');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const submitTestBtn = document.getElementById('submit-test-btn');
        const testLanguageToggle = document.getElementById('test-language-toggle');
        const reviewTitle = document.getElementById('review-title');
        const reviewSummary = document.getElementById('review-summary');
        const reviewContent = document.getElementById('review-content');
        const exitReviewBtn = document.getElementById('exit-review-btn');
        const reviewFilters = document.getElementById('review-filters');
        const saveReviewBtn = document.getElementById('save-review-btn');
        const reviewLanguageToggle = document.getElementById('review-language-toggle');


        // --- Config & Constants ---
        const MODEL_NAME = "gemini-1.5-pro-latest"; // Use 1.5 Pro for better multimodal support
        const API_URL_BASE=`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=`;
        const STORAGE_KEY_API_KEY='geminiApiKey_insecureDemo';
        const NEW_CHAT_TITLE="(New Chat)";
        const TEXT_SIZE_STEP=0.1;
        const MIN_TEXT_SIZE_MULTIPLIER=0.7;
        const MAX_TEXT_SIZE_MULTIPLIER=1.5;
        const LIGHT_THEME_ICON='☀️';
        const DARK_THEME_ICON='🌙';
        const DELETE_ICON = '×';
        const EDIT_TEST_ICON = '✏️';
        const DELETE_TEST_ICON = '🗑️';
        const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:watch\?v=|embed\/|v\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})(?:\S+)?/i;
        const imageUrlRegex = /(?<!src=["'])(?<!href=["'])(https?:\/\/[^\s()<>]+?\.(?:jpg|jpeg|png|gif|webp|bmp))/gi;
        const MAX_IMAGE_SIZE_MB = 4;
        const MAX_AUDIO_SIZE_MB = 15; // Max audio file size for base64 upload (adjust lower if needed)
        const SUPPORTED_AUDIO_TYPES = ['audio/mpeg', 'audio/mp3', 'audio/wav', 'audio/ogg', 'audio/aac', 'audio/aiff', 'audio/flac', 'audio/webm']; // Added webm for recording

        // --- State Variables ---
        let API_KEY='';
        let currentUser = null;
        let activeChatId = null;
        let currentChatHistory=[];
        let currentTextSizeMultiplier=1.0;
        let currentTheme='light';
        let isTestMode=false;
        let isReviewMode=false;
        let currentTestMCQs=[];
        let currentQuestionIndex=0;
        let userAnswers=[];
        let testStartTime=null;
        let testTimerInterval=null;
        let reviewResultsCache = null;
        let cameFromAllTestsList = false;
        let activeChatListener = null;
        let chatListListener = null;
        let testListListener = null;
        let isDeletingChat = false;
        let allSavedTestsData = [];
        let currentTestLanguage = 'en';
        let currentReviewLanguage = 'en';
        // Media State
        let selectedImageData = { file: null, base64: null, mimeType: null };
        let selectedAudioData = { file: null, base64: null, mimeType: null, filename: null }; // Added filename
        // Recording State
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let recordingStartTime = null;

        // --- Initialization ---
        initializeApp();

        // --- Event Listeners ---
        sendButton.addEventListener('click', handleSendMessage);
        userInput.addEventListener('input', autoGrowTextarea);
        userInput.addEventListener('keydown', handleInputKeydown);
        suggestionsContainer.addEventListener('click', handleSuggestionClick);
        startChatButton.addEventListener('click', createNewChat);
        chatListContainer.addEventListener('click', handleChatListClick);
        allTestsListContainer.addEventListener('click', handleAllTestsListClick);
        testSearchInput.addEventListener('input', filterTestsInSidebar);
        decreaseTextBtn.addEventListener('click', () => adjustTextSize(-TEXT_SIZE_STEP));
        increaseTextBtn.addEventListener('click', () => adjustTextSize(TEXT_SIZE_STEP));
        themeToggleButton.addEventListener('click', toggleTheme);
        prevQuestionBtn.addEventListener('click', () => handleTestNavigation('prev'));
        nextQuestionBtn.addEventListener('click', () => handleTestNavigation('next'));
        submitTestBtn.addEventListener('click', submitTest);
        testLanguageToggle.addEventListener('click', toggleTestLanguage);
        exitReviewBtn.addEventListener('click', exitReview);
        chatArea.addEventListener('click', handleChatAreaClick);
        reviewFilters.addEventListener('click', handleReviewFilterClick);
        saveReviewBtn.addEventListener('click', saveTestReviewToCloud);
        reviewLanguageToggle.addEventListener('click', toggleReviewLanguage);
        loginBtn.addEventListener('click', signInWithGoogle);
        logoutBtn.addEventListener('click', signOut);
        // Media Listeners
        fileUploadButton.addEventListener('click', () => fileUploadInput.click()); // Upload btn triggers hidden input
        fileUploadInput.addEventListener('change', handleFileUpload); // Handles both image/audio file selection
        removeImageButton.addEventListener('click', removeSelectedImage);
        recordAudioButton.addEventListener('click', toggleRecording);
        removeAudioButton.addEventListener('click', removeSelectedAudio);


        // --- Initialization Functions ---
        async function initializeApp() { loadGeminiApiKey(); fbAuth.onAuthStateChanged(handleAuthStateChange); switchView('chat'); userInput.focus(); }
        function loadGeminiApiKey() { /* ... (same as before) ... */ console.warn("!!! SECURITY WARNING !!! Using insecure API key storage."); API_KEY = localStorage.getItem(STORAGE_KEY_API_KEY); if(!API_KEY){ API_KEY=prompt("--- INSECURE DEMO --- Enter Gemini API Key:"); if(API_KEY){ localStorage.setItem(STORAGE_KEY_API_KEY, API_KEY); } else { displayError("API Key required."); setLoadingState(true,"API Key Missing"); } } setLoadingState(!API_KEY); }

        // --- Authentication Functions ---
        async function signInWithGoogle() { /* ... (same as before) ... */ const p = new firebase.auth.GoogleAuthProvider(); try { setLoadingState(true,"Logging in..."); await fbAuth.signInWithPopup(p); } catch (e) { console.error("SignIn Error:", e); displayError(`Login failed: ${e.message||'?'}`); setLoadingState(false); } }
        async function signOut() { /* ... (same as before) ... */ try { setLoadingState(true,"Logging out..."); await fbAuth.signOut(); } catch (e) { console.error("SignOut Error:", e); displayError(`Logout failed: ${e.message||'?'}`); setLoadingState(false); } }

        function handleAuthStateChange(user) { /* ... (Updated to disable audio buttons) ... */
            if (activeChatListener) activeChatListener(); if (chatListListener) chatListListener(); if (testListListener) testListListener();
            chatArea.innerHTML = ''; chatListContainer.innerHTML = '<div>Please log in...</div>'; allTestsListContainer.innerHTML = '<div>Login to see tests.</div>';
            allTestsSection.classList.remove('visible'); testSearchInput.value = ''; testSearchInput.disabled = true; activeChatId = null; currentChatHistory = []; isDeletingChat = false; allSavedTestsData = [];
            removeSelectedImage(); removeSelectedAudio(); // Clear previews

            if (user) {
                currentUser = user; console.log("User logged in:", currentUser.uid);
                loginBtn.style.display = 'none'; logoutBtn.style.display = 'inline-block';
                accountEmail.textContent = currentUser.email || '?'; accountAvatar.textContent = (currentUser.displayName||currentUser.email||'U')[0].toUpperCase(); accountPlan.textContent = "Firebase User";
                // Enable controls
                startChatButton.disabled = false; decreaseTextBtn.disabled = false; increaseTextBtn.disabled = false; themeToggleButton.disabled = false; testSearchInput.disabled = false; userInput.disabled = false;
                fileUploadButton.disabled = false; // Enable file upload
                recordAudioButton.disabled = false; // Enable record button
                sendButton.disabled = true; mcqModeCheckbox.disabled = true; // Until chat selected
                userInput.placeholder = "Select or create a chat"; inputContainer.style.display = 'block'; suggestionsContainer.style.display = 'flex'; allTestsSection.classList.add('visible');
                loadUserSettings(currentUser.uid); loadAndListenForChats(currentUser.uid); loadAndListenForTests(currentUser.uid); setLoadingState(false);
            } else {
                currentUser = null; console.log("User logged out");
                loginBtn.style.display = 'inline-block'; logoutBtn.style.display = 'none';
                accountEmail.textContent = "Not logged in"; accountAvatar.textContent = '?'; accountPlan.textContent = "";
                // Disable controls
                startChatButton.disabled = true; decreaseTextBtn.disabled = true; increaseTextBtn.disabled = true; themeToggleButton.disabled = true; testSearchInput.disabled = true; userInput.disabled = true;
                fileUploadButton.disabled = true; // Disable file upload
                recordAudioButton.disabled = true; // Disable record button
                sendButton.disabled = true; mcqModeCheckbox.disabled = true;
                userInput.placeholder = "Please log in"; inputContainer.style.display = 'none'; suggestionsContainer.style.display = 'none'; allTestsSection.classList.remove('visible');
                renderGreetingOrLoginPrompt();
                currentTheme = 'light'; applyTheme(); currentTextSizeMultiplier = 1.0; applyTextSize(); setLoadingState(false);
            }
        }

        function renderGreetingOrLoginPrompt() { /* ... (same as before) ... */ chatArea.innerHTML = ''; const el = document.createElement('div'); el.classList.add('greeting'); if (currentUser) { el.innerHTML = `<span class="asterisk">*</span>Hi, ${currentUser.displayName||'User'}!`; if (!activeChatId) { displayMessage("Select a chat or start new.", 'ai'); } } else { el.innerHTML = `<span class="asterisk">*</span>Welcome!`; displayMessage("Log in to start.", 'ai'); } chatArea.appendChild(el); scrollToBottom(true); }

        // --- Settings (Theme/Text Size) ---
        /* ... (loadUserSettings, saveUserSettings, applyTheme, toggleTheme, applyTextSize, adjustTextSize remain the same) ... */
        async function loadUserSettings(userId){/*...*/} async function saveUserSettings(){/*...*/} function applyTheme(){/*...*/} function toggleTheme(){/*...*/} function applyTextSize(){/*...*/} function adjustTextSize(change){/*...*/}

        // --- Chat Storage & Loading ---
        function loadAndListenForChats(userId) { /* ... (Updated to disable audio buttons if no chat) ... */
            if (chatListListener) chatListListener();
            const chatsRef = db.collection('chats').where('userId', '==', userId).orderBy('lastUpdated', 'desc');
            console.log(`Listening chats user ${userId}`);
            chatListListener = chatsRef.onSnapshot(snapshot => {
                 if (isDeletingChat) return;
                const chats = []; snapshot.forEach(doc => chats.push({ id: doc.id, ...doc.data() }));
                renderSidebarChatList(chats);
                let chatToLoad = null;
                if (activeChatId && chats.some(c => c.id === activeChatId)) chatToLoad = activeChatId;
                else if (chats.length > 0) chatToLoad = chats[0].id;
                else { activeChatId = null; if (activeChatListener) activeChatListener(); renderGreetingOrLoginPrompt(); setLoadingState(false); sendButton.disabled = true; mcqModeCheckbox.disabled = true; fileUploadButton.disabled = true; recordAudioButton.disabled = true; userInput.placeholder = "Create chat"; }
                 if (chatToLoad && chatToLoad !== activeChatId) switchChat(chatToLoad);
                 else if (activeChatId) { highlightActiveChatInSidebar(); setLoadingState(false); const enable = !API_KEY; sendButton.disabled = enable; mcqModeCheckbox.disabled = enable; fileUploadButton.disabled = enable; recordAudioButton.disabled = enable; }
                 else setLoadingState(false);
            }, error => { console.error("Error listening chats:", error); displayError("Could not load chat list."); setLoadingState(false); });
        }
        function renderSidebarChatList(chats) { /* ... (same as v9.2) ... */ chatListContainer.innerHTML = ''; if (!currentUser) { chatListContainer.innerHTML = '<div>Log in</div>'; return; } if (chats.length === 0) { chatListContainer.innerHTML = '<div>No chats yet</div>'; } else { chats.forEach(chat => { const item = document.createElement('div'); item.classList.add('chat-list-item'); let title = chat.title; if (!title?.trim()) title = '(Untitled)'; title = title.trim(); item.textContent = title; item.dataset.id = chat.id; item.title = title; const delBtn = document.createElement('button'); delBtn.classList.add('delete-chat-button'); delBtn.innerHTML = DELETE_ICON; delBtn.title = "Delete"; delBtn.dataset.id = chat.id; item.appendChild(delBtn); chatListContainer.appendChild(item); }); } highlightActiveChatInSidebar(); }
        function highlightActiveChatInSidebar() { /* ... (same as v9.2) ... */ const items=chatListContainer.querySelectorAll('.chat-list-item'); items.forEach(i=>i.classList.toggle('active',i.dataset.id===activeChatId)); }

        // --- Media Handling (Image & Audio Upload) ---
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                // If user cancels file selection, ensure previews are cleared
                removeSelectedImage();
                removeSelectedAudio();
                return;
            }

            // Clear previous selections before processing new one
            removeSelectedImage();
            removeSelectedAudio();

            if (file.type.startsWith('image/')) {
                handleImageFileSelect(file);
            } else if (file.type.startsWith('audio/')) {
                handleAudioFileSelect(file);
            } else {
                alert("Unsupported file type. Please select an image or audio file. / ஆதரிக்கப்படாத கோப்பு வகை. படம் அல்லது ஆடியோ கோப்பைத் தேர்ந்தெடுக்கவும்.");
                fileUploadInput.value = ''; // Reset input
            }
        }

        function handleImageFileSelect(file) { // Takes file object directly now
            const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif', 'image/bmp'];
            if (!allowedTypes.includes(file.type)) { alert("Invalid image type."); fileUploadInput.value = ''; return; }
            const fileSizeMB = file.size / 1024 / 1024;
            if (fileSizeMB > MAX_IMAGE_SIZE_MB) { alert(`Image too large (${fileSizeMB.toFixed(1)}MB). Max ${MAX_IMAGE_SIZE_MB}MB.`); fileUploadInput.value = ''; return; }

            const reader = new FileReader();
            reader.onload = (e) => {
                selectedImageData = { file: file, base64: e.target.result, mimeType: file.type };
                previewImage.src = e.target.result;
                imagePreviewInfo.textContent = file.name;
                imagePreviewContainer.style.display = 'flex';
            }
            reader.onerror = (e) => { console.error("File Read Error:", e); alert("Error reading image."); removeSelectedImage(); };
            reader.readAsDataURL(file);
        }

        function handleAudioFileSelect(file) { // Takes file object directly now
            if (!SUPPORTED_AUDIO_TYPES.includes(file.type)) { alert(`Unsupported audio type: ${file.type}. Supported: ${SUPPORTED_AUDIO_TYPES.join(', ')}`); fileUploadInput.value = ''; return; }
            const fileSizeMB = file.size / 1024 / 1024;
            if (fileSizeMB > MAX_AUDIO_SIZE_MB) { alert(`Audio too large (${fileSizeMB.toFixed(1)}MB). Max ${MAX_AUDIO_SIZE_MB}MB.`); fileUploadInput.value = ''; return; }
             // Check if currently recording, stop it if necessary
            if (isRecording) {
                stopRecording(); // Ensure recording is stopped before processing uploaded file
                alert("Recording stopped to upload audio file.");
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                selectedAudioData = { file: file, base64: e.target.result, mimeType: file.type, filename: file.name };
                console.log("Audio selected:", file.name, file.type);
                displayAudioPreview(file.name);
            }
            reader.onerror = (e) => { console.error("File Read Error:", e); alert("Error reading audio file."); removeSelectedAudio(); };
            reader.readAsDataURL(file);
        }

        function displayAudioPreview(filename) {
            audioPreviewInfo.textContent = filename || "Audio ready";
            recordingStatus.textContent = ''; // Clear recording status
            audioPreviewContainer.style.display = 'flex';
        }

        function removeSelectedImage() { /* ... (same as v9.2) ... */ selectedImageData={file:null,base64:null,mimeType:null}; imagePreviewContainer.style.display='none'; previewImage.src='#'; imagePreviewInfo.textContent=''; if(fileUploadInput) fileUploadInput.value=''; console.log("Selected image removed."); }
        function removeSelectedAudio() {
             if (isRecording) stopRecording(); // Stop recording if active
             selectedAudioData = { file: null, base64: null, mimeType: null, filename: null };
             audioPreviewContainer.style.display = 'none';
             audioPreviewInfo.textContent = '';
             recordingStatus.textContent = '';
             // Don't reset fileUploadInput here if it handles both images and audio
             console.log("Selected audio removed.");
         }

        // --- Audio Recording Functions ---
        async function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                await startRecording();
            }
        }

        async function startRecording() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert("Audio recording is not supported by your browser.");
                return;
            }
            // Clear any previously uploaded/recorded audio/image
            removeSelectedAudio();
            removeSelectedImage();

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                isRecording = true;
                audioChunks = [];
                // Explicitly try common supported types first
                const options = { mimeType: 'audio/webm' }; // Try webm first
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                     console.warn("audio/webm not supported, trying audio/ogg");
                     options.mimeType = 'audio/ogg'; // Fallback to ogg
                     if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                          console.warn("audio/ogg not supported, using browser default");
                          delete options.mimeType; // Use browser default
                     }
                 }
                mediaRecorder = new MediaRecorder(stream, options);
                const recorderMimeType = mediaRecorder.mimeType; // Get the actual mimeType being used
                console.log("Recording started with type:", recorderMimeType);

                mediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    console.log("Recording stopped.");
                    isRecording = false;
                    recordAudioButton.classList.remove('recording');
                    recordAudioButton.title = "Record audio";
                    recordingStatus.textContent = 'Processing...';
                    const audioBlob = new Blob(audioChunks, { type: recorderMimeType });
                    processRecording(audioBlob);
                    // Stop microphone tracks
                    stream.getTracks().forEach(track => track.stop());
                    mediaRecorder = null; // Clean up recorder instance
                };

                 mediaRecorder.onerror = (event) => {
                     console.error("MediaRecorder error:", event.error);
                     alert(`Recording error: ${event.error.name || 'Unknown error'}`);
                     isRecording = false;
                     recordAudioButton.classList.remove('recording');
                     recordAudioButton.title = "Record audio";
                     recordingStatus.textContent = 'Error!';
                     stream.getTracks().forEach(track => track.stop()); // Ensure tracks are stopped on error
                     mediaRecorder = null;
                 };

                mediaRecorder.start();
                recordingStartTime = Date.now();
                recordAudioButton.classList.add('recording');
                recordAudioButton.title = "Stop recording";
                recordingStatus.textContent = 'Recording...';
                audioPreviewContainer.style.display = 'flex'; // Show container for status
                audioPreviewInfo.textContent = ''; // Clear filename

            } catch (err) {
                console.error("Error accessing microphone:", err);
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    alert("Microphone permission denied. Please allow microphone access in your browser settings.");
                } else {
                    alert(`Could not start recording: ${err.name || err.message}`);
                }
                isRecording = false;
                 recordAudioButton.classList.remove('recording');
                 recordAudioButton.title = "Record audio";
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop(); // This will trigger the 'onstop' event
                console.log("Stop recording requested...");
            } else {
                 console.log("Not recording or recorder not ready.");
                 // Manually reset state if something went wrong
                 isRecording = false;
                 recordAudioButton.classList.remove('recording');
                 recordAudioButton.title = "Record audio";
                 recordingStatus.textContent = '';
                 if(mediaRecorder) mediaRecorder = null; // Clean up just in case
            }
        }

        function processRecording(audioBlob) {
            const fileSizeMB = audioBlob.size / 1024 / 1024;
            console.log(`Processing recording: Type=${audioBlob.type}, Size=${fileSizeMB.toFixed(2)}MB`);

             if (fileSizeMB > MAX_AUDIO_SIZE_MB) {
                 alert(`Recording too large (${fileSizeMB.toFixed(1)}MB). Max ${MAX_AUDIO_SIZE_MB}MB.`);
                 removeSelectedAudio();
                 return;
             }

             if (!SUPPORTED_AUDIO_TYPES.includes(audioBlob.type)) {
                 console.warn(`Recording resulted in potentially unsupported type: ${audioBlob.type}. Sending anyway.`);
                 // Optionally alert user or attempt conversion server-side in a real app.
             }

            const reader = new FileReader();
            reader.onload = (e) => {
                const filename = `recording-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.${audioBlob.type.split('/')[1] || 'bin'}`;
                selectedAudioData = {
                    file: null, // No file object for recordings
                    base64: e.target.result,
                    mimeType: audioBlob.type,
                    filename: filename
                };
                console.log("Recording processed to base64.");
                displayAudioPreview(filename); // Show preview with generated filename
            };
             reader.onerror = (e) => { console.error("Blob Read Error:", e); alert("Error processing recording."); removeSelectedAudio(); };
            reader.readAsDataURL(audioBlob);
        }


        // --- Chat Creation, Deletion, Switching ---
        async function createNewChat() { /* ... (Added audio removal) ... */ if (!currentUser) { displayError("Log in"); return; } setLoadingState(true, "Creating..."); removeSelectedImage(); removeSelectedAudio(); /*...*/ const newRef=db.collection('chats').doc(); const ts=firebase.firestore.FieldValue.serverTimestamp(); try { await newRef.set({userId:currentUser.uid, title:NEW_CHAT_TITLE, createdAt:ts, lastUpdated:ts}); console.log("New chat:", newRef.id); } catch (e) { console.error(e); displayError("Failed create chat."); setLoadingState(false); } }
        function handleChatListClick(event) { /* ... (same) ... */ const tgt=event.target; const delBtn=tgt.closest('.delete-chat-button'); if (delBtn) { event.stopPropagation(); const id=delBtn.dataset.id; const item=delBtn.closest('.chat-list-item'); const title=item?.textContent?.replace(delBtn.textContent,'').trim()||'chat'; if(id) confirmAndDeleteChat(id,title); return; } const item=tgt.closest('.chat-list-item'); const id=item?.dataset?.id; if(item&&id&&id!==activeChatId) switchChat(id); }
        function confirmAndDeleteChat(id, title) { /* ... (same) ... */ if (!currentUser || !id) return; if (confirm(`Delete "${title}"?`)) deleteChatFromFirestore(id); }
        async function deleteChatFromFirestore(id) { /* ... (Added audio button disable) ... */ if (!currentUser||!id) return; isDeletingChat=true; setLoadingState(true,"Deleting..."); const chatRef=db.collection('chats').doc(id); const msgRef=chatRef.collection('messages'); try { const msgSnap=await msgRef.get(); if (!msgSnap.empty) { const batch=db.batch(); msgSnap.docs.forEach(d=>batch.delete(d.ref)); await batch.commit(); } await chatRef.delete(); console.log("Deleted chat:", id); if (activeChatId===id) { activeChatId=null; currentChatHistory=[]; if(activeChatListener) activeChatListener(); chatArea.innerHTML=''; renderGreetingOrLoginPrompt(); userInput.placeholder="Select/create chat"; sendButton.disabled=true; mcqModeCheckbox.disabled=true; fileUploadButton.disabled=true; recordAudioButton.disabled=true; removeSelectedImage(); removeSelectedAudio(); } } catch (e) { console.error(e); displayError("Failed delete."); setLoadingState(false); } finally { isDeletingChat=false; } }
        function switchChat(id) { /* ... (Added audio removal) ... */ if (!currentUser||!id||id===activeChatId) return; console.log("Switch chat:", id); setLoadingState(true, "Loading..."); activeChatId=id; removeSelectedImage(); removeSelectedAudio(); highlightActiveChatInSidebar(); userInput.value=''; autoGrowTextarea(); mcqModeCheckbox.checked=false; userInput.placeholder="Loading..."; loadAndListenForActiveChat(id); }

        // --- Message Loading ---
        function loadAndListenForActiveChat(chatId) { /* ... (Updated placeholder, enable audio buttons) ... */
            if (!currentUser || !chatId) { /* handle */ return; }
            if (activeChatListener) activeChatListener();
            const messagesRef = db.collection('chats').doc(chatId).collection('messages').orderBy('timestamp', 'asc');
            chatArea.innerHTML = ''; const loadingMsg = displayMessage("Loading...", 'ai', ['thinking']); scrollToBottom(true);
            activeChatListener = messagesRef.onSnapshot(snapshot => {
                removeMessageElement(loadingMsg); chatArea.innerHTML = ''; currentChatHistory = [];
                if (snapshot.empty && activeChatId === chatId) { /* handle empty */ renderGreetingOrLoginPrompt(); }
                else { snapshot.forEach(doc => { const msgData = doc.data(); const text = msgData.text || ""; const role = msgData.role === 'user' ? 'user' : 'model'; currentChatHistory.push({ role: role, parts: [{ text: text }] }); displayMessage(text, role, [], null, msgData); }); }
                scrollToBottom(true); setLoadingState(false); const enable = !API_KEY; sendButton.disabled = enable; mcqModeCheckbox.disabled = enable; fileUploadButton.disabled = enable; recordAudioButton.disabled = enable; // Enable audio buttons
                userInput.placeholder = "Enter prompt, paste URL, click 📎 or 🎙️"; if (!isTestMode && !isReviewMode) userInput.focus();
            }, error => { /* handle error */ console.error(error); displayError("Could not load messages."); removeMessageElement(loadingMsg); setLoadingState(false); /* disable buttons */ sendButton.disabled=true; mcqModeCheckbox.disabled=true; fileUploadButton.disabled=true; recordAudioButton.disabled=true; userInput.placeholder="Error"; });
        }


        // --- Message Sending (Handles Text, Image, Audio, YouTube) ---
        async function handleSendMessage() {
            const userMessageTextRaw = userInput.value.trim();
            const imageToSend = selectedImageData.base64 ? { ...selectedImageData } : null;
            const audioToSend = selectedAudioData.base64 ? { ...selectedAudioData } : null; // Use selectedAudioData

            if (!API_KEY) { displayError("API Key not set."); return; }
            if (!currentUser) { displayError("Please log in."); return; }
            if (!activeChatId) { displayError("Please select/create a chat."); return; }
            // Require text OR image OR audio to send
            if (!userMessageTextRaw && !imageToSend && !audioToSend) {
                console.log("Nothing to send."); return;
            }
            if (sendButton.disabled) return;

            const isMCQRequest = mcqModeCheckbox.checked;
            setLoadingState(true, "Sending...");

            // Clear inputs after copying values
            userInput.value = ''; autoGrowTextarea();
            if (isMCQRequest) mcqModeCheckbox.checked = false;
            removeSelectedImage();
            removeSelectedAudio(); // Clear audio state too

            const timestamp = firebase.firestore.FieldValue.serverTimestamp();
            const messagesColRef = db.collection('chats').doc(activeChatId).collection('messages');
            const chatDocRef = db.collection('chats').doc(activeChatId);

            let isFirstUserMessageInNewChat = false;
            let potentialTestTitle = null;

            // Handle YouTube URL
            const youtubeMatch = userMessageTextRaw.match(youtubeRegex);
            const youtubeUrl = youtubeMatch ? youtubeMatch[0] : null;
            const youtubeVideoId = youtubeMatch ? youtubeMatch[1] : null;
            if (youtubeUrl) console.log("Detected YouTube URL:", youtubeUrl);

             // --- Prepare User Message Data for Firestore ---
             // Store raw text, image data (if any), audio data (if any), YT ID (if any)
             const userMsgData = {
                 role: "user",
                 text: userMessageTextRaw, // Store raw text always
                 timestamp: timestamp,
                 ...(youtubeVideoId && { youtubeVideoId: youtubeVideoId }),
                 ...(imageToSend && { imageData: imageToSend.base64, imageMimeType: imageToSend.mimeType }),
                 ...(audioToSend && { audioData: audioToSend.base64, audioMimeType: audioToSend.mimeType }) // Save audio base64
                 // WARNING: Saving large audio base64 strings to Firestore is inefficient and can exceed limits. Use Firebase Storage in production.
             };
             console.log("Saving to Firestore:", { ...userMsgData, imageData: imageToSend?"Yes":"No", audioData: audioToSend?"Yes":"No" });

             // --- Save User Message to Firestore ---
             try {
                 /* ... (Check first message, save message, update timestamp - same as before) ... */
                 const chatSnap = await chatDocRef.get(); if (chatSnap.exists && chatSnap.data().title === NEW_CHAT_TITLE) { const messagesSnap = await messagesColRef.limit(1).get(); if (messagesSnap.empty) isFirstUserMessageInNewChat = true; }
                 await messagesColRef.add(userMsgData); await chatDocRef.update({ lastUpdated: timestamp }); console.log("User message saved.");
                 if (isFirstUserMessageInNewChat) { const titleSrc = userMessageTextRaw || (imageToSend?"Image":null) || (audioToSend?"Audio":null) || "New Chat"; const genTitle = generateChatTitle(titleSrc); if (genTitle && genTitle !== NEW_CHAT_TITLE) { await updateActiveChatTitle(genTitle); console.log("Auto title:", genTitle); } }
             } catch(error) { console.error("Error saving user message:", error); displayError("Failed to send."); setLoadingState(false); return; }

             // Display "Thinking..."
            const thinking = displayMessage("Thinking...", 'ai', ['thinking']);
            scrollToBottom();

            // --- Prepare Parts for CURRENT API Call ---
            const currentUserPartsForAPI = [];
            let userTextForPrompt = userMessageTextRaw; // Use raw text for prompt

            // Handle MCQ Prompt Modification
            if (isMCQRequest) {
                 if (!userMessageTextRaw) { displayError("MCQs require a text prompt."); removeMessageElement(thinking); setLoadingState(false); return; }
                 potentialTestTitle = generateChatTitle(userMessageTextRaw) || "Generated Test"; potentialTestTitle += ` (${new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})})`;
                 // Append MCQ request to the prompt text
                 userTextForPrompt += `\n\nPlease generate multiple choice questions... (rest of your bilingual prompt)`; // ADD FULL PROMPT
                 console.log("MCQ mode: Modifying prompt text.");
             }

            // Add Text Part (if non-empty)
            if (userTextForPrompt) {
                currentUserPartsForAPI.push({ text: userTextForPrompt });
            }

            // Add Image Part (if exists)
            if (imageToSend) {
                const base64DataOnly = imageToSend.base64.substring(imageToSend.base64.indexOf(',') + 1);
                currentUserPartsForAPI.push({ inlineData: { mimeType: imageToSend.mimeType, data: base64DataOnly } });
                console.log(`API: Adding image part ${imageToSend.mimeType}`);
            }

            // Add Audio Part (if exists)
            if (audioToSend) {
                 // Ensure audio MIME type is valid for API if possible, default otherwise
                 const apiMimeType = SUPPORTED_AUDIO_TYPES.includes(audioToSend.mimeType) ? audioToSend.mimeType : 'application/octet-stream'; // Fallback if type unknown/unsupported
                 if (apiMimeType !== audioToSend.mimeType) console.warn(`Sending audio with type ${apiMimeType} instead of original ${audioToSend.mimeType}`);
                 const base64DataOnly = audioToSend.base64.substring(audioToSend.base64.indexOf(',') + 1);
                 currentUserPartsForAPI.push({ inlineData: { mimeType: apiMimeType, data: base64DataOnly } });
                 console.log(`API: Adding audio part ${apiMimeType}`);
            }

            // Add YouTube Video Part (if exists) - Use fileUri as per docs
            if (youtubeUrl) {
                 currentUserPartsForAPI.push({ fileData: { fileUri: youtubeUrl } });
                 console.log(`API: Adding YouTube URI part ${youtubeUrl}`);
                 // No need to remove YT URL from the text part for the API
            }

            // --- Prepare History for API (Text Only) ---
            const apiHistoryForCall = currentChatHistory.map(msg => ({
                role: msg.role, parts: msg.parts.filter(part => part.text)
            })).filter(msg => msg.parts.length > 0);

            // --- Combine History + Current Parts for API ---
            const finalContentsForAPI = [...apiHistoryForCall];
            if (currentUserPartsForAPI.length > 0) {
                 finalContentsForAPI.push({ role: "user", parts: currentUserPartsForAPI });
            } else { console.warn("No parts to send to API."); removeMessageElement(thinking); setLoadingState(false); return; }


             console.warn("Calling Gemini API (Model:", MODEL_NAME, "). Ensure key validity & model access.");
             // --- Call Gemini API ---
             try {
                 const response = await fetch(API_URL_BASE + API_KEY, {
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify({
                         contents: finalContentsForAPI, // Send combined history and current parts
                         safetySettings: [ /* ... Safety settings ... */ { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, ]
                     }),
                 });

                 removeMessageElement(thinking);

                 // --- Process API Response ---
                 let aiMsgData = { role: "model", text: "Error: No valid response.", timestamp: firebase.firestore.FieldValue.serverTimestamp(), mcqData: null, mcqTitle: null };
                 let displayAsError = true;

                 if (!response.ok) { /* ... Error handling ... */ let eD=`API error (${response.status})`; try{const eJ=await response.json();eD=eJ.error?.message||eD;}catch{} console.error("API Error:",response.status,eD); aiMsgData.text=`Error: ${eD}`; if(response.status===400&&eD.toLowerCase().includes('api key not valid')){localStorage.removeItem(STORAGE_KEY_API_KEY);API_KEY='';aiMsgData.text+=" Invalid Key cleared. Reload.";} }
                 else {
                     const data = await response.json(); console.log("API Response:", data);
                     let rawAiText = ""; let blocked = false; displayAsError = false;

                     // Check safety blocks
                     if (data.promptFeedback?.blockReason) { aiMsgData.text = `Blocked (Prompt): ${data.promptFeedback.blockReason}`; blocked = true; displayAsError = true; }
                     else if (data.candidates?.[0]?.finishReason === 'SAFETY') { aiMsgData.text = `Blocked (Response)`; blocked = true; displayAsError = true; }
                     // Check for valid text content
                     else if (data.candidates?.[0]?.content?.parts?.some(p => p.text)) {
                         rawAiText = data.candidates[0].content.parts.map(p => p.text || '').join('\n'); // Join text parts
                         aiMsgData.text = rawAiText;
                         displayAsError = false;

                         // --- Parse MCQ if requested ---
                         if (isMCQRequest && !blocked) {
                             try { /* ... MCQ Parsing Logic ... */ const jsonMatch = rawAiText.match(/```json\s*([\s\S]*?)\s*```/); const jsonString = jsonMatch ? jsonMatch[1].trim() : rawAiText.trim(); if (jsonString.startsWith('[')&&jsonString.endsWith(']')) { const mcqs=JSON.parse(jsonString); const isValid=Array.isArray(mcqs)&&mcqs.length>0&&mcqs.every(q=>q&&q.question?.en&&q.question.ta&&Array.isArray(q.options)&&q.options.length===4&&q.options.every(o=>o?.en&&o.ta)&&q.answer&&['A','B','C','D'].includes(q.answer.toUpperCase())&&q.explanation?.en&&q.explanation.ta); if(isValid){ aiMsgData.text=`Generated ${mcqs.length} MCQs.`; aiMsgData.mcqData=mcqs; aiMsgData.mcqTitle=potentialTestTitle; console.log("MCQs parsed:", mcqs.length); displayAsError=false; } else { console.warn("MCQ JSON invalid."); aiMsgData.text="MCQ format error.\n\n"+rawAiText; displayAsError=true; } } else { console.warn("MCQ not JSON array."); aiMsgData.text="Expected MCQ JSON.\n\n"+rawAiText; displayAsError=true; } } catch (e) { console.error("MCQ Parse Error:", e); aiMsgData.text="Error parsing MCQs.\n\n"+rawAiText; displayAsError=true; } finally { if(displayAsError){aiMsgData.mcqData=null; aiMsgData.mcqTitle=null;} }
                         }

                     } else { // No text, not blocked
                        console.warn("API response OK but no text part found. Reason:", data.candidates?.[0]?.finishReason);
                        aiMsgData.text = `(Response finished: ${data.candidates?.[0]?.finishReason || 'OK, No Text'})`;
                        displayAsError = data.candidates?.[0]?.finishReason !== 'STOP'; // Don't show as error if it just stopped normally
                     }
                 }

                 // --- Save AI Response ---
                 try { await messagesColRef.add(aiMsgData); await chatDocRef.update({ lastUpdated: firebase.firestore.FieldValue.serverTimestamp() }); console.log("AI response saved."); }
                 catch (e) { console.error("Error saving AI response:", e); displayError(`Failed to save response: ${aiMsgData.text}`); }

             } catch (fetchError) { /* ... Network error handling ... */ console.error("API Fetch Error:",fetchError); removeMessageElement(thinking); const eTxt=`API Error: ${fetchError.message||"Network issue."}`; displayError(eTxt); try { await messagesColRef.add({role:"model",text:eTxt, timestamp:firebase.firestore.FieldValue.serverTimestamp()}); await chatDocRef.update({lastUpdated:firebase.firestore.FieldValue.serverTimestamp()}); } catch(e){console.error("Failed save fetch error:",e);} }
             finally { setLoadingState(false); if (!isTestMode && !isReviewMode && activeChatId) userInput.focus(); }
        } // End of handleSendMessage

        // --- Chat Title Generation/Update ---
        /* ... (generateChatTitle, updateActiveChatTitle remain the same) ... */
        function generateChatTitle(srcTxt){if(!srcTxt)return NEW_CHAT_TITLE; const txt=srcTxt.trim(); if(!txt)return NEW_CHAT_TITLE; const title=txt.split(/\s+/).slice(0,5).join(' ').replace(/[.,!?;:]+$/,''); return title.length>35?title.substring(0,32)+'...':title;} async function updateActiveChatTitle(newTitle){if(!currentUser||!activeChatId||!newTitle?.trim()||newTitle.trim()===NEW_CHAT_TITLE)return; const final=newTitle.trim(); const docRef=db.collection('chats').doc(activeChatId); try{await docRef.update({title:final});console.log(`Title updated: ${final}`);}catch(e){console.error("Err update title:",e);}}

        // --- UI & Message Display Helpers ---
        /* ... (autoGrowTextarea, handleInputKeydown, handleSuggestionClick, displayError, scrollToBottom, removeMessageElement remain the same) ... */
        function autoGrowTextarea() { userInput.style.height='auto'; userInput.style.height=(userInput.scrollHeight)+'px'; }
        function handleInputKeydown(event) { if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();handleSendMessage();} }
        function handleSuggestionClick(event) { if(event.target.classList.contains('suggestion-chip')){userInput.value=event.target.dataset.prompt||'';autoGrowTextarea();userInput.focus();} }
        function displayError(text) { console.error("ERR:", text); displayMessage(`Error: ${text}`, 'ai', ['error-message']); scrollToBottom(); }
        function scrollToBottom(immediate=false) { chatArea.scrollTo({top:chatArea.scrollHeight,behavior:immediate?'auto':'smooth'}); }
        function removeMessageElement(el) { if(el?.parentNode===chatArea) chatArea.removeChild(el); }

        function setLoadingState(isLoading, message = "Generating...") { /* ... (Updated for audio buttons) ... */
             const isDisabledOverall = isLoading || !currentUser || !API_KEY; const isSendDisabled = isDisabledOverall || !activeChatId;
             userInput.disabled = isDisabledOverall; sendButton.disabled = isSendDisabled; mcqModeCheckbox.disabled = isSendDisabled;
             fileUploadButton.disabled = isSendDisabled || isRecording; // Disable upload if no chat or recording
             recordAudioButton.disabled = isSendDisabled && !isRecording; // Disable record if no chat, but allow stopping if already recording

             const isControlDisabled = isLoading || !currentUser; startChatButton.disabled = isControlDisabled; testSearchInput.disabled = isControlDisabled; decreaseTextBtn.disabled = isControlDisabled || (currentUser && currentTextSizeMultiplier <= MIN_TEXT_SIZE_MULTIPLIER); increaseTextBtn.disabled = isControlDisabled || (currentUser && currentTextSizeMultiplier >= MAX_TEXT_SIZE_MULTIPLIER); themeToggleButton.disabled = isControlDisabled;
             if (isLoading) { userInput.placeholder = message; } else if (!currentUser) { userInput.placeholder = "Please log in"; } else if (!activeChatId) { userInput.placeholder = "Select or create chat"; } else if (!API_KEY) { userInput.placeholder = "API Key missing."; } else { userInput.placeholder = "Enter prompt, paste URL, click 📎 or 🎙️"; }
         }

        function switchView(viewName, cameFromTests = false) { /* ... (same) ... */ console.log("View:", viewName); chatView.classList.remove('active'); reviewView.classList.remove('active'); testView.classList.remove('active'); appContainer.classList.remove('hidden'); isTestMode=false; isReviewMode=false; cameFromAllTestsList=cameFromTests; saveReviewBtn.style.display='none'; exitReviewBtn.style.display='none'; if(viewName==='test'){ appContainer.classList.add('hidden'); testView.classList.add('active'); isTestMode=true; } else if(viewName==='review'){ reviewView.classList.add('active'); isReviewMode=true; exitReviewBtn.style.display='inline-block'; exitReviewBtn.textContent=cameFromAllTestsList?"Back to Tests":"Back to Chat"; } else { chatView.classList.add('active'); if (currentUser && activeChatId && API_KEY) userInput.focus(); } if (viewName!=='test'&&testTimerInterval) clearInterval(testTimerInterval); }

        // Displays message (Handles text, img URL, uploaded img, audio, YT)
        function displayMessage(text, sender, cssClasses = [], appendHtml = null, messageData = null) {
            const messageElement = document.createElement('div'); messageElement.classList.add('message', `${sender}-message`); if (cssClasses?.length) messageElement.classList.add(...cssClasses);
            const contentContainer = document.createElement('div'); // To hold text/inline images

            // 1. Display Uploaded Image (if present)
            if (messageData?.imageData) { const img = document.createElement('img'); img.src = messageData.imageData; img.alt = "Uploaded Image"; img.classList.add('uploaded-image'); img.loading = "lazy"; messageElement.appendChild(img); }

             // 2. Display Uploaded/Recorded Audio (if present)
             if (messageData?.audioData) {
                 console.log("Rendering audio player for message.");
                 const audio = document.createElement('audio');
                 audio.src = messageData.audioData; // Base64 data URL
                 audio.controls = true;
                 audio.classList.add('chat-audio');
                 audio.preload = "metadata"; // Don't load full audio until user clicks play
                 messageElement.appendChild(audio);
             }

            // 3. Process Text Content
            const tempDiv = document.createElement('div'); tempDiv.innerText = text || ""; let formattedText = tempDiv.innerHTML;
            // Parse Image URLs in text (only if no uploaded image)
            if (!messageData?.imageData) { formattedText = formattedText.replace(imageUrlRegex, (m, url) => `<img src="${url}" class="chat-image" alt="Image" loading="lazy">`); }
            // Other formatting
            formattedText = formattedText.replace(/```([\s\S]*?)```/g, (_, code) => `<pre><code>${code.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</code></pre>`).replace(/`([^`]+)`/g, (_, code) => `<code>${code.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</code>`).replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/(?<!\*)\*(?!\*)(.*?)(?<!\*)\*(?!\*)/g, '<em>$1</em>').replace(/\n/g, '<br>');
            contentContainer.innerHTML = formattedText; if (text) { messageElement.appendChild(contentContainer); } // Add text container if text exists

            // 4. YouTube Embed (if ID exists)
            if (messageData?.youtubeVideoId) { const ytDiv = document.createElement('div'); ytDiv.classList.add('youtube-embed-container'); const iframe = document.createElement('iframe'); iframe.classList.add('chat-video'); iframe.src = `https://www.youtube.com/embed/${messageData.youtubeVideoId}`; iframe.title = "YouTube video player"; iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"; iframe.allowFullscreen = true; iframe.loading = "lazy"; ytDiv.appendChild(iframe); messageElement.appendChild(ytDiv); }

            // 5. MCQ Offer
            if (messageData?.role === 'model' && messageData?.mcqData?.length > 0) { displayMCQOffer(messageData.mcqData, messageData.mcqTitle, messageElement); }
            else if (appendHtml) { const appDiv = document.createElement('div'); appDiv.innerHTML = appendHtml; while (appDiv.firstChild) messageElement.appendChild(appDiv.firstChild); }

            chatArea.appendChild(messageElement);
            try { if (typeof MathJax !== "undefined" && MathJax.typesetPromise) { MathJax.typesetPromise([messageElement]).catch(err => console.error('MathJax:', err)); } } catch (e) { console.error("MathJax call:", e); }
            return messageElement;
        }


        // --- MCQ/Test Specific Functions ---
        /* ... (All test/review functions remain the same as v9.3/v9.2) ... */
         function handleChatAreaClick(event) { const startBtn = event.target.closest('.start-test-button'); if (startBtn) { const dataStr = startBtn.dataset.mcq; const title = startBtn.dataset.mcqTitle; let mcqs = null; if (dataStr) { try { mcqs = JSON.parse(dataStr); } catch(e){ console.error("MCQ Parse fail:",e); displayError("Cannot start test."); return; } } if (mcqs?.length > 0) startMockTest(mcqs, title || null); else displayError("MCQ data invalid."); return; } const img = event.target.closest('img.chat-image, img.uploaded-image'); if (img?.src && !img.src.endsWith('#')) window.open(img.src, '_blank'); }
        function displayMCQOffer(mcqData,mcqTitle,el){if(el.querySelector('.start-test-button'))return; const count=mcqData.length; const btn=document.createElement('button'); btn.classList.add('start-test-button'); btn.textContent=`Start Test (${count} Qs)`; btn.title=mcqTitle||`Start test`; try{btn.dataset.mcq=JSON.stringify(mcqData); if(mcqTitle)btn.dataset.mcqTitle=mcqTitle;}catch(e){console.error("MCQ stringify err:",e); return;} const cont=document.createElement('div'); cont.style.marginTop='10px'; cont.appendChild(btn); el.appendChild(cont);}
        function toggleTestLanguage() { currentTestLanguage=(currentTestLanguage==='en')?'ta':'en'; testLanguageToggle.textContent=(currentTestLanguage==='en')?'தமிழ்':'English'; displayTestQuestion(currentQuestionIndex); }
        function startMockTest(mcqs,title=null){if(!currentUser){displayError("Log in.");return;} if(!mcqs?.length){displayError("No Qs.");if(cameFromAllTestsList)switchView('chat');return;} console.log("Start test:",mcqs.length,"Qs. Title:",title); currentTestMCQs=mcqs; currentQuestionIndex=0; userAnswers=new Array(mcqs.length).fill(null); reviewResultsCache=null; currentTestLanguage='en'; testLanguageToggle.textContent='தமிழ்'; switchView('test'); displayTestQuestion(0); startTestTimer(); const finalTitle=(title?.trim())?title.trim():`Test (${mcqs.length} Qs)`; testTitle.textContent=finalTitle;}
        function displayTestQuestion(idx){if(idx<0||idx>=currentTestMCQs.length)return; currentQuestionIndex=idx; const qData=currentTestMCQs[idx]; const lang=currentTestLanguage; const qTxt=qData.question?.[lang]||qData.question?.en||"?"; testQuestionNumber.textContent=`Q ${idx+1}`; testQuestion.innerHTML=qTxt; testOptionsContainer.innerHTML=''; const opts=qData.options||[]; const letters=['A','B','C','D']; opts.forEach((optObj,optIdx)=>{if(optIdx>=letters.length)return; const optTxt=optObj?.[lang]||optObj?.en||'?'; const lbl=document.createElement('label'); const inp=document.createElement('input'); inp.type='radio'; inp.name=`q_${idx}`; inp.value=optIdx; inp.checked=(userAnswers[idx]===optIdx); inp.onchange=()=>handleOptionSelect(optIdx); lbl.appendChild(inp); lbl.appendChild(document.createTextNode(` ${letters[optIdx]}. ${optTxt}`)); testOptionsContainer.appendChild(lbl);}); try{if(typeof MathJax!=="undefined"&&MathJax.typesetPromise)MathJax.typesetPromise([testQuestion,testOptionsContainer]).catch(err=>console.error(err));}catch(e){console.error(e);} prevQuestionBtn.disabled=(idx===0); nextQuestionBtn.disabled=(idx===currentTestMCQs.length-1); questionCounter.textContent=`Q: ${idx+1}/${currentTestMCQs.length}`; }
        function handleOptionSelect(optIdx){if(currentQuestionIndex>=0&&currentQuestionIndex<userAnswers.length)userAnswers[currentQuestionIndex]=optIdx;}
        function handleTestNavigation(dir){let newIdx=currentQuestionIndex; if(dir==='prev'&&currentQuestionIndex>0)newIdx--; else if(dir==='next'&&currentQuestionIndex<currentTestMCQs.length-1)newIdx++; if(newIdx!==currentQuestionIndex)displayTestQuestion(newIdx);}
        function startTestTimer(){if(testTimerInterval)clearInterval(testTimerInterval); testStartTime=Date.now(); testTimer.textContent=`Time: 00:00`; testTimerInterval=setInterval(()=>{const elS=Math.floor((Date.now()-testStartTime)/1000); const min=Math.floor(elS/60).toString().padStart(2,'0'); const sec=(elS%60).toString().padStart(2,'0'); testTimer.textContent=`Time: ${min}:${sec}`;},1000);}
        function submitTest(){if(!confirm("Submit?"))return; if(testTimerInterval)clearInterval(testTimerInterval); const endT=Date.now(); const timeMs=testStartTime?endT-testStartTime:0; const results=calculateResults(currentTestMCQs,userAnswers,timeMs); reviewResultsCache=results; switchView('review',false); displayReview(results);}
        function toggleReviewLanguage(){currentReviewLanguage=(currentReviewLanguage==='en')?'ta':'en'; reviewLanguageToggle.textContent=(currentReviewLanguage==='en')?'தமிழ்':'English'; if(reviewResultsCache)displayReview(reviewResultsCache);}
        function calculateResults(mcqs,ans,timeMs){let c=0,i=0,s=0; const rQ=[]; mcqs.forEach((q,idx)=>{const uAIdx=ans[idx]; const opts=q.options||[]; const cALtr=q.answer?.trim().toUpperCase(); const cAIdx=cALtr?cALtr.charCodeAt(0)-'A'.charCodeAt(0):-1; const cATxtE=(cAIdx>=0&&cAIdx<opts.length)?(opts[cAIdx]?.en||'?'):"N/A"; let uATxtE="Skipped"; let st="skipped"; if(uAIdx!==null&&uAIdx>=0&&uAIdx<opts.length){uATxtE=opts[uAIdx]?.en||'?'; if(uAIdx===cAIdx){st="correct";c++;}else{st="incorrect";i++;}}else if(uAIdx!==null){uATxtE="Invalid";st="incorrect";i++;}else{s++;} rQ.push({question:q.question?.en||'?',correctAnswer:cATxtE,userAnswer:uATxtE,status:st,explanation:q.explanation?.en||"N/A"});}); const total=mcqs.length; const score=`${c}/${total}`; const timeS=Math.round(timeMs/1000); const mins=Math.floor(timeS/60); const secs=timeS%60; const timeStr=`${mins}m ${secs}s`; return{questions:rQ,summary:{score,correct:c,incorrect:i,skipped:s,timeString:timeStr},testDate:new Date().toISOString(),timeTakenMs:timeMs,sourceChatId:activeChatId,testTitle:testTitle.textContent,originalMCQs:mcqs};}
        function displayReview(rData){reviewContent.innerHTML=''; reviewSummary.innerHTML=''; reviewFilters.style.display='none'; if(!rData?.questions?.length||!rData.summary||!rData.originalMCQs){reviewSummary.innerHTML="<span>No data</span>"; saveReviewBtn.style.display='none'; return;} const expBtnTxt=(currentReviewLanguage==='en')?'தமிழ்':'English'; if(!reviewLanguageToggle||reviewLanguageToggle.textContent!==expBtnTxt){currentReviewLanguage='en'; if(reviewLanguageToggle)reviewLanguageToggle.textContent='தமிழ்';} const{score,correct,incorrect,skipped,timeString}=rData.summary; reviewSummary.innerHTML=`<span>Score: ${score}</span><span class="score-correct"> Correct: ${correct}</span><span class="score-incorrect"> Incorrect: ${incorrect}</span><span class="score-skipped"> Skipped: ${skipped}</span><span> Time: ${timeString}</span>`; reviewTitle.textContent=rData.testTitle||"Review"; const lang=currentReviewLanguage; rData.questions.forEach((qSum,idx)=>{const origQ=rData.originalMCQs[idx]; if(!origQ)return; const qTxt=origQ.question?.[lang]||origQ.question?.en||'?'; const opts=origQ.options||[]; const cALtr=origQ.answer?.trim().toUpperCase(); const cAIdx=cALtr?cALtr.charCodeAt(0)-'A'.charCodeAt(0):-1; const cATxt=(cAIdx>=0&&cAIdx<opts.length)?(opts[cAIdx]?.[lang]||opts[cAIdx]?.en):"N/A"; let uATxt=qSum.userAnswer; const st=qSum.status; if(st!=='skipped'&&st!=='invalid'){const uAEn=qSum.userAnswer; const uAIdx=opts.findIndex(o=>o.en===uAEn); if(uAIdx!==-1)uATxt=opts[uAIdx]?.[lang]||opts[uAIdx]?.en; else uATxt=uAEn||'?';}else if(st==='skipped')uATxt=(lang==='ta')?"தவிர்க்கப்பட்டது":"Skipped"; else uATxt=(lang==='ta')?"தவறான தேர்வு":"Invalid"; const explTxt=origQ.explanation?.[lang]||origQ.explanation?.en||"N/A."; let iStCls=`status-${st}`; let aDtCls=`user-answer-${st}`; const rItem=document.createElement('div'); rItem.classList.add('review-item',iStCls); rItem.dataset.status=st; let dHtml=`<span class="${aDtCls}">Your: ${uATxt}</span>`; if(st!=='correct')dHtml+=`<br><span class="correct-answer">Correct: ${cATxt}</span>`; dHtml+=`<div class="review-item-explanation">${(lang==='ta'?'விளக்கம்':'Explanation')}: ${explTxt}</div>`; rItem.innerHTML=`<div class="review-item-qnum">Q ${idx+1}</div><div class="review-item-question">${qTxt}</div><div class="review-item-details">${dHtml}</div>`; reviewContent.appendChild(rItem);}); if(rData.savedAt){saveReviewBtn.textContent="Saved"; saveReviewBtn.disabled=true; saveReviewBtn.style.display='inline-block';}else if(reviewResultsCache&&!cameFromAllTestsList){saveReviewBtn.textContent="Save"; saveReviewBtn.disabled=!currentUser; saveReviewBtn.style.display='inline-block';}else{saveReviewBtn.style.display='none';} reviewFilters.style.display='block'; try{if(typeof MathJax!=="undefined"&&MathJax.typesetPromise)MathJax.typesetPromise([reviewContent]).catch(err=>console.error(err));}catch(e){console.error(e);} filterReviewItems('all'); reviewFilters.querySelectorAll('button').forEach(b=>b.classList.toggle('active-filter',b.dataset.filter==='all'));}
        function handleReviewFilterClick(event){const btn=event.target.closest('button[data-filter]');if(btn)filterReviewItems(btn.dataset.filter);}
        function filterReviewItems(filter){reviewFilters.querySelectorAll('button').forEach(b=>b.classList.toggle('active-filter',b.dataset.filter===filter)); reviewContent.querySelectorAll('.review-item').forEach(item=>{const show=(filter==='all')||item.dataset.status===filter; item.classList.toggle('hidden-by-filter',!show);});}
        function exitReview(){reviewResultsCache=null; switchView('chat'); reviewSummary.innerHTML=''; reviewContent.innerHTML=''; reviewTitle.textContent='Review'; if(reviewLanguageToggle)reviewLanguageToggle.textContent='தமிழ்'; currentReviewLanguage='en';}
        async function saveTestReviewToCloud(){if(!currentUser){alert("Log in.");return;} if(!reviewResultsCache||reviewResultsCache.savedAt){alert("No data or saved.");return;} if(!reviewResultsCache.originalMCQs?.length){if(!confirm("Warn: Q data missing. Save?"))return;} const data={...reviewResultsCache, userId:currentUser.uid, savedAt:firebase.firestore.FieldValue.serverTimestamp()}; saveReviewBtn.disabled=true; saveReviewBtn.textContent="Saving..."; try{const newRef=await db.collection('testReviews').add(data); console.log("Review saved:",newRef.id); alert("Review saved!"); saveReviewBtn.textContent="Saved"; if(reviewResultsCache)reviewResultsCache.savedAt=new Date();}catch(e){console.error("Err save review:",e); alert("Failed save review."); saveReviewBtn.disabled=false; saveReviewBtn.textContent="Save";}}

        // --- All Tests List Functions ---
        /* ... (loadAndListenForTests, renderAllTestsList, filterTestsInSidebar, handleAllTestsListClick, enterTestTitleEditMode, exitTestTitleEditMode, saveTestTitle, deleteSavedTest, startReattempt remain the same) ... */
        function loadAndListenForTests(userId){/*...*/} function renderAllTestsList(tests){/*...*/} function filterTestsInSidebar(){/*...*/} async function handleAllTestsListClick(event){/*...*/} function enterTestTitleEditMode(listItem,reviewId){/*...*/} function exitTestTitleEditMode(listItem,originalTitle=null){/*...*/} async function saveTestTitle(listItem,reviewId,newTitle){/*...*/} async function deleteSavedTest(reviewId,listItem){/*...*/} async function startReattempt(reviewId,mode){/*...*/}

    </script>

</body>
</html>
