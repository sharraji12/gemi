<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ‡Æ™‡Æ§‡Æø‡Æ™‡Øç‡Æ™‡ØÅ ‡Æ™‡ØÅ‡Æ§‡ØÅ‡Æ™‡Øç‡Æ™‡Æø‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ / Version Updated -->
    <title>Gemini Chat + Mock Test (v9.4 - Audio Input)</title>
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']] },
            svg: { fontCache: 'global' },
            options: { skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'] }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <!-- <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script> -->

    <style>
        /* --- Styles (v9.4 - Audio UI adjustments) --- */
        :root { /* ... Theme Variables (mostly same as v9.3) ... */
             --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; --sidebar-width: 260px; --message-font-size-base: 1rem;
            /* LIGHT */ --sidebar-bg: #f7f7f7; --main-bg: #ffffff; --input-bg: #ffffff; --border-color: #e0e0e0; --text-primary: #2c2c2c; --text-secondary: #5f5f5f; --text-placeholder: #999999; --accent-color: #d97a7a; --user-message-bg: #cce0ff; --user-message-text: #1c1c1c; --ai-message-bg: #f0f0f0; --ai-message-text: #2c2c2c; --button-bg: #f0f0f0; --button-hover-bg: #e0e0e0; --active-item-bg: #e0e0e0; --code-bg: #e8e8e8; --scrollbar-thumb: #ccc; --scrollbar-thumb-hover: #bbb; --app-outer-bg: #e8e8e8; --send-button-bg: var(--accent-color); --send-button-hover-bg: #c76b6b; --send-button-text: #ffffff; --error-bg: #ffebee; --error-text: #c62828; --error-border: #ef9a9a; --message-font-size: var(--message-font-size-base); --delete-button-color: #aaa; --delete-button-hover-color: #dc3545; --input-border-color: var(--border-color); --input-focus-border-color: var(--accent-color); --preview-bg: var(--button-bg); --preview-border: var(--border-color); --remove-btn-color: var(--text-secondary); --remove-btn-hover-color: var(--error-text); --recording-color: #dc3545; /* ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ‡Æ§‡ØÅ: ‡Æ∞‡ØÜ‡Æï‡Øç‡Æï‡Ææ‡Æ∞‡Øç‡Æü‡Æø‡Æô‡Øç ‡Æï‡ØÅ‡Æ±‡Æø‡Æï‡Øç‡Æï ‡Æ®‡Æø‡Æ±‡ÆÆ‡Øç / New: Color for recording indication */
        }
        body.dark-theme { /* DARK */ --sidebar-bg: #2a2a2e; --main-bg: #1e1e1e; --input-bg: #2a2a2e; --border-color: #404040; --text-primary: #e0e0e0; --text-secondary: #a0a0a0; --text-placeholder: #777777; --accent-color: #e58b8b; --user-message-bg: #3a4a6b; --user-message-text: #e8e8e8; --ai-message-bg: #333333; --ai-message-text: #e0e0e0; --button-bg: #404040; --button-hover-bg: #505050; --active-item-bg: #454545; --code-bg: #2c2c2e; --scrollbar-thumb: #555; --scrollbar-thumb-hover: #666; --app-outer-bg: #121212; --send-button-bg: var(--accent-color); --send-button-hover-bg: #f09f9f; --send-button-text: #1e1e1e; --error-bg: #5c2b2b; --error-text: #ffcdd2; --error-border: #8c4343; --delete-button-color: #666; --delete-button-hover-color: #f09f9f; --input-border-color: var(--border-color); --input-focus-border-color: var(--accent-color); --preview-bg: var(--button-bg); --preview-border: var(--border-color); --remove-btn-color: var(--text-secondary); --remove-btn-hover-color: var(--error-text); --recording-color: #f09f9f; }
        body { font-family: var(--font-family); margin: 0; padding: 0; background-color: var(--app-outer-bg); color: var(--text-primary); font-size: 15px; transition: background-color 0.3s ease, color 0.3s ease; }

        /* Layout & Structure */
        .app-container { display: flex; height: 100vh; width: 100vw; overflow: hidden; } .app-container.hidden { display: none; }
        .sidebar { width: var(--sidebar-width); background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 15px 0; box-sizing: border-box; flex-shrink: 0; transition: background-color 0.3s ease, border-color 0.3s ease, width 0.3s ease; }
        .main-container { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; overflow: hidden; position: relative; }
        .main-content, .review-view { display: none; flex-direction: column; background-color: var(--main-bg); height: 100%; width: 100%; overflow: hidden; transition: background-color 0.3s ease; }
        .main-content.active, .review-view.active { display: flex; }
        .chat-area { flex-grow: 1; overflow-y: auto; padding: 30px 10% 20px; display: flex; flex-direction: column; max-width: 800px; margin: 0 auto; width: 80%; }
        .input-container { padding: 15px 10% 20px; border-top: 1px solid var(--border-color); background-color: var(--input-bg); max-width: 800px; margin: 0 auto; width: 80%; transition: background-color 0.3s ease, border-color 0.3s ease; display: none; }

        /* Sidebar Elements (same as v9.3) */
         .sidebar-header { padding: 10px 20px; font-size: 1.1em; font-weight: 600; color: var(--text-primary); }
         .sidebar-section { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; margin-top: 10px; }
         .sidebar-section-title { padding: 5px 20px; font-size: 0.85em; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; flex-shrink: 0; }
         #all-tests-section { border-bottom: 1px solid var(--border-color); margin-bottom: 10px; padding-bottom: 10px; flex-shrink: 0; display: flex; flex-direction: column; max-height: 40%; display: none; }
         #all-tests-section.visible { display: flex; }
         #test-search-input { width: calc(100% - 40px); padding: 8px 10px; margin: 5px 15px 10px 15px; border: 1px solid var(--input-border-color); background-color: var(--input-bg); color: var(--text-primary); border-radius: 6px; font-size: 0.9em; box-sizing: border-box; }
         #test-search-input:focus { outline: none; border-color: var(--input-focus-border-color); }
         #all-tests-list { overflow-y: auto; padding: 0 15px; flex-grow: 1; }
         #all-tests-list::-webkit-scrollbar { width: 6px; } #all-tests-list::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 3px;} #all-tests-list::-webkit-scrollbar-thumb:hover { background: var(--scrollbar-thumb-hover); }
         .test-list-item { padding: 8px 10px; margin-bottom: 5px; border-radius: 6px; background-color: var(--button-bg); cursor: default; transition: background-color 0.2s ease; display: flex; flex-direction: column; gap: 5px; border: 1px solid var(--border-color); }
         .test-list-item.hidden-by-search { display: none; }
         .test-list-item .no-search-results { padding:10px;color:var(--text-secondary);font-size:0.9em; }
         .test-item-info { font-size: 0.9em; color: var(--text-primary); position: relative; padding-right: 50px; }
         .test-item-title { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
         .test-item-details { font-size: 0.8em; color: var(--text-secondary); }
         .test-item-actions { display: flex; justify-content: flex-start; gap: 8px; }
         .test-item-actions button, .test-item-actions select { background-color: var(--main-bg); border: 1px solid var(--border-color); color: var(--text-secondary); border-radius: 4px; padding: 4px 8px; font-size: 0.8em; cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease; }
         .test-item-actions button:hover, .test-item-actions select:hover { background-color: var(--button-hover-bg); color: var(--text-primary); }
         .test-item-actions select:disabled { opacity: 0.6; cursor: not-allowed; }
        .test-item-controls { position: absolute; right: 5px; top: 0; display: flex; gap: 5px; }
        .test-item-controls button { background: none; border: none; color: var(--delete-button-color); cursor: pointer; font-size: 1.1em; padding: 0 3px; line-height: 1; opacity: 0.7; transition: color 0.2s ease, opacity 0.2s ease; }
        .test-item-controls button:hover { opacity: 1; color: var(--delete-button-hover-color); }
        .test-item-edit-mode { display: flex; align-items: center; }
        .test-item-edit-mode input[type="text"] { flex-grow: 1; padding: 2px 4px; margin-right: 5px; border: 1px solid var(--input-focus-border-color); background-color: var(--input-bg); color: var(--text-primary); border-radius: 3px; font-size: 0.95em; }
        .test-item-edit-mode button { font-size: 0.9em; padding: 2px 5px; background-color: var(--button-bg); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 3px; cursor: pointer; margin-left: 3px; }
        .test-item-edit-mode button:hover { background-color: var(--button-hover-bg); }
         .start-chat-button { display: flex; align-items: center; gap: 8px; background-color: var(--main-bg); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 8px; padding: 10px 15px; margin: 0 15px 10px 15px; font-size: 0.95em; font-weight: 500; cursor: pointer; text-align: left; transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease; flex-shrink: 0; }
         .start-chat-button:hover { background-color: var(--button-hover-bg); } .start-chat-button svg { fill: currentColor; width: 16px; height: 16px; }
         .start-chat-button:disabled { opacity: 0.6; cursor: not-allowed; }
         .chat-list { overflow-y: auto; padding: 0 15px; margin-bottom: 10px; flex-grow: 1; }
         .chat-list::-webkit-scrollbar { width: 6px; } .chat-list::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 3px;} .chat-list::-webkit-scrollbar-thumb:hover { background: var(--scrollbar-thumb-hover); }
         .chat-list-item { padding: 8px 30px 8px 10px; margin-bottom: 4px; border-radius: 6px; font-size: 0.9em; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-secondary); transition: background-color 0.2s ease, color 0.2s ease; position: relative; }
         .chat-list-item:hover { background-color: var(--button-hover-bg); color: var(--text-primary); }
         .chat-list-item.active { background-color: var(--active-item-bg); color: var(--text-primary); font-weight: 500; }
         .delete-chat-button { position: absolute; right: 6px; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; background: none; border: none; color: var(--delete-button-color); cursor: pointer; font-size: 1.3em; line-height: 1; padding: 0; display: none; opacity: 0.7; transition: color 0.2s ease, opacity 0.2s ease; }
         .chat-list-item:hover .delete-chat-button { display: block; }
         .delete-chat-button:hover { color: var(--delete-button-hover-color); opacity: 1; }
         .sidebar-footer { border-top: 1px solid var(--border-color); padding: 10px 15px; transition: border-color 0.3s ease; flex-shrink: 0; }
         .sidebar-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
         .text-size-controls span, .theme-toggle span { font-size: 0.85em; color: var(--text-secondary); }
         .text-size-buttons button, .theme-toggle button { background: var(--button-bg); border: 1px solid var(--border-color); color: var(--text-secondary); border-radius: 4px; padding: 2px 8px; margin-left: 5px; cursor: pointer; font-size: 1.1em; line-height: 1; transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease; }
         .text-size-buttons button:hover, .theme-toggle button:hover { background-color: var(--button-hover-bg); color: var(--text-primary); }
         .text-size-buttons button:disabled, .theme-toggle button:disabled { opacity: 0.6; cursor: not-allowed; }
         .account-info { display: flex; align-items: center; gap: 10px; font-size: 0.9em; margin-top: 10px; }
         .account-avatar { width: 30px; height: 30px; border-radius: 50%; background-color: #6c757d; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; }
         .account-details { overflow: hidden; }
         .account-email { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-primary); }
         .account-plan { font-size: 0.85em; color: var(--text-secondary); }
         #auth-controls { margin-top: 15px; text-align: center; }
         #auth-controls button { background-color: var(--button-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; padding: 8px 15px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s ease; }
         #auth-controls button:hover { background-color: var(--button-hover-bg); }
         #logout-btn { display: none; }

        /* Chat Area Elements (same as v9.3) */
        .greeting { font-size: 1.8em; font-weight: 600; margin-bottom: 40px; color: var(--text-primary); } .greeting .asterisk { color: var(--accent-color); font-size: 1.2em; margin-right: 5px; display: inline-block; vertical-align: middle; }
        .message { padding: 12px 18px; border-radius: 18px; max-width: 80%; word-wrap: break-word; line-height: 1.6; margin-bottom: 15px; font-size: var(--message-font-size); transition: background-color 0.3s ease, color 0.3s ease; }
        .user-message { background-color: var(--user-message-bg); color: var(--user-message-text); align-self: flex-end; border-bottom-right-radius: 5px; }
        .ai-message { background-color: var(--ai-message-bg); color: var(--ai-message-text); align-self: flex-start; border-bottom-left-radius: 5px; }
        .ai-message strong { font-weight: 600; } .ai-message em { font-style: italic; }
        .ai-message pre { background-color: var(--code-bg); color: var(--text-primary); padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 0.9em; transition: background-color 0.3s ease, color 0.3s ease; }
        .ai-message code { font-family: monospace; background-color: var(--code-bg); color: var(--text-primary); padding: 2px 4px; border-radius: 3px; transition: background-color 0.3s ease, color 0.3s ease;}
        .ai-message pre code { background-color: transparent; padding: 0; }
        .ai-message.thinking { background-color: transparent; color: var(--text-secondary); font-style: italic; }
        .error-message { background-color: var(--error-bg); color: var(--error-text); border: 1px solid var(--error-border); align-self: flex-start; transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;}
        .info-message { text-align: center; color: var(--text-secondary); padding: 50px 20px; font-style: italic; }
        .message mjx-container { color: inherit !important; font-size: inherit !important; }
        .message img.chat-image, .message img.uploaded-image { max-width: 100%; height: auto; border-radius: 8px; margin-top: 8px; cursor: pointer; display: block; }
        .message img.uploaded-image { border: 1px solid var(--border-color); margin-bottom: 5px; /* Space between uploaded img and text */ }
        .message .youtube-embed-container { margin-top: 10px; }
        .message iframe.chat-video { max-width: 100%; aspect-ratio: 16 / 9; border: none; border-radius: 8px; }
        .message audio.chat-audio { /* ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ‡Æ§‡ØÅ: ‡Æö‡Ææ‡Æü‡Øç‡Æü‡Æø‡Æ≤‡Øç ‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã ‡Æ™‡Øç‡Æ≥‡Øá‡ÆØ‡Æ∞‡Øç ‡Æ∏‡Øç‡Æü‡Øà‡Æ≤‡Øç / New: Style for audio player in chat */ max-width: 100%; margin-top: 8px; display: block; }

        /* Input Area Elements */
        .suggestions { display: none; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .suggestion-chip { background-color: var(--button-bg); border: 1px solid var(--border-color); color: var(--text-secondary); border-radius: 16px; padding: 8px 15px; font-size: 0.9em; cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease; }
        .suggestion-chip:hover { background-color: var(--button-hover-bg); color: var(--text-primary); }
        .input-box { display: flex; align-items: flex-end; background-color: var(--main-bg); border: 1px solid var(--input-border-color); border-radius: 12px; padding: 5px 5px 5px 15px; position: relative; transition: background-color 0.3s ease, border-color 0.3s ease; }
        .input-box:focus-within { border-color: var(--input-focus-border-color); }
        /* ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ‡Æ§‡ØÅ: ‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã & ‡Æá‡ÆÆ‡Øá‡Æú‡Øç ‡Æ™‡Æü‡Øç‡Æü‡Æ©‡Øç‡Æï‡Æ≥‡Øç ‡Æ∏‡Øç‡Æü‡Øà‡Æ≤‡Øç / New: Styles for Audio & Image Buttons */
        .input-action-buttons button { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.4em; padding: 0 6px; margin-right: 2px; line-height: 1; align-self: center; transition: color 0.2s ease; }
        .input-action-buttons button:hover:not(:disabled) { color: var(--text-primary); }
        .input-action-buttons button:disabled { opacity: 0.5; cursor: not-allowed; }
        .input-action-buttons button.recording { color: var(--recording-color); animation: pulse 1.5s infinite; } /* ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ‡Æ§‡ØÅ: ‡Æ∞‡ØÜ‡Æï‡Øç‡Æï‡Ææ‡Æ∞‡Øç‡Æü‡Æø‡Æô‡Øç ‡ÆÖ‡Æ©‡Æø‡ÆÆ‡Øá‡Æ∑‡Æ©‡Øç / New: Recording animation */
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        #user-input { flex-grow: 1; border: none; outline: none; padding: 10px 5px; font-size: 1rem; background-color: transparent; resize: none; min-height: 48px; max-height: 250px; line-height: 1.5; color: var(--text-primary); font-family: var(--font-family); }
        #user-input::placeholder { color: var(--text-placeholder); }
        .mcq-mode-control { display: flex; align-items: center; margin-left: 10px; padding-bottom: 8px; flex-shrink: 0; }
        .mcq-mode-control input[type="checkbox"] { margin-right: 5px; accent-color: var(--accent-color); cursor: pointer;}
        .mcq-mode-control label { font-size: 0.85em; color: var(--text-secondary); cursor: pointer; user-select: none;}
        #send-button { background-color: var(--send-button-bg); color: var(--send-button-text); border: none; border-radius: 8px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-left: 10px; transition: background-color 0.2s ease; padding: 0; flex-shrink: 0; }
        #send-button:hover:not(:disabled) { background-color: var(--send-button-hover-bg); }
        #send-button:disabled { background-color: #cccccc; cursor: not-allowed; opacity: 0.6; }
        #send-button svg { width: 20px; height: 20px; fill: currentColor; }

        /* ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ‡Æ§‡ØÅ: ‡Æá‡ÆÆ‡Øá‡Æú‡Øç & ‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã ‡Æ™‡Øç‡Æ∞‡Æø‡Æµ‡Æø‡ÆØ‡ØÇ ‡Æ∏‡Øç‡Æü‡Øà‡Æ≤‡Øç‡Æï‡Æ≥‡Øç / New: Image & Audio Preview Styles */
        #image-preview-container,
        #audio-preview-container { margin-bottom: 10px; padding: 8px; background-color: var(--preview-bg); border: 1px solid var(--preview-border); border-radius: 8px; display: flex; align-items: center; gap: 10px; display: none; }
        #image-preview-container img { max-height: 50px; max-width: 80px; height: auto; width: auto; border-radius: 4px; object-fit: cover; }
        #audio-preview-container audio { max-height: 40px; }
        #image-preview-info,
        #audio-preview-info { font-size: 0.85em; color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex-grow: 1; }
        #remove-image-button,
        #remove-audio-button { background: none; border: none; color: var(--remove-btn-color); cursor: pointer; font-size: 1.4em; line-height: 1; padding: 0 5px; transition: color 0.2s ease; flex-shrink: 0; }
        #remove-image-button:hover,
        #remove-audio-button:hover { color: var(--remove-btn-hover-color); }

        .thinking::after { content: ' .'; animation: dots 1s steps(3, end) infinite; display: inline-block; }
        @keyframes dots { 0%, 20% { content: ' .'; } 40% { content: ' ..'; } 60%, 100% { content: ' ...'; } }
         .start-test-button { background-color: var(--accent-color); color: var(--send-button-text); border: none; border-radius: 6px; padding: 8px 15px; margin-top: 10px; cursor: pointer; font-weight: 500; display: inline-block; transition: background-color 0.2s ease; }
         .start-test-button:hover { background-color: var(--send-button-hover-bg); }

        /* Mock Test & Review View Styles (same as v9.3) */
        /* ... (These remain the same as v9.3) ... */
        .mock-test-view { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--main-bg); z-index: 100; flex-direction: column; padding: 20px; box-sizing: border-box; transition: background-color 0.3s ease; }
        .mock-test-view.active { display: flex; }
        .test-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .test-header h2 { margin: 0; font-size: 1.3em; color: var(--text-primary); }
        .test-info { display: flex; align-items: center; }
        .test-info span { margin-left: 15px; font-size: 0.95em; color: var(--text-secondary); }
        #test-language-toggle, #review-language-toggle { margin-left: 15px; padding: 3px 8px; font-size: 0.8em; cursor: pointer; background-color: var(--button-bg); border: 1px solid var(--border-color); color: var(--text-secondary); border-radius: 4px; transition: background-color 0.2s ease, color 0.2s ease; }
        #test-language-toggle:hover, #review-language-toggle:hover { background-color: var(--button-hover-bg); color: var(--text-primary); }
        .test-content { flex-grow: 1; overflow-y: auto; padding: 10px 20px; }
        .test-question-container { margin-bottom: 25px; }
        .test-question-number { font-weight: bold; margin-bottom: 8px; color: var(--text-secondary); }
        .test-question { font-size: 1.1em; line-height: 1.5; margin-bottom: 15px; color: var(--text-primary); }
        .test-options label { display: block; margin-bottom: 12px; background-color: var(--button-bg); padding: 12px 15px; border-radius: 6px; border: 1px solid var(--border-color); cursor: pointer; transition: background-color 0.2s ease, border-color 0.2s ease; color: var(--text-primary); }
        .test-options label:hover { background-color: var(--button-hover-bg); }
        .test-options input[type="radio"] { margin-right: 10px; accent-color: var(--accent-color); cursor: pointer;}
        .test-navigation { display: flex; justify-content: space-between; padding-top: 15px; border-top: 1px solid var(--border-color); margin-top: auto; flex-shrink: 0; }
        .test-navigation button { background-color: var(--button-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; padding: 10px 20px; cursor: pointer; font-size: 0.95em; transition: background-color 0.2s ease; }
        .test-navigation button:hover:not(:disabled) { background-color: var(--button-hover-bg); }
        .test-navigation button#submit-test-btn { background-color: var(--accent-color); color: var(--send-button-text); border-color: var(--accent-color); }
        .test-navigation button#submit-test-btn:hover:not(:disabled) { background-color: var(--send-button-hover-bg); }
        .test-navigation button:disabled { opacity: 0.5; cursor: not-allowed; }
        .review-view { padding: 20px; box-sizing: border-box; background-color: var(--main-bg); }
        .review-header { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .review-header h2 { margin: 0 0 10px 0; font-size: 1.3em; color: var(--text-primary); }
        .review-summary { display: inline; }
        .review-summary span { margin-right: 20px; font-size: 1em; color: var(--text-primary); }
        .review-summary .score-correct { color: #28a745; font-weight: bold;} .review-summary .score-incorrect { color: #dc3545; font-weight: bold;} .review-summary .score-skipped { color: #fd7e14; font-weight: bold;}
        .review-filters { margin-top: 10px; margin-bottom: 15px; }
        .review-filters button { background-color: var(--button-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; padding: 5px 12px; margin-right: 8px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s ease, border-color 0.2s ease; }
        .review-filters button:hover { background-color: var(--button-hover-bg); }
        .review-filters button.active-filter { background-color: var(--accent-color); color: var(--send-button-text); border-color: var(--accent-color);}
        .review-content { flex-grow: 1; overflow-y: auto; padding-right: 10px; }
        .review-item { margin-bottom: 15px; padding: 15px; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--button-bg); transition: background-color 0.3s ease, border-color 0.3s ease; }
        .review-item.hidden-by-filter { display: none; }
        .review-item-qnum { font-weight: bold; margin-bottom: 8px; color: var(--text-secondary); }
        .review-item-question { margin-bottom: 10px; line-height: 1.5; color: var(--text-primary); }
        .review-item-details span { display: block; margin-bottom: 5px; font-size: 0.95em; color: var(--text-primary); }
        .review-item-details .correct-answer { color: #28a745; font-weight: bold; }
        .review-item-details .user-answer-correct { color: #28a745; } .review-item-details .user-answer-incorrect { color: #dc3545; text-decoration: line-through; } .review-item-details .user-answer-skipped { color: #fd7e14; font-style: italic; }
        .review-item-explanation { margin-top: 8px; font-size: 0.9em; color: var(--text-secondary); border-left: 3px solid var(--border-color); padding-left: 8px; line-height: 1.4; }
        .review-footer { text-align: center; padding-top: 20px; border-top: 1px solid var(--border-color); margin-top: auto; flex-shrink: 0; display: flex; justify-content: center; gap: 15px; }
        #exit-review-btn, #save-review-btn { background-color: var(--accent-color); color: var(--send-button-text); border: none; border-radius: 6px; padding: 10px 25px; cursor: pointer; font-size: 1em; transition: background-color 0.2s ease; display: none; }
        #exit-review-btn:hover, #save-review-btn:hover:not(:disabled) { background-color: var(--send-button-hover-bg); }
        #save-review-btn { background-color: var(--button-bg); color: var(--text-primary); border: 1px solid var(--border-color); }
        #save-review-btn:hover:not(:disabled) { background-color: var(--button-hover-bg); }
        #save-review-btn:disabled { opacity: 0.6; cursor: not-allowed; background-color: #cccccc; border-color: #aaaaaa; }

        /* Responsive Design (minor adjustments if needed) */
        @media (max-width: 768px) {
            :root { --sidebar-width: 200px; }
            /* ... other mobile styles remain mostly the same ... */
            .input-action-buttons button { font-size: 1.3em; padding: 0 5px; }
            #image-preview-container, #audio-preview-container { padding: 6px; gap: 8px; }
            #image-preview-container img { max-height: 40px; }
            #audio-preview-container audio { max-height: 35px; }
            #image-preview-info, #audio-preview-info { font-size: 0.8em; }
            #remove-image-button, #remove-audio-button { font-size: 1.3em; }
            .input-box { padding: 5px 5px 5px 8px; } /* Adjust padding for buttons */
             #user-input { min-height: 40px; font-size: 0.95rem; }
             #send-button { width: 32px; height: 32px; }
             /* ... test/review mobile styles ... */
        }

    </style>
</head>
<body>

    <div class="app-container" id="app-container">
        <div class="sidebar">
             <!-- Sidebar content remains the same -->
             <div class="sidebar-header">Gemini Chat</div>
             <div id="all-tests-section">
                 <div class="sidebar-section-title">All Tests</div>
                 <input type="search" id="test-search-input" placeholder="Search tests..." disabled>
                 <div class="all-tests-list" id="all-tests-list">
                      <div style="padding:10px;color:var(--text-secondary);font-size:0.9em;">Login to see saved tests.</div>
                 </div>
             </div>
             <div class="sidebar-section">
                 <button class="start-chat-button" id="start-chat" disabled> <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg>
                      Start new chat
                 </button>
                 <div class="sidebar-section-title">Chats</div>
                 <div class="chat-list" id="chat-list">
                      <div style="padding:10px;color:var(--text-secondary);font-size:0.9em;">Please log in to see chats.</div>
                 </div>
             </div>
             <div class="sidebar-footer">
                  <div class="sidebar-controls">
                      <div class="text-size-controls">
                          <span>Text Size</span>
                          <div class="text-size-buttons"> <button id="decrease-text-size" title="Decrease text size" disabled>-</button> <button id="increase-text-size" title="Increase text size" disabled>+</button> </div>
                      </div>
                      <div class="theme-toggle"> <button id="theme-toggle-button" title="Toggle Theme" disabled>‚òÄÔ∏è</button> </div>
                  </div>
                   <div id="auth-controls"> <button id="login-google-btn">Login with Google</button> <button id="logout-btn" style="display: none;">Logout</button> </div>
                   <div class="account-info">
                       <div class="account-avatar" id="account-avatar">?</div>
                       <div class="account-details"> <div class="account-email" id="account-email">Not logged in</div> <div class="account-plan" id="account-plan"></div> </div>
                   </div>
             </div>
        </div>

        <div class="main-container">
            <div class="main-content active" id="main-content-chat">
                 <div class="chat-area" id="chat-area">
                     <!-- Chat messages will be loaded here -->
                 </div>
                 <div class="input-container" id="input-container">
                     <div class="suggestions" id="suggestions">
                          <button class="suggestion-chip" data-prompt="Summarize this audio">Summarize this audio</button> <!-- ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ‡Æ§‡ØÅ / New -->
                          <button class="suggestion-chip" data-prompt="Transcribe this audio">Transcribe this audio</button> <!-- ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ‡Æ§‡ØÅ / New -->
                          <button class="suggestion-chip" data-prompt="Summarize this video">Summarize this video</button>
                          <button class="suggestion-chip" data-prompt="Describe this image">Describe this image</button>
                          <button class="suggestion-chip" data-prompt="Explain $\lim_{x\to 0} \frac{\sin x}{x} = 1$">Limit sin(x)/x ?</button>
                     </div>
                    <!-- ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ‡Æ§‡ØÅ: ‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã ‡Æ™‡Øç‡Æ∞‡Æø‡Æµ‡Æø‡ÆØ‡ØÇ / New: Audio Preview Container -->
                    <div id="audio-preview-container">
                        <audio id="preview-audio" controls></audio>
                        <span id="audio-preview-info">audioname.mp3</span>
                        <button id="remove-audio-button" title="Remove audio">&times;</button>
                    </div>
                    <!-- Image Preview Container -->
                    <div id="image-preview-container">
                        <img id="preview-image" src="#" alt="Image preview" />
                        <span id="image-preview-info">filename.jpg</span>
                        <button id="remove-image-button" title="Remove image">&times;</button>
                    </div>
                    <div class="input-box">
                         <!-- ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ‡Æ§‡ØÅ: ‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã ‡Æá‡Æ©‡Øç‡Æ™‡ØÅ‡Æü‡Øç‡Æï‡Æ≥‡Øç / New: Audio Inputs (hidden) -->
                         <input type="file" id="audio-upload-input" accept="audio/wav,audio/mp3,audio/aiff,audio/aac,audio/ogg,audio/flac" style="display: none;">
                         <!-- ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ‡Æ§‡ØÅ: ‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã & ‡Æá‡ÆÆ‡Øá‡Æú‡Øç ‡Æ™‡Æü‡Øç‡Æü‡Æ©‡Øç‡Æï‡Æ≥‡Øç / New: Audio & Image Buttons -->
                         <div class="input-action-buttons">
                            <button id="image-upload-button" title="Upload image (Max 4MB)" disabled>üìé</button>
                            <button id="audio-upload-button" title="Upload audio file (Max 15MB)" disabled>üéµ</button>
                            <button id="record-audio-button" title="Record audio" disabled>üé§</button>
                         </div>
                         <textarea id="user-input" placeholder="Enter prompt, paste URL, or attach image/audio" rows="1"></textarea>
                         <div class="mcq-mode-control"> <input type="checkbox" id="mcq-mode-checkbox" title="Check to generate MCQs based on your prompt"> <label for="mcq-mode-checkbox">MCQs?</label> </div>
                         <button id="send-button" title="Send message" disabled> <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
                        </button>
                    </div>
                 </div>
            </div>
            <!-- Review View (same as v9.3) -->
            <div class="review-view" id="review-view">
                 <div class="review-header">
                     <h2 id="review-title">Test Review</h2>
                     <div> <div class="review-summary" id="review-summary"></div> <button id="review-language-toggle" style="margin-left: 15px; padding: 3px 8px; font-size: 0.8em; vertical-align: middle;">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</button> </div>
                     <div class="review-filters" id="review-filters" style="display: none;"> <button data-filter="all" class="active-filter">All</button> <button data-filter="incorrect">Incorrect</button> <button data-filter="skipped">Skipped</button> </div>
                 </div>
                 <div class="review-content" id="review-content"></div>
                 <div class="review-footer"> <button id="save-review-btn">Save Review</button> <button id="exit-review-btn">Back</button> </div>
              </div>
        </div>
    </div>
    <!-- Mock Test View (same as v9.3) -->
    <div class="mock-test-view" id="mock-test-view">
         <div class="test-header">
            <h2 id="test-title">Mock Test</h2>
            <div class="test-info"> <span id="question-counter">Q: 1 / N</span> <span id="test-timer">Time: 00:00</span> <button id="test-language-toggle" style="margin-left: 15px; padding: 3px 8px; font-size: 0.8em;">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</button> </div>
         </div>
         <div class="test-content">
            <div class="test-question-container"> <div class="test-question-number" id="test-question-number"></div> <div class="test-question" id="test-question"></div> <div class="test-options" id="test-options"></div> </div>
         </div>
         <div class="test-navigation"> <button id="prev-question-btn" disabled>Previous</button> <button id="next-question-btn">Next</button> <button id="submit-test-btn">Submit Test</button> </div>
    </div>


    <script>
        // --- Firebase Config (same as v9.3) ---
        const firebaseConfig = {
          apiKey: "AIzaSyDgw604fe5jnNu4kTOv1cQ-3n7PL8gcN58", // <- REPLACE WITH YOUR KEY
          authDomain: "krish-c5db8.firebaseapp.com",
          projectId: "krish-c5db8",
          storageBucket: "krish-c5db8.appspot.com",
          messagingSenderId: "217175257890",
          appId: "1:217175257890:web:209f0f290eabab6b1fab7b",
          measurementId: "G-97SHYGL2J4"
        };

        // --- Initialize Firebase (same as v9.3) ---
        firebase.initializeApp(firebaseConfig);
        const fbAuth = firebase.auth();
        const db = firebase.firestore();

        // --- DOM Elements ---
        // ‡Æ™‡Æ¥‡Øà‡ÆØ DOM ‡Æï‡ØÇ‡Æ±‡ØÅ‡Æï‡Æ≥‡Øç / Existing DOM Elements (v9.3)
        const imageUploadButton = document.getElementById('image-upload-button');
        const imageUploadInput = document.getElementById('image-upload-input');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const previewImage = document.getElementById('preview-image');
        const previewInfo = document.getElementById('image-preview-info');
        const removeImageButton = document.getElementById('remove-image-button');
        const appContainer = document.getElementById('app-container');
        const chatArea = document.getElementById('chat-area');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const suggestionsContainer = document.getElementById('suggestions');
        const startChatButton = document.getElementById('start-chat');
        const chatListContainer = document.getElementById('chat-list');
        const allTestsSection = document.getElementById('all-tests-section');
        const testSearchInput = document.getElementById('test-search-input');
        const allTestsListContainer = document.getElementById('all-tests-list');
        const accountEmail = document.getElementById('account-email');
        const accountAvatar = document.getElementById('account-avatar');
        const accountPlan = document.getElementById('account-plan');
        const decreaseTextBtn = document.getElementById('decrease-text-size');
        const increaseTextBtn = document.getElementById('increase-text-size');
        const themeToggleButton = document.getElementById('theme-toggle-button');
        const mainContainer = document.querySelector('.main-container');
        const chatView = document.getElementById('main-content-chat');
        const testView = document.getElementById('mock-test-view');
        const reviewView = document.getElementById('review-view');
        const inputContainer = document.getElementById('input-container');
        const mcqModeCheckbox = document.getElementById('mcq-mode-checkbox');
        const loginBtn = document.getElementById('login-google-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const testTitle = document.getElementById('test-title');
        const questionCounter = document.getElementById('question-counter');
        const testTimer = document.getElementById('test-timer');
        const testQuestionNumber = document.getElementById('test-question-number');
        const testQuestion = document.getElementById('test-question');
        const testOptionsContainer = document.getElementById('test-options');
        const prevQuestionBtn = document.getElementById('prev-question-btn');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const submitTestBtn = document.getElementById('submit-test-btn');
        const testLanguageToggle = document.getElementById('test-language-toggle');
        const reviewTitle = document.getElementById('review-title');
        const reviewSummary = document.getElementById('review-summary');
        const reviewContent = document.getElementById('review-content');
        const exitReviewBtn = document.getElementById('exit-review-btn');
        const reviewFilters = document.getElementById('review-filters');
        const saveReviewBtn = document.getElementById('save-review-btn');
        const reviewLanguageToggle = document.getElementById('review-language-toggle');

        // ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ DOM ‡Æï‡ØÇ‡Æ±‡ØÅ‡Æï‡Æ≥‡Øç (‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã) / New DOM Elements (Audio)
        const audioUploadButton = document.getElementById('audio-upload-button');
        const audioUploadInput = document.getElementById('audio-upload-input');
        const recordAudioButton = document.getElementById('record-audio-button');
        const audioPreviewContainer = document.getElementById('audio-preview-container');
        const previewAudio = document.getElementById('preview-audio');
        const audioPreviewInfo = document.getElementById('audio-preview-info');
        const removeAudioButton = document.getElementById('remove-audio-button');

        // --- Config & Constants ---
        // ‡Æ™‡Æ¥‡Øà‡ÆØ ‡ÆÆ‡Ææ‡Æ±‡Æø‡Æ≤‡Æø‡Æï‡Æ≥‡Øç / Existing Constants (v9.3)
        const MODEL_NAME = "gemini-1.5-pro-latest"; // Keep using 1.5 Pro for multimodal
        const API_URL_BASE=`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=`;
        const STORAGE_KEY_API_KEY='geminiApiKey_insecureDemo';
        const NEW_CHAT_TITLE="(New Chat)";
        const TEXT_SIZE_STEP=0.1;
        const MIN_TEXT_SIZE_MULTIPLIER=0.7;
        const MAX_TEXT_SIZE_MULTIPLIER=1.5;
        const LIGHT_THEME_ICON='‚òÄÔ∏è';
        const DARK_THEME_ICON='üåô';
        const DELETE_ICON = '√ó';
        const EDIT_TEST_ICON = '‚úèÔ∏è';
        const DELETE_TEST_ICON = 'üóëÔ∏è';
        const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:watch\?v=|embed\/|v\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})(?:\S+)?/i;
        const imageUrlRegex = /(?<!src=["'])(?<!href=["'])(https?:\/\/[^\s()<>]+?\.(?:jpg|jpeg|png|gif|webp|bmp))/gi;
        const MAX_IMAGE_SIZE_MB = 4;

        // ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ ‡ÆÆ‡Ææ‡Æ±‡Æø‡Æ≤‡Æø‡Æï‡Æ≥‡Øç (‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã) / New Constants (Audio)
        const MAX_AUDIO_SIZE_MB = 15; // Inline data limit consideration (‡ÆÖ‡Æ§‡Æø‡Æï‡Æ™‡Æü‡Øç‡Æö ‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã ‡ÆÖ‡Æ≥‡Æµ‡ØÅ)
        const SUPPORTED_AUDIO_MIME_TYPES = [ // ‡Æú‡ØÜ‡ÆÆ‡Æø‡Æ©‡Æø ‡ÆÜ‡Æ§‡Æ∞‡Æø‡Æï‡Øç‡Æï‡ØÅ‡ÆÆ‡Øç ‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã ‡Æµ‡Æï‡Øà‡Æï‡Æ≥‡Øç / Gemini supported audio types
            'audio/wav', 'audio/mp3', 'audio/aiff', 'audio/aac', 'audio/ogg', 'audio/flac'
        ];
        const RECORDING_MIME_TYPE = 'audio/ogg'; // MediaRecorder ‡Æï‡Øç‡Æï‡ØÅ ‡Æµ‡Æø‡Æ∞‡ØÅ‡ÆÆ‡Øç‡Æ™‡ØÅ‡ÆÆ‡Øç ‡Æµ‡Æï‡Øà / Preferred type for MediaRecorder

        // --- State Variables ---
        // ‡Æ™‡Æ¥‡Øà‡ÆØ ‡ÆÆ‡Ææ‡Æ®‡Æø‡Æ≤ ‡ÆÆ‡Ææ‡Æ±‡Æø‡Æï‡Æ≥‡Øç / Existing State Variables (v9.3)
        let API_KEY='';
        let currentUser = null;
        let activeChatId = null;
        let currentChatHistory=[];
        let currentTextSizeMultiplier=1.0;
        let currentTheme='light';
        let isTestMode=false;
        let isReviewMode=false;
        let currentTestMCQs=[];
        let currentQuestionIndex=0;
        let userAnswers=[];
        let testStartTime=null;
        let testTimerInterval=null;
        let reviewResultsCache = null;
        let cameFromAllTestsList = false;
        let activeChatListener = null;
        let chatListListener = null;
        let testListListener = null;
        let isDeletingChat = false;
        let allSavedTestsData = [];
        let currentTestLanguage = 'en';
        let currentReviewLanguage = 'en';
        let selectedImageData = { file: null, base64: null, mimeType: null };

        // ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ ‡ÆÆ‡Ææ‡Æ®‡Æø‡Æ≤ ‡ÆÆ‡Ææ‡Æ±‡Æø‡Æï‡Æ≥‡Øç (‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã) / New State Variables (Audio)
        let selectedAudioData = { file: null, base64: null, mimeType: null, source: null }; // source: 'upload' or 'record'
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;

        // --- Initialization ---
        initializeApp();

        // --- Event Listeners ---
        // ‡Æ™‡Æ¥‡Øà‡ÆØ ‡Æ®‡Æø‡Æï‡Æ¥‡Øç‡Æµ‡ØÅ ‡Æï‡Øá‡Æü‡Øç‡Æ™‡Øã‡Æ∞‡Øç / Existing Event Listeners (v9.3)
        sendButton.addEventListener('click', handleSendMessage);
        userInput.addEventListener('input', autoGrowTextarea);
        userInput.addEventListener('keydown', handleInputKeydown);
        suggestionsContainer.addEventListener('click', handleSuggestionClick);
        startChatButton.addEventListener('click', createNewChat);
        chatListContainer.addEventListener('click', handleChatListClick);
        allTestsListContainer.addEventListener('click', handleAllTestsListClick);
        testSearchInput.addEventListener('input', filterTestsInSidebar);
        decreaseTextBtn.addEventListener('click', () => adjustTextSize(-TEXT_SIZE_STEP));
        increaseTextBtn.addEventListener('click', () => adjustTextSize(TEXT_SIZE_STEP));
        themeToggleButton.addEventListener('click', toggleTheme);
        prevQuestionBtn.addEventListener('click', () => handleTestNavigation('prev'));
        nextQuestionBtn.addEventListener('click', () => handleTestNavigation('next'));
        submitTestBtn.addEventListener('click', submitTest);
        testLanguageToggle.addEventListener('click', toggleTestLanguage);
        exitReviewBtn.addEventListener('click', exitReview);
        chatArea.addEventListener('click', handleChatAreaClick);
        reviewFilters.addEventListener('click', handleReviewFilterClick);
        saveReviewBtn.addEventListener('click', saveTestReviewToCloud);
        reviewLanguageToggle.addEventListener('click', toggleReviewLanguage);
        loginBtn.addEventListener('click', signInWithGoogle);
        logoutBtn.addEventListener('click', signOut);
        imageUploadButton.addEventListener('click', () => imageUploadInput.click());
        imageUploadInput.addEventListener('change', handleImageFileSelect);
        removeImageButton.addEventListener('click', removeSelectedImage);

        // ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ ‡Æ®‡Æø‡Æï‡Æ¥‡Øç‡Æµ‡ØÅ ‡Æï‡Øá‡Æü‡Øç‡Æ™‡Øã‡Æ∞‡Øç (‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã) / New Event Listeners (Audio)
        audioUploadButton.addEventListener('click', () => audioUploadInput.click());
        audioUploadInput.addEventListener('change', handleAudioFileSelect);
        recordAudioButton.addEventListener('click', toggleAudioRecording);
        removeAudioButton.addEventListener('click', removeSelectedAudio);


        // --- Initialization Functions ---
        // ‡Æá‡Æ®‡Øç‡Æ§‡Æ™‡Øç ‡Æ™‡Æï‡ØÅ‡Æ§‡Æø ‡Æ™‡ØÜ‡Æ∞‡ØÅ‡ÆÆ‡Øç‡Æ™‡Ææ‡Æ≤‡ØÅ‡ÆÆ‡Øç ‡ÆÆ‡Ææ‡Æ±‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà / This part is mostly unchanged
        async function initializeApp() {
            loadGeminiApiKey();
            fbAuth.onAuthStateChanged(handleAuthStateChange);
            switchView('chat');
            userInput.focus();
        }

        function loadGeminiApiKey() { /* ... (same as before) ... */
             console.warn("!!! SECURITY WARNING / ‡Æ™‡Ææ‡Æ§‡ØÅ‡Æï‡Ææ‡Æ™‡Øç‡Æ™‡ØÅ ‡Æé‡Æö‡Øç‡Æö‡Æ∞‡Æø‡Æï‡Øç‡Æï‡Øà !!! Using insecure API key storage. Use Cloud Functions in production.");
             API_KEY = localStorage.getItem(STORAGE_KEY_API_KEY);
             if(!API_KEY){
                 API_KEY=prompt("--- INSECURE DEMO --- Please enter your Gemini API Key (will be stored insecurely).");
                 if(API_KEY){ localStorage.setItem(STORAGE_KEY_API_KEY, API_KEY); console.log("Saved insecure API Key."); }
                 else { displayError("Gemini API Key is required."); setLoadingState(true, "API Key Missing"); }
             } else { console.log("Loaded insecure API Key."); }
             setLoadingState(!API_KEY);
        }

        // --- Authentication Functions ---
        // ‡Æá‡Æ®‡Øç‡Æ§‡Æ™‡Øç ‡Æ™‡Æï‡ØÅ‡Æ§‡Æø ‡ÆÆ‡Ææ‡Æ±‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà / This part is unchanged
        async function signInWithGoogle() { /* ... (same as before) ... */
             const provider = new firebase.auth.GoogleAuthProvider();
             try { setLoadingState(true, "Logging in..."); await fbAuth.signInWithPopup(provider); }
             catch (error) { console.error("Google Sign-In Error:", error); displayError(`Login failed: ${error.message || 'Unknown error'}`); setLoadingState(false); }
         }
        async function signOut() { /* ... (same as before) ... */
             try { setLoadingState(true, "Logging out..."); await fbAuth.signOut(); }
             catch (error) { console.error("Sign Out Error:", error); displayError(`Logout failed: ${error.message || 'Unknown error'}`); setLoadingState(false); }
         }

        // handleAuthStateChange ‡Æá‡Æ≤‡Øç ‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã ‡Æ™‡Æü‡Øç‡Æü‡Æ©‡Øç‡Æï‡Æ≥‡ØÅ‡ÆÆ‡Øç ‡Æö‡Øá‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡ØÅ‡Æ≥‡Øç‡Æ≥‡Æ© / Audio buttons also included in handleAuthStateChange
        function handleAuthStateChange(user) {
            // ... (‡Æ™‡Æ¥‡Øà‡ÆØ ‡Æö‡Ææ‡Æü‡Øç/‡Æü‡ØÜ‡Æ∏‡Øç‡Æü‡Øç ‡Æ≤‡Æø‡Æ∏‡Øç‡Æü‡Æ©‡Æ∞‡Øç ‡ÆÖ‡Æï‡Æ±‡Øç‡Æ±‡ØÅ‡Æ§‡Æ≤‡Øç / existing chat/test listener removal) ...
            if (activeChatListener) { activeChatListener(); activeChatListener = null; }
            if (chatListListener) { chatListListener(); chatListListener = null; }
            if (testListListener) { testListListener(); testListListener = null; }

            // UI ‡ÆÆ‡ØÄ‡Æü‡Øç‡Æü‡ÆÆ‡Øà‡Æ§‡Øç‡Æ§‡Æ≤‡Øç / Reset UI
            chatArea.innerHTML = '';
            chatListContainer.innerHTML = '<div style="padding:10px;color:var(--text-secondary);font-size:0.9em;">Please log in...</div>';
            allTestsListContainer.innerHTML = '<div style="padding:10px;color:var(--text-secondary);font-size:0.9em;">Login to see tests.</div>';
            allTestsSection.classList.remove('visible');
            testSearchInput.value = ''; testSearchInput.disabled = true;
            activeChatId = null; currentChatHistory = []; isDeletingChat = false; allSavedTestsData = [];
            removeSelectedImage();
            removeSelectedAudio(); // ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ‡Æ§‡ØÅ: ‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã‡Æµ‡Øà‡ÆØ‡ØÅ‡ÆÆ‡Øç ‡ÆÖ‡Æï‡Æ±‡Øç‡Æ±‡ØÅ / New: Also remove audio
            stopRecordingCleanup(); // ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ‡Æ§‡ØÅ: ‡Æ∞‡ØÜ‡Æï‡Øç‡Æï‡Ææ‡Æ∞‡Øç‡Æü‡Æø‡Æô‡Øç ‡Æ®‡Æü‡Æ®‡Øç‡Æ§‡Ææ‡Æ≤‡Øç ‡Æ®‡Æø‡Æ±‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ / New: Stop recording if active

            if (user) {
                currentUser = user; console.log("User logged in:", currentUser.uid);
                // ... (‡Æ™‡Æ¥‡Øà‡ÆØ ‡Æâ‡Æ≥‡Øç‡Æ®‡ØÅ‡Æ¥‡Øà‡Æµ‡ØÅ UI ‡Æ™‡ØÅ‡Æ§‡ØÅ‡Æ™‡Øç‡Æ™‡Æø‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øç / existing login UI updates) ...
                loginBtn.style.display = 'none'; logoutBtn.style.display = 'inline-block';
                accountEmail.textContent = currentUser.email || currentUser.displayName || `User`;
                accountAvatar.textContent = (currentUser.displayName || currentUser.email || 'U')[0].toUpperCase();
                accountPlan.textContent = "Firebase User";

                // Enable controls
                startChatButton.disabled = false;
                decreaseTextBtn.disabled = false; increaseTextBtn.disabled = false;
                themeToggleButton.disabled = false;
                testSearchInput.disabled = false;
                userInput.disabled = false;
                imageUploadButton.disabled = false;
                audioUploadButton.disabled = false; // ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ‡Æ§‡ØÅ / New
                recordAudioButton.disabled = false; // ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ‡Æ§‡ØÅ / New
                sendButton.disabled = true; // Initially disabled until chat selected
                mcqModeCheckbox.disabled = true; // Initially disabled until chat selected

                userInput.placeholder = "Select or create a chat";
                inputContainer.style.display = 'block';
                suggestionsContainer.style.display = 'flex';
                allTestsSection.classList.add('visible');

                // Load user data
                loadUserSettings(currentUser.uid);
                loadAndListenForChats(currentUser.uid);
                loadAndListenForTests(currentUser.uid);
                setLoadingState(false);
            } else {
                currentUser = null; console.log("User logged out");
                // ... (‡Æ™‡Æ¥‡Øà‡ÆØ ‡Æµ‡ØÜ‡Æ≥‡Æø‡ÆØ‡Øá‡Æ±‡Øç‡Æ± UI ‡Æ™‡ØÅ‡Æ§‡ØÅ‡Æ™‡Øç‡Æ™‡Æø‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øç / existing logout UI updates) ...
                loginBtn.style.display = 'inline-block'; logoutBtn.style.display = 'none';
                accountEmail.textContent = "Not logged in"; accountAvatar.textContent = '?'; accountPlan.textContent = "";

                // Disable controls
                startChatButton.disabled = true;
                decreaseTextBtn.disabled = true; increaseTextBtn.disabled = true;
                themeToggleButton.disabled = true;
                testSearchInput.disabled = true;
                userInput.disabled = true;
                imageUploadButton.disabled = true;
                audioUploadButton.disabled = true; // ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ‡Æ§‡ØÅ / New
                recordAudioButton.disabled = true; // ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ‡Æ§‡ØÅ / New
                sendButton.disabled = true;
                mcqModeCheckbox.disabled = true;

                userInput.placeholder = "Please log in";
                inputContainer.style.display = 'none';
                suggestionsContainer.style.display = 'none';
                allTestsSection.classList.remove('visible');

                // Reset UI state
                renderGreetingOrLoginPrompt();
                currentTheme = 'light'; applyTheme();
                currentTextSizeMultiplier = 1.0; applyTextSize();
                setLoadingState(false);
            }
        }

        function renderGreetingOrLoginPrompt() { /* ... (same as v9.3) ... */
             chatArea.innerHTML = ''; const greetingElement = document.createElement('div'); greetingElement.classList.add('greeting');
             if (currentUser) { greetingElement.innerHTML = `<span class="asterisk">*</span>Good day, ${currentUser.displayName || 'User'}!`; chatArea.appendChild(greetingElement); if (!activeChatId) { displayMessage("Select a chat or start a new one.", 'ai'); } }
             else { greetingElement.innerHTML = `<span class="asterisk">*</span>Welcome!`; chatArea.appendChild(greetingElement); displayMessage("Please log in to start chatting.", 'ai'); }
             scrollToBottom(true);
         }

        // --- Settings (Theme/Text Size) ---
        // ‡Æá‡Æ®‡Øç‡Æ§‡Æ™‡Øç ‡Æ™‡Æï‡ØÅ‡Æ§‡Æø ‡ÆÆ‡Ææ‡Æ±‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà / This part is unchanged
        async function loadUserSettings(userId) { /* ... (same as v9.2) ... */ const userDocRef = db.collection('users').doc(userId); try { const docSnap = await userDocRef.get(); if (docSnap.exists) { const settings = docSnap.data(); currentTheme = settings.theme || 'light'; currentTextSizeMultiplier = settings.textSizeMultiplier || 1.0; console.log("Loaded user settings:", settings); } else { console.log("No user settings found, using defaults."); currentTheme = 'light'; currentTextSizeMultiplier = 1.0; await saveUserSettings(); } } catch (error) { console.error("Error loading user settings:", error); currentTheme = 'light'; currentTextSizeMultiplier = 1.0; } applyTheme(); applyTextSize(); }
        async function saveUserSettings() { /* ... (same as v9.2) ... */ if (!currentUser) return; const userDocRef = db.collection('users').doc(currentUser.uid); const settings = { theme: currentTheme, textSizeMultiplier: currentTextSizeMultiplier }; try { await userDocRef.set(settings, { merge: true }); console.log("User settings saved:", settings); } catch (error) { console.error("Error saving user settings:", error); } }
        function applyTheme() { /* ... (same as v9.2) ... */ if(currentTheme==='dark'){ document.body.classList.add('dark-theme'); themeToggleButton.textContent=LIGHT_THEME_ICON; themeToggleButton.title="Switch to Light Theme"; } else { document.body.classList.remove('dark-theme'); themeToggleButton.textContent=DARK_THEME_ICON; themeToggleButton.title="Switch to Dark Theme"; } }
        function toggleTheme() { /* ... (same as v9.2) ... */ if (!currentUser) return; currentTheme = (currentTheme === 'light') ? 'dark' : 'light'; applyTheme(); saveUserSettings(); }
        function applyTextSize() { /* ... (same as v9.2) ... */ const newSize = `calc(var(--message-font-size-base) * ${currentTextSizeMultiplier})`; document.documentElement.style.setProperty('--message-font-size', newSize); decreaseTextBtn.disabled = !currentUser || currentTextSizeMultiplier <= MIN_TEXT_SIZE_MULTIPLIER; increaseTextBtn.disabled = !currentUser || currentTextSizeMultiplier >= MAX_TEXT_SIZE_MULTIPLIER; }
        function adjustTextSize(change) { /* ... (same as v9.2) ... */ if (!currentUser) return; let newMultiplier = Math.max(MIN_TEXT_SIZE_MULTIPLIER, Math.min(MAX_TEXT_SIZE_MULTIPLIER, currentTextSizeMultiplier + change)); newMultiplier = Math.round(newMultiplier * 10) / 10; if (newMultiplier !== currentTextSizeMultiplier) { currentTextSizeMultiplier = newMultiplier; applyTextSize(); saveUserSettings(); } }


        // --- Chat Storage & Loading (Firestore) ---
        // ‡Æá‡Æ®‡Øç‡Æ§‡Æ™‡Øç ‡Æ™‡Æï‡ØÅ‡Æ§‡Æø ‡ÆÆ‡Ææ‡Æ±‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà, ‡ÆÜ‡Æ©‡Ææ‡Æ≤‡Øç setLoadingState ‡Æá‡Æ™‡Øç‡Æ™‡Øã‡Æ§‡ØÅ ‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã ‡Æ™‡Æü‡Øç‡Æü‡Æ©‡Øç‡Æï‡Æ≥‡Øà‡ÆØ‡ØÅ‡ÆÆ‡Øç ‡Æï‡Øà‡ÆØ‡Ææ‡Æ≥‡ØÅ‡ÆÆ‡Øç / Unchanged, but setLoadingState now handles audio buttons too
        function loadAndListenForChats(userId) { /* ... (same as v9.2) ... */
            if (chatListListener) { chatListListener(); chatListListener = null; }
            const chatsRef = db.collection('chats').where('userId', '==', userId).orderBy('lastUpdated', 'desc');
            console.log(`Listening for chats for user ${userId}`);
            chatListListener = chatsRef.onSnapshot(snapshot => {
                 if (isDeletingChat) { console.log("Skipping chat list update during delete."); return; }
                const chats = []; snapshot.forEach(doc => { chats.push({ id: doc.id, ...doc.data() }); });
                console.log("Received chat list snapshot:", chats.length, "chats");
                renderSidebarChatList(chats);
                let chatToLoad = null;
                if (activeChatId && chats.some(c => c.id === activeChatId)) { chatToLoad = activeChatId; }
                else if (chats.length > 0) { chatToLoad = chats[0].id; console.log("Active chat gone/none, selecting newest:", chatToLoad); }
                else { activeChatId = null; if (activeChatListener) { activeChatListener(); activeChatListener = null; } renderGreetingOrLoginPrompt(); setLoadingState(false); /* Buttons already handled by auth state change */ userInput.placeholder = "Create a new chat"; }
                 if (chatToLoad && chatToLoad !== activeChatId) { switchChat(chatToLoad); }
                 else if (activeChatId) { highlightActiveChatInSidebar(); setLoadingState(false); /* Buttons handled by setLoadingState itself */ }
                 else { setLoadingState(false); }
            }, error => { console.error("Error listening for chats:", error); displayError("Could not load chat list."); chatListContainer.innerHTML = '<div style="padding:10px;color:var(--error-text);">Error loading chats.</div>'; setLoadingState(false); });
        }
        function renderSidebarChatList(chats) { /* ... (same as v9.2) ... */
            chatListContainer.innerHTML = ''; if (!currentUser) { chatListContainer.innerHTML = '<div style="padding:10px;color:var(--text-secondary);">Please log in.</div>'; return; }
            if (chats.length === 0) { chatListContainer.innerHTML = '<div style="padding:10px;color:var(--text-secondary);">No chats yet. Start one!</div>'; }
            else { chats.forEach(chatData => { const itemElement = document.createElement('div'); itemElement.classList.add('chat-list-item'); let title = chatData.title; if (typeof title !== 'string' || !title.trim()) { title = '(Untitled Chat)'; } title = title.trim(); itemElement.textContent = title; itemElement.dataset.id = chatData.id; itemElement.title = title; const deleteBtn = document.createElement('button'); deleteBtn.classList.add('delete-chat-button'); deleteBtn.innerHTML = DELETE_ICON; deleteBtn.title = "Delete chat"; deleteBtn.dataset.id = chatData.id; itemElement.appendChild(deleteBtn); chatListContainer.appendChild(itemElement); }); }
            highlightActiveChatInSidebar();
        }
        function highlightActiveChatInSidebar() { /* ... (same as v9.2) ... */ const items = chatListContainer.querySelectorAll('.chat-list-item'); items.forEach(item => { item.classList.toggle('active', item.dataset.id === activeChatId); }); }


        // --- Image Handling Functions ---
        // ‡Æá‡Æ®‡Øç‡Æ§‡Æ™‡Øç ‡Æ™‡Æï‡ØÅ‡Æ§‡Æø ‡ÆÆ‡Ææ‡Æ±‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà / This part is unchanged
        function handleImageFileSelect(event) { /* ... (same as v9.2) ... */
             removeSelectedAudio(); // ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ‡Æ§‡ØÅ: ‡Æí‡Æ∞‡ØÅ ‡Æ®‡Øá‡Æ∞‡Æ§‡Øç‡Æ§‡Æø‡Æ≤‡Øç ‡Æí‡Æ©‡Øç‡Æ±‡ØÅ ‡ÆÆ‡Æü‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç / New: Only one attachment at a time
            const file = event.target.files[0]; if (!file) { removeSelectedImage(); return; }
            const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif', 'image/bmp']; if (!allowedTypes.includes(file.type)) { alert(`Invalid file type. Please select an image.`); imageUploadInput.value = ''; removeSelectedImage(); return; }
            const fileSizeMB = file.size / 1024 / 1024; if (fileSizeMB > MAX_IMAGE_SIZE_MB) { alert(`Image too large (${fileSizeMB.toFixed(1)}MB). Max ${MAX_IMAGE_SIZE_MB}MB.`); imageUploadInput.value = ''; removeSelectedImage(); return; }
            const reader = new FileReader();
            reader.onload = (e) => { selectedImageData = { file: file, base64: e.target.result, mimeType: file.type }; console.log("Image selected:", file.name, file.type, `(${fileSizeMB.toFixed(2)} MB)`); previewImage.src = e.target.result; previewInfo.textContent = file.name; imagePreviewContainer.style.display = 'flex'; }
            reader.onerror = (error) => { console.error("Error reading file:", error); alert("Error reading image file."); removeSelectedImage(); };
            reader.readAsDataURL(file);
        }
        function removeSelectedImage() { /* ... (same as v9.2) ... */
            selectedImageData = { file: null, base64: null, mimeType: null };
            imagePreviewContainer.style.display = 'none'; previewImage.src = '#'; previewInfo.textContent = ''; imageUploadInput.value = ''; console.log("Selected image removed.");
        }

        // --- ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ‡Æ§‡ØÅ: ‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã ‡Æï‡Øà‡ÆØ‡Ææ‡Æ≥‡ØÅ‡ÆÆ‡Øç ‡Æö‡ØÜ‡ÆØ‡Æ≤‡Øç‡Æ™‡Ææ‡Æü‡ØÅ‡Æï‡Æ≥‡Øç / New: Audio Handling Functions ---

        /**
         * ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç: ‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü ‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã ‡Æï‡Øã‡Æ™‡Øç‡Æ™‡Øà‡Æï‡Øç ‡Æï‡Øà‡ÆØ‡Ææ‡Æ≥‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ.
         * ‡Æï‡Øã‡Æ™‡Øç‡Æ™‡Æø‡Æ©‡Øç ‡Æµ‡Æï‡Øà ‡ÆÆ‡Æ±‡Øç‡Æ±‡ØÅ‡ÆÆ‡Øç ‡ÆÖ‡Æ≥‡Æµ‡Øà‡Æö‡Øç ‡Æö‡Æ∞‡Æø‡Æ™‡Ææ‡Æ∞‡Øç‡Æ§‡Øç‡Æ§‡ØÅ, ‡Æ™‡Øç‡Æ∞‡Æø‡Æµ‡Æø‡ÆØ‡ØÇ ‡Æï‡Ææ‡Æ£‡Øç‡Æ™‡Æø‡Æ§‡Øç‡Æ§‡ØÅ, API ‡Æï‡Øç‡Æï‡ØÅ ‡ÆÖ‡Æ©‡ØÅ‡Æ™‡Øç‡Æ™ base64 ‡ÆÜ‡Æï ‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ.
         * English: Handles the selected audio file.
         * Validates file type and size, displays preview, and converts to base64 for API.
         */
        function handleAudioFileSelect(event) {
            removeSelectedImage(); // ‡Æí‡Æ∞‡ØÅ ‡Æ®‡Øá‡Æ∞‡Æ§‡Øç‡Æ§‡Æø‡Æ≤‡Øç ‡Æí‡Æ©‡Øç‡Æ±‡ØÅ ‡ÆÆ‡Æü‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç / Only one attachment at a time
            const file = event.target.files[0];
            if (!file) {
                removeSelectedAudio();
                return;
            }

            console.log("Audio file selected:", file.name, file.type, file.size);

            // ‡Æï‡Øã‡Æ™‡Øç‡Æ™‡ØÅ ‡Æµ‡Æï‡Øà‡ÆØ‡Øà ‡Æö‡Æ∞‡Æø‡Æ™‡Ææ‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç / Validate file type
            if (!SUPPORTED_AUDIO_MIME_TYPES.includes(file.type)) {
                alert(`Unsupported audio format: ${file.type}. Supported formats are: ${SUPPORTED_AUDIO_MIME_TYPES.join(', ')}`);
                audioUploadInput.value = '';
                removeSelectedAudio();
                return;
            }

            // ‡Æï‡Øã‡Æ™‡Øç‡Æ™‡ØÅ ‡ÆÖ‡Æ≥‡Æµ‡Øà ‡Æö‡Æ∞‡Æø‡Æ™‡Ææ‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç / Validate file size
            const fileSizeMB = file.size / 1024 / 1024;
            if (fileSizeMB > MAX_AUDIO_SIZE_MB) {
                alert(`Audio file too large (${fileSizeMB.toFixed(1)}MB). Maximum size is ${MAX_AUDIO_SIZE_MB}MB for inline upload.`);
                audioUploadInput.value = '';
                removeSelectedAudio();
                return;
            }

            // Base64 ‡ÆÜ‡Æï‡Æ™‡Øç ‡Æ™‡Æü‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç / Read as Base64
            const reader = new FileReader();
            reader.onload = (e) => {
                selectedAudioData = {
                    file: file,
                    base64: e.target.result, // ‡Æá‡Æ§‡ØÅ data URL ‡ÆÜ‡Æï ‡Æá‡Æ∞‡ØÅ‡Æï‡Øç‡Æï‡ØÅ‡ÆÆ‡Øç (e.g., "data:audio/mp3;base64,...") / This will be a data URL
                    mimeType: file.type,
                    source: 'upload'
                };
                console.log(`Audio selected: ${file.name}, Type: ${file.type}, Size: ${fileSizeMB.toFixed(2)} MB`);
                displayAudioPreview(file.name, e.target.result); // ‡Æ™‡Øç‡Æ∞‡Æø‡Æµ‡Æø‡ÆØ‡ØÇ ‡Æï‡Ææ‡Æ£‡Øç‡Æ™‡Æø‡Æï‡Øç‡Æï Data URL ‡Æê‡Æ™‡Øç ‡Æ™‡ÆØ‡Æ©‡Øç‡Æ™‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡Æµ‡ØÅ‡ÆÆ‡Øç / Use Data URL for preview
            }
            reader.onerror = (error) => {
                console.error("Error reading audio file:", error);
                alert("Error reading audio file.");
                removeSelectedAudio();
            };
            reader.readAsDataURL(file); // Data URL ‡ÆÜ‡Æï‡Æ™‡Øç ‡Æ™‡Æü‡Æø / Read as Data URL
        }

        /**
         * ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç: ‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü ‡ÆÖ‡Æ≤‡Øç‡Æ≤‡Æ§‡ØÅ ‡Æ™‡Æ§‡Æø‡Æµ‡ØÅ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü ‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã‡Æµ‡Æø‡Æ±‡Øç‡Æï‡Ææ‡Æ© ‡Æ™‡Øç‡Æ∞‡Æø‡Æµ‡Æø‡ÆØ‡ØÇ‡Æµ‡Øà‡Æï‡Øç ‡Æï‡Ææ‡Æü‡Øç‡Æü‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ.
         * English: Displays the preview for the selected or recorded audio.
         */
        function displayAudioPreview(fileName, audioSrc) {
            audioPreviewInfo.textContent = fileName;
            previewAudio.src = audioSrc; // ‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã ‡Æ™‡Øç‡Æ≥‡Øá‡ÆØ‡Æ∞‡ØÅ‡Æï‡Øç‡Æï‡ØÅ ‡ÆÆ‡ØÇ‡Æ≤‡Æ§‡Øç‡Æ§‡Øà ‡ÆÖ‡ÆÆ‡Øà‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç / Set source for the audio player
            previewAudio.load(); // ‡Æ§‡Øá‡Æµ‡Øà‡Æ™‡Øç‡Æ™‡Æü‡Æ≤‡Ææ‡ÆÆ‡Øç / May be needed
            audioPreviewContainer.style.display = 'flex';
        }

        /**
         * ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç: ‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü ‡ÆÖ‡Æ≤‡Øç‡Æ≤‡Æ§‡ØÅ ‡Æ™‡Æ§‡Æø‡Æµ‡ØÅ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü ‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã‡Æµ‡Øà ‡Æ®‡ØÄ‡Æï‡Øç‡Æï‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ.
         * English: Removes the selected or recorded audio and clears the preview.
         */
        function removeSelectedAudio() {
            selectedAudioData = { file: null, base64: null, mimeType: null, source: null };
            audioPreviewContainer.style.display = 'none';
            previewAudio.src = ''; // ‡ÆÆ‡ØÇ‡Æ≤‡Æ§‡Øç‡Æ§‡Øà ‡ÆÖ‡Æ¥‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç / Clear the source
            audioPreviewInfo.textContent = '';
            audioUploadInput.value = ''; // ‡Æá‡Æ©‡Øç‡Æ™‡ØÅ‡Æü‡Øç ‡Æê ‡ÆÖ‡Æ¥‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç / Clear the input
            stopRecordingCleanup(); // ‡Æ∞‡ØÜ‡Æï‡Øç‡Æï‡Ææ‡Æ∞‡Øç‡Æü‡Æø‡Æô‡Øç ‡Æ®‡Æü‡Æ®‡Øç‡Æ§‡Ææ‡Æ≤‡Øç ‡Æ®‡Æø‡Æ±‡ØÅ‡Æ§‡Øç‡Æ§‡Æµ‡ØÅ‡ÆÆ‡Øç / Stop recording if active
            console.log("Selected audio removed.");
        }

        /**
         * ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç: ‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã ‡Æ∞‡ØÜ‡Æï‡Øç‡Æï‡Ææ‡Æ∞‡Øç‡Æü‡Æø‡Æô‡Øç‡Æï‡Øà‡Æ§‡Øç ‡Æ§‡Øä‡Æü‡Æô‡Øç‡Æï‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ ‡ÆÖ‡Æ≤‡Øç‡Æ≤‡Æ§‡ØÅ ‡Æ®‡Æø‡Æ±‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ.
         * English: Toggles audio recording on or off.
         */
        async function toggleAudioRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                removeSelectedImage(); // ‡Æí‡Æ∞‡ØÅ ‡Æ®‡Øá‡Æ∞‡Æ§‡Øç‡Æ§‡Æø‡Æ≤‡Øç ‡Æí‡Æ©‡Øç‡Æ±‡ØÅ ‡ÆÆ‡Æü‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç / Only one attachment
                removeSelectedAudio(); // ‡Æè‡Æ±‡Øç‡Æï‡Æ©‡Æµ‡Øá ‡Æâ‡Æ≥‡Øç‡Æ≥‡Æ§‡Øà ‡Æ®‡ØÄ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç / Remove existing audio
                await startRecording();
            }
        }

        /**
         * ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç: ‡ÆÆ‡Øà‡Æï‡Øç‡Æ∞‡Øã‡ÆÉ‡Æ™‡Øã‡Æ©‡Øç ‡ÆÖ‡Æ£‡ØÅ‡Æï‡Æ≤‡Øà‡Æï‡Øç ‡Æï‡Øá‡Æü‡Øç‡Æü‡ØÅ ‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã ‡Æ∞‡ØÜ‡Æï‡Øç‡Æï‡Ææ‡Æ∞‡Øç‡Æü‡Æø‡Æô‡Øç‡Æï‡Øà‡Æ§‡Øç ‡Æ§‡Øä‡Æü‡Æô‡Øç‡Æï‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ.
         * English: Requests microphone access and starts audio recording.
         */
        async function startRecording() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert("Audio recording is not supported by your browser.");
                return;
            }

            try {
                // ‡ÆÆ‡Øà‡Æï‡Øç‡Æ∞‡Øã‡ÆÉ‡Æ™‡Øã‡Æ©‡Øç ‡ÆÖ‡Æ£‡ØÅ‡Æï‡Æ≤‡Øà‡Æï‡Øç ‡Æï‡Øá‡Æü‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç / Request microphone access
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                isRecording = true;
                audioChunks = []; // ‡ÆÆ‡ØÅ‡Æ®‡Øç‡Æ§‡Øà‡ÆØ ‡Æ™‡Æ§‡Æø‡Æµ‡ØÅ‡Æï‡Æ≥‡Øà ‡ÆÖ‡Æ¥‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç / Clear previous chunks
                recordAudioButton.classList.add('recording'); // ‡Æ∞‡ØÜ‡Æï‡Øç‡Æï‡Ææ‡Æ∞‡Øç‡Æü‡Æø‡Æô‡Øç ‡Æ™‡Æü‡Øç‡Æü‡Æ©‡Øà ‡ÆÖ‡Æ©‡Æø‡ÆÆ‡Øá‡Æü‡Øç ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡Æµ‡ØÅ‡ÆÆ‡Øç / Animate recording button
                recordAudioButton.title = "Stop recording";
                setRecordingState(true); // ‡ÆÆ‡Æ±‡Øç‡Æ± ‡Æ™‡Æü‡Øç‡Æü‡Æ©‡Øç‡Æï‡Æ≥‡Øà ‡ÆÆ‡ØÅ‡Æü‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç / Disable other buttons

                // MediaRecorder ‡Æê‡Æ§‡Øç ‡Æ§‡Øä‡Æü‡Æô‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç / Initialize MediaRecorder
                // Gemini ‡ÆÜ‡Æ§‡Æ∞‡Æø‡Æï‡Øç‡Æï‡ØÅ‡ÆÆ‡Øç ‡Æí‡Æ∞‡ØÅ ‡Æµ‡Æï‡Øà‡ÆØ‡Øà ‡ÆÆ‡ØÅ‡ÆØ‡Æ±‡Øç‡Æö‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç (OGG) / Try a type supported by Gemini (OGG)
                const options = { mimeType: RECORDING_MIME_TYPE };
                try {
                    mediaRecorder = new MediaRecorder(stream, options);
                } catch (e) {
                    console.warn(`Preferred mimeType ${RECORDING_MIME_TYPE} not supported, trying default. Error:`, e);
                    // ‡ÆÜ‡Æ§‡Æ∞‡Æµ‡ØÅ ‡Æá‡Æ≤‡Øç‡Æ≤‡Øà ‡Æé‡Æ©‡Øç‡Æ±‡Ææ‡Æ≤‡Øç, ‡Æá‡ÆØ‡Æ≤‡Øç‡Æ™‡ØÅ‡Æ®‡Æø‡Æ≤‡Øà‡ÆØ‡Øà ‡ÆÆ‡ØÅ‡ÆØ‡Æ±‡Øç‡Æö‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç / If not supported, try default
                    try {
                         mediaRecorder = new MediaRecorder(stream);
                    } catch (e2) {
                        console.error("MediaRecorder initialization failed:", e2);
                        alert("Failed to initialize audio recorder. Your browser might not support recording.");
                        stopRecordingCleanup(); // ‡Æö‡ØÅ‡Æ§‡Øç‡Æ§‡ÆÆ‡Øç ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡Æµ‡ØÅ‡ÆÆ‡Øç / Clean up
                        return;
                    }
                }

                console.log("Recording started with mimeType:", mediaRecorder.mimeType);

                // ‡Æ§‡Æ∞‡Æµ‡ØÅ ‡Æï‡Æø‡Æü‡Øà‡Æï‡Øç‡Æï‡ØÅ‡ÆÆ‡Øç‡Æ™‡Øã‡Æ§‡ØÅ ‡Æö‡Øá‡Æï‡Æ∞‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç / Collect data when available
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                // ‡Æ∞‡ØÜ‡Æï‡Øç‡Æï‡Ææ‡Æ∞‡Øç‡Æü‡Æø‡Æô‡Øç ‡Æ®‡Æø‡Æ±‡ØÅ‡Æ§‡Øç‡Æ§‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ‡ÆÆ‡Øç ‡Æï‡Øà‡ÆØ‡Ææ‡Æ≥‡Æµ‡ØÅ‡ÆÆ‡Øç / Handle stop event
                mediaRecorder.onstop = () => {
                    isRecording = false;
                    recordAudioButton.classList.remove('recording');
                    recordAudioButton.title = "Record audio";
                    setRecordingState(false); // ‡Æ™‡Æü‡Øç‡Æü‡Æ©‡Øç‡Æï‡Æ≥‡Øà ‡ÆÆ‡ØÄ‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡Æá‡ÆØ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç / Re-enable buttons

                    if (audioChunks.length === 0) {
                        console.warn("Recording stopped, but no audio data received.");
                        removeSelectedAudio(); // ‡Æé‡Æ§‡ØÅ‡Æµ‡ØÅ‡ÆÆ‡Øç ‡Æá‡Æ≤‡Øç‡Æ≤‡Øà ‡Æé‡Æ©‡Øç‡Æ±‡Ææ‡Æ≤‡Øç ‡Æ®‡ØÄ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç / Remove if nothing
                        return;
                    }

                    // Blob ‡Æê ‡Æâ‡Æ∞‡ØÅ‡Æµ‡Ææ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç / Create the Blob
                    const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
                    const recordedFileType = mediaRecorder.mimeType;
                    const fileSizeMB = audioBlob.size / 1024 / 1024;
                    console.log(`Recording stopped. Blob created: Type=${recordedFileType}, Size=${fileSizeMB.toFixed(2)} MB`);

                    // ‡Æ™‡Æ§‡Æø‡Æµ‡ØÅ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü ‡Æµ‡Æï‡Øà ‡ÆÜ‡Æ§‡Æ∞‡Æø‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡Ææ ‡Æé‡Æ©‡Øç‡Æ±‡ØÅ ‡Æö‡Æ∞‡Æø‡Æ™‡Ææ‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç / Check if recorded type is supported
                     if (!SUPPORTED_AUDIO_MIME_TYPES.includes(recordedFileType.split(';')[0])) { // Ignore codecs part for check
                         alert(`Recorded audio format (${recordedFileType}) might not be directly supported by Gemini. Supported: ${SUPPORTED_AUDIO_MIME_TYPES.join(', ')}`);
                         // You might want to still allow sending, Gemini might handle it, or show a stronger warning.
                     }

                     if (fileSizeMB > MAX_AUDIO_SIZE_MB) {
                         alert(`Recorded audio too large (${fileSizeMB.toFixed(1)}MB). Maximum size is ${MAX_AUDIO_SIZE_MB}MB.`);
                         removeSelectedAudio();
                         return;
                     }

                    // Base64 ‡ÆÜ‡Æï ‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡Æµ‡ØÅ‡ÆÆ‡Øç / Convert to Base64
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        selectedAudioData = {
                            file: audioBlob, // Store Blob for potential future use
                            base64: e.target.result, // Data URL
                            mimeType: recordedFileType, // Use actual recorded type
                            source: 'record'
                        };
                        displayAudioPreview(`recorded_audio.${recordedFileType.split('/')[1].split(';')[0]}`, e.target.result); // ‡Æ™‡Øç‡Æ∞‡Æø‡Æµ‡Æø‡ÆØ‡ØÇ / Preview
                    };
                    reader.onerror = (error) => {
                        console.error("Error reading recorded audio blob:", error);
                        alert("Error processing recorded audio.");
                        removeSelectedAudio();
                    };
                    reader.readAsDataURL(audioBlob); // Data URL ‡ÆÜ‡Æï‡Æ™‡Øç ‡Æ™‡Æü‡Æø / Read as Data URL

                    // ‡Æ∏‡Øç‡Æü‡Øç‡Æ∞‡ØÄ‡ÆÆ‡Øç ‡Æü‡Æø‡Æ∞‡Ææ‡Æï‡Øç‡Æï‡ØÅ‡Æï‡Æ≥‡Øà ‡Æ®‡Æø‡Æ±‡ØÅ‡Æ§‡Øç‡Æ§‡Æµ‡ØÅ‡ÆÆ‡Øç / Stop stream tracks
                     stream.getTracks().forEach(track => track.stop());
                };

                 mediaRecorder.onerror = (event) => {
                     console.error("MediaRecorder error:", event.error);
                     alert(`Audio recording error: ${event.error.name}. Please check microphone permissions.`);
                     stopRecordingCleanup();
                 };

                // ‡Æ∞‡ØÜ‡Æï‡Øç‡Æï‡Ææ‡Æ∞‡Øç‡Æü‡Æø‡Æô‡Øç‡Æï‡Øà‡Æ§‡Øç ‡Æ§‡Øä‡Æü‡Æô‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç / Start recording
                mediaRecorder.start();

            } catch (err) {
                console.error("Error accessing microphone:", err);
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    alert("Microphone access denied. Please allow microphone access in your browser settings.");
                } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                     alert("No microphone found. Please ensure a microphone is connected and enabled.");
                } else {
                     alert(`Could not start recording: ${err.name}`);
                }
                stopRecordingCleanup(); // ‡Æ™‡Æø‡Æ¥‡Øà ‡Æè‡Æ±‡Øç‡Æ™‡Æü‡Øç‡Æü‡Ææ‡Æ≤‡Øç ‡Æö‡ØÅ‡Æ§‡Øç‡Æ§‡ÆÆ‡Øç ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡Æµ‡ØÅ‡ÆÆ‡Øç / Clean up on error
            }
        }

        /**
         * ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç: ‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã ‡Æ∞‡ØÜ‡Æï‡Øç‡Æï‡Ææ‡Æ∞‡Øç‡Æü‡Æø‡Æô‡Øç‡Æï‡Øà ‡Æ®‡Æø‡Æ±‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ.
         * English: Stops the audio recording.
         */
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop(); // ‡Æá‡Æ§‡ØÅ onstop ‡Æ®‡Æø‡Æï‡Æ¥‡Øç‡Æµ‡Øà‡Æ§‡Øç ‡Æ§‡ØÇ‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç / This triggers the onstop event
                console.log("Stopping recording...");
            } else {
                 console.warn("Stop recording called but not recording.");
                 stopRecordingCleanup(); // Still ensure cleanup
            }
        }

        /**
         * ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç: ‡Æ∞‡ØÜ‡Æï‡Øç‡Æï‡Ææ‡Æ∞‡Øç‡Æü‡Æø‡Æô‡Øç ‡Æ§‡Øä‡Æü‡Æ∞‡Øç‡Æ™‡Ææ‡Æ© ‡ÆÆ‡Ææ‡Æ±‡Æø‡Æï‡Æ≥‡Øç ‡ÆÆ‡Æ±‡Øç‡Æ±‡ØÅ‡ÆÆ‡Øç UI ‡Æê ‡Æö‡ØÅ‡Æ§‡Øç‡Æ§‡ÆÆ‡Øç ‡Æö‡ØÜ‡ÆØ‡Øç‡Æï‡Æø‡Æ±‡Æ§‡ØÅ.
         * English: Cleans up recording related variables and UI.
         */
        function stopRecordingCleanup() {
             if (mediaRecorder && mediaRecorder.stream) {
                 mediaRecorder.stream.getTracks().forEach(track => track.stop()); // ‡Æ∏‡Øç‡Æü‡Øç‡Æ∞‡ØÄ‡ÆÆ‡Øà ‡Æ®‡Æø‡Æ±‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ / Stop stream
             }
            mediaRecorder = null;
            audioChunks = [];
            isRecording = false;
            recordAudioButton.classList.remove('recording');
            recordAudioButton.title = "Record audio";
            setRecordingState(false); // ‡Æ™‡Æü‡Øç‡Æü‡Æ©‡Øç‡Æï‡Æ≥‡Øà ‡Æá‡ÆØ‡Æï‡Øç‡Æï‡ØÅ / Enable buttons
        }

        /**
         * ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç: ‡Æ∞‡ØÜ‡Æï‡Øç‡Æï‡Ææ‡Æ∞‡Øç‡Æü‡Æø‡Æô‡Øç ‡Æ®‡Æø‡Æ≤‡Øà‡ÆØ‡Æø‡Æ©‡Øç ‡ÆÖ‡Æü‡Æø‡Æ™‡Øç‡Æ™‡Æü‡Øà‡ÆØ‡Æø‡Æ≤‡Øç UI ‡Æê ‡Æ™‡ØÅ‡Æ§‡ØÅ‡Æ™‡Øç‡Æ™‡Æø‡Æï‡Øç‡Æï‡Æø‡Æ±‡Æ§‡ØÅ (‡Æ™‡Æü‡Øç‡Æü‡Æ©‡Øç‡Æï‡Æ≥‡Øà ‡ÆÆ‡ØÅ‡Æü‡Æï‡Øç‡Æï‡ØÅ‡Æ§‡Æ≤‡Øç/‡Æá‡ÆØ‡Æï‡Øç‡Æï‡ØÅ‡Æ§‡Æ≤‡Øç).
         * English: Updates the UI based on recording state (disabling/enabling buttons).
         */
        function setRecordingState(recordingActive) {
             userInput.disabled = recordingActive;
             sendButton.disabled = recordingActive;
             imageUploadButton.disabled = recordingActive;
             audioUploadButton.disabled = recordingActive;
             // recordAudioButton is handled separately by toggleAudioRecording
             mcqModeCheckbox.disabled = recordingActive;
             startChatButton.disabled = recordingActive;
             // Keep sidebar controls potentially enabled
        }


        // --- Chat Creation, Deletion, Switching ---
        // ‡Æá‡Æ®‡Øç‡Æ§‡Æ™‡Øç ‡Æ™‡Æï‡ØÅ‡Æ§‡Æø ‡ÆÆ‡Ææ‡Æ±‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà, ‡ÆÜ‡Æ©‡Ææ‡Æ≤‡Øç switchChat ‡Æá‡Æ™‡Øç‡Æ™‡Øã‡Æ§‡ØÅ ‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã‡Æµ‡Øà‡ÆØ‡ØÅ‡ÆÆ‡Øç ‡Æ®‡ØÄ‡Æï‡Øç‡Æï‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ / Unchanged, but switchChat now also removes audio
        async function createNewChat() { /* ... (same as v9.2) ... */
            if (!currentUser) { displayError("Please log in."); return; } setLoadingState(true, "Creating chat..."); removeSelectedImage(); removeSelectedAudio(); // ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ‡Æ§‡ØÅ / New
            const newChatRef = db.collection('chats').doc(); const timestamp = firebase.firestore.FieldValue.serverTimestamp();
            try { await newChatRef.set({ userId: currentUser.uid, title: NEW_CHAT_TITLE, createdAt: timestamp, lastUpdated: timestamp }); console.log("New chat created:", newChatRef.id); }
            catch (error) { console.error("Error creating new chat:", error); displayError("Failed to create chat."); setLoadingState(false); }
        }
        function handleChatListClick(event) { /* ... (same as v9.2) ... */
             const target = event.target; const deleteButton = target.closest('.delete-chat-button'); if (deleteButton) { event.stopPropagation(); const chatId = deleteButton.dataset.id; const chatListItem = deleteButton.closest('.chat-list-item'); const chatTitle = chatListItem?.textContent?.replace(deleteButton.textContent, '').trim() || 'this chat'; if (chatId) { confirmAndDeleteChat(chatId, chatTitle); } return; }
             const item = target.closest('.chat-list-item'); const clickedId = item?.dataset?.id; if (item && clickedId && clickedId !== activeChatId) { switchChat(clickedId); }
        }
        function confirmAndDeleteChat(chatId, chatTitle) { /* ... (same as v9.2) ... */
            if (!currentUser || !chatId) return; if (confirm(`Delete chat "${chatTitle}" permanently?`)) { deleteChatFromFirestore(chatId); } else { console.log(`Deletion cancelled for chat: ${chatId}`); }
        }
        async function deleteChatFromFirestore(chatId) { /* ... (same as v9.2) ... */
            if (!currentUser || !chatId) return; isDeletingChat = true; console.log(`[Delete Start] Chat: ${chatId}`); setLoadingState(true, "Deleting chat...");
            const chatDocRef = db.collection('chats').doc(chatId); const messagesRef = chatDocRef.collection('messages');
            try { const messagesSnapshot = await messagesRef.get(); if (!messagesSnapshot.empty) { const batch = db.batch(); messagesSnapshot.docs.forEach(doc => { batch.delete(doc.ref); }); await batch.commit(); console.log(`[Delete] Deleted ${messagesSnapshot.size} messages.`); } await chatDocRef.delete(); console.log(`[Delete Success] Chat doc: ${chatId}`); if (activeChatId === chatId) { activeChatId = null; currentChatHistory = []; if (activeChatListener) { activeChatListener(); activeChatListener = null; } chatArea.innerHTML = ''; renderGreetingOrLoginPrompt(); userInput.placeholder = "Select or create chat"; setLoadingState(false); /* Buttons handled by auth state / loading state */ removeSelectedImage(); removeSelectedAudio(); } } // Buttons handled by setLoadingState below
            catch (error) { console.error(`[Delete Error] Chat ${chatId}:`, error); displayError(`Failed to delete chat.`); } // setLoadingState called in finally
            finally { isDeletingChat = false; setLoadingState(false); console.log(`[Delete End] Chat: ${chatId}`); }
        }
        function switchChat(chatId) {
             if (!currentUser || !chatId || chatId === activeChatId) return;
             console.log("Switching to chat:", chatId);
             setLoadingState(true, "Loading chat...");
             activeChatId = chatId;
             removeSelectedImage();
             removeSelectedAudio(); // ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ‡Æ§‡ØÅ: ‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã‡Æµ‡Øà‡ÆØ‡ØÅ‡ÆÆ‡Øç ‡Æ®‡ØÄ‡Æï‡Øç‡Æï‡ØÅ / New: Also remove audio
             stopRecordingCleanup(); // ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ‡Æ§‡ØÅ: ‡Æ∞‡ØÜ‡Æï‡Øç‡Æï‡Ææ‡Æ∞‡Øç‡Æü‡Æø‡Æô‡Øç‡Æï‡Øà ‡Æ®‡Æø‡Æ±‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ / New: Stop recording
             highlightActiveChatInSidebar();
             userInput.value = '';
             autoGrowTextarea();
             mcqModeCheckbox.checked = false;
             userInput.placeholder = "Loading messages...";
             loadAndListenForActiveChat(chatId);
        }

        // --- Message Loading (Firestore) ---
        // ‡Æá‡Æ®‡Øç‡Æ§‡Æ™‡Øç ‡Æ™‡Æï‡ØÅ‡Æ§‡Æø ‡Æ™‡ØÜ‡Æ∞‡ØÅ‡ÆÆ‡Øç‡Æ™‡Ææ‡Æ≤‡ØÅ‡ÆÆ‡Øç ‡ÆÆ‡Ææ‡Æ±‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà / This part is mostly unchanged
        function loadAndListenForActiveChat(chatId) {
            if (!currentUser || !chatId) { /* Handle missing user/chatId */ chatArea.innerHTML = ''; if (activeChatListener) { activeChatListener(); activeChatListener = null; } renderGreetingOrLoginPrompt(); setLoadingState(false); return; }
            if (activeChatListener) { activeChatListener(); activeChatListener = null; }
            const messagesRef = db.collection('chats').doc(chatId).collection('messages').orderBy('timestamp', 'asc');
            chatArea.innerHTML = ''; const loadingMsg = displayMessage("Loading chat history...", 'ai', ['thinking']); scrollToBottom(true);
            console.log(`Listening for messages in chat ${chatId}`);
            activeChatListener = messagesRef.onSnapshot(snapshot => {
                console.log(`Received messages snapshot for chat ${chatId}:`, snapshot.size, "messages"); removeMessageElement(loadingMsg); chatArea.innerHTML = ''; currentChatHistory = [];
                if (snapshot.empty && activeChatId === chatId) { /* Handle empty chat */ const chatListItem = chatListContainer.querySelector(`.chat-list-item[data-id="${chatId}"]`); const chatTitle = chatListItem?.textContent?.replace(DELETE_ICON, '').trim() || ''; if (chatTitle && chatTitle !== NEW_CHAT_TITLE) { displayMessage("Chat empty. Send a message!", 'ai'); } else { renderGreetingOrLoginPrompt(); } }
                else {
                    snapshot.forEach(doc => {
                        const msgData = doc.data();
                        const role = msgData.role === 'user' ? 'user' : 'model';
                        // API History ‡Æï‡Øç‡Æï‡Ææ‡Æï ‡Æé‡Æ≥‡Æø‡ÆÆ‡Øà‡ÆØ‡Ææ‡Æ© ‡Æµ‡Æ∞‡Æ≤‡Ææ‡Æ±‡Øç‡Æ±‡Øà ‡Æâ‡Æ∞‡ØÅ‡Æµ‡Ææ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç (‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã/‡Æ™‡Æü‡Æ§‡Øç ‡Æ§‡Æ∞‡Æµ‡ØÅ ‡Æá‡Æ≤‡Øç‡Æ≤‡Ææ‡ÆÆ‡Æ≤‡Øç) / Build simplified history for API (no audio/image data)
                        // YouTube ID ‡Æê‡ÆØ‡ØÅ‡ÆÆ‡Øç ‡Æ§‡Æµ‡Æø‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç / Also skip YouTube ID
                        const historyParts = [];
                        if (typeof msgData.text === 'string') {
                            historyParts.push({ text: msgData.text });
                        }
                        if (historyParts.length > 0) {
                             currentChatHistory.push({ role: role, parts: historyParts });
                        }
                        // ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡Æø‡ÆØ‡Øà ‡ÆÆ‡ØÅ‡Æ¥‡ØÅ ‡Æ§‡Æ∞‡Æµ‡ØÅ‡Æü‡Æ©‡Øç ‡Æï‡Ææ‡Æ£‡Øç‡Æ™‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç (‡Æ™‡Æü‡ÆÆ‡Øç, ‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã, ‡ÆØ‡ØÇ‡Æü‡Æø‡ÆØ‡ØÇ‡Æ™‡Øç) / Display message with full data (image, audio, youtube)
                        displayMessage(msgData.text || "", role, [], null, msgData);
                    });
                 }
                scrollToBottom(true); setLoadingState(false); userInput.placeholder = "Enter prompt, paste URL, or attach file"; if (!isTestMode && !isReviewMode) userInput.focus();
            }, error => { /* Handle error */ console.error(`Error listening messages chat ${chatId}:`, error); displayError("Could not load messages."); removeMessageElement(loadingMsg); chatArea.innerHTML = ''; currentChatHistory = []; setLoadingState(false); userInput.placeholder = "Error loading chat"; });
        }

        // --- Message Sending (Gemini API & Firestore Save) ---
        // ‡Æá‡Æ§‡ØÅ ‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã‡Æµ‡Øà ‡ÆÖ‡Æ©‡ØÅ‡Æ™‡Øç‡Æ™ ‡Æ™‡ØÅ‡Æ§‡ØÅ‡Æ™‡Øç‡Æ™‡Æø‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡ØÅ‡Æ≥‡Øç‡Æ≥‡Æ§‡ØÅ / Updated to send audio
        async function handleSendMessage() {
            const userMessageTextRaw = userInput.value.trim();
            // ‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü ‡Æ™‡Æü‡ÆÆ‡Øç ‡ÆÖ‡Æ≤‡Øç‡Æ≤‡Æ§‡ØÅ ‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã‡Æµ‡Øà ‡Æ®‡Æï‡Æ≤‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç / Copy selected image or audio
            const imageToSend = selectedImageData.base64 ? { ...selectedImageData } : null;
            const audioToSend = selectedAudioData.base64 ? { ...selectedAudioData } : null;

            if (!API_KEY) { displayError("API Key not set."); return; }
            if (!currentUser) { displayError("Please log in."); return; }
            if (!activeChatId) { displayError("Please select/create a chat."); return; }
            // ‡Æâ‡Æ∞‡Øà, ‡Æ™‡Æü‡ÆÆ‡Øç ‡ÆÖ‡Æ≤‡Øç‡Æ≤‡Æ§‡ØÅ ‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã ‡Æá‡Æ∞‡ØÅ‡Æï‡Øç‡Æï ‡Æµ‡Øá‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç / Must have text, image, OR audio
            if (!userMessageTextRaw && !imageToSend && !audioToSend) {
                console.log("Nothing to send."); return;
            }
            if (sendButton.disabled) return;

            const isMCQRequest = mcqModeCheckbox.checked;
            setLoadingState(true, "Sending...");

            // ‡Æâ‡Æ≥‡Øç‡Æ≥‡ØÄ‡Æü‡Øç‡Æü‡Øà ‡ÆÖ‡Æ¥‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç *‡ÆÆ‡Æ§‡Æø‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øà ‡Æ®‡Æï‡Æ≤‡ØÜ‡Æü‡ØÅ‡Æ§‡Øç‡Æ§ ‡Æ™‡Æø‡Æ±‡Æï‡ØÅ* / Clear input *after* copying values
            userInput.value = '';
            autoGrowTextarea();
            if (isMCQRequest) mcqModeCheckbox.checked = false;
            removeSelectedImage(); // ‡Æ™‡Øç‡Æ∞‡Æø‡Æµ‡Æø‡ÆØ‡ØÇ & ‡Æ®‡Æø‡Æ≤‡Øà‡ÆØ‡Øà ‡ÆÖ‡Æ¥‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç / Clear preview & state
            removeSelectedAudio(); // ‡Æ™‡Øç‡Æ∞‡Æø‡Æµ‡Æø‡ÆØ‡ØÇ & ‡Æ®‡Æø‡Æ≤‡Øà‡ÆØ‡Øà ‡ÆÖ‡Æ¥‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç / Clear preview & state

            const timestamp = firebase.firestore.FieldValue.serverTimestamp();
            const messagesColRef = db.collection('chats').doc(activeChatId).collection('messages');
            const chatDocRef = db.collection('chats').doc(activeChatId);

            let isFirstUserMessageInNewChat = false;
            let potentialTestTitle = null;

            // --- YouTube URL ‡Æê‡Æï‡Øç ‡Æï‡Øà‡ÆØ‡Ææ‡Æ≥‡ØÅ‡Æ§‡Æ≤‡Øç (‡ÆÆ‡Ææ‡Æ±‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà) / Handle YouTube URL (Unchanged) ---
            const youtubeMatch = userMessageTextRaw.match(youtubeRegex);
            const youtubeUrl = youtubeMatch ? youtubeMatch[0] : null;
            const youtubeVideoId = youtubeMatch ? youtubeMatch[1] : null;
            if (youtubeUrl) { console.log("Detected YouTube URL:", youtubeUrl, "ID:", youtubeVideoId); }

             // --- ‡Æ™‡ÆØ‡Æ©‡Æ∞‡Øç ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡Æø‡ÆØ‡Øà Firestore ‡Æï‡Øç‡Æï‡Ææ‡Æï ‡Æ§‡ÆØ‡Ææ‡Æ∞‡Øç ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡Æµ‡ØÅ‡ÆÆ‡Øç / Prepare User Message Data for Firestore ---
             // ‡ÆÆ‡ØÇ‡Æ≤ ‡Æâ‡Æ∞‡Øà, ‡Æ™‡Æü‡Æ§‡Øç ‡Æ§‡Æ∞‡Æµ‡ØÅ (‡Æá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡Ææ‡Æ≤‡Øç), ‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã ‡Æ§‡Æ∞‡Æµ‡ØÅ (‡Æá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡Ææ‡Æ≤‡Øç), YT ID (‡Æá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡Ææ‡Æ≤‡Øç) ‡Æö‡Øá‡ÆÆ‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç
             // Store raw text, image data (if any), audio data (if any), YT ID (if any)
             const userMsgData = {
                 role: "user",
                 text: userMessageTextRaw, // ‡Æï‡Ææ‡Æü‡Øç‡Æö‡Æø ‡Æµ‡Æ∞‡Æ≤‡Ææ‡Æ±‡Øç‡Æ±‡ØÅ‡Æï‡Øç‡Æï‡Ææ‡Æï ‡ÆÆ‡ØÇ‡Æ≤ ‡Æâ‡Æ∞‡Øà‡ÆØ‡Øà ‡Æµ‡Øà‡Æ§‡Øç‡Æ§‡Æø‡Æ∞‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç / Keep raw text for display history
                 timestamp: timestamp,
                 ...(youtubeVideoId && { youtubeVideoId: youtubeVideoId }), // ‡Æâ‡Æü‡Øç‡Æ™‡Øä‡Æ§‡Æø‡Æï‡Øç‡Æï / For embedding
                 ...(imageToSend && { imageData: imageToSend.base64, imageMimeType: imageToSend.mimeType }), // ‡Æï‡Ææ‡Æü‡Øç‡Æö‡Æø ‡Æµ‡Æ∞‡Æ≤‡Ææ‡Æ±‡Øç‡Æ±‡ØÅ‡Æï‡Øç‡Æï‡Ææ‡Æï / For display history
                 ...(audioToSend && { // ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ‡Æ§‡ØÅ: ‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã ‡Æ§‡Æ∞‡Æµ‡ØÅ / New: Audio data
                        audioData: audioToSend.base64, // Data URL
                        audioMimeType: audioToSend.mimeType,
                        audioSource: audioToSend.source // 'upload' or 'record'
                    })
             };
             // Base64 ‡Æê ‡ÆÆ‡Æ±‡Øà‡Æ§‡Øç‡Æ§‡ØÅ ‡Æ™‡Æ§‡Æø‡Æµ‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡Æµ‡ØÅ‡ÆÆ‡Øç / Log with Base64 hidden
             console.log("Saving to Firestore:", {
                    ...userMsgData,
                    imageData: imageToSend ? "Base64 Hidden" : null,
                    audioData: audioToSend ? "Base64 Hidden" : null
             });

             // --- ‡Æ™‡ÆØ‡Æ©‡Æ∞‡Øç ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡Æø‡ÆØ‡Øà Firestore ‡Æá‡Æ≤‡Øç ‡Æö‡Øá‡ÆÆ‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç / Save User Message to Firestore ---
             try {
                 const chatSnap = await chatDocRef.get();
                 if (chatSnap.exists && chatSnap.data().title === NEW_CHAT_TITLE) {
                     const messagesSnap = await messagesColRef.limit(1).get();
                     if (messagesSnap.empty) { isFirstUserMessageInNewChat = true; }
                 }
                 await messagesColRef.add(userMsgData);
                 await chatDocRef.update({ lastUpdated: timestamp });
                 console.log("User message saved to Firestore.");
                 if (isFirstUserMessageInNewChat) { // ‡Æ§‡Æ≤‡Øà‡Æ™‡Øç‡Æ™‡ØÅ ‡Æâ‡Æ∞‡ØÅ‡Æµ‡Ææ‡Æï‡Øç‡Æï‡ØÅ‡ÆÆ‡Øç ‡Æ§‡Æ∞‡Øç‡Æï‡Øç‡Æï‡ÆÆ‡Øç ‡ÆÆ‡Ææ‡Æ±‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà / Title generation logic unchanged
                    const titleTextSource = userMessageTextRaw || (imageToSend ? "Image Upload" : (audioToSend ? "Audio Upload" : NEW_CHAT_TITLE)) || "New Chat";
                    const generatedTitle = generateChatTitle(titleTextSource);
                    if (generatedTitle && generatedTitle !== NEW_CHAT_TITLE) { await updateActiveChatTitle(generatedTitle); console.log("Chat title updated:", generatedTitle); }
                 }
             } catch(error) {
                 console.error("Error saving user message:", error); displayError("Failed to send message."); setLoadingState(false); return;
             }

             // "‡Æö‡Æø‡Æ®‡Øç‡Æ§‡Æø‡Æï‡Øç‡Æï‡Æø‡Æ±‡Æ§‡ØÅ..." ‡Æï‡Ææ‡Æ£‡Øç‡Æ™‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç / Display "Thinking..."
            const thinking = displayMessage("Thinking...", 'ai', ['thinking']);
            scrollToBottom();

            // --- ‡Æ§‡Æ±‡Øç‡Æ™‡Øã‡Æ§‡Øà‡ÆØ API ‡ÆÖ‡Æ¥‡Øà‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Øç‡Æï‡Ææ‡Æ© ‡Æ™‡Æï‡ØÅ‡Æ§‡Æø‡Æï‡Æ≥‡Øà‡Æ§‡Øç ‡Æ§‡ÆØ‡Ææ‡Æ∞‡Øç ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡Æµ‡ØÅ‡ÆÆ‡Øç / Prepare Parts for CURRENT API Call ---
            const currentUserPartsForAPI = [];
            let userTextForPrompt = userMessageTextRaw; // ‡ÆÆ‡ØÇ‡Æ≤ ‡Æâ‡Æ∞‡Øà‡ÆØ‡ØÅ‡Æü‡Æ©‡Øç ‡Æ§‡Øä‡Æü‡Æô‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç / Start with raw text

            // MCQ ‡Æï‡Øã‡Æ∞‡Æø‡Æï‡Øç‡Æï‡Øà ‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡Æ§‡Øç‡Æ§‡Øà‡Æï‡Øç ‡Æï‡Øà‡ÆØ‡Ææ‡Æ≥‡Æµ‡ØÅ‡ÆÆ‡Øç (‡ÆÆ‡Ææ‡Æ±‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà) / Handle MCQ Prompt Modification (Unchanged)
            if (isMCQRequest) {
                 if (!userMessageTextRaw && !imageToSend && !audioToSend) { // ‡Æâ‡Æ∞‡Øà, ‡Æ™‡Æü‡ÆÆ‡Øç ‡ÆÖ‡Æ≤‡Øç‡Æ≤‡Æ§‡ØÅ ‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã ‡Æá‡Æ≤‡Øç‡Æ≤‡Ææ‡ÆÆ‡Æ≤‡Øç MCQ ‡Æá‡Æ≤‡Øç‡Æ≤‡Øà / No MCQ without text, image or audio
                     displayError("Cannot generate MCQs without a prompt (text, image, or audio).");
                     removeMessageElement(thinking); setLoadingState(false); return;
                 }
                 // ‡Æ§‡Æ≤‡Øà‡Æ™‡Øç‡Æ™‡Øà ‡Æâ‡Æ∞‡ØÅ‡Æµ‡Ææ‡Æï‡Øç‡Æï MCQ ‡ÆÖ‡Æ≤‡Øç‡Æ≤‡Ææ‡Æ§ ‡Æâ‡Æ≥‡Øç‡Æ≥‡Æü‡Æï‡Øç‡Æï‡Æ§‡Øç‡Æ§‡Øà‡Æ™‡Øç ‡Æ™‡ÆØ‡Æ©‡Øç‡Æ™‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡Æµ‡ØÅ‡ÆÆ‡Øç / Use non-MCQ content for title
                 const titleSourceForMCQ = userMessageTextRaw || (imageToSend ? "Image based MCQs" : (audioToSend ? "Audio based MCQs" : "Generated Test"));
                 potentialTestTitle = generateChatTitle(titleSourceForMCQ);
                 potentialTestTitle = (potentialTestTitle === NEW_CHAT_TITLE || !potentialTestTitle) ? "Generated Test" : potentialTestTitle;
                 potentialTestTitle += ` (${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })})`;

                 // MCQ ‡Æï‡Øã‡Æ∞‡Æø‡Æï‡Øç‡Æï‡Øà‡ÆØ‡Øà ‡Æ™‡ÆØ‡Æ©‡Æ∞‡Æø‡Æ©‡Øç ‡Æâ‡Æ∞‡Øà‡ÆØ‡ØÅ‡Æü‡Æ©‡Øç ‡Æö‡Øá‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç (‡ÆÖ‡Æ≤‡Øç‡Æ≤‡Æ§‡ØÅ ‡Æ§‡Æ©‡Æø‡ÆØ‡Ææ‡Æï) / Append MCQ request to user's text (or stand-alone)
                 const mcqInstruction = `\n\nPlease generate multiple choice questions based on the preceding content (text, image, or audio). Provide the response *only* as a valid JSON array string, enclosed within \`\`\`json ... \`\`\`.
Each object in the array must have these exact keys:
1.  "question": An object with "en" (English question) and "ta" (Tamil question) string properties.
2.  "options": An array of 4 objects. Each object must have "en" (English option) and "ta" (Tamil option) string properties.
3.  "answer": A string representing the correct option letter ('A', 'B', 'C', or 'D'). This should NOT be bilingual.
4.  "explanation": An object with "en" (English explanation) and "ta" (Tamil explanation) string properties.
Provide accurate Tamil translations. Do not include any text outside the JSON structure.`;

                if (userTextForPrompt) {
                    userTextForPrompt += mcqInstruction;
                } else {
                    // ‡Æ™‡Æü‡ÆÆ‡Øç/‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã ‡ÆÆ‡Æü‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡Æá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡Ææ‡Æ≤‡Øç, ‡ÆÖ‡Æ±‡Æø‡Æµ‡ØÅ‡Æ±‡ØÅ‡Æ§‡Øç‡Æ§‡Æ≤‡Øç ‡ÆÆ‡Æü‡Øç‡Æü‡ØÅ‡ÆÆ‡Øá ‡Æ™‡Æï‡ØÅ‡Æ§‡Æø‡ÆØ‡Ææ‡Æï ‡ÆÆ‡Ææ‡Æ±‡ØÅ‡ÆÆ‡Øç / If only image/audio, instruction becomes the only text part
                    userTextForPrompt = mcqInstruction.trim();
                }
                 console.log("MCQ mode: Modified/Set text prompt for API, title:", potentialTestTitle);
             }

             // ‡Æâ‡Æ∞‡Øà ‡Æ™‡Æï‡ØÅ‡Æ§‡Æø‡ÆØ‡Øà‡Æö‡Øç ‡Æö‡Øá‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç (‡Æâ‡Æ∞‡Øà ‡Æá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡Ææ‡Æ≤‡Øç) / Add Text Part (if text exists)
             if (userTextForPrompt) {
                 currentUserPartsForAPI.push({ text: userTextForPrompt });
             }

             // ‡Æ™‡Æü‡Æ™‡Øç ‡Æ™‡Æï‡ØÅ‡Æ§‡Æø‡ÆØ‡Øà‡Æö‡Øç ‡Æö‡Øá‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç (‡Æá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡Ææ‡Æ≤‡Øç) / Add Image Part (if exists)
             if (imageToSend) {
                 // Base64 ‡Æ§‡Æ∞‡Æµ‡Øà ‡ÆÆ‡Æü‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡Æ™‡Æø‡Æ∞‡Æø‡Æ§‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç (data:mime/type;base64, ‡Æê ‡ÆÖ‡Æï‡Æ±‡Øç‡Æ±‡Æµ‡ØÅ‡ÆÆ‡Øç) / Extract Base64 data only (remove data:mime/type;base64,)
                 const base64DataOnly = imageToSend.base64.substring(imageToSend.base64.indexOf(',') + 1);
                 currentUserPartsForAPI.push({ inlineData: { mimeType: imageToSend.mimeType, data: base64DataOnly } });
                 console.log(`Preparing image for API: ${imageToSend.mimeType}`);
             }

             // ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ‡Æ§‡ØÅ: ‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã ‡Æ™‡Æï‡ØÅ‡Æ§‡Æø‡ÆØ‡Øà‡Æö‡Øç ‡Æö‡Øá‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç (‡Æá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡Ææ‡Æ≤‡Øç) / New: Add Audio Part (if exists)
             if (audioToSend) {
                 // Base64 ‡Æ§‡Æ∞‡Æµ‡Øà ‡ÆÆ‡Æü‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡Æ™‡Æø‡Æ∞‡Æø‡Æ§‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç / Extract Base64 data only
                 const base64DataOnly = audioToSend.base64.substring(audioToSend.base64.indexOf(',') + 1);
                 currentUserPartsForAPI.push({ inlineData: { mimeType: audioToSend.mimeType, data: base64DataOnly } });
                 console.log(`Preparing audio for API: ${audioToSend.mimeType}, Source: ${audioToSend.source}`);
             }

             // YouTube ‡Æµ‡ØÄ‡Æü‡Æø‡ÆØ‡Øã ‡Æ™‡Æï‡ØÅ‡Æ§‡Æø‡ÆØ‡Øà‡Æö‡Øç ‡Æö‡Øá‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç (‡Æá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡Ææ‡Æ≤‡Øç - ‡ÆÆ‡Ææ‡Æ±‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà) / Add YouTube Video Part (if exists - unchanged)
             if (youtubeUrl) {
                 // Gemini 1.5 Pro supports fileData with youtube URI
                 currentUserPartsForAPI.push({ fileData: { mimeType: "video/youtube", fileUri: youtubeUrl } });
                 console.log(`Preparing YouTube URI for API: ${youtubeUrl}`);
             }

             // --- API ‡Æï‡Øç‡Æï‡Ææ‡Æï ‡Æµ‡Æ∞‡Æ≤‡Ææ‡Æ±‡Øç‡Æ±‡Øà‡Æ§‡Øç ‡Æ§‡ÆØ‡Ææ‡Æ∞‡Øç ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡Æµ‡ØÅ‡ÆÆ‡Øç (‡Æâ‡Æ∞‡Øà ‡ÆÆ‡Æü‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç - ‡ÆÆ‡Ææ‡Æ±‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà) / Prepare History for API (Text Only - unchanged) ---
             const apiHistoryForCall = currentChatHistory.map(msg => ({
                 role: msg.role,
                 parts: msg.parts.filter(part => part.text) // ‡Æâ‡Æ∞‡Øà ‡Æ™‡Æï‡ØÅ‡Æ§‡Æø‡Æï‡Øç‡Æï‡ØÅ ‡Æ™‡Ææ‡Æ§‡ØÅ‡Æï‡Ææ‡Æ™‡Øç‡Æ™‡ØÅ ‡Æö‡Øã‡Æ§‡Æ©‡Øà / Safety check for text part
             })).filter(msg => msg.parts.length > 0); // ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡Æø‡Æï‡Øç‡Æï‡ØÅ ‡Æ™‡Æï‡ØÅ‡Æ§‡Æø‡Æï‡Æ≥‡Øç ‡Æá‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡Æ§‡Øà ‡Æâ‡Æ±‡ØÅ‡Æ§‡Æø‡Æö‡ØÜ‡ÆØ‡Øç‡Æï / Ensure message has parts

             // --- ‡Æµ‡Æ∞‡Æ≤‡Ææ‡Æ±‡ØÅ + ‡Æ§‡Æ±‡Øç‡Æ™‡Øã‡Æ§‡Øà‡ÆØ ‡Æ™‡Æï‡ØÅ‡Æ§‡Æø‡Æï‡Æ≥‡Øà API ‡Æï‡Øç‡Æï‡Ææ‡Æï ‡Æá‡Æ£‡Øà‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç / Combine History + Current Parts for API ---
             const finalContentsForAPI = [...apiHistoryForCall];
             if (currentUserPartsForAPI.length > 0) {
                  finalContentsForAPI.push({ role: "user", parts: currentUserPartsForAPI });
             } else {
                 // ‡Æá‡Æ§‡ØÅ ‡Æ®‡Æü‡Æï‡Øç‡Æï‡Æï‡Øç‡Æï‡ØÇ‡Æü‡Ææ‡Æ§‡ØÅ, ‡Æè‡Æ©‡ØÜ‡Æ©‡Æø‡Æ≤‡Øç ‡Æ®‡Ææ‡ÆÆ‡Øç ‡ÆÆ‡ØÅ‡Æ©‡Øç‡Æ™‡Øá ‡Æö‡Æ∞‡Æø‡Æ™‡Ææ‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æø‡Æ±‡Øã‡ÆÆ‡Øç / Should not happen as we check earlier
                 console.warn("No valid parts generated for the current user message.");
                 removeMessageElement(thinking); setLoadingState(false); return;
             }

             console.warn("Calling Gemini API (Model:", MODEL_NAME, ") with multimodal input:", finalContentsForAPI.map(c => ({ role: c.role, parts: c.parts.map(p => p.text ? 'text' : (p.inlineData ? `inline ${p.inlineData.mimeType}` : (p.fileData ? `file ${p.fileData.fileUri}` : 'unknown'))) })));

             // --- Gemini API ‡Æê ‡ÆÖ‡Æ¥‡Øà‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç / Call Gemini API ---
             try {
                 const response = await fetch(API_URL_BASE + API_KEY, {
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify({
                         contents: finalContentsForAPI,
                         safetySettings: [ // ‡Æ™‡Ææ‡Æ§‡ØÅ‡Æï‡Ææ‡Æ™‡Øç‡Æ™‡ØÅ ‡ÆÖ‡ÆÆ‡Øà‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øç ‡ÆÆ‡Ææ‡Æ±‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà / Safety settings unchanged
                            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                         ]
                     }),
                 });

                 removeMessageElement(thinking);

                 // --- API ‡Æ™‡Æ§‡Æø‡Æ≤‡Øà‡Æö‡Øç ‡Æö‡ØÜ‡ÆØ‡Æ≤‡Ææ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç / Process API Response ---
                 // ‡Æá‡Æ®‡Øç‡Æ§ ‡Æ§‡Æ∞‡Øç‡Æï‡Øç‡Æï‡ÆÆ‡Øç ‡Æ™‡ØÜ‡Æ∞‡ØÅ‡ÆÆ‡Øç‡Æ™‡Ææ‡Æ≤‡ØÅ‡ÆÆ‡Øç ‡ÆÆ‡Ææ‡Æ±‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà, ‡ÆÜ‡Æ©‡Ææ‡Æ≤‡Øç ‡Æ™‡Æø‡Æ¥‡Øà ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡Æø‡Æï‡Æ≥‡Øç ‡Æá‡Æ©‡Øç‡Æ©‡ØÅ‡ÆÆ‡Øç ‡Æ§‡ØÜ‡Æ≥‡Æø‡Æµ‡Ææ‡Æï ‡Æá‡Æ∞‡ØÅ‡Æï‡Øç‡Æï‡Æ≤‡Ææ‡ÆÆ‡Øç / This logic is largely unchanged, error messages might be clearer
                 let aiMsgData = { role: "model", text: "Error: No valid response.", timestamp: firebase.firestore.FieldValue.serverTimestamp(), mcqData: null, mcqTitle: null };
                 let displayAsError = true;

                 if (!response.ok) { // ‡Æ™‡Æø‡Æ¥‡Øà ‡Æï‡Øà‡ÆØ‡Ææ‡Æ≥‡ØÅ‡Æ§‡Æ≤‡Øç ‡ÆÆ‡Ææ‡Æ±‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà / Error handling unchanged
                     let errorDetails = `API error (${response.status})`; try { const errorJson = await response.json(); errorDetails = errorJson.error?.message || errorDetails; } catch {} console.error("API Error:", response.status, errorDetails); aiMsgData.text = `Error: ${errorDetails}`; if (response.status === 400 && errorDetails.toLowerCase().includes('api key not valid')) { localStorage.removeItem(STORAGE_KEY_API_KEY); API_KEY=''; aiMsgData.text += " Invalid API Key cleared. Reload page."; }
                 } else {
                     const data = await response.json();
                     console.log("API Response Data:", data);
                     let rawAiText = ""; let blocked = false; displayAsError = false;

                     // ‡Æ™‡Ææ‡Æ§‡ØÅ‡Æï‡Ææ‡Æ™‡Øç‡Æ™‡ØÅ‡Æ§‡Øç ‡Æ§‡Æü‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øà‡Æö‡Øç ‡Æö‡Æ∞‡Æø‡Æ™‡Ææ‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç (‡ÆÆ‡Ææ‡Æ±‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà) / Check safety blocks (unchanged)
                     if (data.promptFeedback?.blockReason) { aiMsgData.text = `Blocked (Prompt): ${data.promptFeedback.blockReason}`; blocked = true; displayAsError = true; console.warn("Prompt blocked:", data.promptFeedback.blockReason); }
                     else if (data.candidates?.[0]?.finishReason === 'SAFETY') { aiMsgData.text = `Blocked (Response Safety)`; blocked = true; displayAsError = true; console.warn("Response blocked due to safety."); }
                     else if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
                         // ‡Æö‡Æ∞‡Æø‡ÆØ‡Ææ‡Æ© ‡Æâ‡Æ∞‡Øà ‡Æ™‡Æ§‡Æø‡Æ≤‡Øç ‡Æ™‡ØÜ‡Æ±‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ / Valid text response received
                         rawAiText = data.candidates[0].content.parts.map(part => part.text || '').join('');
                         aiMsgData.text = rawAiText;
                         displayAsError = false;

                         // ‡Æï‡Øã‡Æ∞‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Ææ‡Æ≤‡Øç MCQ ‡Æê ‡ÆÖ‡Æ≤‡Æö‡Æµ‡ØÅ‡ÆÆ‡Øç (‡ÆÆ‡Ææ‡Æ±‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà) / Parse MCQ if requested (unchanged)
                         if (isMCQRequest && !blocked) {
                             console.log("Attempting to parse MCQ JSON...");
                             try { /* ... (MCQ Parsing Logic - same as v9.3) ... */
                                  const jsonMatch = rawAiText.match(/```json\s*([\s\S]*?)\s*```/); const jsonString = jsonMatch ? jsonMatch[1].trim() : rawAiText.trim();
                                  if (jsonString.startsWith('[') && jsonString.endsWith(']')) {
                                      const mcqs = JSON.parse(jsonString); const isValidMCQArray = Array.isArray(mcqs) && mcqs.length > 0 && mcqs.every(q => q && q.question && typeof q.question.en === 'string' && typeof q.question.ta === 'string' && Array.isArray(q.options) && q.options.length === 4 && q.options.every(opt => opt && typeof opt.en === 'string' && typeof opt.ta === 'string') && typeof q.answer === 'string' && ['A','B','C','D'].includes(q.answer.toUpperCase()) && q.explanation && typeof q.explanation.en === 'string' && typeof q.explanation.ta === 'string');
                                      if (isValidMCQArray) { const summaryText = `Generated ${mcqs.length} MCQs.`; aiMsgData.text = summaryText; aiMsgData.mcqData = mcqs; aiMsgData.mcqTitle = potentialTestTitle; console.log("MCQs parsed successfully:", mcqs.length); displayAsError = false; }
                                      else { console.warn("MCQ JSON validation failed."); aiMsgData.text = "MCQ format error.\n\n" + rawAiText; displayAsError = true; aiMsgData.mcqData = null; aiMsgData.mcqTitle = null; }
                                  } else { console.warn("MCQ response not JSON array."); aiMsgData.text = "Expected MCQ JSON format error.\n\n" + rawAiText; displayAsError = true; aiMsgData.mcqData = null; aiMsgData.mcqTitle = null; }
                              } catch (parseError) { console.error("Failed to parse MCQ JSON:", parseError); aiMsgData.text = "Error parsing MCQ JSON.\n\n" + rawAiText; displayAsError = true; aiMsgData.mcqData = null; aiMsgData.mcqTitle = null; }
                         } // MCQ ‡ÆÖ‡Æ≤‡Æö‡Æ≤‡Øç ‡ÆÆ‡ØÅ‡Æü‡Æø‡Æµ‡ØÅ / End MCQ parsing

                     } else if (data.candidates?.[0]?.finishReason === 'STOP') {
                         // ‡ÆÆ‡Ææ‡Æ§‡Æø‡Æ∞‡Æø ‡ÆÆ‡ØÅ‡Æü‡Æø‡Æ®‡Øç‡Æ§‡Æ§‡ØÅ, ‡ÆÜ‡Æ©‡Ææ‡Æ≤‡Øç ‡Æâ‡Æ∞‡Øà ‡Æ™‡Æï‡ØÅ‡Æ§‡Æø ‡Æá‡Æ≤‡Øç‡Æ≤‡Øà / Model finished, but maybe no text part
                         console.warn("API response finished with STOP but no text part found.");
                         aiMsgData.text = "(Model response finished without text)";
                         displayAsError = false; // ‡Æ™‡Æø‡Æ¥‡Øà‡ÆØ‡Ææ‡Æï‡Æï‡Øç ‡Æï‡Æ∞‡ØÅ‡Æ§ ‡Æµ‡Øá‡Æ£‡Øç‡Æü‡Ææ‡ÆÆ‡Øç / Don't treat as error
                     }
                      else { // ‡Æµ‡Øá‡Æ±‡ØÅ ‡Æï‡Ææ‡Æ∞‡Æ£‡Æô‡Øç‡Æï‡Æ≥‡Øç / Other reasons
                         console.warn("Unexpected API response format or finish reason:", data.candidates?.[0]?.finishReason, data);
                         aiMsgData.text = `Sorry, received an unexpected response. (Reason: ${data.candidates?.[0]?.finishReason || 'Unknown'})`;
                         displayAsError = true;
                     }
                 }

                 // --- AI ‡Æ™‡Æ§‡Æø‡Æ≤‡Øà Firestore ‡Æá‡Æ≤‡Øç ‡Æö‡Øá‡ÆÆ‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç / Save AI Response to Firestore ---
                 try {
                      // MCQ ‡ÆÖ‡Æ≤‡Øç‡Æ≤‡Ææ‡Æ§ ‡Æ§‡Æ∞‡Æµ‡Øà ‡Æö‡Øá‡ÆÆ‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç / Save non-MCQ data
                      const aiResponseToSave = { ...aiMsgData };
                      // mcqData ‡Æ™‡ØÜ‡Æ∞‡Æø‡ÆØ‡Æ§‡Ææ‡Æï ‡Æá‡Æ∞‡ØÅ‡Æï‡Øç‡Æï‡Æ≤‡Ææ‡ÆÆ‡Øç, ‡Æ§‡Øá‡Æµ‡Øà‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Ææ‡Æ≤‡Øç ‡ÆÆ‡Æü‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡Æö‡Øá‡ÆÆ‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç / mcqData can be large, save only if needed/separate doc?
                      // ‡Æá‡Æ™‡Øç‡Æ™‡Øã‡Æ§‡ØÅ ‡Æ®‡Ææ‡ÆÆ‡Øç ‡ÆÖ‡Æ§‡Øà ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡Æø‡ÆØ‡ØÅ‡Æü‡Æ©‡Øç ‡Æö‡Øá‡ÆÆ‡Æø‡Æï‡Øç‡Æï‡Æø‡Æ±‡Øã‡ÆÆ‡Øç / For now we save it with the message
                      await messagesColRef.add(aiResponseToSave);
                      await chatDocRef.update({ lastUpdated: firebase.firestore.FieldValue.serverTimestamp() });
                      console.log("AI response/error saved to Firestore.");
                 } catch (saveError) {
                      console.error("Error saving AI response:", saveError); displayError(`Failed to save response: ${aiMsgData.text}`);
                 }

             } catch (fetchError) { // ‡Æ®‡ØÜ‡Æü‡Øç‡Æµ‡Øä‡Æ∞‡Øç‡Æï‡Øç ‡Æ™‡Æø‡Æ¥‡Øà‡Æï‡Æ≥‡Øç / Network errors
                 console.error("API Fetch Error:", fetchError); removeMessageElement(thinking); const errorText = `API Error: ${fetchError.message || "Network issue."}`; displayError(errorText);
                 try { await messagesColRef.add({ role: "model", text: errorText, timestamp: firebase.firestore.FieldValue.serverTimestamp() }); await chatDocRef.update({ lastUpdated: firebase.firestore.FieldValue.serverTimestamp() }); } catch (saveError) { console.error("Failed to save fetch error:", saveError); }
             } finally {
                 setLoadingState(false); if (!isTestMode && !isReviewMode && activeChatId) { userInput.focus(); }
             }
        } // handleSendMessage ‡Æá‡Æ©‡Øç ‡ÆÆ‡ØÅ‡Æü‡Æø‡Æµ‡ØÅ / End of handleSendMessage

        // --- Chat Title Generation/Update ---
        // ‡Æá‡Æ®‡Øç‡Æ§‡Æ™‡Øç ‡Æ™‡Æï‡ØÅ‡Æ§‡Æø ‡ÆÆ‡Ææ‡Æ±‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà / This part is unchanged
        function generateChatTitle(sourceText) { /* ... (same as v9.2) ... */ if (!sourceText || typeof sourceText !== 'string') return NEW_CHAT_TITLE; const text = sourceText.trim(); if (!text) return NEW_CHAT_TITLE; const title = text.split(/\s+/).slice(0, 5).join(' ').replace(/[.,!?;:]+$/, ''); return title.length > 35 ? title.substring(0, 32) + '...' : title; }
        async function updateActiveChatTitle(newTitle) { /* ... (same as v9.2) ... */ if (!currentUser || !activeChatId || !newTitle || typeof newTitle !== 'string' || !newTitle.trim() || newTitle.trim() === NEW_CHAT_TITLE) return; const finalTitle = newTitle.trim(); const chatDocRef = db.collection('chats').doc(activeChatId); try { await chatDocRef.update({ title: finalTitle }); console.log(`Chat ${activeChatId} title updated: "${finalTitle}"`); } catch (error) { console.error("Error updating chat title:", error); } }


        // --- UI & Message Display Helpers ---
        // ‡Æá‡Æ®‡Øç‡Æ§‡Æ™‡Øç ‡Æ™‡Æï‡ØÅ‡Æ§‡Æø ‡Æ™‡ØÜ‡Æ∞‡ØÅ‡ÆÆ‡Øç‡Æ™‡Ææ‡Æ≤‡ØÅ‡ÆÆ‡Øç ‡ÆÆ‡Ææ‡Æ±‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà, ‡ÆÜ‡Æ©‡Ææ‡Æ≤‡Øç displayMessage ‡Æá‡Æ™‡Øç‡Æ™‡Øã‡Æ§‡ØÅ ‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã‡Æµ‡Øà‡Æï‡Øç ‡Æï‡Øà‡ÆØ‡Ææ‡Æ≥‡ØÅ‡ÆÆ‡Øç / Mostly unchanged, but displayMessage now handles audio
        function autoGrowTextarea() { /* ... (same as v9.3) ... */ userInput.style.height='auto'; userInput.style.height=(userInput.scrollHeight)+'px'; }
        function handleInputKeydown(event) { /* ... (same as v9.3) ... */ if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();handleSendMessage();} }
        function handleSuggestionClick(event) { /* ... (same as v9.3) ... */ if(event.target.classList.contains('suggestion-chip')){userInput.value=event.target.dataset.prompt||'';autoGrowTextarea();userInput.focus();} }
        function displayError(text) { /* ... (same as v9.3) ... */ console.error("Displaying Error:", text); displayMessage(`Error: ${text}`, 'ai', ['error-message']); scrollToBottom(); }
        function scrollToBottom(immediate = false) { /* ... (same as v9.3) ... */ chatArea.scrollTo({top:chatArea.scrollHeight,behavior:immediate?'auto':'smooth'}); }
        function removeMessageElement(element) { /* ... (same as v9.3) ... */ if(element && element.parentNode === chatArea) { chatArea.removeChild(element); } }

        // setLoadingState ‡Æá‡Æ™‡Øç‡Æ™‡Øã‡Æ§‡ØÅ ‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã ‡Æ™‡Æü‡Øç‡Æü‡Æ©‡Øç‡Æï‡Æ≥‡Øà‡ÆØ‡ØÅ‡ÆÆ‡Øç ‡Æï‡Øà‡ÆØ‡Ææ‡Æ≥‡ØÅ‡ÆÆ‡Øç / setLoadingState now handles audio buttons
        function setLoadingState(isLoading, message = "Generating...") {
             const isDisabledOverall = isLoading || !currentUser || !API_KEY || isRecording; // ‡Æ∞‡ØÜ‡Æï‡Øç‡Æï‡Ææ‡Æ∞‡Øç‡Æü‡Æø‡Æô‡Øç ‡Æ™‡Øã‡Æ§‡ØÅ ‡ÆÆ‡ØÅ‡Æü‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç / Disable during recording
             const isSendDisabled = isDisabledOverall || !activeChatId; // ‡Æö‡Ææ‡Æü‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡Æ™‡Øç‡Æ™‡Æü‡Ææ‡Æµ‡Æø‡Æü‡Øç‡Æü‡Ææ‡Æ≤‡Øç ‡ÆÆ‡ØÅ‡Æü‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç / Disable if no chat selected

             userInput.disabled = isDisabledOverall;
             sendButton.disabled = isSendDisabled;
             mcqModeCheckbox.disabled = isSendDisabled;
             imageUploadButton.disabled = isDisabledOverall;
             audioUploadButton.disabled = isDisabledOverall; // ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ‡Æ§‡ØÅ / New
             recordAudioButton.disabled = isLoading || !currentUser || !API_KEY; // ‡Æ∞‡ØÜ‡Æï‡Øç‡Æï‡Ææ‡Æ∞‡Øç‡Æü‡Æø‡Æô‡Øç ‡ÆÖ‡Æ≤‡Øç‡Æ≤‡Ææ‡Æ§ ‡Æ®‡Æø‡Æ≤‡Øà‡ÆØ‡Æø‡Æ≤‡Øç ‡ÆÆ‡ØÅ‡Æü‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç / Disable based on non-recording state

             // Sidebar controls
             const isControlDisabled = isLoading || !currentUser || isRecording;
             startChatButton.disabled = isControlDisabled;
             testSearchInput.disabled = isControlDisabled;
             decreaseTextBtn.disabled = isControlDisabled || (currentUser && currentTextSizeMultiplier <= MIN_TEXT_SIZE_MULTIPLIER);
             increaseTextBtn.disabled = isControlDisabled || (currentUser && currentTextSizeMultiplier >= MAX_TEXT_SIZE_MULTIPLIER);
             themeToggleButton.disabled = isControlDisabled;

             // Placeholder text
             if (isLoading) { userInput.placeholder = message; }
             else if (isRecording) { userInput.placeholder = "Recording audio..."; } // ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ‡Æ§‡ØÅ / New
             else if (!currentUser) { userInput.placeholder = "Please log in"; }
             else if (!activeChatId) { userInput.placeholder = "Select or create a chat"; }
             else if (!API_KEY) { userInput.placeholder = "API Key missing."; }
             else { userInput.placeholder = "Enter prompt, URL, or attach file"; } // ‡Æ™‡ØÅ‡Æ§‡ØÅ‡Æ™‡Øç‡Æ™‡Æø‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ / Updated
         }

        function switchView(viewName, cameFromTests = false) { /* ... (same as v9.3, ensures recording stops) ... */
            stopRecordingCleanup(); // View ‡ÆÆ‡Ææ‡Æ±‡ØÅ‡ÆÆ‡Øç‡Æ™‡Øã‡Æ§‡ØÅ ‡Æ∞‡ØÜ‡Æï‡Øç‡Æï‡Ææ‡Æ∞‡Øç‡Æü‡Æø‡Æô‡Øç‡Æï‡Øà ‡Æ®‡Æø‡Æ±‡ØÅ‡Æ§‡Øç‡Æ§‡Æµ‡ØÅ‡ÆÆ‡Øç / Stop recording when switching view
            console.log("Switching view to:", viewName); chatView.classList.remove('active'); reviewView.classList.remove('active'); testView.classList.remove('active'); appContainer.classList.remove('hidden');
            isTestMode = false; isReviewMode = false; cameFromAllTestsList = cameFromTests;
            saveReviewBtn.style.display = 'none'; exitReviewBtn.style.display = 'none';
            if(viewName==='test'){ appContainer.classList.add('hidden'); testView.classList.add('active'); isTestMode=true; }
            else if(viewName==='review'){ reviewView.classList.add('active'); isReviewMode=true; exitReviewBtn.style.display = 'inline-block'; exitReviewBtn.textContent = cameFromAllTestsList ? "Back to All Tests" : "Back to Chat"; }
            else { chatView.classList.add('active'); if (currentUser && activeChatId && API_KEY) { userInput.focus(); } }
            if (viewName !== 'test' && testTimerInterval) { clearInterval(testTimerInterval); testTimerInterval = null; }
        }

        // displayMessage ‡Æá‡Æ™‡Øç‡Æ™‡Øã‡Æ§‡ØÅ ‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã‡Æµ‡Øà‡Æï‡Øç ‡Æï‡Ææ‡Æ£‡Øç‡Æ™‡Æø‡Æï‡Øç‡Æï‡ØÅ‡ÆÆ‡Øç / displayMessage now shows audio
        function displayMessage(text, sender, cssClasses = [], appendHtml = null, messageData = null) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', `${sender}-message`);
            if (cssClasses && cssClasses.length > 0) { messageElement.classList.add(...cssClasses); }

            const messageContentContainer = document.createElement('div'); // ‡Æâ‡Æ∞‡Øà‡ÆØ‡Øà ‡Æµ‡Øà‡Æï‡Øç‡Æï / To hold text

            // ‡Æ™‡Æ§‡Æø‡Æµ‡Øá‡Æ±‡Øç‡Æ±‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü ‡Æ™‡Æü‡ÆÆ‡Øç (‡Æá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡Ææ‡Æ≤‡Øç) ‡Æï‡Ææ‡Æ£‡Øç‡Æ™‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç / Display Uploaded Image (if present)
            if (messageData?.imageData) {
                const img = document.createElement('img');
                img.src = messageData.imageData; // Base64 data URL
                img.alt = "Uploaded Image";
                img.classList.add('uploaded-image');
                img.loading = "lazy";
                messageElement.appendChild(img);
            }

            // ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ‡Æ§‡ØÅ: Firestore ‡Æá‡Æ≤‡Æø‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã‡Æµ‡Øà‡Æï‡Øç ‡Æï‡Ææ‡Æ£‡Øç‡Æ™‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç / New: Display Audio from Firestore (if present)
             if (messageData?.audioData && messageData?.audioMimeType) {
                 const audioPlayer = document.createElement('audio');
                 audioPlayer.controls = true;
                 audioPlayer.src = messageData.audioData; // Base64 data URL
                 audioPlayer.classList.add('chat-audio');
                 // audioPlayer.type = messageData.audioMimeType; // ‡Æâ‡Æ≤‡Ææ‡Æµ‡Æø‡Æï‡Æ≥‡Øç ‡Æ™‡Øä‡Æ§‡ØÅ‡Æµ‡Ææ‡Æï ‡Æï‡Æ£‡Øç‡Æü‡Æ±‡Æø‡ÆØ‡ØÅ‡ÆÆ‡Øç / Browsers usually detect
                 messageElement.appendChild(audioPlayer);
                 // ‡ÆÜ‡Æü‡Æø‡ÆØ‡Øã‡Æµ‡ØÅ‡Æï‡Øç‡Æï‡ØÅ‡Æï‡Øç ‡Æï‡ØÄ‡Æ¥‡Øá ‡Æí‡Æ∞‡ØÅ ‡Æö‡Æø‡Æ±‡Æø‡ÆØ ‡Æ≤‡Øá‡Æ™‡Æø‡Æ≥‡Øà‡Æö‡Øç ‡Æö‡Øá‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æ≤‡Ææ‡ÆÆ‡Øç / Optionally add a small label below audio
                 const audioLabel = document.createElement('div');
                 audioLabel.textContent = `(${messageData.audioSource === 'record' ? 'Recorded' : 'Uploaded'} audio: ${messageData.audioMimeType.split('/')[1]})`;
                 audioLabel.style.fontSize = '0.8em';
                 audioLabel.style.color = 'var(--text-secondary)';
                 audioLabel.style.marginTop = '3px';
                 messageElement.appendChild(audioLabel);
             }

            // ‡Æâ‡Æ∞‡Øà‡ÆØ‡Øà ‡Æµ‡Æü‡Æø‡Æµ‡ÆÆ‡Øà‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç / Format Text
            if (text) {
                const tempDiv = document.createElement('div');
                tempDiv.innerText = text; // XSS ‡Æ§‡Æü‡ØÅ‡Æï‡Øç‡Æï / Prevent XSS
                let formattedText = tempDiv.innerHTML; // HTML ‡Æï‡ØÅ‡Æ±‡Æø‡ÆØ‡ØÄ‡Æü‡ØÅ‡Æï‡Æ≥‡Øà‡Æ™‡Øç ‡Æ™‡ØÜ‡Æ± / Get HTML entities

                // ‡Æâ‡Æ∞‡Øà‡ÆØ‡Æø‡Æ≤‡Øç ‡Æâ‡Æ≥‡Øç‡Æ≥ ‡Æ™‡Æü URL ‡Æï‡Æ≥‡Øà ‡ÆÖ‡Æ≤‡Æö‡Æµ‡ØÅ‡ÆÆ‡Øç (‡Æ™‡Æ§‡Æø‡Æµ‡Øá‡Æ±‡Øç‡Æ±‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü ‡Æ™‡Æü‡ÆÆ‡Øç ‡Æá‡Æ≤‡Øç‡Æ≤‡Øà ‡Æé‡Æ©‡Øç‡Æ±‡Ææ‡Æ≤‡Øç) / Parse Image URLs in text (only if no uploaded image)
                if (!messageData?.imageData) {
                    formattedText = formattedText.replace(imageUrlRegex, (match, imgUrl) => `<img src="${imgUrl}" class="chat-image" alt="Chat Image" loading="lazy">`);
                }

                // ‡ÆÆ‡Æ±‡Øç‡Æ± ‡Æµ‡Æü‡Æø‡Æµ‡ÆÆ‡Øà‡Æ™‡Øç‡Æ™‡ØÅ (‡ÆÆ‡Ææ‡Æ±‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà) / Other formatting (unchanged)
                formattedText = formattedText.replace(/```([\s\S]*?)```/g, (match, code) => `<pre><code>${code.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</code></pre>`)
                                        .replace(/`([^`]+)`/g, (match, code) => `<code>${code.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</code>`)
                                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                        .replace(/(?<!\*)\*(?!\*)(.*?)(?<!\*)\*(?!\*)/g, '<em>$1</em>')
                                        .replace(/\n/g, '<br>');

                messageContentContainer.innerHTML = formattedText;
                messageElement.appendChild(messageContentContainer);
            }

            // YouTube ‡Æâ‡Æü‡Øç‡Æ™‡Øä‡Æ§‡Æø‡Æ™‡Øç‡Æ™‡ØÅ (‡ÆÆ‡Ææ‡Æ±‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà) / YouTube Embed (unchanged)
            if (messageData?.youtubeVideoId) {
                const youtubeEmbedDiv = document.createElement('div');
                youtubeEmbedDiv.classList.add('youtube-embed-container');
                const iframe = document.createElement('iframe');
                iframe.classList.add('chat-video');
                iframe.src = `https://www.youtube.com/embed/${messageData.youtubeVideoId}`;
                iframe.title = "YouTube video player";
                iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share";
                iframe.allowFullscreen = true;
                iframe.loading = "lazy";
                youtubeEmbedDiv.appendChild(iframe);
                messageElement.appendChild(youtubeEmbedDiv);
            }

            // MCQ ‡Æö‡Æ≤‡ØÅ‡Æï‡Øà (‡ÆÆ‡Ææ‡Æ±‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà) / MCQ Offer (unchanged)
            if (messageData?.role === 'model' && messageData?.mcqData?.length > 0) {
                displayMCQOffer(messageData.mcqData, messageData.mcqTitle, messageElement);
            }
            // ‡Æï‡ØÇ‡Æü‡ØÅ‡Æ§‡Æ≤‡Øç HTML (‡ÆÆ‡Ææ‡Æ±‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà) / Append HTML (unchanged)
            else if (appendHtml) {
                const appendDiv = document.createElement('div');
                appendDiv.innerHTML = appendHtml;
                while (appendDiv.firstChild) {
                    messageElement.appendChild(appendDiv.firstChild);
                }
            }

            chatArea.appendChild(messageElement);
            // MathJax ‡Æê ‡Æá‡ÆØ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç (‡ÆÆ‡Ææ‡Æ±‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà) / Run MathJax (unchanged)
            try { if (typeof MathJax !== "undefined" && MathJax.typesetPromise) { MathJax.typesetPromise([messageElement]).catch(err => console.error('MathJax error:', err)); } } catch (e) { console.error("MathJax call failed:", e); }
            return messageElement;
        }


        // --- MCQ/Test Specific Functions ---
        // ‡Æá‡Æ®‡Øç‡Æ§‡Æ™‡Øç ‡Æ™‡Æï‡ØÅ‡Æ§‡Æø ‡ÆÆ‡Ææ‡Æ±‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà / This part is unchanged
        function handleChatAreaClick(event) { /* ... (same as v9.3) ... */
            const startButton = event.target.closest('.start-test-button'); if (startButton) { const mcqDataString = startButton.dataset.mcq; const titleFromButton = startButton.dataset.mcqTitle; let mcqs = null; if (mcqDataString) { try { mcqs = JSON.parse(mcqDataString); } catch (e) { console.error("Failed parse MCQ:", e); displayError("Could not start test."); return; } } if (mcqs?.length > 0) { startMockTest(mcqs, titleFromButton || null); } else { displayError("MCQ data missing/invalid."); } return; }
            const clickedImage = event.target.closest('img.chat-image, img.uploaded-image'); if (clickedImage?.src && !clickedImage.src.endsWith('#')) { window.open(clickedImage.src, '_blank'); }
        }
        function displayMCQOffer(mcqData, mcqTitle, aiMessageElement) { /* ... (same as v9.3) ... */ if (aiMessageElement.querySelector('.start-test-button')) return; const questionCount = mcqData.length; const button = document.createElement('button'); button.classList.add('start-test-button'); button.textContent = `Start Mock Test (${questionCount} Qs)`; button.title = mcqTitle || `Start test`; try { button.dataset.mcq = JSON.stringify(mcqData); if (mcqTitle) { button.dataset.mcqTitle = mcqTitle; } } catch (e) { console.error("Failed stringify MCQ data:", e); return; } const buttonContainer = document.createElement('div'); buttonContainer.style.marginTop = '10px'; buttonContainer.appendChild(button); aiMessageElement.appendChild(buttonContainer); }
        function toggleTestLanguage() { /* ... (same as v9.3) ... */ currentTestLanguage = (currentTestLanguage === 'en') ? 'ta' : 'en'; testLanguageToggle.textContent = (currentTestLanguage === 'en') ? '‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç' : 'English'; displayTestQuestion(currentQuestionIndex); }
        function startMockTest(mcqs, title = null) { /* ... (same as v9.3) ... */ if (!currentUser) { displayError("Log in to start test."); return; } if (!mcqs?.length) { displayError("No questions for test."); if (cameFromAllTestsList) { switchView('chat'); } return; } console.log("Starting mock test:", mcqs.length, "Qs. Title:", title); currentTestMCQs = mcqs; currentQuestionIndex = 0; userAnswers = new Array(mcqs.length).fill(null); reviewResultsCache = null; currentTestLanguage = 'en'; testLanguageToggle.textContent = '‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç'; switchView('test'); displayTestQuestion(0); startTestTimer(); const finalTitle = (title && title.trim()) ? title.trim() : `Mock Test (${mcqs.length} Qs)`; testTitle.textContent = finalTitle; }
        function displayTestQuestion(index) { /* ... (same as v9.3) ... */ if (index < 0 || index >= currentTestMCQs.length) return; currentQuestionIndex = index; const questionData = currentTestMCQs[index]; const lang = currentTestLanguage; const questionText = questionData.question?.[lang] || questionData.question?.en || "(Missing)"; testQuestionNumber.textContent = `Question ${index + 1}`; testQuestion.innerHTML = questionText; testOptionsContainer.innerHTML = ''; const options = questionData.options || []; const optionLetters = ['A', 'B', 'C', 'D']; options.forEach((optionObj, optionIndex) => { if (optionIndex >= optionLetters.length) return; const optionText = optionObj?.[lang] || optionObj?.en || '(Missing)'; const label = document.createElement('label'); const input = document.createElement('input'); input.type = 'radio'; input.name = `q_${index}`; input.value = optionIndex; input.checked = (userAnswers[index] === optionIndex); input.onchange = () => handleOptionSelect(optionIndex); label.appendChild(input); label.appendChild(document.createTextNode(` ${optionLetters[optionIndex]}. ${optionText}`)); testOptionsContainer.appendChild(label); }); try { if (typeof MathJax !== "undefined" && MathJax.typesetPromise) { MathJax.typesetPromise([testQuestion, testOptionsContainer]).catch(err=>console.error(err)); } } catch(e){ console.error(e); } prevQuestionBtn.disabled = (index === 0); nextQuestionBtn.disabled = (index === currentTestMCQs.length - 1); questionCounter.textContent = `Q: ${index + 1} / ${currentTestMCQs.length}`; }
        function handleOptionSelect(optionIndex) { /* ... (same as v9.3) ... */ if (currentQuestionIndex >= 0 && currentQuestionIndex < userAnswers.length) { userAnswers[currentQuestionIndex] = optionIndex; } }
        function handleTestNavigation(direction) { /* ... (same as v9.3) ... */ let newIndex = currentQuestionIndex; if (direction === 'prev' && currentQuestionIndex > 0) { newIndex--; } else if (direction === 'next' && currentQuestionIndex < currentTestMCQs.length - 1) { newIndex++; } if (newIndex !== currentQuestionIndex) { displayTestQuestion(newIndex); } }
        function startTestTimer() { /* ... (same as v9.3) ... */ if (testTimerInterval) clearInterval(testTimerInterval); testStartTime = Date.now(); testTimer.textContent = `Time: 00:00`; testTimerInterval = setInterval(() => { const elapsedSeconds = Math.floor((Date.now() - testStartTime) / 1000); const minutes = Math.floor(elapsedSeconds / 60).toString().padStart(2, '0'); const seconds = (elapsedSeconds % 60).toString().padStart(2, '0'); testTimer.textContent = `Time: ${minutes}:${seconds}`; }, 1000); }
        function submitTest() { /* ... (same as v9.3) ... */ if (!confirm("Submit test?")) return; if (testTimerInterval) clearInterval(testTimerInterval); const endTime = Date.now(); const timeTakenMs = testStartTime ? endTime - testStartTime : 0; const results = calculateResults(currentTestMCQs, userAnswers, timeTakenMs); reviewResultsCache = results; switchView('review', false); displayReview(results); }

        // --- Review Functions ---
        // ‡Æá‡Æ®‡Øç‡Æ§‡Æ™‡Øç ‡Æ™‡Æï‡ØÅ‡Æ§‡Æø ‡ÆÆ‡Ææ‡Æ±‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà / This part is unchanged
        function toggleReviewLanguage() { /* ... (same as v9.3) ... */ currentReviewLanguage = (currentReviewLanguage === 'en') ? 'ta' : 'en'; reviewLanguageToggle.textContent = (currentReviewLanguage === 'en') ? '‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç' : 'English'; if (reviewResultsCache) { displayReview(reviewResultsCache); } }
        function calculateResults(mcqs, answers, timeMs) { /* ... (same as v9.3) ... */ let c = 0, i = 0, s = 0; const rQ = []; mcqs.forEach((q, idx) => { const uAIdx = answers[idx]; const opts = q.options || []; const cALtr = q.answer?.trim().toUpperCase(); const cAIdx = cALtr ? cALtr.charCodeAt(0) - 'A'.charCodeAt(0) : -1; const cATxtE = (cAIdx >= 0 && cAIdx < opts.length) ? (opts[cAIdx]?.en || '?') : "N/A"; let uATxtE = "Skipped"; let st = "skipped"; if (uAIdx !== null && uAIdx >= 0 && uAIdx < opts.length) { uATxtE = opts[uAIdx]?.en || '?'; if (uAIdx === cAIdx) { st = "correct"; c++; } else { st = "incorrect"; i++; } } else if (uAIdx !== null) { uATxtE = "Invalid"; st = "incorrect"; i++; } else { s++; } rQ.push({ question: q.question?.en || '?', correctAnswer: cATxtE, userAnswer: uATxtE, status: st, explanation: q.explanation?.en || "N/A" }); }); const total = mcqs.length; const score = `${c}/${total}`; const timeS = Math.round(timeMs / 1000); const mins = Math.floor(timeS / 60); const secs = timeS % 60; const timeStr = `${mins}m ${secs}s`; return { questions: rQ, summary: { score, correct: c, incorrect: i, skipped: s, timeString: timeStr }, testDate: new Date().toISOString(), timeTakenMs: timeMs, sourceChatId: activeChatId, testTitle: testTitle.textContent, originalMCQs: mcqs }; }
        function displayReview(reviewData) { /* ... (same as v9.3) ... */ reviewContent.innerHTML = ''; reviewSummary.innerHTML = ''; reviewFilters.style.display = 'none'; if (!reviewData?.questions?.length || !reviewData.summary || !reviewData.originalMCQs) { reviewSummary.innerHTML = "<span>No review data.</span>"; saveReviewBtn.style.display = 'none'; return; } const expBtnTxt = (currentReviewLanguage === 'en') ? '‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç' : 'English'; if (!reviewLanguageToggle || reviewLanguageToggle.textContent !== expBtnTxt) { currentReviewLanguage = 'en'; if (reviewLanguageToggle) reviewLanguageToggle.textContent = '‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç'; } const { score, correct, incorrect, skipped, timeString } = reviewData.summary; reviewSummary.innerHTML = `<span>Score: ${score}</span> <span class="score-correct">Correct: ${correct}</span> <span class="score-incorrect">Incorrect: ${incorrect}</span> <span class="score-skipped">Skipped: ${skipped}</span> <span>Time: ${timeString}</span>`; reviewTitle.textContent = reviewData.testTitle || "Review"; const lang = currentReviewLanguage; reviewData.questions.forEach((qSum, idx) => { const origQ = reviewData.originalMCQs[idx]; if (!origQ) { /* fallback */ return; } const qTxt = origQ.question?.[lang] || origQ.question?.en || '?'; const opts = origQ.options || []; const cALtr = origQ.answer?.trim().toUpperCase(); const cAIdx = cALtr ? cALtr.charCodeAt(0) - 'A'.charCodeAt(0) : -1; const cATxt = (cAIdx >= 0 && cAIdx < opts.length) ? (opts[cAIdx]?.[lang] || opts[cAIdx]?.en) : "N/A"; let uATxt = qSum.userAnswer; const st = qSum.status; if (st !== 'skipped' && st !== 'invalid') { const uAEn = qSum.userAnswer; const uAIdx = opts.findIndex(opt => opt.en === uAEn); if (uAIdx !== -1) { uATxt = opts[uAIdx]?.[lang] || opts[uAIdx]?.en; } else { uATxt = uAEn || '?'; } } else if (st === 'skipped') { uATxt = (lang === 'ta') ? "‡Æ§‡Æµ‡Æø‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ" : "Skipped"; } else { uATxt = (lang === 'ta') ? "‡Æ§‡Æµ‡Æ±‡Ææ‡Æ© ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ" : "Invalid"; } const explTxt = origQ.explanation?.[lang] || origQ.explanation?.en || "N/A."; let iStCls = `status-${st}`; let aDtCls = `user-answer-${st}`; const rItem = document.createElement('div'); rItem.classList.add('review-item', iStCls); rItem.dataset.status = st; let dHtml = `<span class="${aDtCls}">Your: ${uATxt}</span>`; if (st !== 'correct') { dHtml += `<br><span class="correct-answer">Correct: ${cATxt}</span>`; } dHtml += `<div class="review-item-explanation">${(lang === 'ta' ? '‡Æµ‡Æø‡Æ≥‡Æï‡Øç‡Æï‡ÆÆ‡Øç' : 'Explanation')}: ${explTxt}</div>`; rItem.innerHTML = `<div class="review-item-qnum">Q ${idx + 1}</div> <div class="review-item-question">${qTxt}</div> <div class="review-item-details">${dHtml}</div>`; reviewContent.appendChild(rItem); }); if (reviewData.savedAt) { saveReviewBtn.textContent = "Saved"; saveReviewBtn.disabled = true; saveReviewBtn.style.display = 'inline-block'; } else if (reviewResultsCache && !cameFromAllTestsList) { saveReviewBtn.textContent = "Save"; saveReviewBtn.disabled = !currentUser; saveReviewBtn.style.display = 'inline-block'; } else { saveReviewBtn.style.display = 'none'; } reviewFilters.style.display = 'block'; try { if (typeof MathJax !== "undefined" && MathJax.typesetPromise) { MathJax.typesetPromise([reviewContent]).catch(err=>console.error(err)); } } catch (e) { console.error(e); } filterReviewItems('all'); reviewFilters.querySelectorAll('button').forEach(btn => { btn.classList.toggle('active-filter', btn.dataset.filter === 'all'); }); }
        function handleReviewFilterClick(event) { /* ... (same as v9.3) ... */ const button = event.target.closest('button[data-filter]'); if (button) { filterReviewItems(button.dataset.filter); } }
        function filterReviewItems(filter) { /* ... (same as v9.3) ... */ reviewFilters.querySelectorAll('button').forEach(btn => { btn.classList.toggle('active-filter', btn.dataset.filter === filter); }); reviewContent.querySelectorAll('.review-item').forEach(item => { const show = (filter === 'all') || item.dataset.status === filter; item.classList.toggle('hidden-by-filter', !show); }); }
        function exitReview() { /* ... (same as v9.3) ... */ reviewResultsCache = null; switchView('chat'); reviewSummary.innerHTML = ''; reviewContent.innerHTML = ''; reviewTitle.textContent = 'Review'; if (reviewLanguageToggle) reviewLanguageToggle.textContent = '‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç'; currentReviewLanguage = 'en'; }
        async function saveTestReviewToCloud() { /* ... (same as v9.3) ... */ if (!currentUser) { alert("Log in to save."); return; } if (!reviewResultsCache || reviewResultsCache.savedAt) { alert("No new review data or already saved."); return; } if (!reviewResultsCache.originalMCQs?.length) { if (!confirm("Warn: Original Q data missing. Save anyway?")) { return; } } const dataToSave = { ...reviewResultsCache, userId: currentUser.uid, savedAt: firebase.firestore.FieldValue.serverTimestamp(), }; saveReviewBtn.disabled = true; saveReviewBtn.textContent = "Saving..."; try { const newRef = await db.collection('testReviews').add(dataToSave); console.log("Review saved:", newRef.id); alert("Review saved!"); saveReviewBtn.textContent = "Saved"; if (reviewResultsCache) reviewResultsCache.savedAt = new Date(); } catch (error) { console.error("Error saving review:", error); alert("Failed to save review."); saveReviewBtn.disabled = false; saveReviewBtn.textContent = "Save"; } }


        // --- All Tests List Functions ---
        // ‡Æá‡Æ®‡Øç‡Æ§‡Æ™‡Øç ‡Æ™‡Æï‡ØÅ‡Æ§‡Æø ‡ÆÆ‡Ææ‡Æ±‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà / This part is unchanged
        function loadAndListenForTests(userId) { /* ... (same as v9.2) ... */ if (testListListener) { testListListener(); testListListener = null; } const testsRef = db.collection('testReviews').where('userId', '==', userId).orderBy('savedAt', 'desc'); console.log(`Listening for saved tests user ${userId}`); testListListener = testsRef.onSnapshot(snapshot => { allSavedTestsData = []; snapshot.forEach(doc => { allSavedTestsData.push({ id: doc.id, ...doc.data() }); }); console.log("Received tests snapshot:", allSavedTestsData.length); renderAllTestsList(allSavedTestsData); filterTestsInSidebar(); }, error => { console.error("Error listening tests:", error); allTestsListContainer.innerHTML = `<div style="color:var(--error-text);">Error loading tests.</div>`; allSavedTestsData = []; }); }
        function renderAllTestsList(tests) { /* ... (same as v9.2) ... */ allTestsListContainer.innerHTML = ''; if (!currentUser) { allTestsListContainer.innerHTML = '<div>Login to see tests.</div>'; return; } if (tests.length === 0) { allTestsListContainer.innerHTML = '<div>No saved tests.</div>'; } else { tests.forEach(testData => { const item = document.createElement('div'); item.classList.add('test-list-item'); item.dataset.reviewId = testData.id; const title = testData.testTitle || '(Untitled)'; const date = testData.savedAt?.toDate ? testData.savedAt.toDate().toLocaleString() : '?'; const score = testData.summary?.score || 'N/A'; const hasRe = testData.originalMCQs?.length > 0 && testData.originalMCQs.every(q => q?.question && q.options && q.answer && q.explanation); const info = document.createElement('div'); info.classList.add('test-item-info'); const titleS = document.createElement('span'); titleS.classList.add('test-item-title'); titleS.textContent = title; titleS.title = title; const detailS = document.createElement('span'); detailS.classList.add('test-item-details'); detailS.textContent = `Saved: ${date} | Score: ${score}`; const ctrls = document.createElement('div'); ctrls.classList.add('test-item-controls'); const editB = document.createElement('button'); editB.innerHTML = EDIT_TEST_ICON; editB.title = "Edit title"; editB.dataset.action = "edit-title"; ctrls.appendChild(editB); const delB = document.createElement('button'); delB.innerHTML = DELETE_TEST_ICON; delB.title = "Delete test"; delB.dataset.action = "delete-test"; ctrls.appendChild(delB); info.appendChild(titleS); info.appendChild(detailS); info.appendChild(ctrls); const acts = document.createElement('div'); acts.classList.add('test-item-actions'); const viewB = document.createElement('button'); viewB.textContent = "Details"; viewB.dataset.action = "view"; acts.appendChild(viewB); const reSel = document.createElement('select'); reSel.dataset.action = "reattempt"; reSel.disabled = !hasRe; reSel.title = hasRe ? "Reattempt" : "Reattempt N/A"; reSel.innerHTML = `<option value="" selected>${hasRe ? 'Reattempt...' : 'N/A'}</option><option value="mistaked" ${!hasRe?'disabled':''}>Mistaked</option><option value="skipped" ${!hasRe?'disabled':''}>Skipped</option><option value="both" ${!hasRe?'disabled':''}>Mistaked/Skipped</option><option value="full" ${!hasRe?'disabled':''}>Full</option>`; reSel.addEventListener('change', (e) => { const mode = e.target.value; if (mode) { const rId = e.target.closest('.test-list-item')?.dataset.reviewId; if (rId) { startReattempt(rId, mode); } e.target.value = ""; } }); acts.appendChild(reSel); item.appendChild(info); item.appendChild(acts); allTestsListContainer.appendChild(item); }); } }
        function filterTestsInSidebar() { /* ... (same as v9.2) ... */ const term = testSearchInput.value.toLowerCase().trim(); const items = allTestsListContainer.querySelectorAll('.test-list-item'); let vis = 0; const noRes = allTestsListContainer.querySelector('.no-search-results'); if (noRes) { noRes.remove(); } items.forEach(item => { const title = item.querySelector('.test-item-title')?.textContent.toLowerCase() || ''; const details = item.querySelector('.test-item-details')?.textContent.toLowerCase() || ''; const match = title.includes(term) || details.includes(term); item.classList.toggle('hidden-by-search', !match); if (match) vis++; }); if (vis === 0 && term !== '' && items.length > 0) { const msg = document.createElement('div'); msg.textContent = "No tests match search."; msg.classList.add('no-search-results'); allTestsListContainer.appendChild(msg); } }
        async function handleAllTestsListClick(event) { /* ... (same as v9.2) ... */ const button = event.target.closest('button[data-action], select[data-action]'); if (!button) return; const action = button.dataset.action; const listItem = button.closest('.test-list-item'); const reviewId = listItem?.dataset.reviewId; if (!reviewId) return; switch (action) { case "view": const data = allSavedTestsData.find(t => t.id === reviewId); if (data) { reviewResultsCache = data; switchView('review', true); displayReview(data); } else { alert("Error loading review."); } break; case "edit-title": enterTestTitleEditMode(listItem, reviewId); break; case "delete-test": const title = listItem.querySelector('.test-item-title')?.textContent || 'test'; if (confirm(`Delete "${title}"?`)) { deleteSavedTest(reviewId, listItem); } break; case "reattempt": /* Handled by select change event */ break; } }
        function enterTestTitleEditMode(listItem, reviewId) { /* ... (same as v9.2) ... */ const info = listItem.querySelector('.test-item-info'); const tS = info.querySelector('.test-item-title'); const dS = info.querySelector('.test-item-details'); const cD = info.querySelector('.test-item-controls'); const curT = tS.textContent; tS.style.display = 'none'; dS.style.display = 'none'; if(cD) cD.style.display = 'none'; if (info.querySelector('.test-item-edit-mode')) return; const editC = document.createElement('div'); editC.classList.add('test-item-edit-mode'); const inp = document.createElement('input'); inp.type = 'text'; inp.value = curT; inp.maxLength = 100; inp.addEventListener('keydown', (e) => { if (e.key === 'Enter') saveTestTitle(listItem, reviewId, inp.value); else if (e.key === 'Escape') exitTestTitleEditMode(listItem, curT); }); const saveB = document.createElement('button'); saveB.textContent = 'Save'; saveB.onclick = () => saveTestTitle(listItem, reviewId, inp.value); const cancelB = document.createElement('button'); cancelB.textContent = 'Cancel'; cancelB.onclick = () => exitTestTitleEditMode(listItem, curT); editC.appendChild(inp); editC.appendChild(saveB); editC.appendChild(cancelB); info.appendChild(editC); inp.focus(); inp.select(); }
        function exitTestTitleEditMode(listItem, originalTitle = null) { /* ... (same as v9.2) ... */ const info = listItem.querySelector('.test-item-info'); const tS = info.querySelector('.test-item-title'); const dS = info.querySelector('.test-item-details'); const cD = info.querySelector('.test-item-controls'); const editC = info.querySelector('.test-item-edit-mode'); if (editC) editC.remove(); if (originalTitle !== null && tS) { tS.textContent = originalTitle; tS.title = originalTitle; } if(tS) tS.style.display = ''; if(dS) dS.style.display = ''; if(cD) cD.style.display = ''; }
        async function saveTestTitle(listItem, reviewId, newTitle) { /* ... (same as v9.2) ... */ const trimT = newTitle.trim(); if (!trimT) { alert("Title cannot be empty."); return; } if (trimT.length > 100) { alert("Title too long."); return; } const docRef = db.collection('testReviews').doc(reviewId); try { await docRef.update({ testTitle: trimT }); console.log("Title updated:", reviewId); const tS = listItem.querySelector('.test-item-title'); if (tS) { tS.textContent = trimT; tS.title = trimT; } const idx = allSavedTestsData.findIndex(t => t.id === reviewId); if (idx > -1) allSavedTestsData[idx].testTitle = trimT; exitTestTitleEditMode(listItem); } catch (error) { console.error("Error updating title:", error); alert("Failed to update title."); } }
        async function deleteSavedTest(reviewId, listItem) { /* ... (same as v9.2) ... */ if (!currentUser || !reviewId) return; listItem.style.opacity = '0.5'; listItem.style.pointerEvents = 'none'; const docRef = db.collection('testReviews').doc(reviewId); try { await docRef.delete(); console.log("Test deleted:", reviewId); allSavedTestsData = allSavedTestsData.filter(t => t.id !== reviewId); /* Snapshot listener will update UI */ alert("Test deleted."); } catch (error) { console.error("Error deleting test:", error); alert("Failed to delete test."); listItem.style.opacity = '1'; listItem.style.pointerEvents = 'auto'; } } // UI update relies on listener now
        async function startReattempt(reviewId, mode) { /* ... (same as v9.2) ... */ console.log(`Reattempt: ${reviewId}, mode: ${mode}`); const data = allSavedTestsData.find(t => t.id === reviewId); if (!data) { alert("Error: Review data not found."); return; } const origQs = data.originalMCQs; const hasData = origQs?.length > 0 && origQs.every(q => q?.question && q.options && q.answer && q.explanation); if (!hasData) { alert("Error: Cannot reattempt. Original data missing/invalid."); return; } const sumQs = data.questions || []; let qsRe = []; switch (mode) { case 'mistaked': qsRe = origQs.filter((mcq, i) => sumQs[i]?.status === 'incorrect'); break; case 'skipped': qsRe = origQs.filter((mcq, i) => sumQs[i]?.status === 'skipped'); break; case 'both': qsRe = origQs.filter((mcq, i) => sumQs[i]?.status === 'incorrect' || sumQs[i]?.status === 'skipped'); break; case 'full': default: qsRe = [...origQs]; break; } if (qsRe.length === 0) { alert(`No questions for mode '${mode}'.`); return; } const title = `${data.testTitle || 'Test'} (Reattempt: ${mode})`; startMockTest(qsRe, title); }

    </script>

</body>
</html>
