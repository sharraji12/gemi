<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Chat + Mock Test (v9 - MultiPage)</title>

    <!-- MathJax, Firebase SDKs (‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡ÆÆ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà) -->
    <script> window.MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],displayMath:[['$$','$$'],['\\[','\\]']]},svg:{fontCache:'global'},options:{skipHtmlTags:['script','noscript','style','textarea','pre','code']}}; </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <style>
        /* Styles (‡ÆÆ‡ØÅ‡Æ®‡Øç‡Æ§‡Øà‡ÆØ‡Æ§‡Æø‡Æ≤‡Øç ‡Æá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æö‡Æø‡Æ≤ ‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡Æô‡Øç‡Æï‡Æ≥‡ØÅ‡Æü‡Æ©‡Øç) */
        :root {
             /* ... Theme Variables ... */
             --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; --sidebar-width: 260px; --message-font-size-base: 1rem;
             /* LIGHT */ --sidebar-bg: #f7f7f7; --main-bg: #ffffff; --input-bg: #ffffff; --border-color: #e0e0e0; --text-primary: #2c2c2c; --text-secondary: #5f5f5f; --text-placeholder: #999999; --accent-color: #d97a7a; --user-message-bg: #cce0ff; --user-message-text: #1c1c1c; --ai-message-bg: #f0f0f0; --ai-message-text: #2c2c2c; --button-bg: #f0f0f0; --button-hover-bg: #e0e0e0; --active-item-bg: #e0e0e0; --code-bg: #e8e8e8; --scrollbar-thumb: #ccc; --scrollbar-thumb-hover: #bbb; --app-outer-bg: #e8e8e8; --send-button-bg: var(--accent-color); --send-button-hover-bg: #c76b6b; --send-button-text: #ffffff; --error-bg: #ffebee; --error-text: #c62828; --error-border: #ef9a9a; --message-font-size: var(--message-font-size-base); --delete-button-color: #aaa; --delete-button-hover-color: #dc3545; --link-color: var(--accent-color);
        }
        body.dark-theme {
             /* DARK */ --sidebar-bg: #2a2a2e; --main-bg: #1e1e1e; --input-bg: #2a2a2e; --border-color: #404040; --text-primary: #e0e0e0; --text-secondary: #a0a0a0; --text-placeholder: #777777; --accent-color: #e58b8b; --user-message-bg: #3a4a6b; --user-message-text: #e8e8e8; --ai-message-bg: #333333; --ai-message-text: #e0e0e0; --button-bg: #404040; --button-hover-bg: #505050; --active-item-bg: #454545; --code-bg: #2c2c2e; --scrollbar-thumb: #555; --scrollbar-thumb-hover: #666; --app-outer-bg: #121212; --send-button-bg: var(--accent-color); --send-button-hover-bg: #f09f9f; --send-button-text: #1e1e1e; --error-bg: #5c2b2b; --error-text: #ffcdd2; --error-border: #8c4343; --delete-button-color: #666; --delete-button-hover-color: #f09f9f; --link-color: var(--accent-color);
        }
        body { font-family: var(--font-family); margin: 0; padding: 0; background-color: var(--app-outer-bg); color: var(--text-primary); font-size: 15px; transition: background-color 0.3s ease, color 0.3s ease; }
        a { color: var(--link-color); text-decoration: none; }
        a:hover { text-decoration: underline; }

        /* Layout, Sidebar, Chat Area, Input, Test, Review Styles (‡ÆÆ‡ØÅ‡Æ®‡Øç‡Æ§‡Øà‡ÆØ‡Æ§‡ØÅ ‡Æ™‡Øã‡Æ≤‡Æµ‡Øá, ‡Æö‡Æø‡Æ≤ ‡Æö‡Æø‡Æ±‡Æø‡ÆØ ‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡Æô‡Øç‡Æï‡Æ≥‡Øç) */
         .app-container { display: flex; height: 100vh; width: 100vw; overflow: hidden; } .app-container.hidden { display: none; }
         .sidebar { width: var(--sidebar-width); background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 15px 0; box-sizing: border-box; flex-shrink: 0; transition: background-color 0.3s ease, border-color 0.3s ease; }
         .main-container { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; overflow: hidden; position: relative; }
         .main-content, .review-view { display: none; flex-direction: column; background-color: var(--main-bg); height: 100%; width: 100%; overflow: hidden; transition: background-color 0.3s ease; }
         .main-content.active, .review-view.active { display: flex; }
         .chat-area { flex-grow: 1; overflow-y: auto; padding: 30px 10% 20px; display: flex; flex-direction: column; max-width: 800px; margin: 0 auto; width: 80%; }
         .input-container { padding: 20px 10%; border-top: 1px solid var(--border-color); background-color: var(--input-bg); max-width: 800px; margin: 0 auto; width: 80%; transition: background-color 0.3s ease, border-color 0.3s ease; display: none; }

         /* Sidebar */
         .sidebar-header { padding: 10px 20px; font-size: 1.1em; font-weight: 600; color: var(--text-primary); }
         .sidebar-button, .start-chat-button { display: flex; align-items: center; gap: 8px; background-color: var(--main-bg); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 8px; padding: 10px 15px; margin: 5px 15px; /* Adjusted margin */ font-size: 0.95em; font-weight: 500; cursor: pointer; text-align: left; transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease; }
         .sidebar-button:hover, .start-chat-button:hover { background-color: var(--button-hover-bg); }
         .sidebar-button svg, .start-chat-button svg { fill: currentColor; width: 16px; height: 16px; flex-shrink: 0; }
         .sidebar-button:disabled, .start-chat-button:disabled { opacity: 0.6; cursor: not-allowed; }
         .sidebar-section-title { padding: 15px 20px 5px; font-size: 0.85em; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
         .chat-list { flex-grow: 1; overflow-y: auto; padding: 0 15px; margin-bottom: 10px; }
         .chat-list::-webkit-scrollbar { width: 6px; } .chat-list::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 3px;} .chat-list::-webkit-scrollbar-thumb:hover { background: var(--scrollbar-thumb-hover); }
         .chat-list-item { padding: 8px 30px 8px 10px; margin-bottom: 4px; border-radius: 6px; font-size: 0.9em; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-secondary); transition: background-color 0.2s ease, color 0.2s ease; position: relative; }
         .chat-list-item:hover { background-color: var(--button-hover-bg); color: var(--text-primary); }
         .chat-list-item.active { background-color: var(--active-item-bg); color: var(--text-primary); font-weight: 500; }
         .delete-chat-button { position: absolute; right: 6px; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; background: none; border: none; color: var(--delete-button-color); cursor: pointer; font-size: 1.3em; line-height: 1; padding: 0; display: none; opacity: 0.7; transition: color 0.2s ease, opacity 0.2s ease; }
         .chat-list-item:hover .delete-chat-button { display: block; }
         .delete-chat-button:hover { color: var(--delete-button-hover-color); opacity: 1; }
         .sidebar-footer { border-top: 1px solid var(--border-color); padding: 10px 15px; margin-top: auto; /* Push footer down */ transition: border-color 0.3s ease;}
         .sidebar-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px; } /* Added wrap and gap */
         .text-size-controls, .theme-toggle, .language-toggle { display: flex; align-items: center; gap: 5px; } /* Group label and button */
         .text-size-controls span, .theme-toggle span, .language-toggle span { font-size: 0.85em; color: var(--text-secondary); }
         .text-size-buttons button, .theme-toggle button, .language-toggle button { background: var(--button-bg); border: 1px solid var(--border-color); color: var(--text-secondary); border-radius: 4px; padding: 2px 8px; cursor: pointer; font-size: 1.1em; line-height: 1; transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease; }
         .text-size-buttons button:hover, .theme-toggle button:hover, .language-toggle button:hover { background-color: var(--button-hover-bg); color: var(--text-primary); }
         .text-size-buttons button:disabled, .theme-toggle button:disabled, .language-toggle button:disabled { opacity: 0.6; cursor: not-allowed; }
         .account-info { display: flex; align-items: center; gap: 10px; font-size: 0.9em; margin-top: 10px; }
         .account-avatar { width: 30px; height: 30px; border-radius: 50%; background-color: #6c757d; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; }
         .account-details { overflow: hidden; }
         .account-email { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-primary); }
         .account-plan { font-size: 0.85em; color: var(--text-secondary); }
         #auth-controls { margin-top: 15px; text-align: center; }
         #auth-controls button { background-color: var(--button-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; padding: 8px 15px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s ease; }
         #auth-controls button:hover { background-color: var(--button-hover-bg); }
         #logout-btn { display: none; }

         /* Chat Area, Input, Test, Review (‡ÆÆ‡ØÅ‡Æ®‡Øç‡Æ§‡Øà‡ÆØ‡Æ§‡ØÅ ‡Æ™‡Øã‡Æ≤‡Æµ‡Øá) */
         /* ... (‡Æá‡Æ®‡Øç‡Æ§ ‡Æ∏‡Øç‡Æü‡Øà‡Æ≤‡Øç‡Æï‡Æ≥‡Øç ‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡Æ™‡Øç‡Æ™‡Æü‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà, ‡Æö‡ØÅ‡Æ∞‡ØÅ‡Æï‡Øç‡Æï‡Æ§‡Øç‡Æ§‡Æø‡Æ±‡Øç‡Æï‡Ææ‡Æï ‡Æ§‡Æµ‡Æø‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ) ... */
          .greeting { font-size: 1.8em; font-weight: 600; margin-bottom: 40px; color: var(--text-primary); } .greeting .asterisk { color: var(--accent-color); font-size: 1.2em; margin-right: 5px; display: inline-block; vertical-align: middle; }
          .message { padding: 12px 18px; border-radius: 18px; max-width: 80%; word-wrap: break-word; line-height: 1.6; margin-bottom: 15px; font-size: var(--message-font-size); transition: background-color 0.3s ease, color 0.3s ease; }
          .user-message { background-color: var(--user-message-bg); color: var(--user-message-text); align-self: flex-end; border-bottom-right-radius: 5px; }
          .ai-message { background-color: var(--ai-message-bg); color: var(--ai-message-text); align-self: flex-start; border-bottom-left-radius: 5px; }
          .ai-message strong { font-weight: 600; } .ai-message em { font-style: italic; }
          .ai-message pre { background-color: var(--code-bg); color: var(--text-primary); padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 0.9em; transition: background-color 0.3s ease, color 0.3s ease;}
          .ai-message code { font-family: monospace; background-color: var(--code-bg); color: var(--text-primary); padding: 2px 4px; border-radius: 3px; transition: background-color 0.3s ease, color 0.3s ease;}
          .ai-message pre code { background-color: transparent; padding: 0; }
          .ai-message.thinking { background-color: transparent; color: var(--text-secondary); font-style: italic; }
          .error-message { background-color: var(--error-bg); color: var(--error-text); border: 1px solid var(--error-border); align-self: flex-start; transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;}
          .info-message { text-align: center; color: var(--text-secondary); padding: 50px 20px; font-style: italic; }
          .message mjx-container { color: inherit !important; font-size: inherit !important; }
          .suggestions { display: none; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
          .suggestion-chip { background-color: var(--button-bg); border: 1px solid var(--border-color); color: var(--text-secondary); border-radius: 16px; padding: 8px 15px; font-size: 0.9em; cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease; }
          .suggestion-chip:hover { background-color: var(--button-hover-bg); color: var(--text-primary); }
          .input-box { display: flex; align-items: flex-end; background-color: var(--main-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 5px 5px 5px 15px; position: relative; transition: background-color 0.3s ease, border-color 0.3s ease; }
          .input-box:focus-within { border-color: var(--accent-color); }
          #user-input { flex-grow: 1; border: none; outline: none; padding: 10px 5px; font-size: 1rem; background-color: transparent; resize: none; min-height: 48px; max-height: 250px; line-height: 1.5; color: var(--text-primary); font-family: var(--font-family); }
          #user-input::placeholder { color: var(--text-placeholder); }
          .mcq-mode-control { display: flex; align-items: center; margin-left: 10px; padding-bottom: 8px; flex-shrink: 0; }
          .mcq-mode-control input[type="checkbox"] { margin-right: 5px; accent-color: var(--accent-color); cursor: pointer;}
          .mcq-mode-control label { font-size: 0.85em; color: var(--text-secondary); cursor: pointer; user-select: none;}
          #send-button { background-color: var(--send-button-bg); color: var(--send-button-text); border: none; border-radius: 8px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-left: 10px; transition: background-color 0.2s ease; padding: 0; flex-shrink: 0; }
          #send-button:hover:not(:disabled) { background-color: var(--send-button-hover-bg); }
          #send-button:disabled { background-color: #cccccc; cursor: not-allowed; opacity: 0.6; }
          #send-button svg { width: 20px; height: 20px; fill: currentColor; }
          .thinking::after { content: ' .'; animation: dots 1s steps(3, end) infinite; display: inline-block; }
          @keyframes dots { 0%, 20% { content: ' .'; } 40% { content: ' ..'; } 60%, 100% { content: ' ...'; } }
           .start-test-button { background-color: var(--accent-color); color: var(--send-button-text); border: none; border-radius: 6px; padding: 8px 15px; margin-top: 10px; cursor: pointer; font-weight: 500; display: inline-block; transition: background-color 0.2s ease; }
           .start-test-button:hover { background-color: var(--send-button-hover-bg); }
           /* Mock Test View */
           .mock-test-view { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--main-bg); z-index: 100; flex-direction: column; padding: 20px; box-sizing: border-box; transition: background-color 0.3s ease; }
           .mock-test-view.active { display: flex; }
           .test-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
           .test-header h2 { margin: 0; font-size: 1.3em; color: var(--text-primary); }
           .test-info span { margin-left: 15px; font-size: 0.95em; color: var(--text-secondary); }
           .test-content { flex-grow: 1; overflow-y: auto; padding: 10px 20px; }
           .test-question-container { margin-bottom: 25px; }
           .test-question-number { font-weight: bold; margin-bottom: 8px; color: var(--text-secondary); }
           .test-question { font-size: 1.1em; line-height: 1.5; margin-bottom: 15px; color: var(--text-primary); }
           .test-options label { display: block; margin-bottom: 12px; background-color: var(--button-bg); padding: 12px 15px; border-radius: 6px; border: 1px solid var(--border-color); cursor: pointer; transition: background-color 0.2s ease, border-color 0.2s ease; color: var(--text-primary); }
           .test-options label:hover { background-color: var(--button-hover-bg); }
           .test-options input[type="radio"] { margin-right: 10px; accent-color: var(--accent-color); cursor: pointer;}
           .test-navigation { display: flex; justify-content: space-between; padding-top: 15px; border-top: 1px solid var(--border-color); margin-top: auto; flex-shrink: 0; }
           .test-navigation button { background-color: var(--button-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; padding: 10px 20px; cursor: pointer; font-size: 0.95em; transition: background-color 0.2s ease; }
           .test-navigation button:hover:not(:disabled) { background-color: var(--button-hover-bg); }
           .test-navigation button#submit-test-btn { background-color: var(--accent-color); color: var(--send-button-text); border-color: var(--accent-color); }
           .test-navigation button#submit-test-btn:hover:not(:disabled) { background-color: var(--send-button-hover-bg); }
           .test-navigation button:disabled { opacity: 0.5; cursor: not-allowed; }
           /* Review View */
           .review-view { padding: 20px; box-sizing: border-box; background-color: var(--main-bg); }
           .review-header { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
           .review-header h2 { margin: 0 0 10px 0; font-size: 1.3em; color: var(--text-primary); }
           .review-summary span { margin-right: 20px; font-size: 1em; color: var(--text-primary); }
           .review-summary .score-correct { color: #28a745; font-weight: bold;} .review-summary .score-incorrect { color: #dc3545; font-weight: bold;} .review-summary .score-skipped { color: #fd7e14; font-weight: bold;}
           .review-filters { margin-bottom: 15px; }
           .review-filters button { background-color: var(--button-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; padding: 5px 12px; margin-right: 8px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s ease, border-color 0.2s ease; }
           .review-filters button:hover { background-color: var(--button-hover-bg); }
           .review-filters button.active-filter { background-color: var(--accent-color); color: var(--send-button-text); border-color: var(--accent-color);}
           .review-content { flex-grow: 1; overflow-y: auto; padding-right: 10px; }
           .review-item { margin-bottom: 15px; padding: 15px; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--button-bg); transition: background-color 0.3s ease, border-color 0.3s ease; }
           .review-item.hidden-by-filter { display: none; }
           .review-item-qnum { font-weight: bold; margin-bottom: 8px; color: var(--text-secondary); }
           .review-item-question { margin-bottom: 10px; line-height: 1.5; color: var(--text-primary); }
           .review-item-details span { display: block; margin-bottom: 5px; font-size: 0.95em; color: var(--text-primary); }
           .review-item-details .correct-answer { color: #28a745; font-weight: bold; }
           .review-item-details .user-answer-correct { color: #28a745; } .review-item-details .user-answer-incorrect { color: #dc3545; text-decoration: line-through; } .review-item-details .user-answer-skipped { color: #fd7e14; font-style: italic; }
           .review-footer { text-align: center; padding-top: 20px; border-top: 1px solid var(--border-color); margin-top: auto; flex-shrink: 0; display: flex; justify-content: center; gap: 15px; }
           #exit-review-btn, #save-review-btn { background-color: var(--accent-color); color: var(--send-button-text); border: none; border-radius: 6px; padding: 10px 25px; cursor: pointer; font-size: 1em; transition: background-color 0.2s ease; }
           #exit-review-btn:hover, #save-review-btn:hover:not(:disabled) { background-color: var(--send-button-hover-bg); }
           #save-review-btn { background-color: var(--button-bg); color: var(--text-primary); border: 1px solid var(--border-color); }
           #save-review-btn:hover:not(:disabled) { background-color: var(--button-hover-bg); }
           #save-review-btn:disabled { opacity: 0.6; cursor: not-allowed; background-color: #cccccc; border-color: #aaaaaa; }

    </style>
</head>
<body>

    <!-- App Container -->
    <div class="app-container" id="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header" data-translate-key="geminiChat">Gemini Chat</div>

            <!-- NEW: Test History Button -->
            <a href="testhistory.html" class="sidebar-button" id="test-history-link" data-translate-key="testHistoryLink">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1s-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 18H5V5h14v16z"/><path d="M12 6c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm.01 11c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.23 5-5 5zm-1-8h2v5h-2z"/></svg>
                <span data-translate-key="testHistory">Test History</span>
            </a>

            <button class="start-chat-button" id="start-chat" disabled>
                 <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg>
                 <span data-translate-key="startNewChat">Start new chat</span>
            </button>

            <div class="sidebar-section-title" data-translate-key="chats">Chats</div>
            <div class="chat-list" id="chat-list">
                 <div style="padding:10px;color:var(--text-secondary);font-size:0.9em;" data-translate-key="loginToSeeChats">Please log in to see chats.</div>
            </div>

            <div class="sidebar-footer">
                <div class="sidebar-controls">
                     <div class="text-size-controls">
                         <span data-translate-key="textSize">Text Size</span>
                         <div class="text-size-buttons">
                             <button id="decrease-text-size" title="Decrease text size" disabled data-translate-title="decreaseTextSizeTitle">-</button>
                             <button id="increase-text-size" title="Increase text size" disabled data-translate-title="increaseTextSizeTitle">+</button>
                         </div>
                     </div>
                     <div class="theme-toggle">
                         <button id="theme-toggle-button" title="Toggle Theme" disabled data-translate-title="toggleThemeTitle">‚òÄÔ∏è</button>
                     </div>
                     <!-- NEW: Language Toggle -->
                     <div class="language-toggle">
                          <button id="language-toggle-button" title="Change Language" disabled data-translate-title="changeLanguageTitle">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</button>
                      </div>
                </div>
                 <div id="auth-controls">
                     <button id="login-google-btn" data-translate-key="loginWithGoogle">Login with Google</button>
                     <button id="logout-btn" style="display: none;" data-translate-key="logout">Logout</button>
                 </div>
                 <div class="account-info">
                     <div class="account-avatar" id="account-avatar">?</div>
                     <div class="account-details">
                         <div class="account-email" id="account-email" data-translate-key="notLoggedIn">Not logged in</div>
                         <div class="account-plan" id="account-plan"></div>
                     </div>
                 </div>
            </div>
        </div>

        <!-- Main Area Container (Chat / Review) -->
        <div class="main-container">
            <!-- Chat View -->
            <div class="main-content active" id="main-content-chat">
                 <div class="chat-area" id="chat-area"></div>
                 <div class="input-container" id="input-container">
                     <div class="suggestions" id="suggestions">
                          <button class="suggestion-chip" data-prompt="5 questions about US History">5 Qs US History (Check MCQ)</button>
                          <button class="suggestion-chip" data-prompt="What is recursion?">Recursion?</button>
                          <button class="suggestion-chip" data-prompt="Explain $\lim_{x\to 0} \frac{\sin x}{x} = 1$">Limit sin(x)/x ?</button>
                     </div>
                    <div class="input-box">
                        <textarea id="user-input" placeholder="Enter prompt..." rows="1" data-translate-placeholder="enterPromptMCQ"></textarea>
                        <div class="mcq-mode-control">
                            <input type="checkbox" id="mcq-mode-checkbox" title="Check to generate MCQs" data-translate-title="mcqCheckboxTitle">
                            <label for="mcq-mode-checkbox">MCQs?</label>
                        </div>
                        <button id="send-button" title="Send message" disabled data-translate-title="sendMessageTitle">
                            <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
                        </button>
                    </div>
                </div>
            </div>
            <!-- Review View (Immediate review after test) -->
             <div class="review-view" id="review-view">
                 <div class="review-header">
                     <h2 data-translate-key="testReview">Test Review</h2>
                     <div class="review-summary" id="review-summary"></div>
                     <div class="review-filters" id="review-filters">
                         <button data-filter="all" class="active-filter" data-translate-key="filterAll">All</button>
                         <button data-filter="incorrect" data-translate-key="filterIncorrect">Incorrect</button>
                         <button data-filter="skipped" data-translate-key="filterSkipped">Skipped</button>
                     </div>
                 </div>
                 <div class="review-content" id="review-content"></div>
                 <div class="review-footer">
                     <button id="save-review-btn" data-translate-key="saveReview">Save Review</button>
                     <button id="exit-review-btn" data-translate-key="backToChat">Back to Chat</button>
                 </div>
             </div>
        </div>
    </div>

    <!-- Mock Test View (Overlay for taking test) -->
    <div class="mock-test-view" id="mock-test-view">
        <div class="test-header">
            <h2 id="test-title" data-translate-key="mockTest">Mock Test</h2>
            <div class="test-info">
                <span id="question-counter">Q: 1 / N</span>
                <span id="test-timer" data-translate-key="timeLabel">Time: 00:00</span>
            </div>
        </div>
        <div class="test-content">
            <div class="test-question-container">
                <div class="test-question-number" id="test-question-number"></div>
                <div class="test-question" id="test-question"></div>
                <div class="test-options" id="test-options"></div>
            </div>
        </div>
        <div class="test-navigation">
            <button id="prev-question-btn" disabled data-translate-key="previous">Previous</button>
            <button id="next-question-btn" data-translate-key="next">Next</button>
            <button id="submit-test-btn" data-translate-key="submitTest">Submit Test</button>
        </div>
    </div>

    <script>
        // --- Firebase Config (‡Æ™‡Ææ‡Æ§‡ØÅ‡Æï‡Ææ‡Æ™‡Øç‡Æ™‡ØÅ ‡Æé‡Æö‡Øç‡Æö‡Æ∞‡Æø‡Æï‡Øç‡Æï‡Øà‡ÆØ‡ØÅ‡Æü‡Æ©‡Øç) ---
        const firebaseConfig = { /* ... ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç config ... */
          apiKey: "AIzaSyDgw604fe5jnNu4kTOv1cQ-3n7PL8gcN58",
          authDomain: "krish-c5db8.firebaseapp.com",
          projectId: "krish-c5db8",
          storageBucket: "krish-c5db8.appspot.com",
          messagingSenderId: "217175257890",
          appId: "1:217175257890:web:209f0f290eabab6b1fab7b",
          measurementId: "G-97SHYGL2J4"
        };
        firebase.initializeApp(firebaseConfig);
        const fbAuth = firebase.auth();
        const db = firebase.firestore();

        // --- DOM Elements (‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡ÆÆ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà) ---
        const appContainer = document.getElementById('app-container');
        // ... (‡ÆÆ‡Æ±‡Øç‡Æ± elements ‡ÆÆ‡ØÅ‡Æ®‡Øç‡Æ§‡Øà‡ÆØ‡Æ§‡ØÅ ‡Æ™‡Øã‡Æ≤‡Æµ‡Øá) ...
        const chatArea = document.getElementById('chat-area');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const suggestionsContainer = document.getElementById('suggestions');
        const startChatButton = document.getElementById('start-chat');
        const chatListContainer = document.getElementById('chat-list');
        const accountEmail = document.getElementById('account-email');
        const accountAvatar = document.getElementById('account-avatar');
        const accountPlan = document.getElementById('account-plan');
        const decreaseTextBtn = document.getElementById('decrease-text-size');
        const increaseTextBtn = document.getElementById('increase-text-size');
        const themeToggleButton = document.getElementById('theme-toggle-button');
        const mainContainer = document.querySelector('.main-container');
        const chatView = document.getElementById('main-content-chat');
        const testView = document.getElementById('mock-test-view');
        const reviewView = document.getElementById('review-view');
        const inputContainer = document.getElementById('input-container');
        const mcqModeCheckbox = document.getElementById('mcq-mode-checkbox');
        const loginBtn = document.getElementById('login-google-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const testTitle = document.getElementById('test-title');
        const questionCounter = document.getElementById('question-counter');
        const testTimer = document.getElementById('test-timer');
        const testQuestionNumber = document.getElementById('test-question-number');
        const testQuestion = document.getElementById('test-question');
        const testOptionsContainer = document.getElementById('test-options');
        const prevQuestionBtn = document.getElementById('prev-question-btn');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const submitTestBtn = document.getElementById('submit-test-btn');
        const reviewSummary = document.getElementById('review-summary');
        const reviewContent = document.getElementById('review-content');
        const exitReviewBtn = document.getElementById('exit-review-btn');
        const reviewFilters = document.getElementById('review-filters');
        const saveReviewBtn = document.getElementById('save-review-btn');
        const languageToggleButton = document.getElementById('language-toggle-button'); // New

        // --- Config & Constants ---
        const MODEL_NAME="gemini-1.5-flash-latest";
        const API_URL_BASE=`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=`;
        const STORAGE_KEY_API_KEY='geminiApiKey';
        const STORAGE_KEY_LANGUAGE = 'geminiChatLanguage'; // For storing language preference
        const NEW_CHAT_TITLE_EN = "(New Chat)";
        const NEW_CHAT_TITLE_TA = "(‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ ‡Æâ‡Æ∞‡Øà‡ÆØ‡Ææ‡Æü‡Æ≤‡Øç)";
        const TEXT_SIZE_STEP=0.1;
        const MIN_TEXT_SIZE_MULTIPLIER=0.7;
        const MAX_TEXT_SIZE_MULTIPLIER=1.5;
        const LIGHT_THEME_ICON='‚òÄÔ∏è';
        const DARK_THEME_ICON='üåô';
        const DELETE_ICON = '√ó';

        // --- State Variables ---
        let API_KEY='';
        let currentUser = null;
        let activeChatId = null;
        let currentChatHistory=[];
        let currentTextSizeMultiplier=1.0;
        let currentTheme='light';
        let currentLanguage = 'en'; // Default language
        let isTestMode=false;
        let isReviewMode=false;
        let currentTestMCQs=[];
        let currentQuestionIndex=0;
        let userAnswers=[];
        let testStartTime=null;
        let testTimerInterval=null;
        let generatedMCQData=null;
        let reviewResultsCache = null;
        let activeChatListener = null;
        let chatListListener = null;
        let isDeletingChat = false;

        // --- Translations ---
        const translations = {
            en: {
                geminiChat: "Gemini Chat", testHistoryLink: "Test History", testHistory: "Test History", startNewChat: "Start new chat", chats: "Chats",
                loginToSeeChats: "Please log in to see chats.", textSize: "Text Size", decreaseTextSizeTitle: "Decrease text size", increaseTextSizeTitle: "Increase text size",
                toggleThemeTitle: "Toggle Theme", changeLanguageTitle: "Change Language", changeLanguageTo: "‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç", loginWithGoogle: "Login with Google",
                logout: "Logout", notLoggedIn: "Not logged in", firebaseUser: "Firebase User", enterPromptMCQ: "Enter prompt (Check 'MCQs?' to generate test)",
                mcqCheckboxTitle: "Check to generate MCQs based on your prompt", sendMessageTitle: "Send message", loading: "Loading...", sending: "Sending...",
                thinking: "Thinking...", creatingChat: "Creating chat...", deletingChat: "Deleting chat...", loginPrompt: "Please log in to start chatting or view your history.",
                welcome: "Welcome!", goodDay: "Good day, {name}!", selectOrCreateChat: "Select a chat or start a new one.", loginToCreateChat: "Please log in to create a new chat.",
                failedToCreateChat: "Failed to create chat.", loginToDeleteChat: "Please log in to delete chats.", confirmDelete: 'Are you sure you want to permanently delete "{title}" and all its messages?',
                failedToDeleteChat: "Failed to delete chat. Check permissions or network.", apiKeyMissing: "Gemini API Key required. Reload to enter.",
                invalidApiKey: "Invalid Gemini API Key cleared. Reload to enter new key.", apiError: "API error ({status})", unknownApiError: "Unknown API error",
                blockedResponse: "Blocked: {reason}", emptyResponse: "Sorry, I received an empty response.", failedToParseResponse: "Error: Could not extract valid text from response.",
                failedToSaveUserMsg: "Failed to send message. Please try again.", failedToSaveChanges: "Error saving response. It might not appear.", networkError: "Error: {message} or Network error.",
                mcqsGenerated: "Generated {count} MCQs. Click below to start the test.", startMockTestBtn: "Start Mock Test ({count} Questions)",
                loginToStartTest: "Please log in to start a test.", noQuestionsForTest: "No questions available for this test.",
                testReview: "Test Review", filterAll: "All", filterIncorrect: "Incorrect", filterSkipped: "Skipped", saveReview: "Save Review", backToChat: "Back to Chat",
                mockTest: "Mock Test", timeLabel: "Time:", previous: "Previous", next: "Next", submitTest: "Submit Test", confirmSubmit: "Are you sure you want to submit the test?",
                scoreLabel: "Score:", correctLabel: "Correct:", incorrectLabel: "Incorrect:", skippedLabel: "Skipped:", totalTimeLabel: "Total Time:",
                yourAnswerLabel: "Your Answer:", correctAnswerLabel: "Correct Answer:", skippedAnswerText: "Skipped", invalidSelectionText: "Invalid Selection",
                loginToSaveReview: "Please log in to save the review.", noReviewData: "No review data available to save.", savingReview: "Saving...", reviewSaved: "Review Saved", failedToSaveReview: "Failed to save review. Please try again.",
                // Titles added for consistency
                chatTitleUntitled: "(New Chat)",
            },
            ta: {
                geminiChat: "Gemini ‡Æâ‡Æ∞‡Øà‡ÆØ‡Ææ‡Æü‡Æ≤‡Øç", testHistoryLink: "‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ ‡Æµ‡Æ∞‡Æ≤‡Ææ‡Æ±‡ØÅ", testHistory: "‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ ‡Æµ‡Æ∞‡Æ≤‡Ææ‡Æ±‡ØÅ", startNewChat: "‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ ‡Æâ‡Æ∞‡Øà‡ÆØ‡Ææ‡Æü‡Æ≤‡Øç", chats: "‡Æâ‡Æ∞‡Øà‡ÆØ‡Ææ‡Æü‡Æ≤‡Øç‡Æï‡Æ≥‡Øç",
                loginToSeeChats: "‡Æâ‡Æ∞‡Øà‡ÆØ‡Ææ‡Æü‡Æ≤‡Øç‡Æï‡Æ≥‡Øà‡Æ™‡Øç ‡Æ™‡Ææ‡Æ∞‡Øç‡Æï‡Øç‡Æï ‡Æâ‡Æ≥‡Øç‡Æ®‡ØÅ‡Æ¥‡Øà‡ÆØ‡Æµ‡ØÅ‡ÆÆ‡Øç.", textSize: "‡Æé‡Æ¥‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ ‡ÆÖ‡Æ≥‡Æµ‡ØÅ", decreaseTextSizeTitle: "‡Æé‡Æ¥‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ ‡ÆÖ‡Æ≥‡Æµ‡Øà‡Æï‡Øç ‡Æï‡ØÅ‡Æ±‡Øà‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç", increaseTextSizeTitle: "‡Æé‡Æ¥‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ ‡ÆÖ‡Æ≥‡Æµ‡Øà ‡ÆÖ‡Æ§‡Æø‡Æï‡Æ∞‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç",
                toggleThemeTitle: "Theme ‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡Æµ‡ØÅ‡ÆÆ‡Øç", changeLanguageTitle: "‡ÆÆ‡Øä‡Æ¥‡Æø‡ÆØ‡Øà ‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡Æµ‡ØÅ‡ÆÆ‡Øç", changeLanguageTo: "English", loginWithGoogle: "Google ‡ÆÆ‡ØÇ‡Æ≤‡ÆÆ‡Øç ‡Æâ‡Æ≥‡Øç‡Æ®‡ØÅ‡Æ¥‡Øà‡Æï",
                logout: "‡Æµ‡ØÜ‡Æ≥‡Æø‡ÆØ‡Øá‡Æ±‡ØÅ", notLoggedIn: "‡Æâ‡Æ≥‡Øç‡Æ®‡ØÅ‡Æ¥‡Øà‡ÆØ‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà", firebaseUser: "Firebase ‡Æ™‡ÆØ‡Æ©‡Æ∞‡Øç", enterPromptMCQ: "‡Æï‡Øá‡Æ≥‡Øç‡Æµ‡Æø‡ÆØ‡Øà ‡Æâ‡Æ≥‡Øç‡Æ≥‡Æø‡Æü‡Æµ‡ØÅ‡ÆÆ‡Øç ('MCQs?' ‡Æé‡Æ©‡Øç‡Æ™‡Æ§‡Øà ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡Ææ‡Æ≤‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ ‡Æâ‡Æ∞‡ØÅ‡Æµ‡Ææ‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡ØÅ‡ÆÆ‡Øç)",
                mcqCheckboxTitle: "‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æï‡Øá‡Æ≥‡Øç‡Æµ‡Æø ‡ÆÖ‡Æü‡Æø‡Æ™‡Øç‡Æ™‡Æü‡Øà‡ÆØ‡Æø‡Æ≤‡Øç MCQ ‡Æï‡Æ≥‡Øà ‡Æâ‡Æ∞‡ØÅ‡Æµ‡Ææ‡Æï‡Øç‡Æï ‡Æá‡Æ§‡Øà‡Æ§‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ‡Æö‡ØÜ‡ÆØ‡Øç‡Æï", sendMessageTitle: "‡ÆÖ‡Æ©‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ", loading: "‡Æè‡Æ±‡Øç‡Æ±‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ...", sending: "‡ÆÖ‡Æ©‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ...",
                thinking: "‡Æö‡Æø‡Æ®‡Øç‡Æ§‡Æø‡Æï‡Øç‡Æï‡Æø‡Æ±‡Æ§‡ØÅ...", creatingChat: "‡Æâ‡Æ∞‡Øà‡ÆØ‡Ææ‡Æü‡Æ≤‡Øà ‡Æâ‡Æ∞‡ØÅ‡Æµ‡Ææ‡Æï‡Øç‡Æï‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ...", deletingChat: "‡Æâ‡Æ∞‡Øà‡ÆØ‡Ææ‡Æü‡Æ≤‡Øà ‡Æ®‡ØÄ‡Æï‡Øç‡Æï‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ...", loginPrompt: "‡Æâ‡Æ∞‡Øà‡ÆØ‡Ææ‡Æü‡Æ≤‡Øà‡Æ§‡Øç ‡Æ§‡Øä‡Æü‡Æô‡Øç‡Æï ‡ÆÖ‡Æ≤‡Øç‡Æ≤‡Æ§‡ØÅ ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æµ‡Æ∞‡Æ≤‡Ææ‡Æ±‡Øç‡Æ±‡Øà‡Æï‡Øç ‡Æï‡Ææ‡Æ£ sidebar-‡Æá‡Æ≤‡Øç ‡Æâ‡Æ≥‡Øç‡Æ≥ Google ‡Æ™‡Øä‡Æ§‡Øç‡Æ§‡Ææ‡Æ©‡Øà‡Æ™‡Øç ‡Æ™‡ÆØ‡Æ©‡Øç‡Æ™‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡Æø ‡Æâ‡Æ≥‡Øç‡Æ®‡ØÅ‡Æ¥‡Øà‡ÆØ‡Æµ‡ØÅ‡ÆÆ‡Øç.",
                welcome: "‡Æµ‡Æ∞‡ØÅ‡Æï!", goodDay: "‡Æµ‡Æ£‡Æï‡Øç‡Æï‡ÆÆ‡Øç, {name}!", selectOrCreateChat: "‡Æí‡Æ∞‡ØÅ ‡Æâ‡Æ∞‡Øà‡ÆØ‡Ææ‡Æü‡Æ≤‡Øà‡Æ§‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç ‡ÆÖ‡Æ≤‡Øç‡Æ≤‡Æ§‡ØÅ ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ‡Æ§‡Ææ‡Æï‡Æ§‡Øç ‡Æ§‡Øä‡Æü‡Æô‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç.", loginToCreateChat: "‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ ‡Æâ‡Æ∞‡Øà‡ÆØ‡Ææ‡Æü‡Æ≤‡Øà ‡Æâ‡Æ∞‡ØÅ‡Æµ‡Ææ‡Æï‡Øç‡Æï ‡Æâ‡Æ≥‡Øç‡Æ®‡ØÅ‡Æ¥‡Øà‡ÆØ‡Æµ‡ØÅ‡ÆÆ‡Øç.",
                failedToCreateChat: "Chat-‡Æê ‡Æâ‡Æ∞‡ØÅ‡Æµ‡Ææ‡Æï‡Øç‡Æï ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà.", loginToDeleteChat: "‡Æâ‡Æ∞‡Øà‡ÆØ‡Ææ‡Æü‡Æ≤‡Øç‡Æï‡Æ≥‡Øà ‡Æ®‡ØÄ‡Æï‡Øç‡Æï ‡Æâ‡Æ≥‡Øç‡Æ®‡ØÅ‡Æ¥‡Øà‡ÆØ‡Æµ‡ØÅ‡ÆÆ‡Øç.", confirmDelete: '"{title}" ‡ÆÆ‡Æ±‡Øç‡Æ±‡ØÅ‡ÆÆ‡Øç ‡ÆÖ‡Æ§‡Æ©‡Øç ‡ÆÖ‡Æ©‡Øà‡Æ§‡Øç‡Æ§‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡Æø‡Æï‡Æ≥‡Øà‡ÆØ‡ØÅ‡ÆÆ‡Øç ‡Æ®‡Æø‡Æ∞‡Æ®‡Øç‡Æ§‡Æ∞‡ÆÆ‡Ææ‡Æï ‡Æ®‡ØÄ‡Æï‡Øç‡Æï ‡Æµ‡Æø‡Æ∞‡ØÅ‡ÆÆ‡Øç‡Æ™‡ØÅ‡Æï‡Æø‡Æ±‡ØÄ‡Æ∞‡Øç‡Æï‡Æ≥‡Ææ?',
                failedToDeleteChat: "‡Æâ‡Æ∞‡Øà‡ÆØ‡Ææ‡Æü‡Æ≤‡Øà ‡Æ®‡ØÄ‡Æï‡Øç‡Æï ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà. ‡ÆÖ‡Æ©‡ØÅ‡ÆÆ‡Æ§‡Æø‡Æï‡Æ≥‡Øç ‡ÆÖ‡Æ≤‡Øç‡Æ≤‡Æ§‡ØÅ ‡Æ™‡Æø‡Æ£‡Øà‡ÆØ ‡Æá‡Æ£‡Øà‡Æ™‡Øç‡Æ™‡Øà‡Æö‡Øç ‡Æö‡Æ∞‡Æø‡Æ™‡Ææ‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç.", apiKeyMissing: "Gemini API Key ‡Æ§‡Øá‡Æµ‡Øà. ‡ÆÆ‡ØÄ‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡Æè‡Æ±‡Øç‡Æ±‡Æµ‡ØÅ‡ÆÆ‡Øç.",
                invalidApiKey: "‡Æ§‡Æµ‡Æ±‡Ææ‡Æ© Gemini API Key ‡Æ®‡ØÄ‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ. ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ key-‡Æê ‡Æâ‡Æ≥‡Øç‡Æ≥‡Æø‡Æü reload ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡Æµ‡ØÅ‡ÆÆ‡Øç.", apiError: "API ‡Æ™‡Æø‡Æ¥‡Øà ({status})", unknownApiError: "‡Æ§‡ØÜ‡Æ∞‡Æø‡ÆØ‡Ææ‡Æ§ API ‡Æ™‡Æø‡Æ¥‡Øà",
                blockedResponse: "‡Æ§‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ: {reason}", emptyResponse: "‡ÆÆ‡Æ©‡Øç‡Æ©‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç, ‡Æµ‡ØÜ‡Æ±‡Øç‡Æ±‡ØÅ‡Æ™‡Øç ‡Æ™‡Æ§‡Æø‡Æ≤‡Øç ‡Æï‡Æø‡Æü‡Øà‡Æ§‡Øç‡Æ§‡Æ§‡ØÅ.", failedToParseResponse: "‡Æ™‡Æø‡Æ¥‡Øà: ‡Æ™‡Æ§‡Æø‡Æ≤‡Æø‡Æ≤‡Æø‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æö‡Æ∞‡Æø‡ÆØ‡Ææ‡Æ© ‡Æâ‡Æ∞‡Øà‡ÆØ‡Øà‡Æ™‡Øç ‡Æ™‡Æø‡Æ∞‡Æø‡Æï‡Øç‡Æï ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà.",
                failedToSaveUserMsg: "‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡Æø‡ÆØ‡Øà ‡ÆÖ‡Æ©‡ØÅ‡Æ™‡Øç‡Æ™ ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà. ‡ÆÆ‡ØÄ‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡ÆÆ‡ØÅ‡ÆØ‡Æ±‡Øç‡Æö‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç.", failedToSaveChanges: "‡Æ™‡Æ§‡Æø‡Æ≤‡Øà‡Æö‡Øç ‡Æö‡Øá‡ÆÆ‡Æø‡Æ™‡Øç‡Æ™‡Æ§‡Æø‡Æ≤‡Øç ‡Æ™‡Æø‡Æ¥‡Øà. ‡ÆÖ‡Æ§‡ØÅ ‡Æ§‡Øã‡Æ©‡Øç‡Æ±‡Ææ‡ÆÆ‡Æ≤‡Øç ‡Æ™‡Øã‡Æï‡Æ≤‡Ææ‡ÆÆ‡Øç.", networkError: "‡Æ™‡Æø‡Æ¥‡Øà: {message} ‡ÆÖ‡Æ≤‡Øç‡Æ≤‡Æ§‡ØÅ ‡Æ™‡Æø‡Æ£‡Øà‡ÆØ‡Æ™‡Øç ‡Æ™‡Æø‡Æ¥‡Øà.",
                mcqsGenerated: "{count} MCQ‡Æï‡Æ≥‡Øç ‡Æâ‡Æ∞‡ØÅ‡Æµ‡Ææ‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ©. ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡Øà‡Æ§‡Øç ‡Æ§‡Øä‡Æü‡Æô‡Øç‡Æï ‡Æï‡ØÄ‡Æ¥‡Øá ‡Æï‡Æø‡Æ≥‡Æø‡Æï‡Øç ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡Æµ‡ØÅ‡ÆÆ‡Øç.", startMockTestBtn: "‡ÆÆ‡Ææ‡Æ§‡Æø‡Æ∞‡Æø‡Æ§‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡Øà‡Æ§‡Øç ‡Æ§‡Øä‡Æü‡Æô‡Øç‡Æï‡ØÅ ({count} ‡Æï‡Øá‡Æ≥‡Øç‡Æµ‡Æø‡Æï‡Æ≥‡Øç)",
                loginToStartTest: "‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡Øà‡Æ§‡Øç ‡Æ§‡Øä‡Æü‡Æô‡Øç‡Æï ‡Æâ‡Æ≥‡Øç‡Æ®‡ØÅ‡Æ¥‡Øà‡ÆØ‡Æµ‡ØÅ‡ÆÆ‡Øç.", noQuestionsForTest: "‡Æá‡Æ®‡Øç‡Æ§‡Æ§‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ‡Æï‡Øç‡Æï‡ØÅ ‡Æï‡Øá‡Æ≥‡Øç‡Æµ‡Æø‡Æï‡Æ≥‡Øç ‡Æá‡Æ≤‡Øç‡Æ≤‡Øà.",
                testReview: "‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ ‡ÆÆ‡Æ±‡ØÅ‡Æ™‡Ææ‡Æ∞‡Øç‡Æµ‡Øà", filterAll: "‡ÆÖ‡Æ©‡Øà‡Æ§‡Øç‡Æ§‡ØÅ‡ÆÆ‡Øç", filterIncorrect: "‡Æ§‡Æµ‡Æ±‡Ææ‡Æ©‡Æµ‡Øà", filterSkipped: "‡Æ§‡Æµ‡Æø‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æµ‡Øà", saveReview: "‡ÆÆ‡Æ±‡ØÅ‡Æ™‡Ææ‡Æ∞‡Øç‡Æµ‡Øà‡ÆØ‡Øà ‡Æö‡Øá‡ÆÆ‡Æø", backToChat: "Chat-‡Æï‡Øç‡Æï‡ØÅ ‡Æ§‡Æø‡Æ∞‡ØÅ‡ÆÆ‡Øç‡Æ™‡ØÅ‡Æï",
                mockTest: "‡ÆÆ‡Ææ‡Æ§‡Æø‡Æ∞‡Æø‡Æ§‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ", timeLabel: "‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç:", previous: "‡ÆÆ‡ØÅ‡Æ®‡Øç‡Æ§‡Øà‡ÆØ‡Æ§‡ØÅ", next: "‡ÆÖ‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡Æ§‡ØÅ", submitTest: "‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡Øà‡Æö‡Øç ‡Æö‡ÆÆ‡Æ∞‡Øç‡Æ™‡Øç‡Æ™‡Æø", confirmSubmit: "‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡Øà‡Æö‡Øç ‡Æö‡ÆÆ‡Æ∞‡Øç‡Æ™‡Øç‡Æ™‡Æø‡Æï‡Øç‡Æï ‡Æµ‡Æø‡Æ∞‡ØÅ‡ÆÆ‡Øç‡Æ™‡ØÅ‡Æï‡Æø‡Æ±‡ØÄ‡Æ∞‡Øç‡Æï‡Æ≥‡Ææ?",
                scoreLabel: "‡ÆÆ‡Æ§‡Æø‡Æ™‡Øç‡Æ™‡ØÜ‡Æ£‡Øç:", correctLabel: "‡Æö‡Æ∞‡Æø:", incorrectLabel: "‡Æ§‡Æµ‡Æ±‡ØÅ:", skippedLabel: "‡Æ§‡Æµ‡Æø‡Æ∞‡Øç‡Æ§‡Øç‡Æ§‡Æµ‡Øà:", totalTimeLabel: "‡ÆÆ‡Øä‡Æ§‡Øç‡Æ§ ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç:",
                yourAnswerLabel: "‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æ™‡Æ§‡Æø‡Æ≤‡Øç:", correctAnswerLabel: "‡Æö‡Æ∞‡Æø‡ÆØ‡Ææ‡Æ© ‡Æ™‡Æ§‡Æø‡Æ≤‡Øç:", skippedAnswerText: "‡Æ§‡Æµ‡Æø‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ", invalidSelectionText: "‡Æ§‡Æµ‡Æ±‡Ææ‡Æ© ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ",
                loginToSaveReview: "‡ÆÆ‡Æ±‡ØÅ‡Æ™‡Ææ‡Æ∞‡Øç‡Æµ‡Øà‡ÆØ‡Øà‡Æö‡Øç ‡Æö‡Øá‡ÆÆ‡Æø‡Æï‡Øç‡Æï ‡Æâ‡Æ≥‡Øç‡Æ®‡ØÅ‡Æ¥‡Øà‡ÆØ‡Æµ‡ØÅ‡ÆÆ‡Øç.", noReviewData: "‡Æö‡Øá‡ÆÆ‡Æø‡Æï‡Øç‡Æï ‡ÆÆ‡Æ±‡ØÅ‡Æ™‡Ææ‡Æ∞‡Øç‡Æµ‡Øà‡Æ§‡Øç ‡Æ§‡Æ∞‡Æµ‡ØÅ ‡Æá‡Æ≤‡Øç‡Æ≤‡Øà.", savingReview: "‡Æö‡Øá‡ÆÆ‡Æø‡Æï‡Øç‡Æï‡Æø‡Æ±‡Æ§‡ØÅ...", reviewSaved: "‡Æö‡Øá‡ÆÆ‡Æø‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ", failedToSaveReview: "‡ÆÆ‡Æ±‡ØÅ‡Æ™‡Ææ‡Æ∞‡Øç‡Æµ‡Øà‡ÆØ‡Øà‡Æö‡Øç ‡Æö‡Øá‡ÆÆ‡Æø‡Æï‡Øç‡Æï ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà. ‡ÆÆ‡ØÄ‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡ÆÆ‡ØÅ‡ÆØ‡Æ±‡Øç‡Æö‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç.",
                 // Titles added for consistency
                 chatTitleUntitled: "(‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ ‡Æâ‡Æ∞‡Øà‡ÆØ‡Ææ‡Æü‡Æ≤‡Øç)",
            }
        };

        // --- Initialization ---
        initializeApp();

        // --- Event Listeners ---
        sendButton.addEventListener('click', handleSendMessage);
        userInput.addEventListener('input', autoGrowTextarea);
        userInput.addEventListener('keydown', handleInputKeydown);
        suggestionsContainer.addEventListener('click', handleSuggestionClick);
        startChatButton.addEventListener('click', createNewChat);
        chatListContainer.addEventListener('click', handleChatListClick);
        decreaseTextBtn.addEventListener('click', () => adjustTextSize(-TEXT_SIZE_STEP));
        increaseTextBtn.addEventListener('click', () => adjustTextSize(TEXT_SIZE_STEP));
        themeToggleButton.addEventListener('click', toggleTheme);
        languageToggleButton.addEventListener('click', toggleLanguage); // New
        prevQuestionBtn.addEventListener('click', () => handleTestNavigation('prev'));
        nextQuestionBtn.addEventListener('click', () => handleTestNavigation('next'));
        submitTestBtn.addEventListener('click', submitTest);
        exitReviewBtn.addEventListener('click', exitReview);
        chatArea.addEventListener('click', handleChatAreaClick);
        reviewFilters.addEventListener('click', handleReviewFilterClick);
        saveReviewBtn.addEventListener('click', saveTestReviewToCloud);
        loginBtn.addEventListener('click', signInWithGoogle);
        logoutBtn.addEventListener('click', signOut);


        // --- Initialization Functions ---
        async function initializeApp() {
            loadGeminiApiKey();
            loadLanguage(); // Load language preference
            fbAuth.onAuthStateChanged(handleAuthStateChange);
            switchView('chat');
            userInput.focus();
            applyStaticTranslations(); // Apply initial translations for non-dynamic elements
        }

        function loadGeminiApiKey() { /* ... (‡Æ™‡Ææ‡Æ§‡ØÅ‡Æï‡Ææ‡Æ™‡Øç‡Æ™‡ØÅ ‡Æé‡Æö‡Øç‡Æö‡Æ∞‡Æø‡Æï‡Øç‡Æï‡Øà‡ÆØ‡ØÅ‡Æü‡Æ©‡Øç) ... */
             console.warn("‡Æ™‡Ææ‡Æ§‡ØÅ‡Æï‡Ææ‡Æ™‡Øç‡Æ™‡ØÅ ‡Æé‡Æö‡Øç‡Æö‡Æ∞‡Æø‡Æï‡Øç‡Æï‡Øà: Gemini API Key localStorage-‡Æ≤‡Øç ‡Æö‡Øá‡ÆÆ‡Æø‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ.");
             const k=localStorage.getItem(STORAGE_KEY_API_KEY);
             if(k){ API_KEY=k; }
             else { API_KEY=prompt("--- ‡Æ™‡Ææ‡Æ§‡ØÅ‡Æï‡Ææ‡Æ™‡Øç‡Æ™‡Æ±‡Øç‡Æ± ‡Æü‡ØÜ‡ÆÆ‡Øã ---\nGemini API Key-‡Æê ‡Æâ‡Æ≥‡Øç‡Æ≥‡Æø‡Æü‡Æµ‡ØÅ‡ÆÆ‡Øç:");
                  if(API_KEY){ localStorage.setItem(STORAGE_KEY_API_KEY, API_KEY); }
                  else { displayError(getTranslation("apiKeyMissing")); setLoadingState(true, "API Key ‡Æá‡Æ≤‡Øç‡Æ≤‡Øà"); }
             }
             setLoadingState(false);
         }

        // --- Language Functions ---
        function getTranslation(key, params = {}) {
            let text = translations[currentLanguage]?.[key] || translations['en']?.[key] || key;
            for (const param in params) {
                text = text.replace(`{${param}}`, params[param]);
            }
            return text;
        }

        function applyTranslations() {
            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.dataset.translateKey;
                const translation = getTranslation(key);
                if (el.tagName === 'TEXTAREA' || el.tagName === 'INPUT') {
                    if (el.placeholder) el.placeholder = translation;
                } else if (el.title && el.dataset.translateTitle === key) { // Check if title needs translation specifically
                    el.title = translation;
                }
                 else {
                    // Handle elements where only part of the text needs translation (like sidebar buttons)
                    const span = el.querySelector('span[data-translate-key]');
                    if (span && span.dataset.translateKey === key) {
                        span.textContent = translation;
                    } else if (!el.querySelector('[data-translate-key]')) { // Avoid overwriting if child has key
                        el.textContent = translation;
                    }
                 }
            });
            // Update dynamic elements specifically
            if (currentUser) {
                renderGreetingOrLoginPrompt(); // Re-render greeting
            }
             updateLanguageButton();
             renderSidebarChatListBasedOnState(); // Re-render chat list with potentially new titles
             updatePlaceholders(); // Update input placeholders based on state and language
        }

        // Apply translations to elements that don't change often after initial load
         function applyStaticTranslations() {
             applyTranslations(); // Call the main function initially
         }

        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem(STORAGE_KEY_LANGUAGE, lang);
            document.documentElement.lang = lang; // Set page language attribute
            applyTranslations(); // Update all UI elements
        }

        function toggleLanguage() {
            const newLang = currentLanguage === 'en' ? 'ta' : 'en';
            setLanguage(newLang);
        }

        function loadLanguage() {
            const savedLang = localStorage.getItem(STORAGE_KEY_LANGUAGE);
            currentLanguage = savedLang || 'en'; // Default to English if nothing saved
             document.documentElement.lang = currentLanguage;
            updateLanguageButton();
        }

        function updateLanguageButton() {
             if (languageToggleButton) {
                 languageToggleButton.textContent = getTranslation('changeLanguageTo');
                 languageToggleButton.disabled = !currentUser; // Disable if logged out
             }
         }

         // Helper to update placeholders based on current state and language
         function updatePlaceholders() {
             if (isLoadingState()) { // Check if currently loading
                 // Placeholder set by setLoadingState
             } else if (!currentUser) {
                 userInput.placeholder = getTranslation("pleaseLogIn");
             } else if (!activeChatId && !isDeletingChat) {
                 userInput.placeholder = getTranslation("selectOrCreateChat");
             } else if (!activeChatId && isDeletingChat) {
                 userInput.placeholder = getTranslation("loading");
             } else {
                 userInput.placeholder = getTranslation("enterPromptMCQ");
             }
         }

         // Helper to check loading state (avoids direct access)
         function isLoadingState() {
             return userInput.disabled && userInput.placeholder !== getTranslation("pleaseLogIn") && userInput.placeholder !== getTranslation("selectOrCreateChat");
         }


        // --- Authentication ---
        async function signInWithGoogle() { /* ... */
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                setLoadingState(true, getTranslation("loggingIn")); // Use translation
                await fbAuth.signInWithPopup(provider);
            } catch (error) {
                console.error("Google ‡Æâ‡Æ≥‡Øç‡Æ®‡ØÅ‡Æ¥‡Øà‡Æµ‡ØÅ ‡Æ™‡Æø‡Æ¥‡Øà:", error);
                displayError(getTranslation("loginFailed", { message: error.message })); // Use translation
                setLoadingState(false);
            }
         }
        async function signOut() { /* ... */
            try {
                setLoadingState(true, getTranslation("loggingOut")); // Use translation
                await fbAuth.signOut();
            } catch (error) {
                console.error("‡Æµ‡ØÜ‡Æ≥‡Æø‡ÆØ‡Øá‡Æ±‡ØÅ‡Æµ‡Æ§‡Æø‡Æ≤‡Øç ‡Æ™‡Æø‡Æ¥‡Øà:", error);
                displayError(getTranslation("logoutFailed", { message: error.message })); // Use translation
                setLoadingState(false);
            }
         }
        function handleAuthStateChange(user) {
             if (activeChatListener) { activeChatListener(); activeChatListener = null; }
             if (chatListListener) { chatListListener(); chatListListener = null; }
             chatArea.innerHTML = ''; chatListContainer.innerHTML = ''; activeChatId = null; currentChatHistory = [];

             const loggedIn = !!user; // Check if user exists

            // Update button disabled states
            startChatButton.disabled = !loggedIn;
            decreaseTextBtn.disabled = !loggedIn;
            increaseTextBtn.disabled = !loggedIn;
            themeToggleButton.disabled = !loggedIn;
            languageToggleButton.disabled = !loggedIn; // Enable/disable based on login
            sendButton.disabled = !loggedIn;
            userInput.disabled = !loggedIn;

            // Update login/logout button visibility
             loginBtn.style.display = loggedIn ? 'none' : 'inline-block';
             logoutBtn.style.display = loggedIn ? 'inline-block' : 'none';

             // Update input container visibility
            inputContainer.style.display = loggedIn ? 'block' : 'none';
            suggestionsContainer.style.display = loggedIn ? 'flex' : 'none';

            if (loggedIn) {
                 currentUser = user;
                 console.log("User logged in:", currentUser.uid);
                 accountEmail.textContent = currentUser.email || currentUser.displayName || getTranslation("firebaseUser");
                 accountAvatar.textContent = (currentUser.displayName || currentUser.email || 'U')[0].toUpperCase();
                 accountPlan.textContent = getTranslation("firebaseUser");

                 loadUserSettings(currentUser.uid); // Loads theme/size
                 loadAndListenForChats(currentUser.uid); // Loads chats
                 renderGreetingOrLoginPrompt(); // Render greeting
            } else {
                 currentUser = null;
                 console.log("User logged out");
                 accountEmail.textContent = getTranslation("notLoggedIn");
                 accountAvatar.textContent = '?';
                 accountPlan.textContent = "";
                 chatListContainer.innerHTML = `<div style="padding:10px;color:var(--text-secondary);font-size:0.9em;">${getTranslation("loginToSeeChats")}</div>`;
                 currentTheme = 'light'; applyTheme();
                 currentTextSizeMultiplier = 1.0; applyTextSize();
                 renderGreetingOrLoginPrompt(); // Render login prompt
            }
             updateLanguageButton(); // Update button text based on new state
             setLoadingState(false); // Ensure loading state is off
             updatePlaceholders(); // Update placeholder after state change
        }

        function renderGreetingOrLoginPrompt() {
            chatArea.innerHTML = '';
            const g = document.createElement('div'); g.classList.add('greeting');
            if (currentUser) {
                 g.innerHTML = `<span class="asterisk">*</span>${getTranslation("goodDay", { name: currentUser.displayName || 'User' })}!`;
                 chatArea.appendChild(g);
                 if (!activeChatId && !isDeletingChat) { // Avoid showing during delete transition
                    displayMessage(getTranslation("selectOrCreateChat"), 'ai');
                 }
            } else {
                g.innerHTML = `<span class="asterisk">*</span>${getTranslation("welcome")}!`;
                chatArea.appendChild(g);
                displayMessage(getTranslation("loginPrompt"), 'ai');
            }
            scrollToBottom(true);
        }


        // --- Settings (Theme/Text Size) --- (‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡ÆÆ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà)
        async function loadUserSettings(userId) { /* ... */ }
        async function saveUserSettings() { /* ... */ }
        function applyTheme() { /* ... */ }
        function toggleTheme() { /* ... */ }
        function applyTextSize() { /* ... */ }
        function adjustTextSize(change) { /* ... */ }

        // --- Chat Storage & Loading ---
        function loadAndListenForChats(userId) {
            if (chatListListener) { chatListListener(); chatListListener = null; }
            const chatsRef = db.collection('chats').where('userId', '==', userId).orderBy('lastUpdated', 'desc');
            console.log(`Listening for chats for user ${userId}`);
            chatListListener = chatsRef.onSnapshot(snapshot => {
                 if (isDeletingChat) { console.log("Skipping chat list update during delete."); return; }
                 const chats = []; snapshot.forEach(doc => { chats.push({ id: doc.id, ...doc.data() }); });
                 console.log("Received chat list snapshot:", chats);
                 renderSidebarChatList(chats);

                 let chatToLoad = null;
                 if (activeChatId && chats.some(c => c.id === activeChatId)) { chatToLoad = activeChatId; }
                 else if (chats.length > 0) { chatToLoad = chats[0].id; console.log("Active chat not found/deleted, selecting newest:", chatToLoad); }
                 else {
                     console.log("No chats found for user."); activeChatId = null;
                     if (activeChatListener) { activeChatListener(); activeChatListener = null; }
                     renderGreetingOrLoginPrompt(); // Show prompt for empty state
                 }

                 if (chatToLoad && chatToLoad !== activeChatId) { console.log("Switching chat:", chatToLoad); switchChat(chatToLoad); }
                 else if (activeChatId) { highlightActiveChatInSidebar(); }

            }, error => { console.error("Error listening for chats:", error); displayError(getTranslation("chatListError")); chatListContainer.innerHTML = `<div style="padding:10px;color:var(--text-secondary);font-size:0.9em;">${getTranslation("chatListError")}</div>`; });
        }

        // Helper function to render chat list based on current state (avoids duplication)
         function renderSidebarChatListBasedOnState() {
             if (currentUser && chatListListener) {
                 // Attempt to re-render using existing data if possible, or trigger listener again
                 // For simplicity, we'll just rely on the listener to update eventually.
                 // If immediate update needed, cache the 'chats' array from the listener.
                 console.log("Requesting sidebar re-render (listener will handle).");
             } else if (!currentUser) {
                 chatListContainer.innerHTML = `<div style="padding:10px;color:var(--text-secondary);font-size:0.9em;">${getTranslation("loginToSeeChats")}</div>`;
             }
         }


        function renderSidebarChatList(chats) {
            chatListContainer.innerHTML = '';
            if (!currentUser) { /* ... */ return; }
            const defaultTitle = getTranslation('chatTitleUntitled'); // Get translated default title
            if (chats.length === 0) { const i = document.createElement('div'); i.textContent = getTranslation("noChatsYet"); i.style.cssText = "padding:10px;color:var(--text-secondary);font-size:0.9em;"; chatListContainer.appendChild(i); }
            else {
                chats.forEach(c => {
                    const i = document.createElement('div'); i.classList.add('chat-list-item');
                    // Use translated default title if needed
                    let title = c.title || defaultTitle;
                    if (title === NEW_CHAT_TITLE_EN || title === NEW_CHAT_TITLE_TA) {
                         title = defaultTitle; // Ensure consistency with current language
                     }
                    if (typeof title !== 'string') title = '(Invalid Title)';
                    i.textContent = title; i.dataset.id = c.id; i.title = title;

                    const deleteBtn = document.createElement('button');
                    deleteBtn.classList.add('delete-chat-button'); deleteBtn.innerHTML = DELETE_ICON;
                    deleteBtn.title = getTranslation("deleteChatTitle"); deleteBtn.dataset.id = c.id;
                    i.appendChild(deleteBtn);
                    chatListContainer.appendChild(i);
                });
            }
            highlightActiveChatInSidebar();
        }

        function highlightActiveChatInSidebar() { /* ... */ }
        async function createNewChat() {
            if (!currentUser) { displayError(getTranslation("loginToCreateChat")); return; }
            setLoadingState(true, getTranslation("creatingChat"));
            const newChatRef = db.collection('chats').doc();
            const timestamp = firebase.firestore.FieldValue.serverTimestamp();
            try {
                await newChatRef.set({ userId: currentUser.uid, title: getTranslation('chatTitleUntitled'), createdAt: timestamp, lastUpdated: timestamp }); // Use translated default
                console.log("New chat created:", newChatRef.id);
            } catch (error) { console.error("Error creating chat:", error); displayError(getTranslation("failedToCreateChat")); }
            finally { setLoadingState(false); userInput.focus(); }
        }
        function handleChatListClick(event) {
             const target = event.target;
             if (target.classList.contains('delete-chat-button')) {
                 event.stopPropagation();
                 const chatId = target.dataset.id;
                 const chatItem = target.closest('.chat-list-item');
                 const chatTitle = chatItem?.title || 'this chat';
                 if (chatId) { confirmAndDeleteChat(chatId, chatTitle); }
                 return;
             }
             const item = target.closest('.chat-list-item'); const clickedId = item?.dataset?.id;
             if (clickedId && clickedId !== activeChatId) { switchChat(clickedId); }
        }
        function confirmAndDeleteChat(chatId, chatTitle) {
            if (!currentUser || !chatId) return;
            if (confirm(getTranslation("confirmDelete", { title: chatTitle }))) {
                deleteChatFromFirestore(chatId);
            }
        }
        async function deleteChatFromFirestore(chatId) {
            if (!currentUser || !chatId) return;
            console.log(`Attempting to delete chat: ${chatId}`);
            isDeletingChat = true; setLoadingState(true, getTranslation("deletingChat"));
            const chatDocRef = db.collection('chats').doc(chatId); const messagesRef = chatDocRef.collection('messages');
            try {
                const messagesSnapshot = await messagesRef.get();
                if (!messagesSnapshot.empty) { const batch = db.batch(); messagesSnapshot.docs.forEach(doc => { batch.delete(doc.ref); }); await batch.commit(); console.log(`Deleted ${messagesSnapshot.size} messages for chat ${chatId}`); }
                else { console.log(`No messages to delete for chat ${chatId}`); }
                await chatDocRef.delete(); console.log(`Successfully deleted chat document: ${chatId}`);
                if (activeChatId === chatId) {
                     console.log("Active chat was deleted. Resetting view."); activeChatId = null; currentChatHistory = [];
                     if (activeChatListener) { activeChatListener(); activeChatListener = null; }
                     chatArea.innerHTML = ''; renderGreetingOrLoginPrompt();
                }
            } catch (error) { console.error(`Error deleting chat ${chatId}:`, error); displayError(getTranslation("failedToDeleteChat")); }
            finally { isDeletingChat = false; setLoadingState(false); }
        }
        function switchChat(chatId) { /* ... */ }
        function loadAndListenForActiveChat(chatId) { /* ... */ }

        // --- Message Sending ---
        async function handleSendMessage() {
            const txt = userInput.value.trim();
            if (!API_KEY) { displayError(getTranslation("apiKeyMissing")); return; }
            if (!currentUser) { displayError(getTranslation("pleaseLogIn")); return; }
            if (!activeChatId) { displayError(getTranslation("selectOrCreateChat")); return; }
            if (!txt || sendButton.disabled) return;

            const isMCQRequest = mcqModeCheckbox.checked;
            setLoadingState(true, getTranslation("sending"));
            const userMessageText = txt;
            userInput.value = ''; autoGrowTextarea(); if (isMCQRequest) mcqModeCheckbox.checked = false;

            const timestamp = firebase.firestore.FieldValue.serverTimestamp();
            const messagesColRef = db.collection('chats').doc(activeChatId).collection('messages');
            const chatDocRef = db.collection('chats').doc(activeChatId);
            const defaultTitle = getTranslation('chatTitleUntitled'); // Get current language default

            let isFirstUserMessageInNewChat = false;
            try {
                 const chatSnap = await chatDocRef.get();
                 if (chatSnap.exists && (chatSnap.data().title === NEW_CHAT_TITLE_EN || chatSnap.data().title === NEW_CHAT_TITLE_TA || chatSnap.data().title === defaultTitle)) { // Check against both + current default
                      const messagesSnap = await messagesColRef.limit(1).get();
                      if (messagesSnap.empty) { isFirstUserMessageInNewChat = true; }
                 }
            } catch(err) { console.error("Error checking for first message:", err); }

            // 1. Save User Message
             const userMsgData = { role: "user", text: userMessageText, timestamp: timestamp };
             try {
                 await messagesColRef.add(userMsgData); await chatDocRef.update({ lastUpdated: timestamp }); console.log("User message saved.");
                 // Auto Title Update
                 if (isFirstUserMessageInNewChat) {
                     const generatedTitle = generateChatTitle(userMessageText);
                     const currentDefaultTitle = getTranslation('chatTitleUntitled');
                     if (generatedTitle !== currentDefaultTitle) { // Compare with translated default
                         await updateActiveChatTitle(generatedTitle); console.log("Chat title updated automatically:", generatedTitle);
                     }
                 }
             } catch(error) { console.error("Error saving user msg/updating title:", error); displayError(getTranslation("failedToSaveUserMsg")); setLoadingState(false); return; }

            // 2. Prepare API Call
            const thinking = displayMessage(getTranslation("thinking"), 'ai', ['thinking']);
            const requestHistory = [ ...currentChatHistory, { role: "user", parts: [{ text: userMessageText }] } ];
            let modifiedPrompt = userMessageText;
            if (isMCQRequest) { /* ... MCQ prompt ... */ }

            // 3. Call API & Handle Response
             console.warn("Calling Gemini API using client-side key.");
            try {
                const response = await fetch(API_URL_BASE + API_KEY, { /* ... fetch options ... */ });
                removeMessageElement(thinking);
                let aiMsgData = { role: "model", text: getTranslation("emptyResponse"), timestamp: firebase.firestore.FieldValue.serverTimestamp() };

                if (!response.ok) { /* ... Error Handling with Translations ... */
                    let err = { message: `API error (${response.status})` }; try { err = (await response.json()).error || err; } catch {} console.error("API Error:", err);
                    aiMsgData.text = getTranslation("apiError", { status: response.status }) + `: ${err.message || getTranslation("unknownApiError")}`;
                    displayError(aiMsgData.text);
                    if(response.status===400 && err.message?.toLowerCase().includes('api key not valid')){ localStorage.removeItem(STORAGE_KEY_API_KEY); API_KEY=''; displayError(getTranslation("invalidApiKey")); }
                } else { /* ... Success/MCQ Handling with Translations ... */
                     const data = await response.json(); let aiTxt = getTranslation("emptyResponse"); let blocked = false;
                     if (data.promptFeedback?.blockReason) { aiTxt = getTranslation("blockedResponse", { reason: data.promptFeedback.blockReason }); blocked = true; aiMsgData.text = aiTxt; displayMessage(aiTxt,'ai',['error-message']); }
                     else if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
                         aiTxt = data.candidates[0].content.parts[0].text; aiMsgData.text = aiTxt; let processedForMCQ = false;
                         if (isMCQRequest && !blocked) { /* ... MCQ parsing ... */
                              try { /* ... */ const mcqs = JSON.parse(jsonString);
                                  if (Array.isArray(mcqs) && mcqs.length > 0 && mcqs.every(q => q.question && Array.isArray(q.options) && q.answer)) {
                                      const summaryText = getTranslation("mcqsGenerated", { count: mcqs.length }); aiMsgData.text = summaryText; aiMsgData.mcqData = mcqs; console.log("MCQs parsed ok."); processedForMCQ = true;
                                  } else { console.warn("MCQ JSON validation failed."); }
                              /* ... */ } catch (parseError) { console.error("Failed to parse MCQ JSON:", parseError); }
                          }
                     } else { console.warn("Unexpected API response format:", data); aiMsgData.text = getTranslation("failedToParseResponse"); displayError(aiMsgData.text); }
                }
                 // 4. Save AI Response/Error
                 try { await messagesColRef.add(aiMsgData); await chatDocRef.update({ lastUpdated: firebase.firestore.FieldValue.serverTimestamp() }); console.log("AI response/error saved."); }
                 catch (saveError) { console.error("Error saving AI response:", saveError); displayError(getTranslation("failedToSaveChanges")); }

            } catch (error) { /* ... Network Error Handling with Translations ... */
                console.error("Fetch/Processing Error:", error); removeMessageElement(thinking);
                const errorText = getTranslation("networkError", { message: error.message || "" }); displayError(errorText);
                try { await messagesColRef.add({ role: "model", text: errorText, timestamp: firebase.firestore.FieldValue.serverTimestamp() }); await chatDocRef.update({ lastUpdated: firebase.firestore.FieldValue.serverTimestamp() }); } catch (saveError) {}
            } finally { setLoadingState(false); if (!isTestMode && !isReviewMode) userInput.focus(); updatePlaceholders(); }
        }

        function generateChatTitle(firstUserMessageText) { /* ... (‡ÆÆ‡ØÅ‡Æ®‡Øç‡Æ§‡Øà‡ÆØ‡Æ§‡ØÅ ‡Æ™‡Øã‡Æ≤‡Æµ‡Øá) ... */ }
        async function updateActiveChatTitle(newTitle) { /* ... */ }

        // --- UI & Message Display ---
        function autoGrowTextarea() { /* ... */ }
        function handleInputKeydown(event) { /* ... */ }
        function handleSuggestionClick(event) { /* ... */ }
        function displayError(text) { displayMessage(`${getTranslation("errorLabel") || 'Error'}: ${text}`, 'ai', ['error-message']); } // Add Error label from translation if available
        function scrollToBottom(immediate = false) { /* ... */ }
        function removeMessageElement(element) { /* ... */ }

        function setLoadingState(isLoading, message = getTranslation("generating")) { // Default message from translation
            const loggedIn = !!currentUser;
            const noActiveChat = !activeChatId;
            const deleting = isDeletingChat; // Capture current delete state

            // Determine overall disabled state for send button and MCQ checkbox
            const isDisabled = isLoading || !loggedIn || (noActiveChat && !deleting);

            // Determine disabled state for the input field (only if loading or logged out)
            const inputDisabled = isLoading || !loggedIn;

            userInput.disabled = inputDisabled;
            sendButton.disabled = isDisabled;
            mcqModeCheckbox.disabled = isDisabled;
            startChatButton.disabled = isLoading || !loggedIn; // Also disable start chat if loading

            // Set placeholder based on current state and language
            if (isLoading) { userInput.placeholder = message; }
            else if (!loggedIn) { userInput.placeholder = getTranslation("pleaseLogIn"); }
            else if (noActiveChat && !deleting) { userInput.placeholder = getTranslation("selectOrCreateChat"); }
            else if (noActiveChat && deleting) { userInput.placeholder = getTranslation("loading"); } // Show loading if deleting last chat
            else { userInput.placeholder = getTranslation("enterPromptMCQ"); } // Default when logged in and chat selected
        }


        function switchView(viewName) { /* ... */ }
        function displayMessage(text, sender, cssClasses = [], appendHtml = null, messageData = null) {
            const element = document.createElement('div');
            element.classList.add('message', `${sender}-message`, ...cssClasses);
             let formattedText = text.replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/```([\s\S]*?)```/g, (match, code) => `<pre><code>${code.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</code></pre>`).replace(/`([^`]+)`/g, (match, code) => `<code>${code.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</code>`).replace(/\n/g, '<br>');
            element.innerHTML = formattedText;

            // MCQ Offer Button (with translation)
            if (messageData?.role === 'model' && Array.isArray(messageData.mcqData)) {
                 displayMCQOffer(messageData.mcqData, element); // Pass element to append to
            } else if (appendHtml) { /* ... */ }

            chatArea.appendChild(element);
            try { if (typeof MathJax !== "undefined" && MathJax.typesetPromise) { MathJax.typesetPromise([element]).catch(err => console.error('MathJax error:', err)); } } catch (e) {}
            return element;
        }


        // --- MCQ/Test/Review Functions ---
        function handleChatAreaClick(event) { /* ... */ }
        function displayMCQOffer(mcqs, aiMessageElement) {
             generatedMCQData = mcqs;
             // Use translation for button text
             const buttonText = getTranslation("startMockTestBtn", { count: mcqs.length });
             const buttonHtml = `<button class="start-test-button">${buttonText}</button>`;
             const tempDiv = document.createElement('div'); tempDiv.style.marginTop = '10px'; tempDiv.innerHTML = buttonHtml;
             aiMessageElement.appendChild(tempDiv);
             scrollToBottom();
        }
        function startMockTest(mcqs) { /* ... Use translations for titles if needed ... */ }
        function displayTestQuestion(index) { /* ... Use translations for labels if needed ... */ }
        function handleOptionSelect(optionIndex) { /* ... */ }
        function handleTestNavigation(direction) { /* ... */ }
        function startTestTimer() { /* ... */ }
        function submitTest() {
            if (!confirm(getTranslation("confirmSubmit"))) return; // Use translation
            if (testTimerInterval) clearInterval(testTimerInterval);
            const endTime = Date.now(); const timeTakenMs = endTime - testStartTime;
            switchView('review'); displayReview(timeTakenMs);
        }
        function displayReview(timeTakenMs) {
             reviewContent.innerHTML = ''; saveReviewBtn.disabled = false; saveReviewBtn.textContent = getTranslation("saveReview");
             if (!currentTestMCQs || currentTestMCQs.length === 0) { reviewSummary.innerHTML = `<span>${getTranslation("noReviewData")}</span>`; return; }
             let correctCount = 0, incorrectCount = 0, skippedCount = 0;
             reviewResultsCache = { questions: [], summary: {}, testDate: new Date().toISOString(), timeTakenMs: timeTakenMs };

             currentTestMCQs.forEach((q, index) => { /* ... Answer checking logic ... */
                 const userAnswerIndex = userAnswers[index];
                 let userAnswerText = getTranslation("skippedAnswerText"); let status = "skipped"; let itemStatusClass = "status-skipped"; let answerDetailClass = "user-answer-skipped";
                 const correctAnswerLetter = q.answer?.trim().toUpperCase(); const correctAnswerIndex = correctAnswerLetter ? correctAnswerLetter.charCodeAt(0) - 'A'.charCodeAt(0) : -1;
                 const options = Array.isArray(q.options) ? q.options : []; const correctAnswerText = (correctAnswerIndex >= 0 && correctAnswerIndex < options.length) ? options[correctAnswerIndex] : "N/A";

                 if (userAnswerIndex !== null && userAnswerIndex >= 0 && userAnswerIndex < options.length) { userAnswerText = options[userAnswerIndex]; if (userAnswerIndex === correctAnswerIndex) { status = "correct"; itemStatusClass = "status-correct"; answerDetailClass = "user-answer-correct"; correctCount++; } else { status = "incorrect"; itemStatusClass = "status-incorrect"; answerDetailClass = "user-answer-incorrect"; incorrectCount++; } }
                 else if (userAnswerIndex !== null) { userAnswerText = getTranslation("invalidSelectionText"); status = "incorrect"; itemStatusClass = "status-incorrect"; answerDetailClass = "user-answer-incorrect"; incorrectCount++; }
                 else { skippedCount++; }
                 reviewResultsCache.questions.push({ question: q.question, options: options, correctAnswer: correctAnswerText, userAnswer: userAnswerText, status: status });
                 const item = document.createElement('div'); item.classList.add('review-item', itemStatusClass); item.dataset.status = status;
                 let detailsHtml = `<span class="${answerDetailClass}">${getTranslation("yourAnswerLabel")} ${userAnswerText}</span>`;
                 if (status !== 'correct') { detailsHtml += `<br><span class="correct-answer">${getTranslation("correctAnswerLabel")} ${correctAnswerText}</span>`; }
                 item.innerHTML = `<div class="review-item-qnum">${getTranslation("questionLabel") || 'Question'} ${index + 1}</div><div class="review-item-question">${q.question}</div><div class="review-item-details">${detailsHtml}</div>`;
                 reviewContent.appendChild(item);
             });

             const totalQuestions = currentTestMCQs.length; const score = `${correctCount}/${totalQuestions}`; const timeSeconds = Math.round(timeTakenMs / 1000); const minutes = Math.floor(timeSeconds / 60); const seconds = timeSeconds % 60; const timeString = currentLanguage === 'ta' ? `${minutes}‡Æ®‡Æø ${seconds}‡Æµ‡Æø` : `${minutes}m ${seconds}s`;

             reviewSummary.innerHTML = `<span>${getTranslation("scoreLabel")} ${score}</span> <span class="score-correct">${getTranslation("correctLabel")} ${correctCount}</span> <span class="score-incorrect">${getTranslation("incorrectLabel")} ${incorrectCount}</span> <span class="score-skipped">${getTranslation("skippedLabel")} ${skippedCount}</span> <span>${getTranslation("totalTimeLabel")} ${timeString}</span>`;
             reviewResultsCache.summary = { score, correct: correctCount, incorrect: incorrectCount, skipped: skippedCount, timeString };
             try { if (typeof MathJax !== "undefined" && MathJax.typesetPromise) { MathJax.typesetPromise([reviewContent]).catch(err => {}); } } catch (e) {}
             filterReviewItems('all');
        }
        function handleReviewFilterClick(event) { /* ... */ }
        function filterReviewItems(filter) { /* ... */ }
        function exitReview() { switchView('chat'); reviewResultsCache = null; }
        async function saveTestReviewToCloud() {
            if (!currentUser) { alert(getTranslation("loginToSaveReview")); return; }
            if (!reviewResultsCache) { alert(getTranslation("noReviewData")); return; }
            const reviewDataToSave = { ...reviewResultsCache, userId: currentUser.uid, savedAt: firebase.firestore.FieldValue.serverTimestamp() };
            saveReviewBtn.disabled = true; saveReviewBtn.textContent = getTranslation("savingReview");
            try { const newReviewRef = await db.collection('testReviews').add(reviewDataToSave); console.log("Review saved:", newReviewRef.id); alert(getTranslation("reviewSaved")); saveReviewBtn.textContent = getTranslation("reviewSaved"); }
            catch (error) { console.error("Error saving review:", error); alert(getTranslation("failedToSaveReview")); saveReviewBtn.disabled = false; saveReviewBtn.textContent = getTranslation("saveReview"); }
        }

    </script>

</body>
</html>
```

**3. Test History ‡Æ™‡Æï‡Øç‡Æï‡ÆÆ‡Øç (`testhistory.html`) - ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ‡Æ§‡ØÅ**

‡Æá‡Æ§‡ØÅ ‡Æö‡Øá‡ÆÆ‡Æø‡Æ§‡Øç‡Æ§ ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ‡Æï‡Æ≥‡Øà‡Æï‡Øç ‡Æï‡Ææ‡Æü‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ ‡Æ™‡Æï‡Øç‡Æï‡ÆÆ‡Øç.

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test History</title>

    <!-- MathJax, Firebase SDKs -->
    <script> window.MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],displayMath:[['$$','$$'],['\\[','\\]']]},svg:{fontCache:'global'},options:{skipHtmlTags:['script','noscript','style','textarea','pre','code']}}; </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <style>
        /* Shared Styles (index.html ‡Æá‡Æ≤‡Æø‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æ®‡Æï‡Æ≤‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ) + History Page Styles */
        :root {
             /* ... Theme Variables ... */
              --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; --message-font-size-base: 1rem; --header-height: 60px;
              /* LIGHT */ --main-bg: #ffffff; --border-color: #e0e0e0; --text-primary: #2c2c2c; --text-secondary: #5f5f5f; --text-placeholder: #999999; --accent-color: #d97a7a; --button-bg: #f0f0f0; --button-hover-bg: #e0e0e0; --app-outer-bg: #e8e8e8; --code-bg: #e8e8e8; --link-color: var(--accent-color); --history-item-bg: var(--main-bg); --history-item-hover-bg: #f9f9f9; --review-overlay-bg: rgba(0, 0, 0, 0.6);
        }
        body.dark-theme {
             /* DARK */ --main-bg: #1e1e1e; --border-color: #404040; --text-primary: #e0e0e0; --text-secondary: #a0a0a0; --text-placeholder: #777777; --accent-color: #e58b8b; --button-bg: #404040; --button-hover-bg: #505050; --app-outer-bg: #121212; --code-bg: #2c2c2e; --link-color: var(--accent-color); --history-item-bg: #2a2a2e; --history-item-hover-bg: #333333; --review-overlay-bg: rgba(0, 0, 0, 0.7);
        }
        body { font-family: var(--font-family); margin: 0; padding: 0; background-color: var(--app-outer-bg); color: var(--text-primary); font-size: 15px; transition: background-color 0.3s ease, color 0.3s ease; }
        a { color: var(--link-color); text-decoration: none; }
        a:hover { text-decoration: underline; }

        .page-container { display: flex; flex-direction: column; min-height: 100vh; background-color: var(--main-bg); }
        .page-header { background-color: var(--sidebar-bg, #f7f7f7); padding: 10px 25px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; height: var(--header-height); box-sizing: border-box; flex-shrink: 0; }
        body.dark-theme .page-header { background-color: var(--sidebar-bg, #2a2a2e); }
        .page-header h1 { margin: 0; font-size: 1.4em; color: var(--text-primary); }
        .header-controls { display: flex; align-items: center; gap: 20px; }
        .header-controls button, .header-controls a { background-color: var(--button-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s ease; display: flex; align-items: center; gap: 5px; }
        .header-controls button:hover, .header-controls a:hover { background-color: var(--button-hover-bg); }
        .header-controls button svg { width: 16px; height: 16px; fill: currentColor; }

        .page-content { padding: 20px; flex-grow: 1; max-width: 1000px; margin: 0 auto; width: 90%; }
        .search-container { margin-bottom: 20px; display: flex; gap: 10px; }
        #search-input { flex-grow: 1; padding: 10px 15px; font-size: 1rem; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--input-bg, #fff); color: var(--text-primary); }
        #search-input::placeholder { color: var(--text-placeholder); }
        body.dark-theme #search-input { background-color: var(--input-bg, #2a2a2e); }

        .history-list { list-style: none; padding: 0; margin: 0; }
        .history-item { background-color: var(--history-item-bg); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 15px; padding: 15px 20px; display: flex; flex-direction: column; gap: 10px; transition: background-color 0.2s ease; }
        .history-item:hover { background-color: var(--history-item-hover-bg); }
        .item-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .item-title { font-weight: 600; font-size: 1.1em; color: var(--text-primary); margin: 0; }
        .item-date { font-size: 0.85em; color: var(--text-secondary); }
        .item-summary span { margin-right: 15px; font-size: 0.9em; color: var(--text-secondary); }
        .item-summary .score-correct { color: #28a745; font-weight: bold;}
        .item-summary .score-incorrect { color: #dc3545; font-weight: bold;}
        .item-actions { display: flex; gap: 10px; margin-top: 5px; }
        .item-actions button { background-color: var(--button-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; padding: 5px 12px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s ease; }
        .item-actions button:hover { background-color: var(--button-hover-bg); }
        .item-actions .retake-btn { border-color: var(--accent-color); color: var(--accent-color); }
        .item-actions .retake-btn:hover { background-color: var(--accent-color); color: var(--send-button-text, #fff); }
        body.dark-theme .item-actions .retake-btn:hover { color: var(--send-button-text, #1e1e1e); }

        #no-history-message { text-align: center; color: var(--text-secondary); padding: 40px; font-style: italic; }

         /* Review Overlay Styles (Similar to index.html's review-view) */
        .review-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--review-overlay-bg); z-index: 1000; justify-content: center; align-items: center; }
        .review-overlay.active { display: flex; }
        .review-popup { background-color: var(--main-bg); color: var(--text-primary); border-radius: 10px; padding: 25px; width: 90%; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .review-popup-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .review-popup-header h2 { margin: 0; font-size: 1.3em; }
        .review-popup-close { background: none; border: none; font-size: 1.8em; cursor: pointer; color: var(--text-secondary); padding: 0 5px; line-height: 1; }
        .review-popup-content { flex-grow: 1; overflow-y: auto; padding-right: 10px; } /* Add padding for scrollbar */
        /* Reuse .review-item styles from index.html if needed, or define specific popup styles */
        .review-item { margin-bottom: 15px; padding: 15px; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--button-bg); }
        .review-item-qnum { font-weight: bold; margin-bottom: 8px; color: var(--text-secondary); }
        .review-item-question { margin-bottom: 10px; line-height: 1.5; }
        .review-item-details span { display: block; margin-bottom: 5px; font-size: 0.95em; }
        .review-item-details .correct-answer { color: #28a745; font-weight: bold; }
        .review-item-details .user-answer-correct { color: #28a745; } .review-item-details .user-answer-incorrect { color: #dc3545; text-decoration: line-through; } .review-item-details .user-answer-skipped { color: #fd7e14; font-style: italic; }

         /* Mock Test View (Copied from index.html for retakes) */
        .mock-test-view { /* ... (Styles from index.html) ... */ }
        /* ... (Ensure all mock-test-view related styles are here) ... */
         .mock-test-view { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--main-bg); z-index: 100; flex-direction: column; padding: 20px; box-sizing: border-box; transition: background-color 0.3s ease; }
         .mock-test-view.active { display: flex; }
         .test-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
         .test-header h2 { margin: 0; font-size: 1.3em; color: var(--text-primary); }
         .test-info span { margin-left: 15px; font-size: 0.95em; color: var(--text-secondary); }
         .test-content { flex-grow: 1; overflow-y: auto; padding: 10px 20px; }
         .test-question-container { margin-bottom: 25px; }
         .test-question-number { font-weight: bold; margin-bottom: 8px; color: var(--text-secondary); }
         .test-question { font-size: 1.1em; line-height: 1.5; margin-bottom: 15px; color: var(--text-primary); }
         .test-options label { display: block; margin-bottom: 12px; background-color: var(--button-bg); padding: 12px 15px; border-radius: 6px; border: 1px solid var(--border-color); cursor: pointer; transition: background-color 0.2s ease, border-color 0.2s ease; color: var(--text-primary); }
         .test-options label:hover { background-color: var(--button-hover-bg); }
         .test-options input[type="radio"] { margin-right: 10px; accent-color: var(--accent-color); cursor: pointer;}
         .test-navigation { display: flex; justify-content: space-between; padding-top: 15px; border-top: 1px solid var(--border-color); margin-top: auto; flex-shrink: 0; }
         .test-navigation button { background-color: var(--button-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; padding: 10px 20px; cursor: pointer; font-size: 0.95em; transition: background-color 0.2s ease; }
         .test-navigation button:hover:not(:disabled) { background-color: var(--button-hover-bg); }
         .test-navigation button#submit-test-btn { background-color: var(--accent-color); color: var(--send-button-text); border-color: var(--accent-color); }
         .test-navigation button#submit-test-btn:hover:not(:disabled) { background-color: var(--send-button-hover-bg); }
         .test-navigation button:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>

    <div class="page-container">
        <header class="page-header">
            <h1 data-translate-key="testHistory">Test History</h1>
            <div class="header-controls">
                <button id="language-toggle-button" data-translate-key="changeLanguageTo" data-translate-title="changeLanguageTitle">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</button>
                <a href="index.html" data-translate-key="backToChat">Back to Chat</a>
                 <button id="logout-btn" style="display: none;" data-translate-key="logout">Logout</button>
            </div>
        </header>

        <main class="page-content">
            <div id="login-prompt" style="display: none; text-align: center; padding: 40px;">
                 <p data-translate-key="loginToViewHistory">Please log in to view your test history.</p>
                 <button id="login-google-btn" data-translate-key="loginWithGoogle">Login with Google</button>
            </div>

            <div id="history-content" style="display: none;">
                 <div class="search-container">
                     <input type="text" id="search-input" placeholder="Search tests by question..." data-translate-placeholder="searchTestsPlaceholder">
                 </div>
                 <ul class="history-list" id="history-list">
                     <!-- History items will be loaded here -->
                 </ul>
                 <div id="no-history-message" style="display: none;" data-translate-key="noTestsSaved">No saved tests found.</div>
            </div>
        </main>
    </div>

     <!-- Review Overlay -->
     <div class="review-overlay" id="review-overlay">
         <div class="review-popup">
             <div class="review-popup-header">
                 <h2 data-translate-key="reviewAttemptTitle">Review Attempt</h2>
                 <button class="review-popup-close" id="review-popup-close">&times;</button>
             </div>
             <div class="review-popup-content" id="review-popup-content">
                 <!-- Review details will be loaded here -->
             </div>
         </div>
     </div>

     <!-- Mock Test View (For Retakes) -->
     <div class="mock-test-view" id="mock-test-view">
         <div class="test-header">
             <h2 id="test-title" data-translate-key="retakeTestTitle">Retake Test</h2>
             <div class="test-info">
                 <span id="question-counter">Q: 1 / N</span>
                 <span id="test-timer" data-translate-key="timeLabel">Time: 00:00</span>
             </div>
         </div>
         <div class="test-content">
             <div class="test-question-container">
                 <div class="test-question-number" id="test-question-number"></div>
                 <div class="test-question" id="test-question"></div>
                 <div class="test-options" id="test-options"></div>
             </div>
         </div>
         <div class="test-navigation">
             <button id="prev-question-btn" disabled data-translate-key="previous">Previous</button>
             <button id="next-question-btn" data-translate-key="next">Next</button>
             <button id="submit-test-btn" data-translate-key="submitTest">Submit Test</button>
         </div>
     </div>


    <script>
        // --- Firebase Config ---
        const firebaseConfig = { /* ... ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç config ... */
          apiKey: "AIzaSyDgw604fe5jnNu4kTOv1cQ-3n7PL8gcN58",
          authDomain: "krish-c5db8.firebaseapp.com",
          projectId: "krish-c5db8",
          storageBucket: "krish-c5db8.appspot.com",
          messagingSenderId: "217175257890",
          appId: "1:217175257890:web:209f0f290eabab6b1fab7b",
          measurementId: "G-97SHYGL2J4"
        };
        firebase.initializeApp(firebaseConfig);
        const fbAuth = firebase.auth();
        const db = firebase.firestore();

        // --- DOM Elements ---
        const historyList = document.getElementById('history-list');
        const searchInput = document.getElementById('search-input');
        const loginPrompt = document.getElementById('login-prompt');
        const historyContent = document.getElementById('history-content');
        const noHistoryMessage = document.getElementById('no-history-message');
        const loginBtn = document.getElementById('login-google-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const languageToggleButton = document.getElementById('language-toggle-button');
        const reviewOverlay = document.getElementById('review-overlay');
        const reviewPopupContent = document.getElementById('review-popup-content');
        const reviewPopupCloseBtn = document.getElementById('review-popup-close');
        // Mock Test View Elements (for retake)
        const testView = document.getElementById('mock-test-view');
        const testTitle = document.getElementById('test-title');
        const questionCounter = document.getElementById('question-counter');
        const testTimer = document.getElementById('test-timer');
        const testQuestionNumber = document.getElementById('test-question-number');
        const testQuestion = document.getElementById('test-question');
        const testOptionsContainer = document.getElementById('test-options');
        const prevQuestionBtn = document.getElementById('prev-question-btn');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const submitTestBtn = document.getElementById('submit-test-btn');


        // --- State ---
        let currentUser = null;
        let currentLanguage = 'en';
        let allReviews = []; // Cache for search
        let currentTestMCQs = []; // For retake
        let currentQuestionIndex = 0; // For retake
        let userAnswers = []; // For retake
        let testStartTime = null; // For retake
        let testTimerInterval = null; // For retake
        const STORAGE_KEY_LANGUAGE = 'geminiChatLanguage'; // Use same key as index.html

        // --- Translations (Same as index.html) ---
        const translations = {
             en: {
                 testHistory: "Test History", backToChat: "Back to Chat", logout: "Logout", loginToViewHistory: "Please log in to view your test history.",
                 loginWithGoogle: "Login with Google", searchTestsPlaceholder: "Search tests by question...", noTestsSaved: "No saved tests found.",
                 reviewAttemptBtn: "Review Attempt", retakeTestBtn: "Retake Test", reviewAttemptTitle: "Review Attempt", retakeTestTitle: "Retake Test",
                 timeLabel: "Time:", previous: "Previous", next: "Next", submitTest: "Submit Test", confirmSubmit: "Are you sure you want to submit the test?",
                 scoreLabel: "Score:", correctLabel: "Correct:", incorrectLabel: "Incorrect:", skippedLabel: "Skipped:", totalTimeLabel: "Total Time:",
                 yourAnswerLabel: "Your Answer:", correctAnswerLabel: "Correct Answer:", skippedAnswerText: "Skipped", invalidSelectionText: "Invalid Selection",
                 questionLabel: "Question", changeLanguageTitle: "Change Language", changeLanguageTo: "‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç", // Added for toggle
             },
             ta: {
                 testHistory: "‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ ‡Æµ‡Æ∞‡Æ≤‡Ææ‡Æ±‡ØÅ", backToChat: "Chat-‡Æï‡Øç‡Æï‡ØÅ ‡Æ§‡Æø‡Æ∞‡ØÅ‡ÆÆ‡Øç‡Æ™‡ØÅ‡Æï", logout: "‡Æµ‡ØÜ‡Æ≥‡Æø‡ÆØ‡Øá‡Æ±‡ØÅ", loginToViewHistory: "‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ ‡Æµ‡Æ∞‡Æ≤‡Ææ‡Æ±‡Øç‡Æ±‡Øà‡Æï‡Øç ‡Æï‡Ææ‡Æ£ ‡Æâ‡Æ≥‡Øç‡Æ®‡ØÅ‡Æ¥‡Øà‡ÆØ‡Æµ‡ØÅ‡ÆÆ‡Øç.",
                 loginWithGoogle: "Google ‡ÆÆ‡ØÇ‡Æ≤‡ÆÆ‡Øç ‡Æâ‡Æ≥‡Øç‡Æ®‡ØÅ‡Æ¥‡Øà‡Æï", searchTestsPlaceholder: "‡Æï‡Øá‡Æ≥‡Øç‡Æµ‡Æø ‡ÆÆ‡ØÇ‡Æ≤‡ÆÆ‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ‡Æï‡Æ≥‡Øà‡Æ§‡Øç ‡Æ§‡Øá‡Æü‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç...", noTestsSaved: "‡Æö‡Øá‡ÆÆ‡Æø‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ‡Æï‡Æ≥‡Øç ‡Æé‡Æ§‡ØÅ‡Æµ‡ØÅ‡ÆÆ‡Øç ‡Æá‡Æ≤‡Øç‡Æ≤‡Øà.",
                 reviewAttemptBtn: "‡ÆÆ‡ØÅ‡ÆØ‡Æ±‡Øç‡Æö‡Æø‡ÆØ‡Øà ‡ÆÆ‡Æ±‡ØÅ‡Æ™‡Ææ‡Æ∞‡Øç‡Æµ‡Øà ‡Æö‡ØÜ‡ÆØ‡Øç", retakeTestBtn: "‡ÆÆ‡ØÄ‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡Æé‡Æ¥‡ØÅ‡Æ§‡ØÅ", reviewAttemptTitle: "‡ÆÆ‡ØÅ‡ÆØ‡Æ±‡Øç‡Æö‡Æø ‡ÆÆ‡Æ±‡ØÅ‡Æ™‡Ææ‡Æ∞‡Øç‡Æµ‡Øà", retakeTestTitle: "‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡Øà ‡ÆÆ‡ØÄ‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡Æé‡Æ¥‡ØÅ‡Æ§‡ØÅ",
                 timeLabel: "‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç:", previous: "‡ÆÆ‡ØÅ‡Æ®‡Øç‡Æ§‡Øà‡ÆØ‡Æ§‡ØÅ", next: "‡ÆÖ‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡Æ§‡ØÅ", submitTest: "‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡Øà‡Æö‡Øç ‡Æö‡ÆÆ‡Æ∞‡Øç‡Æ™‡Øç‡Æ™‡Æø", confirmSubmit: "‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡Øà‡Æö‡Øç ‡Æö‡ÆÆ‡Æ∞‡Øç‡Æ™‡Øç‡Æ™‡Æø‡Æï‡Øç‡Æï ‡Æµ‡Æø‡Æ∞‡ØÅ‡ÆÆ‡Øç‡Æ™‡ØÅ‡Æï‡Æø‡Æ±‡ØÄ‡Æ∞‡Øç‡Æï‡Æ≥‡Ææ?",
                 scoreLabel: "‡ÆÆ‡Æ§‡Æø‡Æ™‡Øç‡Æ™‡ØÜ‡Æ£‡Øç:", correctLabel: "‡Æö‡Æ∞‡Æø:", incorrectLabel: "‡Æ§‡Æµ‡Æ±‡ØÅ:", skippedLabel: "‡Æ§‡Æµ‡Æø‡Æ∞‡Øç‡Æ§‡Øç‡Æ§‡Æµ‡Øà:", totalTimeLabel: "‡ÆÆ‡Øä‡Æ§‡Øç‡Æ§ ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç:",
                 yourAnswerLabel: "‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æ™‡Æ§‡Æø‡Æ≤‡Øç:", correctAnswerLabel: "‡Æö‡Æ∞‡Æø‡ÆØ‡Ææ‡Æ© ‡Æ™‡Æ§‡Æø‡Æ≤‡Øç:", skippedAnswerText: "‡Æ§‡Æµ‡Æø‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ", invalidSelectionText: "‡Æ§‡Æµ‡Æ±‡Ææ‡Æ© ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ",
                 questionLabel: "‡Æï‡Øá‡Æ≥‡Øç‡Æµ‡Æø", changeLanguageTitle: "‡ÆÆ‡Øä‡Æ¥‡Æø‡ÆØ‡Øà ‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡Æµ‡ØÅ‡ÆÆ‡Øç", changeLanguageTo: "English", // Added for toggle
             }
         };

        // --- Initialization ---
        initializeApp();

        // --- Event Listeners ---
        fbAuth.onAuthStateChanged(handleAuthStateChange);
        loginBtn.addEventListener('click', signInWithGoogle);
        logoutBtn.addEventListener('click', signOut);
        languageToggleButton.addEventListener('click', toggleLanguage);
        searchInput.addEventListener('input', handleSearch);
        historyList.addEventListener('click', handleHistoryActionClick);
        reviewPopupCloseBtn.addEventListener('click', closeReviewPopup);
         // Retake Test Listeners
         prevQuestionBtn.addEventListener('click', () => handleTestNavigation('prev'));
         nextQuestionBtn.addEventListener('click', () => handleTestNavigation('next'));
         submitTestBtn.addEventListener('click', submitRetakeTest); // Different submit handler for retake


        // --- Functions ---
        function initializeApp() {
            loadLanguage();
            applyTranslations(); // Apply initial translations
            // Auth state change will handle showing content
        }

        // --- Language Functions (Same as index.html) ---
         function getTranslation(key, params = {}) { /* ... */
             let text = translations[currentLanguage]?.[key] || translations['en']?.[key] || key;
             for (const param in params) { text = text.replace(`{${param}}`, params[param]); }
             return text;
          }
         function applyTranslations() { /* ... */
             document.querySelectorAll('[data-translate-key]').forEach(el => {
                 const key = el.dataset.translateKey;
                 const translation = getTranslation(key);
                 if (el.tagName === 'INPUT' && el.placeholder) { el.placeholder = translation; }
                 else if (el.title && el.dataset.translateTitle === key) { el.title = translation; }
                  else { el.textContent = translation; }
             });
             updateLanguageButton();
             // Re-render list if data exists, to update button text etc.
             if (currentUser && allReviews.length > 0) {
                 renderTestHistoryList(filterReviews(allReviews, searchInput.value));
             } else if (currentUser && allReviews.length === 0) {
                 noHistoryMessage.textContent = getTranslation("noTestsSaved");
             } else if (!currentUser) {
                 loginPrompt.querySelector('p').textContent = getTranslation("loginToViewHistory");
                 loginBtn.textContent = getTranslation("loginWithGoogle");
             }

         }
         function setLanguage(lang) { /* ... */
             currentLanguage = lang; localStorage.setItem(STORAGE_KEY_LANGUAGE, lang); document.documentElement.lang = lang; applyTranslations();
          }
         function toggleLanguage() { /* ... */
             const newLang = currentLanguage === 'en' ? 'ta' : 'en'; setLanguage(newLang);
          }
         function loadLanguage() { /* ... */
             const savedLang = localStorage.getItem(STORAGE_KEY_LANGUAGE); currentLanguage = savedLang || 'en'; document.documentElement.lang = currentLanguage; updateLanguageButton();
          }
         function updateLanguageButton() { /* ... */
             if (languageToggleButton) { languageToggleButton.textContent = getTranslation('changeLanguageTo'); }
          }

        // --- Authentication ---
        async function signInWithGoogle() { /* ... (Same as index.html, no message change needed here) ... */
             const provider = new firebase.auth.GoogleAuthProvider(); try { await fbAuth.signInWithPopup(provider); } catch (error) { console.error("Google Sign-In Error:", error); alert(`Login failed: ${error.message}`); }
         }
        async function signOut() { /* ... (Same as index.html) ... */
             try { await fbAuth.signOut(); } catch (error) { console.error("Sign Out Error:", error); alert(`Logout failed: ${error.message}`); }
         }

        function handleAuthStateChange(user) {
            currentUser = user;
            if (currentUser) {
                console.log("User logged in (History Page):", currentUser.uid);
                loginPrompt.style.display = 'none';
                historyContent.style.display = 'block';
                logoutBtn.style.display = 'inline-flex'; // Show logout button
                loadTestHistory(currentUser.uid);
            } else {
                console.log("User logged out (History Page)");
                loginPrompt.style.display = 'block';
                historyContent.style.display = 'none';
                logoutBtn.style.display = 'none'; // Hide logout button
                historyList.innerHTML = ''; // Clear list
                allReviews = []; // Clear cache
            }
            applyTranslations(); // Update translations based on login state
        }

        // --- History Loading & Display ---
        async function loadTestHistory(userId) {
            noHistoryMessage.style.display = 'none'; // Hide message initially
            historyList.innerHTML = `<li>${getTranslation("loading")}</li>`; // Show loading indicator

            const reviewsRef = db.collection('testReviews')
                                 .where('userId', '==', userId)
                                 .orderBy('savedAt', 'desc'); // Latest first

            try {
                const snapshot = await reviewsRef.get();
                allReviews = []; // Clear cache before filling
                snapshot.forEach(doc => {
                    allReviews.push({ id: doc.id, ...doc.data() });
                });
                console.log(`Loaded ${allReviews.length} test reviews.`);
                renderTestHistoryList(allReviews); // Render all initially
                noHistoryMessage.style.display = allReviews.length === 0 ? 'block' : 'none';
                if(allReviews.length === 0) {
                     noHistoryMessage.textContent = getTranslation("noTestsSaved"); // Update text if empty
                 }
            } catch (error) {
                console.error("Error loading test history:", error);
                historyList.innerHTML = `<li>Error loading history: ${error.message}</li>`;
                noHistoryMessage.style.display = 'none';
            }
        }

        function renderTestHistoryList(reviews) {
            historyList.innerHTML = ''; // Clear previous items
            if (reviews.length === 0 && !searchInput.value) { // Only show 'no tests' if list is empty AND no search term
                 noHistoryMessage.style.display = 'block';
                 noHistoryMessage.textContent = getTranslation("noTestsSaved");
                 return;
             } else if (reviews.length === 0 && searchInput.value) { // Show 'no results' if search yielded nothing
                 noHistoryMessage.style.display = 'block';
                 noHistoryMessage.textContent = getTranslation("noSearchResults") || "No tests match your search."; // Add translation key if needed
                 return;
             }

            noHistoryMessage.style.display = 'none'; // Hide message if there are results

            reviews.forEach(review => {
                const li = document.createElement('li');
                li.classList.add('history-item');
                li.dataset.reviewId = review.id; // Store ID for actions

                // Attempt to create a title (e.g., from first question)
                 // Ensure questions exist and have content
                 let title = `Test (${review.summary?.score || 'N/A'})`;
                 if (review.questions && review.questions.length > 0 && review.questions[0].question) {
                    const firstQ = review.questions[0].question.split(' ').slice(0, 8).join(' ') + '...'; // First 8 words
                     title = firstQ.replace(/<[^>]*>/g, ''); // Remove potential HTML tags
                 }


                const date = review.savedAt?.toDate ? review.savedAt.toDate() : (review.testDate ? new Date(review.testDate) : null);
                const formattedDate = date ? date.toLocaleString(currentLanguage === 'ta' ? 'ta-IN' : 'en-US') : 'N/A';

                li.innerHTML = `
                    <div class="item-header">
                        <h3 class="item-title">${title}</h3>
                        <span class="item-date">${formattedDate}</span>
                    </div>
                    <div class="item-summary">
                        <span>${getTranslation("scoreLabel")} ${review.summary?.score || 'N/A'}</span>
                        <span class="score-correct">${getTranslation("correctLabel")} ${review.summary?.correct ?? 'N/A'}</span>
                        <span class="score-incorrect">${getTranslation("incorrectLabel")} ${review.summary?.incorrect ?? 'N/A'}</span>
                        <span>${getTranslation("totalTimeLabel")} ${review.summary?.timeString || 'N/A'}</span>
                    </div>
                    <div class="item-actions">
                        <button class="review-btn" data-action="review" data-translate-key="reviewAttemptBtn">${getTranslation("reviewAttemptBtn")}</button>
                        <button class="retake-btn" data-action="retake" data-translate-key="retakeTestBtn">${getTranslation("retakeTestBtn")}</button>
                    </div>
                `;
                historyList.appendChild(li);

                // Store full review data on the element for quick access by actions
                li._reviewData = review;
            });
        }

        // --- Search ---
        function handleSearch() {
            const searchTerm = searchInput.value.toLowerCase();
            const filteredReviews = filterReviews(allReviews, searchTerm);
            renderTestHistoryList(filteredReviews);
        }

         function filterReviews(reviews, term) {
             if (!term) {
                 return reviews; // No term, return all
             }
             return reviews.filter(review => {
                 // Search within questions
                 return review.questions?.some(q => q.question?.toLowerCase().includes(term));
             });
         }

        // --- Actions (Review, Retake) ---
        function handleHistoryActionClick(event) {
            const button = event.target.closest('button[data-action]');
            if (!button) return;

            const action = button.dataset.action;
            const listItem = button.closest('.history-item');
            const reviewData = listItem?._reviewData; // Get stored data

            if (!reviewData) {
                console.error("Review data not found for action.");
                return;
            }

            if (action === 'review') {
                showReviewAttempt(reviewData);
            } else if (action === 'retake') {
                startRetakeTest(reviewData.questions); // Pass only the questions array
            }
        }

        // --- Review Attempt Popup ---
        function showReviewAttempt(reviewData) {
            reviewPopupContent.innerHTML = ''; // Clear previous content
            if (!reviewData || !reviewData.questions) {
                reviewPopupContent.innerHTML = '<p>Error: Review data is incomplete.</p>';
                reviewOverlay.classList.add('active');
                return;
            }

            // Replicate the display logic from index.html's displayReview
            reviewData.questions.forEach((q, index) => {
                const item = document.createElement('div');
                item.classList.add('review-item'); // Use the same class for styling

                let detailsHtml = `<span class="${q.status === 'correct' ? 'user-answer-correct' : (q.status === 'incorrect' ? 'user-answer-incorrect' : 'user-answer-skipped')}">
                                      ${getTranslation("yourAnswerLabel")} ${q.userAnswer || getTranslation("skippedAnswerText")}
                                   </span>`;
                if (q.status !== 'correct') {
                    detailsHtml += `<br><span class="correct-answer">${getTranslation("correctAnswerLabel")} ${q.correctAnswer || 'N/A'}</span>`;
                }

                item.innerHTML = `
                    <div class="review-item-qnum">${getTranslation("questionLabel")} ${index + 1}</div>
                    <div class="review-item-question">${q.question || 'N/A'}</div>
                    <div class="review-item-details">${detailsHtml}</div>
                `;
                reviewPopupContent.appendChild(item);
            });

             // Typeset MathJax within the popup
             try {
                 if (typeof MathJax !== "undefined" && MathJax.typesetPromise) {
                     MathJax.typesetPromise([reviewPopupContent]).catch(err => console.error('MathJax typeset error:', err));
                 }
             } catch (e) { console.error("MathJax call failed:", e); }

            reviewOverlay.classList.add('active');
        }

        function closeReviewPopup() {
            reviewOverlay.classList.remove('active');
            reviewPopupContent.innerHTML = ''; // Clear content when closing
        }

        // --- Retake Test Functions (Adapted from index.html) ---
        function startRetakeTest(mcqs) {
            if (!currentUser) { alert(getTranslation("loginToStartTest")); return; } // Use translation
            if (!mcqs || mcqs.length === 0) { alert(getTranslation("noQuestionsForTest")); return; } // Use translation
            console.log(`Starting retake with ${mcqs.length} questions.`);

            currentTestMCQs = mcqs; // Use the questions from the saved review
            currentQuestionIndex = 0;
            userAnswers = new Array(mcqs.length).fill(null);

            // Show the mock test overlay
            testView.classList.add('active');
            displayTestQuestion(0); // Display first question
            startTestTimer(); // Start the timer
            testTitle.textContent = getTranslation("retakeTestTitle"); // Set title
        }

        // Functions displayTestQuestion, handleOptionSelect, handleTestNavigation, startTestTimer
        // are needed here, copied/adapted from index.html's script
        function displayTestQuestion(index) {
             if (index < 0 || index >= currentTestMCQs.length) return;
             currentQuestionIndex = index;
             const q = currentTestMCQs[index];

             testQuestionNumber.textContent = `${getTranslation("questionLabel")} ${index + 1}`;
             testQuestion.innerHTML = q.question;
             testOptionsContainer.innerHTML = '';

             const options = Array.isArray(q.options) ? q.options : [];
             options.forEach((opt, i) => {
                 const label = document.createElement('label');
                 const input = document.createElement('input');
                 input.type = 'radio'; input.name = `q_${index}`; input.value = i;
                 input.checked = (userAnswers[index] === i);
                 input.onchange = () => handleOptionSelect(i);
                 label.appendChild(input);
                 label.appendChild(document.createTextNode(` ${opt || '(Option Error)'}`));
                 testOptionsContainer.appendChild(label);
             });

             try { if (typeof MathJax !== "undefined" && MathJax.typesetPromise) { MathJax.typesetPromise([testQuestion, testOptionsContainer]).catch(err => {}); } } catch(e){}

             prevQuestionBtn.disabled = (index === 0);
             nextQuestionBtn.disabled = (index === currentTestMCQs.length - 1);
             questionCounter.textContent = `Q: ${index + 1} / ${currentTestMCQs.length}`;
        }

        function handleOptionSelect(optionIndex) {
             if (currentQuestionIndex >= 0 && currentQuestionIndex < userAnswers.length) { userAnswers[currentQuestionIndex] = optionIndex; }
        }

        function handleTestNavigation(direction) {
             let newIndex = currentQuestionIndex;
             if (direction === 'prev' && currentQuestionIndex > 0) newIndex--;
             else if (direction === 'next' && currentQuestionIndex < currentTestMCQs.length - 1) newIndex++;
             if (newIndex !== currentQuestionIndex) displayTestQuestion(newIndex);
        }

        function startTestTimer() {
             if (testTimerInterval) clearInterval(testTimerInterval);
             testStartTime = Date.now();
             testTimerInterval = setInterval(() => {
                 const elapsedSeconds = Math.floor((Date.now() - testStartTime) / 1000);
                 const minutes = Math.floor(elapsedSeconds / 60).toString().padStart(2, '0');
                 const seconds = (elapsedSeconds % 60).toString().padStart(2, '0');
                 testTimer.textContent = `${getTranslation("timeLabel")} ${minutes}:${seconds}`;
             }, 1000);
        }

         // Special submit for retake - just show review, don't save again
        function submitRetakeTest() {
             if (!confirm(getTranslation("confirmSubmit"))) return;
             if (testTimerInterval) clearInterval(testTimerInterval);
             const endTime = Date.now(); const timeTakenMs = endTime - testStartTime;
             console.log("Retake submitted. Time:", timeTakenMs);

             testView.classList.remove('active'); // Hide the test overlay

             // Immediately show the review results in the popup
             displayRetakeReview(timeTakenMs);
         }

         // Display review results specifically for the retake, in the popup
         function displayRetakeReview(timeTakenMs) {
             reviewPopupContent.innerHTML = ''; // Clear previous popup content
             if (!currentTestMCQs || currentTestMCQs.length === 0) {
                 reviewPopupContent.innerHTML = '<p>No test data to review.</p>';
                 reviewOverlay.classList.add('active');
                 return;
             }

             let correctCount = 0, incorrectCount = 0, skippedCount = 0;
             // Calculate results (similar to index.html's displayReview)
             currentTestMCQs.forEach((q, index) => {
                 const userAnswerIndex = userAnswers[index];
                 let userAnswerText = getTranslation("skippedAnswerText"); let status = "skipped";
                 const correctAnswerLetter = q.answer?.trim().toUpperCase(); const correctAnswerIndex = correctAnswerLetter ? correctAnswerLetter.charCodeAt(0) - 'A'.charCodeAt(0) : -1;
                 const options = Array.isArray(q.options) ? q.options : []; const correctAnswerText = (correctAnswerIndex >= 0 && correctAnswerIndex < options.length) ? options[correctAnswerIndex] : "N/A";

                 if (userAnswerIndex !== null && userAnswerIndex >= 0 && userAnswerIndex < options.length) { userAnswerText = options[userAnswerIndex]; if (userAnswerIndex === correctAnswerIndex) { status = "correct"; correctCount++; } else { status = "incorrect"; incorrectCount++; } }
                 else if (userAnswerIndex !== null) { userAnswerText = getTranslation("invalidSelectionText"); status = "incorrect"; incorrectCount++; }
                 else { skippedCount++; }

                 // Create review item HTML for the popup
                 const item = document.createElement('div'); item.classList.add('review-item');
                 let detailsHtml = `<span class="${status === 'correct' ? 'user-answer-correct' : (status === 'incorrect' ? 'user-answer-incorrect' : 'user-answer-skipped')}">
                                       ${getTranslation("yourAnswerLabel")} ${userAnswerText}
                                    </span>`;
                 if (status !== 'correct') { detailsHtml += `<br><span class="correct-answer">${getTranslation("correctAnswerLabel")} ${correctAnswerText}</span>`; }
                 item.innerHTML = `<div class="review-item-qnum">${getTranslation("questionLabel")} ${index + 1}</div><div class="review-item-question">${q.question}</div><div class="review-item-details">${detailsHtml}</div>`;
                 reviewPopupContent.appendChild(item);
             });

             // Add summary to the top of the popup content
             const totalQuestions = currentTestMCQs.length; const score = `${correctCount}/${totalQuestions}`; const timeSeconds = Math.round(timeTakenMs / 1000); const minutes = Math.floor(timeSeconds / 60); const seconds = timeSeconds % 60; const timeString = currentLanguage === 'ta' ? `${minutes}‡Æ®‡Æø ${seconds}‡Æµ‡Æø` : `${minutes}m ${seconds}s`;
             const summaryDiv = document.createElement('div'); summaryDiv.style.marginBottom = '15px'; summaryDiv.style.paddingBottom = '10px'; summaryDiv.style.borderBottom = '1px solid var(--border-color)';
             summaryDiv.innerHTML = `<span>${getTranslation("scoreLabel")} ${score}</span> | <span class="score-correct">${getTranslation("correctLabel")} ${correctCount}</span> | <span class="score-incorrect">${getTranslation("incorrectLabel")} ${incorrectCount}</span> | <span>${getTranslation("totalTimeLabel")} ${timeString}</span>`;
             reviewPopupContent.insertBefore(summaryDiv, reviewPopupContent.firstChild);


             // Typeset MathJax
             try { if (typeof MathJax !== "undefined" && MathJax.typesetPromise) { MathJax.typesetPromise([reviewPopupContent]).catch(err => {}); } } catch (e) {}

             // Show the review popup
             reviewOverlay.classList.add('active');
         }


    </script>

</body>
</html>
